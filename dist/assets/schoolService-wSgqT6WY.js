import{s}from"./main-Cv3DLBs1.js";class E{async getDashboardStats(o){try{const{data:t,error:e}=await s.from("school_teachers").select("user_id, status").eq("school_id",o).eq("status","active");if(e)throw e;const r=t?.map(h=>h.user_id)||[],{data:u,error:i}=await s.from("school_classes").select("class_id").eq("school_id",o);if(i)throw i;const a=u?.map(h=>h.class_id)||[];let f={};if(a.length>0){const{data:h,error:_}=await s.from("classes").select("id, name, created_by, subject").in("id",a);if(_)throw _;f=(h||[]).reduce((d,g)=>(d[g.id]=g,d),{})}let c=0;if(o){const{data:h,error:_}=await s.rpc("count_school_students",{p_school_id:o});if(_){console.warn("[SchoolService] Error counting students, using fallback:",_);const{count:d}=await s.from("class_members").select("user_id",{count:"exact",head:!0}).in("class_id",a).eq("role","student");c=d||0}else c=h||0}const n=new Date;n.setDate(n.getDate()-30);let l={total:0,onTime:0,late:0};if(a.length>0){const{data:h}=await s.from("activity_class_assignments").select("activity_id, activities (id, due_date)").in("class_id",a),_=h?.map(d=>d.activity_id)||[];if(_.length>0){const{data:d}=await s.from("submissions").select("id, submitted_at, activity_id").in("activity_id",_).eq("status","submitted").gte("submitted_at",n.toISOString());l.total=d?.length||0;const g=new Map(h?.map(m=>[m.activity_id,m.activities?.due_date])||[]);d?.forEach(m=>{const y=g.get(m.activity_id);if(y){const S=new Date(m.submitted_at),b=new Date(y);S<=b?l.onTime++:l.late++}})}}const w=l.total>0?Math.round(l.onTime/l.total*100):0;let v=null;if(a.length>0){const{data:h}=await s.from("activity_class_assignments").select("activity_id").in("class_id",a),_=h?.map(d=>d.activity_id)||[];if(_.length>0){const{data:d}=await s.from("submissions").select("grade").in("activity_id",_).not("grade","is",null);d&&d.length>0&&(v=(d.reduce((m,y)=>m+(y.grade||0),0)/d.length).toFixed(1))}}return{totalTeachers:r.length,totalStudents:c,totalClasses:a.length,onTimeRate:w,averageGrade:v,submissionsLast30Days:l.total,classIds:a,teacherIds:r}}catch(t){throw console.error("[SchoolService] Error getting dashboard stats:",t),t}}async getTeachers(o){try{const{data:t,error:e}=await s.from("school_teachers").select("user_id, status, joined_at").eq("school_id",o).order("joined_at",{ascending:!1});if(e)throw e;const r=(t||[]).map(i=>i.user_id);let u={};if(r.length>0){const{data:i}=await s.from("profiles").select("id, full_name, email, avatar_url").in("id",r);u=(i||[]).reduce((a,f)=>(a[f.id]=f,a),{})}return(t||[]).map(i=>{const a=u[i.user_id]||{};return{id:i.user_id,name:a.full_name||"Professor",email:a.email||"",avatar:a.avatar_url,status:i.status,joinedAt:i.joined_at}})}catch(t){throw console.error("[SchoolService] Error getting teachers:",t),t}}async getClasses(o){try{const{data:t,error:e}=await s.from("school_classes").select("class_id, created_at").eq("school_id",o).order("created_at",{ascending:!1});if(e)throw e;const r=(t||[]).map(c=>c.class_id);let u={};if(r.length>0){const{data:c}=await s.from("classes").select("id, name, subject, color, created_by").in("id",r);u=(c||[]).reduce((n,l)=>(n[l.id]=l,n),{})}const i=Array.from(new Set(Object.values(u).map(c=>c.created_by).filter(Boolean)));let a={};if(i.length>0){const{data:c}=await s.from("profiles").select("id, full_name").in("id",i);a=(c||[]).reduce((n,l)=>(n[l.id]=l.full_name||"Professor",n),{})}let f={};if(r.length>0){const{data:c,error:n}=await s.rpc("count_class_students_batch",{p_class_ids:r});n?console.warn("[SchoolService] Error counting students batch, using 0:",n):f=(c||[]).reduce((l,w)=>(l[w.class_id]=w.student_count,l),{})}return(t||[]).map(c=>{const n=u[c.class_id]||{};return{id:c.class_id,name:n.name||"Turma",subject:n.subject,color:n.color,teacherName:a[n.created_by]||"Professor",studentCount:f[c.class_id]||0,linkedAt:c.created_at}})}catch(t){throw console.error("[SchoolService] Error getting classes:",t),t}}async linkTeacher(o,t){try{const{data:e,error:r}=await s.from("profiles").select("id, user_metadata->role").eq("email",t).maybeSingle();if(r)throw r;if(!e)throw new Error("Professor não encontrado com este email");const{data:u}=await s.from("school_teachers").select("user_id").eq("school_id",o).eq("user_id",e.id).maybeSingle();if(u)throw new Error("Professor já está vinculado a esta escola");const{error:i}=await s.from("school_teachers").insert({school_id:o,user_id:e.id,status:"active"});if(i)throw i;return{success:!0,teacherId:e.id}}catch(e){throw console.error("[SchoolService] Error linking teacher:",e),e}}async unlinkTeacher(o,t){try{const{error:e}=await s.from("school_teachers").delete().eq("school_id",o).eq("user_id",t);if(e)throw e;return{success:!0}}catch(e){throw console.error("[SchoolService] Error unlinking teacher:",e),e}}async linkClass(o,t){try{const{data:e,error:r}=await s.from("classes").select("id, created_by").eq("id",t).single();if(r)throw r;if(!e)throw new Error("Turma não encontrada");const{data:u}=await s.from("school_teachers").select("user_id").eq("school_id",o).eq("user_id",e.created_by).maybeSingle();if(!u)throw new Error("O professor desta turma não está vinculado à escola");const{data:i}=await s.from("school_classes").select("class_id").eq("school_id",o).eq("class_id",t).maybeSingle();if(i)throw new Error("Turma já está vinculada a esta escola");const{error:a}=await s.from("school_classes").insert({school_id:o,class_id:t});if(a)throw a;return{success:!0}}catch(e){throw console.error("[SchoolService] Error linking class:",e),e}}async unlinkClass(o,t){try{const{error:e}=await s.from("school_classes").delete().eq("school_id",o).eq("class_id",t);if(e)throw e;return{success:!0}}catch(e){throw console.error("[SchoolService] Error unlinking class:",e),e}}async getUserSchool(o){try{const{data:t,error:e}=await s.from("schools").select("id, name, logo_url, settings").eq("id",o).single();if(e){const{data:r,error:u}=await s.from("schools").select("id, name, logo_url, settings").eq("owner_id",o).limit(1).single();return u||!r?(console.error("[SchoolService] School not found for user:",o),null):{id:r.id,name:r.name,logo:r.logo_url,settings:r.settings,adminRole:"owner"}}return{id:t.id,name:t.name,logo:t.logo_url,settings:t.settings,adminRole:"owner"}}catch(t){return console.error("[SchoolService] Error getting user school:",t),null}}async getTeacherAffiliatedSchools(o){try{const{data:t,error:e}=await s.from("school_teachers").select(`
          school_id,
          status,
          joined_at,
          schools:school_id (
            id,
            name,
            logo_url,
            status
          )
        `).eq("user_id",o).eq("status","active").eq("schools.status","active").order("joined_at",{ascending:!1});if(e)throw e;return(t||[]).map(r=>({id:r.schools.id,name:r.schools.name,logo_url:r.schools.logo_url,joined_at:r.joined_at}))}catch(t){return console.error("[SchoolService] Error getting teacher affiliated schools:",t),[]}}async isTeacherAffiliatedToSchool(o,t){try{const{data:e,error:r}=await s.from("school_teachers").select("id").eq("user_id",o).eq("school_id",t).eq("status","active").single();if(r&&r.code!=="PGRST116")throw r;return!!e}catch(e){return console.error("[SchoolService] Error checking teacher affiliation:",e),!1}}}const D=new E;export{D as s};
