import{a8 as A,r as t,j as e,L,s as D,x as H,F as V,H as q,I as z,y as O,J as N,K as k,aC as M,aD as P,aE as G,aF as J,aG as I,i as b,aH as _,C as K,U as F,t as Q,u as W,c as X,W as Y,X as Z,Y as S,B as ee,$ as E}from"./main-C_d-NeC0.js";import{g as se,a as ae,b as te}from"./apiSupabase-E2vryoq3.js";import{B as re}from"./bot-Coh_rcZj.js";import{S as ne}from"./send-fNGwogUJ.js";import{u as U}from"./use-toast-BodzLjgA.js";import{C as y}from"./classInviteService-BdN9yMpI.js";import{C as T}from"./copy-DwFnsVz6.js";import{L as ie}from"./link-BAoktm1Z.js";import{T as oe}from"./trash-2-Uw5FyWrJ.js";import{f as ce}from"./formatDistanceToNow-BxKHLmYO.js";import{f as le}from"./format-BmB7BMvl.js";import{p as de}from"./pt-BR-CVz3wboC.js";import"./constructNow-BUe0KqNa.js";import"./toDate-B_SDEMqy.js";import"./en-US-C1KUdeex.js";import"./endOfMonth-5f4-gZt5.js";const me=()=>{const{classId:r}=A(),[d,o]=t.useState([]),[u,c]=t.useState(!0),[x,l]=t.useState("");return t.useEffect(()=>{r&&(async()=>{c(!0),l("");try{const m=await se(r);o(m)}catch(m){l("Erro ao carregar atividades. Tente novamente."),console.error("Erro ao carregar atividades:",m)}finally{c(!1)}})()},[r]),u?e.jsx(L,{}):x?e.jsx("p",{className:"text-red-500 text-center",children:x}):e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("h1",{className:"text-3xl font-bold mb-4",children:"Atividades da Turma"}),d.length===0?e.jsx("p",{className:"text-gray-500 text-center",children:"Nenhuma atividade disponível."}):e.jsx("div",{className:"space-y-4",children:d.map(a=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:a.title}),e.jsx("p",{className:"text-gray-600 mb-4",children:a.description||"Sem descrição"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Criado em: ",new Date(a.created_at).toLocaleDateString()]}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700",onClick:()=>{},children:"Ver atividade"})]})]},a.id))})]})};async function ue({classId:r,question:d}){try{const{data:o,error:u}=await D.functions.invoke("chatgpt-assistant",{body:{classId:r,question:d}});return u?(console.error("AI Service Error:",u),{answer:"Desculpe, o assistente IA está temporariamente indisponível. Tente novamente em alguns minutos.",error:!0}):o}catch(o){return console.error("AI Service Error:",o),{answer:"Desculpe, o assistente IA está temporariamente indisponível. Tente novamente em alguns minutos.",error:!0}}}function xe({classId:r}){const[d,o]=t.useState(""),[u,c]=t.useState(!1),[x,l]=t.useState([]),[a,m]=t.useState(""),g=async h=>{if(h.preventDefault(),!d.trim())return;m(""),c(!0);const p=d.trim();o("");try{const i=await ue({classId:r,question:p});l(n=>[...n,{role:"user",content:p},{role:"assistant",content:i?.answer||"Sem resposta"}])}catch(i){m(i?.message||"Falha ao obter resposta")}finally{c(!1)}};return e.jsxs("div",{className:"border rounded-lg p-4 bg-card",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(re,{className:"w-5 h-5"}),e.jsx("h3",{className:"font-semibold",children:"Assistente IA da Turma"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Contexto atrelado à turma. A IA responde com base nos materiais e atividades desta turma."}),e.jsxs("div",{className:"space-y-2 max-h-64 overflow-auto border rounded p-2 bg-background",children:[x.length===0&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sem mensagens. Faça sua primeira pergunta."}),x.map((h,p)=>e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium mr-1",children:h.role==="user"?"Você:":"IA:"}),h.content]},p))]}),e.jsxs("form",{onSubmit:g,className:"mt-3 flex items-center gap-2",children:[e.jsx("input",{className:"flex-1 border rounded-md px-3 py-2 text-sm bg-background",placeholder:"Pergunte algo sobre esta turma...",value:d,onChange:h=>o(h.target.value),disabled:u}),e.jsxs("button",{type:"submit",className:"inline-flex items-center gap-1 px-3 py-2 text-sm rounded-md border hover:bg-muted",disabled:u,children:[e.jsx(ne,{className:"w-4 h-4"}),"Enviar"]})]}),a&&e.jsx("div",{className:"text-xs text-red-600 mt-2",children:a})]})}function he(r){const[d,o]=t.useState([]),[u,c]=t.useState(!1),[x,l]=t.useState(null),{toast:a}=U(),m=t.useCallback(async()=>{if(r){c(!0),l(null);try{const i=await y.getInvitesByClass(r);o(i||[])}catch(i){console.error("Error fetching invites:",i),l(i.message),a({variant:"destructive",title:"Erro ao carregar convites",description:"Não foi possível carregar os links de convite. Tente novamente."})}finally{c(!1)}}},[r,a]),g=t.useCallback(async(i={})=>{if(!r)return null;c(!0),l(null);try{const n=await y.createInvite(r,i);return await m(),a({title:"Link de convite criado",description:"O link foi gerado com sucesso!"}),n}catch(n){throw console.error("Error creating invite:",n),l(n.message),a({variant:"destructive",title:"Erro ao criar convite",description:n.message||"Não foi possível criar o link de convite."}),n}finally{c(!1)}},[r,m,a]),h=t.useCallback(async i=>{if(!i)return!1;c(!0),l(null);try{return await y.revokeInvite(i),o(n=>n.filter(v=>v.id!==i)),a({title:"Convite revogado",description:"O link de convite foi desativado com sucesso."}),!0}catch(n){return console.error("Error revoking invite:",n),l(n.message),a({variant:"destructive",title:"Erro ao revogar convite",description:"Não foi possível revogar o link de convite."}),!1}finally{c(!1)}},[a]),p=t.useCallback(async i=>{if(!i)return{success:!1,error:"Token inválido"};c(!0),l(null);try{const{data:{user:n}}=await D.auth.getUser();if(!n)throw new Error("Usuário não autenticado");const v=await y.acceptInvite(i,n.id);return v.success&&a({title:"Inscrição realizada",description:v.alreadyEnrolled?"Você já está inscrito nesta turma.":"Você foi inscrito na turma com sucesso!"}),v}catch(n){throw console.error("Error using invite:",n),l(n.message),a({variant:"destructive",title:"Erro ao usar convite",description:n.message||"Não foi possível aceitar o convite."}),n}finally{c(!1)}},[a]);return{invites:d,isLoading:u,error:x,fetchInvites:m,createInvite:g,revokeInvite:h,useInvite:p}}const pe=({classId:r,className:d})=>{const{toast:o}=U(),[u,c]=t.useState(7),[x,l]=t.useState(10),[a,m]=t.useState(null),[g,h]=t.useState("student"),{invites:p,isLoading:i,createInvite:n,revokeInvite:v,fetchInvites:f}=he(r);t.useEffect(()=>{r&&f()},[r,f]);const w=async()=>{try{await n({maxUses:parseInt(x,10)||10,expiresInHours:(parseInt(u,10)||7)*24,role:g})}catch(s){console.error("Error creating invite:",s)}},C=s=>{const j=`${window.location.origin}/join/${s}`;navigator.clipboard.writeText(j),m(s),setTimeout(()=>m(null),2e3),o({title:"Link copiado!",description:"O link de convite foi copiado para a área de transferência."})},R=s=>{navigator.clipboard.writeText(s),o({title:"Código copiado!",description:"O código de convite foi copiado para a área de transferência."})},$=async s=>{window.confirm("Tem certeza que deseja revogar este convite? Esta ação não pode ser desfeita.")&&await v(s)},B=s=>{if(!s)return"Não expira";const j=new Date(s);return j<new Date?"Expirado":`Expira em ${le(j,"dd/MM/yyyy HH:mm")} (${ce(j,{addSuffix:!0,locale:de})})`};return e.jsxs(H,{className:d,children:[e.jsxs(V,{children:[e.jsx(q,{children:"Convites para a turma"}),e.jsx(z,{children:"Crie links de convite para que alunos possam se juntar a esta turma sem necessidade de aprovação."})]}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:"Criar novo convite"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"expiration",children:"Dias até expirar"}),e.jsx(k,{id:"expiration",type:"number",min:"1",value:u,onChange:s=>c(s.target.value),className:"max-w-[200px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{htmlFor:"maxUses",children:"Número máximo de usos"}),e.jsx(k,{id:"maxUses",type:"number",min:"1",value:x,onChange:s=>l(s.target.value),className:"max-w-[200px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(N,{children:"Role"}),e.jsxs(M,{value:g,onValueChange:h,children:[e.jsx(P,{className:"max-w-[220px]",children:e.jsx(G,{placeholder:"Selecione o papel"})}),e.jsxs(J,{children:[e.jsx(I,{value:"student",children:"Student"}),e.jsx(I,{value:"teacher",children:"Teacher"})]})]})]})]}),e.jsx(b,{onClick:w,disabled:i,className:"mt-2",children:i?e.jsxs(e.Fragment,{children:[e.jsx(_,{className:"mr-2 h-4 w-4 animate-spin"}),"Criando..."]}):"Gerar link de convite"})]}),p.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:"Links ativos"}),e.jsx("div",{className:"space-y-3",children:p.map(s=>e.jsx("div",{className:"border rounded-lg p-4 space-y-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1 min-w-0",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{className:"text-xs text-muted-foreground",children:"Código do convite"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-lg font-bold tracking-wider",children:s.invitation_code}),e.jsx(b,{variant:"ghost",size:"sm",onClick:()=>R(s.invitation_code),children:e.jsx(T,{className:"h-3.5 w-3.5"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(N,{className:"text-xs text-muted-foreground",children:"Link do convite"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"font-mono text-sm truncate text-muted-foreground",children:`${window.location.origin}/join/${s.invitation_code}`})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-muted-foreground pt-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(K,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:B(s.expires_at)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(F,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[s.current_uses||0," de ",s.max_uses," usos"]})]}),s.role&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-blue-50 text-blue-700 text-xs",children:s.role==="student"?"Aluno":"Professor"})}),s.status&&s.status!=="active"&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-red-50 text-red-700 text-xs",children:s.status==="cancelled"?"Cancelado":s.status==="expired"?"Expirado":s.status==="depleted"?"Esgotado":s.status})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(b,{variant:"outline",size:"sm",onClick:()=>C(s.invitation_code),disabled:a===s.invitation_code,children:a===s.invitation_code?e.jsxs(e.Fragment,{children:[e.jsx(Q,{className:"mr-2 h-4 w-4"}),"Copiado!"]}):e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"mr-2 h-4 w-4"}),"Copiar Link"]})}),e.jsx(b,{variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive",onClick:()=>$(s.id),disabled:i||s.status!=="active",children:e.jsx(oe,{className:"h-4 w-4"})})]})]})},s.id))})]})]})})]})},_e=()=>{const{classId:r}=A(),{user:d}=W(),[o,u]=t.useState(null),[c,x]=t.useState(!0),[l,a]=t.useState(""),[m,g]=t.useState(!1),[h,p]=t.useState([]),[i,n]=t.useState(!1),v=t.useCallback(async()=>{if(!r){console.error("No classId provided"),a("ID da turma não fornecido"),x(!1);return}if(!d){console.error("No user found in auth context"),a("Usuário não autenticado"),x(!1);return}try{a(""),console.log("Fetching class details for classId:",r);const f=await ae(r);if(console.log("Class details:",f),!f)throw new Error("Turma não encontrada");const w=f.created_by===d.id;g(w),u(f);const C=await te(r);p(C||[])}catch(f){console.error("Error fetching class details:",f),a(f.message||"Erro ao carregar os detalhes da turma"),x(!1)}},[r,d]);return t.useEffect(()=>{v()},[v]),c?e.jsxs("div",{className:"flex items-center justify-center min-h-[60vh]",children:[e.jsx(L,{}),e.jsx("span",{className:"ml-2",children:"Carregando detalhes da turma..."})]}):l?e.jsx("div",{className:"container mx-auto p-4",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(X,{className:"w-5 h-5 mr-2 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:"Erro ao carregar a turma"})]}),e.jsx("p",{className:"mt-2 text-sm",children:l}),e.jsxs("button",{onClick:v,className:"mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(_,{className:`w-4 h-4 mr-2 ${i?"animate-spin":""}`}),"Tentar novamente"]})]})}):o?e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:o.name}),o.description&&e.jsx("p",{className:"text-gray-600 mt-2",children:o.description})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsxs(Y,{defaultValue:"activities",className:"space-y-6",children:[e.jsxs(Z,{className:"grid w-full grid-cols-2",children:[e.jsxs(S,{value:"activities",children:[e.jsx(ee,{className:"w-4 h-4 mr-2"}),"Atividades"]}),e.jsxs(S,{value:"students",children:[e.jsx(F,{className:"w-4 h-4 mr-2"}),"Alunos"]})]}),e.jsx(E,{value:"activities",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"Atividades da Turma"}),e.jsx(me,{classId:r,isTeacher:m})]})}),m&&e.jsx(E,{value:"invites",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"Gerenciar Convites"}),e.jsx(pe,{classId:r})]})})]})}),e.jsx("div",{className:"space-y-6",children:e.jsx(xe,{classId:r})})]})]}):e.jsx("div",{className:"container mx-auto p-4 text-center",children:e.jsx("p",{className:"text-gray-600",children:"Turma não encontrada."})})};export{_e as default};
