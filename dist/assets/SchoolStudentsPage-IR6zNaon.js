import{u as le,g as ne,r as n,z as oe,s as C,j as e,o as ce,U as de,e as me,k as B,A as ue,a1 as xe,a2 as ge,aA as D,aB as L,aC as I,aD as k,aE as d,m as fe,B as he,d as ve,C as pe,w as je,T as Ne}from"./main-Bujpyeg-.js";import{s as _}from"./schoolService-DcalQc3H.js";import{S as x,P as M}from"./PremiumCard-BaDWg06v.js";import{P as R}from"./PremiumButton-skKgx_xy.js";import{E as we}from"./EmptyState-CpVlA95H.js";import{B as g}from"./badge-BFkPUQ-P.js";import{D as Ae}from"./download-EGp6uXz0.js";import{T as U}from"./triangle-alert-Cw-mO2fL.js";import{G as Se}from"./graduation-cap-Ch-mLRIV.js";import{T as be}from"./trending-down-DPq5oMKG.js";const Ie=()=>{const{user:N}=le(),F=ne(),[q,G]=n.useState(!0),[o,E]=n.useState([]),[w,V]=n.useState([]),[f,z]=n.useState(""),[p,O]=n.useState("all"),[c,$]=n.useState("all"),[W,H]=n.useState([]),[m,J]=n.useState({total:0,active:0,inactive:0,averageGrade:0,topPerformers:0,needsAttention:0});n.useEffect(()=>{N&&K()},[N]),n.useEffect(()=>{Z()},[o,f,p,c]);const K=async()=>{try{G(!0);const s=await _.getUserSchool(N.id);if(!s?.id)throw new Error("Nenhuma escola associada ao usuário");await Promise.all([X(s.id),Q(s.id),Y()])}catch(s){console.error("Erro ao carregar dados:",s),oe.error("Erro ao carregar dados dos alunos")}finally{G(!1)}},Q=async s=>{try{const i=(await _.getClasses(s)||[]).map(r=>({id:r.id,name:r.name,subject:r.subject}));H(i)}catch(a){console.error("Erro ao carregar turmas:",a)}},X=async s=>{try{const i=(await _.getClasses(s)||[]).map(t=>t.id);if(!i||i.length===0){E([]);return}const{data:r,error:j}=await C.from("class_members").select(`
          user_id,
          class_id,
          joined_at,
          role,
          classes (
            id,
            name,
            subject
          ),
          profiles:user_id (
            id,
            full_name,
            avatar_url,
            created_at
          )
        `).in("class_id",i).eq("role","student");if(j)throw j;const A=await Promise.all((r||[]).map(async t=>{const S=t.user_id,{data:h}=await C.from("submissions").select("grade, submitted_at, activity_id, activities(max_score)").eq("student_id",S).not("grade","is",null),u=h?.map(l=>l.grade)||[],te=u.length>0?u.reduce((l,v)=>l+v,0)/u.length:0,b=u.slice(-3),y=u.slice(-6,-3),P=b.length>0?b.reduce((l,v)=>l+v,0)/b.length:0,T=y.length>0?y.reduce((l,v)=>l+v,0)/y.length:0,re=P>T?"up":P<T?"down":"stable",{count:ie}=await C.from("activity_class_assignments").select("activity_id",{count:"exact",head:!0}).eq("class_id",t.class_id).not("activity_id","in",`(${h?.map(l=>l.activity_id).join(",")||"0"})`);return{id:t.user_id,name:t.profiles?.full_name||"Aluno",avatar:t.profiles?.avatar_url,class:t.classes,joinedAt:t.joined_at,createdAt:t.profiles?.created_at,averageGrade:Math.round(te*10)/10,totalSubmissions:h?.length||0,pendingActivities:ie||0,trend:re,isActive:u.length>0,lastActivity:h?.length>0?new Date(Math.max(...h.map(l=>new Date(l.submitted_at)))):null}}));E(A)}catch(a){throw console.error("Erro ao carregar alunos:",a),a}},Y=async()=>{};n.useEffect(()=>{if(o.length>0){const s=o.length,a=o.filter(t=>t.isActive).length,i=s-a,r=o.reduce((t,S)=>t+S.averageGrade,0)/s,j=o.filter(t=>t.averageGrade>=8).length,A=o.filter(t=>t.averageGrade<6||t.pendingActivities>3).length;J({total:s,active:a,inactive:i,averageGrade:Math.round(r*10)/10,topPerformers:j,needsAttention:A})}},[o]);const Z=()=>{let s=[...o];f&&(s=s.filter(a=>a.name.toLowerCase().includes(f.toLowerCase())||a.class?.name.toLowerCase().includes(f.toLowerCase()))),p!=="all"&&(s=s.filter(a=>a.class?.id===p)),c!=="all"&&(c==="active"?s=s.filter(a=>a.isActive):c==="inactive"?s=s.filter(a=>!a.isActive):c==="top"?s=s.filter(a=>a.averageGrade>=8):c==="attention"&&(s=s.filter(a=>a.averageGrade<6||a.pendingActivities>3))),V(s)},ee=()=>{const s=[["Nome","Turma","Média","Submissões","Pendentes","Status","Último Acesso"].join(","),...w.map(r=>[r.name,r.class?.name||"",r.averageGrade,r.totalSubmissions,r.pendingActivities,r.isActive?"Ativo":"Inativo",r.lastActivity?r.lastActivity.toLocaleDateString("pt-BR"):"Nunca"].join(","))].join(`
`),a=new Blob([s],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a");i.href=URL.createObjectURL(a),i.download=`alunos_escola_${new Date().toISOString().split("T")[0]}.csv`,i.click()},se=s=>{switch(s){case"up":return e.jsx(Ne,{className:"w-4 h-4 text-green-500"});case"down":return e.jsx(be,{className:"w-4 h-4 text-red-500"});default:return e.jsx(B,{className:"w-4 h-4 text-gray-500"})}},ae=s=>s>=9?e.jsx(g,{className:"bg-green-100 text-green-700",children:"Excelente"}):s>=8?e.jsx(g,{className:"bg-blue-100 text-blue-700",children:"Muito Bom"}):s>=7?e.jsx(g,{className:"bg-yellow-100 text-yellow-700",children:"Bom"}):s>=6?e.jsx(g,{className:"bg-orange-100 text-orange-700",children:"Regular"}):e.jsx(g,{className:"bg-red-100 text-red-700",children:"Precisa Atenção"});return q?e.jsx(ce,{}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:"Alunos da Escola"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Gerencie e acompanhe o desempenho dos alunos"})]}),e.jsx("div",{className:"flex gap-3",children:e.jsx(R,{onClick:ee,variant:"outline",leftIcon:Ae,children:"Exportar"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4",children:[e.jsx(x,{title:"Total de Alunos",value:m.total,icon:de,gradient:"from-blue-500 to-cyan-500"}),e.jsx(x,{title:"Alunos Ativos",value:m.active,icon:me,gradient:"from-green-500 to-emerald-500"}),e.jsx(x,{title:"Inativos",value:m.inactive,icon:U,gradient:"from-orange-500 to-red-500"}),e.jsx(x,{title:"Média Geral",value:m.averageGrade,icon:B,gradient:"from-purple-500 to-pink-500"}),e.jsx(x,{title:"Top Performers",value:m.topPerformers,icon:ue,gradient:"from-yellow-500 to-orange-500"}),e.jsx(x,{title:"Precisam Atenção",value:m.needsAttention,icon:U,gradient:"from-red-500 to-pink-500"})]}),e.jsx(M,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(ge,{placeholder:"Buscar por nome ou turma...",value:f,onChange:s=>z(s.target.value),className:"pl-10"})]})}),e.jsxs(D,{value:p,onValueChange:O,children:[e.jsx(L,{className:"w-full md:w-48",children:e.jsx(I,{placeholder:"Filtrar por turma"})}),e.jsxs(k,{children:[e.jsx(d,{value:"all",children:"Todas as turmas"}),W.map(s=>e.jsx(d,{value:s.id,children:s.name},s.id))]})]}),e.jsxs(D,{value:c,onValueChange:$,children:[e.jsx(L,{className:"w-full md:w-48",children:e.jsx(I,{placeholder:"Filtrar por status"})}),e.jsxs(k,{children:[e.jsx(d,{value:"all",children:"Todos os status"}),e.jsx(d,{value:"active",children:"Ativos"}),e.jsx(d,{value:"inactive",children:"Inativos"}),e.jsx(d,{value:"top",children:"Top Performers"}),e.jsx(d,{value:"attention",children:"Precisam Atenção"})]})]})]})}),e.jsx(M,{className:"p-6",children:w.length===0?e.jsx(we,{icon:Se,title:"Nenhum aluno encontrado",description:"Não há alunos que correspondam aos filtros selecionados."}):e.jsx("div",{className:"space-y-4",children:w.map(s=>e.jsxs(fe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex items-center justify-between p-4 border border-border rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-white font-bold",children:s.avatar?e.jsx("img",{src:s.avatar,alt:s.name,className:"w-full h-full rounded-full object-cover"}):s.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:s.name}),se(s.trend)]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(he,{className:"w-4 h-4"}),s.class?.name||"Sem turma"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ve,{className:"w-4 h-4"}),"Entrou em ",new Date(s.joinedAt).toLocaleDateString("pt-BR")]}),s.lastActivity&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),"Último acesso: ",s.lastActivity.toLocaleDateString("pt-BR")]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:s.averageGrade}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Média"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold",children:s.totalSubmissions}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Submissões"})]}),s.pendingActivities>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-orange-600",children:s.pendingActivities}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Pendentes"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[ae(s.averageGrade),e.jsx(g,{className:s.isActive?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700",children:s.isActive?"Ativo":"Inativo"})]}),e.jsx(R,{size:"sm",variant:"outline",leftIcon:je,onClick:()=>F(`/students/${s.id}`),children:"Ver Perfil"})]})]},s.id))})})]})};export{Ie as default};
