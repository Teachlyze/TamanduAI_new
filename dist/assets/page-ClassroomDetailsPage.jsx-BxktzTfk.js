import{r as w,j as e}from"./react-vendor-C2HUFn5N.js";import{a as P}from"./page-ActivitiesListPage.jsx-Cv5lq7oV.js";import{L as D,T as U,B as i,C as y,D as m,S as T,a as x,b as L,c as g,s as p}from"./antd-vendor-K_53YjeB.js";import{b as F,a as R,u as _}from"./vendor-react-router-B4Bn0PSh.js";const B="https://api.agora.io",O="na",z="0445e9f0ca784deeb2cdfa15817a74cc",k="https://your-project.supabase.co/functions/v1/generate-agora-token";let u=null,E=0;async function G(){console.log("[Agora] Fetching new education token...");try{console.log(`[Agora] Making request to token service: ${k}`);const s=await fetch(k,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer your-anon-key-here"},body:JSON.stringify({})});if(console.log(`[Agora] Token service response status: ${s.status}`),!s.ok){let o=`HTTP error! status: ${s.status}`;try{const c=await s.json();console.error("[Agora] Token service error response:",c),o=c.error||o}catch{const t=await s.text();console.error("[Agora] Failed to parse error response:",t)}throw new Error(`Failed to fetch education token: ${o}`)}const r=await s.json();if(console.log("[Agora] Token service response data:",r),!r.success)throw new Error(r.error||"Invalid response from token service: success flag is false");if(!r.token)throw new Error("No token received from the token service");return u=r.token,E=Date.now()+3600*1e3,console.log("[Agora] Successfully obtained and cached education token"),u}catch(s){throw console.error("[Agora] Error in fetchEducationToken:",{message:s.message,stack:s.stack,url:k,envVars:{hasSupabaseUrl:!0,hasAnonKey:!0}}),s.message.includes("Failed to fetch")?new Error("Network error: Could not connect to the authentication service. Please check your internet connection."):new Error(`Could not authenticate with the classroom service: ${s.message}`)}}async function M(){return u&&Date.now()<E?u:await G()}const S=async(s,r="GET",o=null)=>{const c=await M(),t=`${B}/${O}/edu/apps/${z}${s}`,f={"Content-Type":"application/json;charset=UTF-8",Authorization:`agora token=${c}`},l={method:r,headers:f};o&&(l.body=JSON.stringify(o));try{const n=await fetch(t,l),d=await n.json();if(!n.ok||d.code!==0)throw new Error(d.msg||`HTTP error! status: ${n.status}`);return d}catch(n){if(console.error(`Agora API call failed: ${n.message}`),n.message.includes("token")||n.message.includes("401"))return console.log("Token may be expired, attempting to refresh..."),u=null,S(s,r,o);throw n}},V=async(s,r)=>{const o=`/v2/rooms/${s}/states/${r}`;return S(o,"PUT")},{Content:v}=D,{Title:C,Paragraph:A}=U,Q=()=>{const{roomUuid:s}=F(),r=R(),o=_(),{classroom:c}=r.state||{},[t,f]=w.useState(c),[l,n]=w.useState(!1),{activities:d,loading:$}=P();if(!t)return e.jsxs(v,{className:"p-8",children:[e.jsx(C,{level:2,children:"Classroom Not Found"}),e.jsx(A,{children:"The classroom details could not be loaded. Please return to the classrooms list."}),e.jsx(i,{onClick:()=>o("/classrooms"),children:"Go to Classrooms"})]});const j=async a=>{n(!0);try{await V(s,a);const h=a===1?"started":"ended";p.success(`Classroom successfully ${h}.`),f(N=>({...N,state:a}))}catch(h){p.error(`Failed to update classroom state: ${h.message}`)}finally{n(!1)}},b=a=>{switch(a){case 0:return e.jsx(g,{color:"default",children:"Not Started"});case 1:return e.jsx(g,{color:"success",children:"In Progress"});case 2:return e.jsx(g,{color:"error",children:"Ended"});default:return e.jsx(g,{children:"Unknown"})}},I=async a=>{try{await deleteActivity(a),p.success("Atividade deletada com sucesso!")}catch{p.error("Erro ao deletar atividade")}};return e.jsxs(v,{className:"p-4 md:p-8",children:[e.jsx(C,{level:2,children:t.roomName}),e.jsx(A,{children:"Gerencie o estado da sala e visualize os detalhes e atividades abaixo."}),e.jsxs(y,{children:[e.jsxs(m,{bordered:!0,column:1,children:[e.jsx(m.Item,{label:"Status",children:b(t.state)}),e.jsx(m.Item,{label:"Room UUID",children:t.roomUuid}),e.jsx(m.Item,{label:"Room Type",children:t.roomType})]}),e.jsxs(T,{className:"mt-6",children:[e.jsx(i,{type:"primary",onClick:()=>j(1),loading:l,disabled:t.state===1||t.state===2,children:"Start Class"}),e.jsx(i,{danger:!0,onClick:()=>j(2),loading:l,disabled:t.state===2,children:"End Class"}),e.jsx(i,{onClick:()=>o(`/atividades/criar?classId=${t.roomUuid}`),children:"Criar Atividade"})]})]}),e.jsx(y,{title:"Atividades da Turma",className:"mt-6",children:$?e.jsx("p",{children:"Carregando atividades..."}):e.jsx(x,{dataSource:d,renderItem:a=>e.jsxs(x.Item,{children:[e.jsx(x.Item.Meta,{title:a.title,description:a.description,avatar:e.jsx(L,{status:"success",text:new Date(a.created_at).toLocaleDateString()})}),e.jsxs(T,{children:[e.jsx(i,{type:"link",onClick:()=>o(`/atividades/${a.id}`),children:"Ver Detalhes"}),t.state===1&&e.jsx(i,{type:"link",onClick:()=>{window.confirm("Tem certeza que deseja deletar esta atividade?")&&I(a.id)},children:"Deletar"})]})]})})})]})};export{Q as default};
