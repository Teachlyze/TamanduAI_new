import{s as m,bF as T,bG as B,a8 as z,g as L,u as U,r as p,z as h,j as e,o as W,a4 as N,n as O,A as V,p as K}from"./main-C_d-NeC0.js";import{P as x}from"./PremiumCard-BmbTLnXK.js";import{P as v}from"./PremiumButton-BXe4rVF6.js";import{E as D}from"./EmptyState-CnYYu1LP.js";import{B as J}from"./Breadcrumb-CGh_tfJR.js";import{A as M}from"./arrow-left-CU0Dph18.js";import{D as X}from"./download-ChS8io6K.js";import{C as H}from"./circle-check-big-CgP05W4G.js";import{T as $}from"./triangle-alert-OXKAA0WJ.js";import{S as Q}from"./save-CorMfGp8.js";import{S as Y}from"./send-fNGwogUJ.js";const Z=async(c,a)=>{try{const{data:s,error:i}=await m.functions.invoke("plagiarism-check-v2",{body:{text:c,submissionId:a,useCache:!0}});if(i)throw console.error("Erro na Edge Function plagiarism-check-v2:",i),i;return s}catch(s){throw console.error("Erro ao chamar Edge Function de plágio:",s),s}},ee=async c=>{try{const{data:a,error:s}=await m.functions.invoke("plagiarism-check-cached",{body:{submissionId:c}});return s?(console.error("Erro ao buscar cache:",s),null):a}catch(a){return console.error("Erro ao buscar cache de plágio:",a),null}},re=async(c,a)=>{try{const{data:s,error:i}=await m.from("plagiarism_checks").insert({submission_id:c,plagiarism_percentage:a.plagiarismPercentage||0,ai_generated:a.isAiGenerated||!1,ai_score:a.aiScore||0,sources:a.sources||[],raw_data:a.rawData||{}}).select().single();if(i)throw console.error("Erro ao salvar resultado:",i),i;return s}catch(s){throw console.error("Erro ao salvar resultado de plágio:",s),s}};class ae{constructor(){this.apiKey=void 0,this.apiUrl="https://api.gowinston.ai/v1/plagiarism",this.useEdgeFunctions=!0}async checkPlagiarism(a,s,i=null,d=null){try{const n=s||i;if(this.useEdgeFunctions&&n){const t=await ee(n);if(t)return console.log("✅ Resultado de plágio encontrado em cache"),{success:!0,percentage:t.plagiarism_percentage,aiGenerated:t.ai_generated,aiScore:t.ai_score,sources:t.sources,status:this.getStatus(t.plagiarism_percentage),cached:!0}}let o;if(this.useEdgeFunctions&&n)console.log("🔄 Usando Edge Function para verificação de plágio..."),o=await Z(a,n);else{console.log("🔄 Usando API WinstonAI diretamente...");const t=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({text:a,language:"pt",check_internet:!0,check_database:!0})});if(!t.ok)throw new Error(`WinstonAI API Error: ${t.status}`);o=await t.json()}n&&await re(n,{plagiarismPercentage:o.plagiarism_score||o.plagiarismPercentage||0,isAiGenerated:o.ai_generated||o.isAiGenerated||!1,aiScore:o.ai_score||o.aiScore||0,sources:o.sources||[],rawData:o});const l=o.plagiarism_score||o.plagiarismPercentage||0,u=o.ai_score||o.aiScore||0;return l>=50&&i&&d&&await this.notifyTeacher(i,d,l,u),{success:!0,percentage:l,aiGenerated:o.ai_generated||o.isAiGenerated||!1,aiScore:u,sources:o.sources||[],status:this.getStatus(l),report:o,cached:!1}}catch(n){return console.error("Erro ao verificar plágio:",n),{success:!1,error:n.message,percentage:0,sources:[]}}}async savePlagiarismReport(a){try{const{error:s}=await m.from("plagiarism_reports").insert([a]);if(s)throw s}catch(s){console.error("Erro ao salvar relatório:",s)}}async notifyTeacher(a,s,i,d=0){try{const[n,o]=await Promise.all([m.from("activities").select("title, created_by").eq("id",a).single(),m.from("profiles").select("full_name").eq("id",s).single()]),l=n.data,u=o.data;if(!l||!u)return;this.useEdgeFunctions?(i>=50&&await T(l.created_by,u.full_name,l.title,i),d>=70&&await B(l.created_by,u.full_name,l.title,d)):await m.from("notifications").insert([{user_id:l.created_by,type:"plagiarism_alert",title:"⚠️ Plágio Detectado",message:`${i}% de plágio detectado na submissão de ${u.full_name} para "${l.title}"`,data:{activityId:a,studentId:s,percentage:i,aiScore:d}}])}catch(n){console.error("Erro ao notificar professor:",n)}}getStatus(a){return a>=70?"high":a>=50?"medium":a>=30?"low":"clean"}async getReports(a,s){try{const{data:i,error:d}=await m.from("plagiarism_reports").select("*").eq("activity_id",a).eq("student_id",s).order("checked_at",{ascending:!1});if(d)throw d;return i||[]}catch(i){return console.error("Erro ao buscar relatórios:",i),[]}}async isAlreadyChecked(a,s){return(await this.getReports(a,s)).length>0}async recheckPlagiarism(a,s,i){return await this.checkPlagiarism(a,s,i)}}const se=new ae,pe=()=>{const{activityId:c}=z(),a=L(),{user:s}=U(),[i,d]=p.useState(!0),[n,o]=p.useState(null),[l,u]=p.useState([]),[t,G]=p.useState(null),[f,w]=p.useState(""),[y,_]=p.useState(""),[k,A]=p.useState(!1);p.useEffect(()=>{c&&s&&j()},[c,s]);const j=async()=>{try{d(!0);const{data:r,error:g}=await m.from("activities").select("*").eq("id",c).single();if(g)throw g;o(r);const{data:P,error:C}=await m.from("submissions").select(`
          *,
          student:profiles!student_id(id, full_name, email, avatar_url),
          plagiarism_reports(*)
        `).eq("activity_id",c).order("submitted_at",{ascending:!1});if(C)throw C;u(P||[]);const F=P?.find(q=>!q.grade);F&&S(F)}catch(r){console.error("Erro ao carregar:",r),h.error("Erro ao carregar correções")}finally{d(!1)}},S=r=>{G(r),w(r.grade||""),_(r.feedback||"")},E=async(r=!1)=>{if(t)try{A(!0);const{error:g}=await m.from("submissions").update({grade:parseFloat(f)||null,feedback:y||null,corrected_at:new Date().toISOString(),corrected_by:s.id}).eq("id",t.id);if(g)throw g;r&&await m.from("notifications").insert([{user_id:t.student_id,type:"grade",title:"Nova Nota Disponível",message:`Sua nota para "${n.title}" foi publicada: ${f}`,link:`/dashboard/activities/${c}`}]),h.success(r?"Correção salva e aluno notificado":"Correção salva"),j()}catch(g){console.error("Erro ao salvar correção:",g),h.error("Erro ao salvar correção")}finally{A(!1)}},I=async()=>{if(t)try{h.loading("Verificando plágio...",{id:"plagiarism"});const r=await se.checkPlagiarism(t.content,c,t.student_id);h.dismiss("plagiarism"),r.success?(h.success(`Plágio verificado: ${r.percentage}%`),j()):h.error("Erro na verificação de plágio")}catch{h.dismiss("plagiarism"),h.error("Erro ao verificar plágio")}},b={total:l.length,corrected:l.filter(r=>r.grade!==null).length,pending:l.filter(r=>r.grade===null).length,averageGrade:l.filter(r=>r.grade).reduce((r,g)=>r+g.grade,0)/l.filter(r=>r.grade).length||0};if(i)return e.jsx(W,{message:"Carregando correções..."});if(!n)return e.jsx(D,{icon:N,title:"Atividade não encontrada",description:"A atividade que você está procurando não existe.",actionLabel:"Voltar para Atividades",onAction:()=>a("/dashboard/activities")});const R=[{label:"Atividades",path:"/dashboard/activities"},{label:n.title,path:`/dashboard/activities/${c}`},{label:"Correções",path:`/dashboard/activities/${c}/corrections`}];return e.jsxs("div",{className:"space-y-6",children:[e.jsx(J,{items:R}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("button",{onClick:()=>a("/dashboard/activities"),className:"p-2 rounded-lg hover:bg-muted",children:e.jsx(M,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-3xl font-bold",children:"Correção de Atividades"})]}),e.jsx("p",{className:"text-muted-foreground",children:n.title})]}),e.jsx(v,{variant:"outline",leftIcon:X,children:"Exportar Notas"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(x,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg",children:e.jsx(N,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:b.total}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Submissões"})]})]})}),e.jsx(x,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-green-100 dark:bg-green-900/30 rounded-lg",children:e.jsx(H,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:b.corrected}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Corrigidas"})]})]})}),e.jsx(x,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg",children:e.jsx(O,{className:"w-6 h-6 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:b.pending}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pendentes"})]})]})}),e.jsx(x,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg",children:e.jsx(V,{className:"w-6 h-6 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:b.averageGrade.toFixed(1)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Média Geral"})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(x,{variant:"elevated",children:[e.jsx("div",{className:"p-4 border-b border-border",children:e.jsxs("h3",{className:"font-bold",children:["Submissões (",l.length,")"]})}),e.jsx("div",{className:"max-h-[600px] overflow-y-auto",children:l.length===0?e.jsx("div",{className:"p-8 text-center text-muted-foreground",children:"Nenhuma submissão ainda"}):l.map(r=>e.jsx("button",{onClick:()=>S(r),className:`w-full p-4 border-b border-border hover:bg-muted/50 transition-colors text-left ${t?.id===r.id?"bg-primary/10":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold flex-shrink-0",children:r.student?.full_name?.charAt(0)||"A"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:r.student?.full_name||"Aluno"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(r.submitted_at).toLocaleString("pt-BR")}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[r.grade!==null?e.jsxs("span",{className:"px-2 py-1 text-xs rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300",children:["Nota: ",r.grade]}):e.jsx("span",{className:"px-2 py-1 text-xs rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:"Pendente"}),r.plagiarism_reports?.length>0&&e.jsxs("span",{className:"px-2 py-1 text-xs rounded-full bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300",children:["⚠️ ",r.plagiarism_reports[0].plagiarism_percentage,"%"]})]})]})]})},r.id))})]})}),e.jsx("div",{className:"lg:col-span-2",children:t?e.jsx(x,{variant:"elevated",className:"p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold",children:t.student?.full_name?.charAt(0)||"A"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:t.student?.full_name||"Aluno"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.student?.email})]})]}),e.jsx(v,{variant:"outline",size:"sm",leftIcon:$,onClick:I,children:"Verificar Plágio"})]}),t.plagiarism_reports?.length>0&&e.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx($,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-bold text-red-900 dark:text-red-100",children:["Plágio Detectado: ",t.plagiarism_reports[0].plagiarism_percentage,"%"]}),e.jsxs("p",{className:"text-sm text-red-800 dark:text-red-200 mt-1",children:["Fontes: ",t.plagiarism_reports[0].sources?.length||0," encontrada(s)"]})]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Submissão do Aluno"}),e.jsx("div",{className:"p-4 bg-muted rounded-lg max-h-64 overflow-y-auto",children:e.jsx("p",{className:"whitespace-pre-wrap",children:t.content})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Nota (0-10)"}),e.jsx(K,{type:"number",min:"0",max:"10",step:"0.1",value:f,onChange:r=>w(r.target.value),placeholder:"Ex: 8.5"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Feedback para o Aluno"}),e.jsx("textarea",{value:y,onChange:r=>_(r.target.value),rows:6,className:"w-full px-4 py-3 bg-background border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary resize-none",placeholder:"Escreva seu feedback detalhado aqui..."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{variant:"outline",leftIcon:Q,onClick:()=>E(!1),disabled:k,children:"Salvar Rascunho"}),e.jsx(v,{variant:"gradient",leftIcon:Y,onClick:()=>E(!0),disabled:k||!f,children:"Salvar e Notificar Aluno"})]})]})}):e.jsx(x,{variant:"elevated",className:"p-12",children:e.jsx(D,{icon:N,title:"Selecione uma submissão",description:"Escolha uma submissão da lista para iniciar a correção"})})})]})]})};export{pe as default};
