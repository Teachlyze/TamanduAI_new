import{u as B,r as n,j as s,o as T,U as _,s as x}from"./main-BrBEgNdp.js";import{P as w}from"./PremiumCard-CQ6HrYyP.js";import{E as h}from"./EmptyState-DQg0NHXl.js";import{T as g}from"./trophy-zpUL2ku0.js";import"./PremiumButton-C1Ncun4G.js";const P=(i,b)=>{const p=Object.entries(i).map(([a,c])=>({user_id:a,xp:c,name:b.get(a)?.full_name||"Aluno"}));return p.sort((a,c)=>(c.xp||0)-(a.xp||0)),p.map((a,c)=>({...a,position:c+1}))},z=()=>{const{user:i}=B(),[b,p]=n.useState(!0),[a,c]=n.useState([]),[f,M]=n.useState({}),[S,R]=n.useState(new Map),[k,q]=n.useState({}),[j,U]=n.useState(null);n.useEffect(()=>{(async()=>{if(i?.id){p(!0);try{const{data:l}=await x.from("class_members").select("class_id, class:classes(id, name)").eq("user_id",i.id).eq("role","student"),e=(l||[]).map(u=>u.class).filter(Boolean);c(e);let t=null;if(e.length>0){const u=e.map(d=>d.id),{data:y}=await x.from("school_classes").select("school_id").in("class_id",u).limit(1).maybeSingle();t=y?.school_id||null}if(U(t),e.length>0){const u=e.map(o=>o.id),{data:y}=await x.from("class_members").select("class_id, user_id").in("class_id",u).eq("role","student"),d={},C=new Set;for(const o of y||[])d[o.class_id]=d[o.class_id]||[],d[o.class_id].push(o.user_id),C.add(o.user_id);M(d);const N=Array.from(C);if(N.length){const{data:o}=await x.from("profiles").select("id, full_name").in("id",N),I=new Map;(o||[]).forEach(m=>I.set(m.id,m)),R(I);const{data:A}=await x.from("xp_log").select("user_id, xp").in("user_id",N),v={};(A||[]).forEach(m=>{v[m.user_id]=(v[m.user_id]||0)+(m.xp||0)}),q(v)}}}finally{p(!1)}}})()},[i?.id]);const E=n.useMemo(()=>{if(!j)return[];const r=new Set;for(const l of a)f[l.id]&&f[l.id].forEach(e=>r.add(e));return Array.from(r)},[j,a,f]);return b?s.jsx(T,{message:"Calculando rankings..."}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"bg-gradient-to-br from-amber-600 to-yellow-600 p-8 rounded-2xl text-white",children:[s.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-3",children:[s.jsx(g,{className:"w-6 h-6"})," Ranking"]}),s.jsx("p",{className:"text-white/90",children:"Rankings por turma e por escola"})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6 items-start",children:[s.jsxs("div",{className:"space-y-6 h-full",children:[s.jsx("h3",{className:"text-xl font-bold",children:"Ranking por Turma"}),a.length===0?s.jsx(w,{variant:"elevated",children:s.jsx("div",{className:"p-6",children:s.jsx(h,{icon:_,title:"Sem turmas",description:"Entre em uma turma para ver o ranking."})})}):a.map(r=>{const l={};(f[r.id]||[]).forEach(t=>{l[t]=k[t]||0});const e=P(l,S);return s.jsx(w,{variant:"elevated",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"font-bold text-lg mb-4 flex items-center gap-2",children:[s.jsx(_,{className:"w-5 h-5 text-primary"}),r.name]}),e.length===0?s.jsx(h,{icon:g,title:"Sem pontos ainda",description:"Ninguém pontuou por enquanto."}):s.jsx("div",{className:"space-y-2 max-h-[500px] overflow-y-auto scrollbar-thin scrollbar-thumb-blue-300 dark:scrollbar-thumb-blue-700 scrollbar-track-transparent",children:e.map(t=>s.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border hover:bg-muted/50 transition-colors",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("span",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${t.position===1?"bg-yellow-400 text-yellow-900":t.position===2?"bg-gray-300 text-gray-800":t.position===3?"bg-orange-400 text-orange-900":"bg-muted text-foreground"}`,children:t.position}),s.jsx("span",{className:t.user_id===i?.id?"font-bold text-primary":"",children:t.name})]}),s.jsxs("span",{className:"text-sm font-semibold bg-primary/10 text-primary px-3 py-1 rounded-full",children:[t.xp," XP"]})]},t.user_id))})]})},r.id)})]}),s.jsxs("div",{className:"space-y-6 h-full",children:[s.jsx("h3",{className:"text-xl font-bold",children:"Ranking da Escola"}),s.jsx(w,{variant:"elevated",className:"h-full",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"font-bold text-lg mb-4 flex items-center gap-2",children:[s.jsx(g,{className:"w-5 h-5 text-amber-500"}),"Classificação Geral"]}),!j||E.length===0?s.jsx(h,{icon:_,title:"Sem escola",description:"Participe de uma turma vinculada a uma escola para ver o ranking."}):(()=>{const r={};E.forEach(e=>{r[e]=k[e]||0});const l=P(r,S);return l.length===0?s.jsx(h,{icon:g,title:"Sem pontos ainda",description:"Ninguém pontuou por enquanto."}):s.jsx("div",{className:"space-y-2 max-h-[500px] overflow-y-auto scrollbar-thin scrollbar-thumb-blue-300 dark:scrollbar-thumb-blue-700 scrollbar-track-transparent",children:l.map(e=>s.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border hover:bg-muted/50 transition-colors",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("span",{className:`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${e.position===1?"bg-yellow-400 text-yellow-900":e.position===2?"bg-gray-300 text-gray-800":e.position===3?"bg-orange-400 text-orange-900":"bg-muted text-foreground"}`,children:e.position}),s.jsx("span",{className:e.user_id===i?.id?"font-bold text-primary":"",children:e.name})]}),s.jsxs("span",{className:"text-sm font-semibold bg-primary/10 text-primary px-3 py-1 rounded-full",children:[e.xp," XP"]})]},e.user_id))})})()]})})]})]})]})};export{z as default};
