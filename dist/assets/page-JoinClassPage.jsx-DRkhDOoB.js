import{r as u,j as e,X as E,f as b,u as S}from"./react-vendor-C2HUFn5N.js";import{s as c,u as C,C as g,b as j,d as y,k as _,e as N,B as w}from"./lazy-CreateActivityPage.jsx-DYBofU2F.js";import{N as k}from"./page-ActivityPublishPage.jsx-DscgTjDM.js";import{b as O,u as q}from"./vendor-react-router-B4Bn0PSh.js";class I{static async createInvite(s,r={}){const{maxUses:o=10,expiresInHours:a=168,recipientEmail:m,role:l="student"}=r,{data:{user:t}}=await c.auth.getUser();if(!t)throw new Error("User not authenticated");const[{data:f},{data:i}]=await Promise.all([c.from("classes").select("id, created_by, name").eq("id",s).single(),c.from("class_members").select("id").eq("class_id",s).eq("user_id",t.id).eq("role","teacher").maybeSingle()]);if(!f||f.created_by!==t.id&&!i)throw new Error("Unauthorized: Only class owner/teacher can create invites");const x=new Date;x.setHours(x.getHours()+a);const{data:p,error:d}=await c.from("class_invitations").insert([{class_id:s,created_by:t.id,token:this.generateToken(),role:l,max_uses:o,uses:0,expires_at:x.toISOString()}]).select().single();if(d)throw d;try{if(m){const{data:n}=await c.from("classes").select("name").eq("id",s).single(),h=`${window?.location?.origin||""}/join/${p.token}`;await k.send("classInviteSent",{email:m,variables:{className:n?.name||"Turma",acceptUrl:h},channelOverride:"email",metadata:{classId:s,inviteId:p.id}})}}catch(n){console.warn("Falha ao enviar email de convite:",n)}return p}static async getInvitesByClass(s){const{data:r,error:o}=await c.from("class_invitations").select("*").eq("class_id",s).order("created_at",{ascending:!1});if(o)throw o;return r}static async revokeInvite(s){const{error:r}=await c.from("class_invitations").update({revoked_at:new Date().toISOString()}).eq("id",s);if(r)throw r;return!0}static async acceptInvite(s,r,o={}){const{data:a,error:m}=await c.from("class_invitations").select("*").eq("token",s).single();if(m)throw new Error("Invalid or expired invite");if(a.revoked_at)throw new Error("Invite revoked");if(new Date(a.expires_at)<new Date)throw new Error("Invite has expired");if(a.max_uses!=null&&a.uses>=a.max_uses)throw new Error("Invite has reached maximum uses");const{error:l}=await c.from("class_members").insert([{class_id:a.class_id,user_id:r,role:a.role||"student",created_at:new Date().toISOString()}]);if(l&&l.code!=="23505")throw l;const{error:t}=await c.from("invitation_usages").insert([{invite_id:a.id,user_id:r,used_at:new Date().toISOString(),ip_address:o.ip_address||null,user_agent:o.user_agent||null}]);t&&console.warn("Failed to record invitation usage",t);const{error:f}=await c.from("class_invitations").update({uses:(a.uses||0)+1}).eq("id",a.id);f&&console.warn("Failed to increment invitation uses",f);try{const{data:i}=await c.from("classes").select("id, name, created_by").eq("id",a.class_id).single(),{data:x}=await c.from("profiles").select("full_name").eq("id",r).single();i?.created_by&&await k.send("classInviteAccepted",{userId:i.created_by,variables:{studentName:x?.full_name||"Aluno",className:i?.name||"Turma"},channelOverride:"push",metadata:{classId:i.id,inviteId:a.id}})}catch(i){console.warn("Falha ao notificar convite aceito:",i)}return{success:!0}}static generateToken(){return Array.from(crypto.getRandomValues(new Uint8Array(16))).map(s=>s.toString(16).padStart(2,"0")).join("")}}function T(v){const[s,r]=u.useState([]),[o,a]=u.useState(!1),[m,l]=u.useState(null),{toast:t}=C(),f=u.useCallback(async()=>{},[v,t]),i=u.useCallback(async(d={})=>null,[v,f,t]),x=u.useCallback(async d=>{if(!d)return!1;a(!0),l(null);try{return await I.revokeInvite(d),r(n=>n.filter(h=>h.id!==d)),t({title:"Convite revogado",description:"O link de convite foi desativado com sucesso."}),!0}catch(n){return console.error("Error revoking invite:",n),l(n.message),t({variant:"destructive",title:"Erro ao revogar convite",description:"Não foi possível revogar o link de convite."}),!1}finally{a(!1)}},[t]),p=u.useCallback(async d=>{if(!d)return{success:!1,error:"Token inválido"};a(!0),l(null);try{const{data:{user:n}}=await c.auth.getUser();if(!n)throw new Error("Usuário não autenticado");const h=await I.acceptInvite(d,n.id);return h.success&&t({title:"Inscrição realizada",description:h.alreadyEnrolled?"Você já está inscrito nesta turma.":"Você foi inscrito na turma com sucesso!"}),h}catch(n){throw console.error("Error using invite:",n),l(n.message),t({variant:"destructive",title:"Erro ao usar convite",description:n.message||"Não foi possível aceitar o convite."}),n}finally{a(!1)}},[t]);return{invites:s,isLoading:o,error:m,fetchInvites:f,createInvite:i,revokeInvite:x,useInvite:p}}function A(){const{token:v}=O(),s=q();C();const[r,o]=u.useState("loading"),[a,m]=u.useState(""),{useInvite:l}=T();u.useEffect(()=>{(async()=>{if(!v){o("error"),m("Token de convite inválido");return}try{const i=await l(v);i.success?(o("success"),setTimeout(()=>{s("/dashboard")},3e3)):i.alreadyEnrolled&&(o("already_member"),setTimeout(()=>{s("/dashboard")},3e3))}catch(i){console.error("Error joining class:",i),o("error"),m(i.message||"Ocorreu um erro ao tentar entrar na turma.")}})()},[v,l,s]);const t=()=>{switch(r){case"loading":return e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 space-y-4",children:[e.jsx(S,{className:"h-12 w-12 animate-spin text-primary"}),e.jsx("p",{className:"text-lg font-medium",children:"Processando seu convite..."})]});case"success":return e.jsxs(g,{className:"max-w-md mx-auto",children:[e.jsxs(j,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100",children:e.jsx(b,{className:"h-6 w-6 text-green-600"})}),e.jsx(y,{className:"mt-4",children:"Inscrição realizada com sucesso!"}),e.jsx(_,{children:"Você foi adicionado à turma com sucesso. Redirecionando para o painel..."})]}),e.jsx(N,{className:"flex justify-center",children:e.jsx(w,{onClick:()=>s("/dashboard"),children:"Ir para o painel agora"})})]});case"already_member":return e.jsxs(g,{className:"max-w-md mx-auto",children:[e.jsxs(j,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-blue-100",children:e.jsx(b,{className:"h-6 w-6 text-blue-600"})}),e.jsx(y,{className:"mt-4",children:"Você já está inscrito"}),e.jsx(_,{children:"Você já é membro desta turma. Redirecionando para o painel..."})]}),e.jsx(N,{className:"flex justify-center",children:e.jsx(w,{onClick:()=>s("/dashboard"),children:"Ir para o painel"})})]});case"error":return e.jsxs(g,{className:"max-w-md mx-auto",children:[e.jsxs(j,{className:"text-center",children:[e.jsx("div",{className:"mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100",children:e.jsx(E,{className:"h-6 w-6 text-red-600"})}),e.jsx(y,{className:"mt-4",children:"Não foi possível processar o convite"}),e.jsx(_,{className:"text-red-600",children:a||"O link de convite é inválido ou expirou."})]}),e.jsxs(N,{className:"flex flex-col items-center space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Verifique se o link está correto ou peça um novo convite ao professor."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(w,{variant:"outline",onClick:()=>s("/"),children:"Página inicial"}),e.jsx(w,{onClick:()=>s("/dashboard"),children:"Ir para o painel"})]})]})]});default:return null}};return e.jsxs("div",{className:"container max-w-4xl py-12 px-4",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Entrar na Turma"}),e.jsx("p",{className:"text-muted-foreground mt-2",children:r==="loading"?"Processando seu convite...":r==="success"?"Você foi adicionado à turma com sucesso!":r==="already_member"?"Você já é membro desta turma.":"Ocorreu um erro ao processar seu convite."})]}),e.jsx("div",{className:"flex justify-center",children:t()})]})}export{A as default};
