import{ak as A,u as C,r as t,j as e,U as n,C as k,s as o,aq as S}from"./main-NgjJy_CG.js";import{P as _}from"./PremiumCard-BGO_It48.js";import{P as E}from"./PremiumButton-DDGOGflQ.js";import{E as c}from"./EmptyState-Cb7n_MKP.js";import{T as R}from"./trash-2-Bhwmq7t6.js";const U=()=>{const{classId:a}=A(),{user:P}=C(),[M,p]=t.useState(!0),[m,q]=t.useState(null),[j,b]=t.useState([]),[g,v]=t.useState([]),[i,y]=t.useState(null);t.useEffect(()=>{(async()=>{if(a){p(!0);try{const{data:l,error:r}=await o.from("classes").select("id, name, created_by").eq("id",a).maybeSingle();if(r)throw r;q(l);const{data:f,error:d}=await o.from("class_members").select("id, user_id, role, joined_at, nickname, user:profiles(id, full_name, email)").eq("class_id",a).order("joined_at",{ascending:!1});if(d)throw d;b(f||[]);const{data:h,error:w}=await o.from("class_member_history").select("id, user_id, action, role, performed_by, reason, created_at, user:profiles!class_member_history_user_id_fkey(full_name), performer:profiles!class_member_history_performed_by_fkey(full_name)").eq("class_id",a).order("created_at",{ascending:!1}).limit(100);if(w)throw w;v(h||[])}catch(l){console.error("Erro ao carregar membros:",l)}finally{p(!1)}}})()},[a]);const N=async(s,l)=>{if(window.confirm("Tem certeza que deseja remover este membro da turma?")){y(s);try{await o.rpc("set_config",{parameter:"app.current_user_id",value:P.id});const{error:r}=await o.from("class_members").delete().eq("id",s);if(r)throw r;b(d=>d.filter(h=>h.id!==s)),S.success?.("Membro removido da turma");const{data:f}=await o.from("class_member_history").select("id, user_id, action, role, performed_by, reason, created_at, user:profiles!class_member_history_user_id_fkey(full_name), performer:profiles!class_member_history_performed_by_fkey(full_name)").eq("class_id",a).order("created_at",{ascending:!1}).limit(100);v(f||[])}catch(r){console.error("Erro ao remover membro:",r),S.error?.("Erro ao remover membro")}finally{y(null)}}};if(!m)return e.jsx(c,{icon:n,title:"Turma não encontrada"});const u=j.filter(s=>s.role==="student"),x=j.filter(s=>s.role==="teacher");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-slate-600 to-gray-700 p-8 rounded-2xl text-white",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-3",children:[e.jsx(n,{className:"w-6 h-6"})," Gerenciar Membros"]}),e.jsx("p",{className:"text-slate-900 dark:text-white/90",children:m.name})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(_,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("h2",{className:"text-lg font-bold",children:["Alunos (",u.length,")"]}),u.length===0?e.jsx(c,{icon:n,title:"Sem alunos",description:"Nenhum aluno matriculado ainda."}):e.jsx("div",{className:"space-y-2",children:u.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.user?.full_name||"Aluno"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.user?.email}),s.nickname&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Apelido: ",s.nickname]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Entrou: ",new Date(s.joined_at).toLocaleDateString("pt-BR")]})]}),e.jsx(E,{variant:"outline",size:"sm",onClick:()=>N(s.id,s.user_id),disabled:i===s.id,leftIcon:R,children:i===s.id?"Removendo...":"Remover"})]},s.id))})]})}),e.jsx(_,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("h2",{className:"text-lg font-bold",children:["Professores (",x.length,")"]}),x.length===0?e.jsx(c,{icon:n,title:"Sem professores"}):e.jsx("div",{className:"space-y-2",children:x.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.user?.full_name||"Professor"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.user?.email})]}),s.user_id!==m.created_by&&e.jsx(E,{variant:"outline",size:"sm",onClick:()=>N(s.id,s.user_id),disabled:i===s.id,leftIcon:R,children:i===s.id?"Removendo...":"Remover"})]},s.id))})]})})]}),e.jsx(_,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2",children:[e.jsx(k,{className:"w-5 h-5"})," Histórico de Alterações"]}),g.length===0?e.jsx(c,{icon:k,title:"Sem histórico",description:"Nenhuma alteração registrada."}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:g.map(s=>e.jsxs("div",{className:"p-3 rounded-lg border border-border text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-semibold ${s.action==="added"?"bg-green-100 text-green-700":s.action==="removed"?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"}`,children:s.action==="added"?"Adicionado":s.action==="removed"?"Removido":"Alterado"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.created_at).toLocaleString("pt-BR")})]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("strong",{children:s.user?.full_name||"Usuário"})," (",s.role,")",s.performer?.full_name&&e.jsxs(e.Fragment,{children:[" por ",e.jsx("strong",{children:s.performer.full_name})]})]}),s.reason&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Motivo: ",s.reason]})]},s.id))})]})})]})};export{U as default};
