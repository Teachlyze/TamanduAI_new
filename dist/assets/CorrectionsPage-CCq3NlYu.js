import{s as d,bO as O,bP as W,al as V,g as K,u as J,r as f,z as p,j as e,o as M,ah as S,n as X,A as H,p as Q}from"./main-BTTCSkdE.js";import{P as b}from"./PremiumCard-CV5gJlVo.js";import{P as w}from"./PremiumButton-TaG2j_oH.js";import{E as R}from"./EmptyState-j91SMhTI.js";import{B as Y}from"./Breadcrumb-CD_ztvW0.js";import{A as Z}from"./arrow-left-CostCvAH.js";import{D as ee}from"./download-BRB6ZsEm.js";import{C as re}from"./circle-check-big-BC3uqdYk.js";import{T as G}from"./triangle-alert-h67Np2YJ.js";import{S as ae}from"./save-DBFYKH5W.js";import{S as se}from"./send-vuN82Ny2.js";const te=async(c,a)=>{try{const{data:s,error:i}=await d.functions.invoke("plagiarism-check-v2",{body:{text:c,submissionId:a,useCache:!0}});if(i)throw console.error("Erro na Edge Function plagiarism-check-v2:",i),i;return s}catch(s){throw console.error("Erro ao chamar Edge Function de plágio:",s),s}},ie=async c=>{try{const{data:a,error:s}=await d.functions.invoke("plagiarism-check-cached",{body:{submissionId:c}});return s?(console.error("Erro ao buscar cache:",s),null):a}catch(a){return console.error("Erro ao buscar cache de plágio:",a),null}},oe=async(c,a)=>{try{const{data:s,error:i}=await d.from("plagiarism_checks").insert({submission_id:c,plagiarism_percentage:a.plagiarismPercentage||0,ai_generated:a.isAiGenerated||!1,ai_score:a.aiScore||0,sources:a.sources||[],raw_data:a.rawData||{}}).select().single();if(i)throw console.error("Erro ao salvar resultado:",i),i;return s}catch(s){throw console.error("Erro ao salvar resultado de plágio:",s),s}};class le{constructor(){this.apiKey=void 0,this.apiUrl="https://api.gowinston.ai/v1/plagiarism",this.useEdgeFunctions=!0}async checkPlagiarism(a,s,i=null,m=null){try{const n=s||i;if(this.useEdgeFunctions&&n){const t=await ie(n);if(t)return console.log("✅ Resultado de plágio encontrado em cache"),{success:!0,percentage:t.plagiarism_percentage,aiGenerated:t.ai_generated,aiScore:t.ai_score,sources:t.sources,status:this.getStatus(t.plagiarism_percentage),cached:!0}}let o;if(this.useEdgeFunctions&&n)console.log("🔄 Usando Edge Function para verificação de plágio..."),o=await te(a,n);else{console.log("🔄 Usando API WinstonAI diretamente...");const t=await fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:JSON.stringify({text:a,language:"pt",check_internet:!0,check_database:!0})});if(!t.ok)throw new Error(`WinstonAI API Error: ${t.status}`);o=await t.json()}n&&await oe(n,{plagiarismPercentage:o.plagiarism_score||o.plagiarismPercentage||0,isAiGenerated:o.ai_generated||o.isAiGenerated||!1,aiScore:o.ai_score||o.aiScore||0,sources:o.sources||[],rawData:o});const l=o.plagiarism_score||o.plagiarismPercentage||0,u=o.ai_score||o.aiScore||0;return l>=50&&i&&m&&await this.notifyTeacher(i,m,l,u),{success:!0,percentage:l,aiGenerated:o.ai_generated||o.isAiGenerated||!1,aiScore:u,sources:o.sources||[],status:this.getStatus(l),report:o,cached:!1}}catch(n){return console.error("Erro ao verificar plágio:",n),{success:!1,error:n.message,percentage:0,sources:[]}}}async savePlagiarismReport(a){try{const{error:s}=await d.from("plagiarism_reports").insert([a]);if(s)throw s}catch(s){console.error("Erro ao salvar relatório:",s)}}async notifyTeacher(a,s,i,m=0){try{const[n,o]=await Promise.all([d.from("activities").select("title, created_by").eq("id",a).single(),d.from("profiles").select("full_name").eq("id",s).single()]),l=n.data,u=o.data;if(!l||!u)return;this.useEdgeFunctions?(i>=50&&await O(l.created_by,u.full_name,l.title,i),m>=70&&await W(l.created_by,u.full_name,l.title,m)):await d.from("notifications").insert([{user_id:l.created_by,type:"plagiarism_alert",title:"⚠️ Plágio Detectado",message:`${i}% de plágio detectado na submissão de ${u.full_name} para "${l.title}"`,data:{activityId:a,studentId:s,percentage:i,aiScore:m}}])}catch(n){console.error("Erro ao notificar professor:",n)}}getStatus(a){return a>=70?"high":a>=50?"medium":a>=30?"low":"clean"}async getReports(a,s){try{const{data:i,error:m}=await d.from("plagiarism_reports").select("*").eq("activity_id",a).eq("student_id",s).order("checked_at",{ascending:!1});if(m)throw m;return i||[]}catch(i){return console.error("Erro ao buscar relatórios:",i),[]}}async isAlreadyChecked(a,s){return(await this.getReports(a,s)).length>0}async recheckPlagiarism(a,s,i){return await this.checkPlagiarism(a,s,i)}}const ne=new le,je=()=>{const{activityId:c}=V(),a=K(),{user:s}=J(),[i,m]=f.useState(!0),[n,o]=f.useState(null),[l,u]=f.useState([]),[t,q]=f.useState(null),[v,A]=f.useState(""),[E,P]=f.useState(""),[C,F]=f.useState(!1);f.useEffect(()=>{c&&s&&y()},[c,s]);const y=async()=>{try{m(!0);const{data:r,error:g}=await d.from("activities").select("*").eq("id",c).single();if(g)throw g;o(r);const{data:x,error:N}=await d.from("submissions").select("*").eq("activity_id",c).order("submitted_at",{ascending:!1});if(N)throw N;if(x&&x.length>0){const _=[...new Set(x.map(h=>h.student_id))],{data:z}=await d.from("profiles").select("id, full_name, email, avatar_url").in("id",_),L=x.map(h=>h.id),{data:U}=await d.from("plagiarism_reports").select("*").in("submission_id",L);x.forEach(h=>{h.student=z?.find(k=>k.id===h.student_id),h.plagiarism_reports=U?.filter(k=>k.submission_id===h.id)||[]})}if(N)throw N;u(x||[]);const $=x?.find(_=>!_.grade);$&&I($)}catch(r){console.error("Erro ao carregar:",r),p.error("Erro ao carregar correções")}finally{m(!1)}},I=r=>{q(r),A(r.grade||""),P(r.feedback||"")},D=async(r=!1)=>{if(t)try{F(!0);const{error:g}=await d.from("submissions").update({grade:parseFloat(v)||null,feedback:E||null,graded_at:new Date().toISOString(),graded_by:s.id}).eq("id",t.id);if(g)throw g;r&&await d.from("notifications").insert([{user_id:t.student_id,type:"grade",title:"Nova Nota Disponível",message:`Sua nota para "${n.title}" foi publicada: ${v}`,link:`/dashboard/activities/${c}`}]),p.success(r?"Correção salva e aluno notificado":"Correção salva"),y()}catch(g){console.error("Erro ao salvar correção:",g),p.error("Erro ao salvar correção")}finally{F(!1)}},T=async()=>{if(t)try{p.loading("Verificando plágio...",{id:"plagiarism"});const r=await ne.checkPlagiarism(t.content,c,t.student_id);p.dismiss("plagiarism"),r.success?(p.success(`Plágio verificado: ${r.percentage}%`),y()):p.error("Erro na verificação de plágio")}catch{p.dismiss("plagiarism"),p.error("Erro ao verificar plágio")}},j={total:l.length,corrected:l.filter(r=>r.grade!==null).length,pending:l.filter(r=>r.grade===null).length,averageGrade:l.filter(r=>r.grade).reduce((r,g)=>r+g.grade,0)/l.filter(r=>r.grade).length||0};if(i)return e.jsx(M,{message:"Carregando correções..."});if(!n)return e.jsx(R,{icon:S,title:"Atividade não encontrada",description:"A atividade que você está procurando não existe.",actionLabel:"Voltar para Atividades",onAction:()=>a("/dashboard/activities")});const B=[{label:"Atividades",path:"/dashboard/activities"},{label:n.title,path:`/dashboard/activities/${c}`},{label:"Correções",path:`/dashboard/activities/${c}/corrections`}];return e.jsxs("div",{className:"space-y-6",children:[e.jsx(Y,{items:B}),e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("button",{onClick:()=>a("/dashboard/activities"),className:"p-2 rounded-lg hover:bg-muted",children:e.jsx(Z,{className:"w-5 h-5"})}),e.jsx("h1",{className:"text-3xl font-bold",children:"Correção de Atividades"})]}),e.jsx("p",{className:"text-muted-foreground",children:n.title})]}),e.jsx(w,{variant:"outline",leftIcon:ee,children:"Exportar Notas"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx(b,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-blue-100 dark:bg-blue-900/30 rounded-lg",children:e.jsx(S,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.total}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Submissões"})]})]})}),e.jsx(b,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-green-100 dark:bg-green-900/30 rounded-lg",children:e.jsx(re,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.corrected}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Corrigidas"})]})]})}),e.jsx(b,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-orange-100 dark:bg-orange-900/30 rounded-lg",children:e.jsx(X,{className:"w-6 h-6 text-orange-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.pending}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pendentes"})]})]})}),e.jsx(b,{variant:"elevated",className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-purple-100 dark:bg-purple-900/30 rounded-lg",children:e.jsx(H,{className:"w-6 h-6 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:j.averageGrade.toFixed(1)}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Média Geral"})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(b,{variant:"elevated",children:[e.jsx("div",{className:"p-4 border-b border-border",children:e.jsxs("h3",{className:"font-bold",children:["Submissões (",l.length,")"]})}),e.jsx("div",{className:"max-h-[600px] overflow-y-auto",children:l.length===0?e.jsx("div",{className:"p-8 text-center text-muted-foreground",children:"Nenhuma submissão ainda"}):l.map(r=>e.jsx("button",{onClick:()=>I(r),className:`w-full p-4 border-b border-border hover:bg-muted/50 transition-colors text-left ${t?.id===r.id?"bg-primary/10":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold flex-shrink-0",children:r.student?.full_name?.charAt(0)||"A"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:r.student?.full_name||"Aluno"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(r.submitted_at).toLocaleString("pt-BR")}),e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[r.grade!==null?e.jsxs("span",{className:"px-2 py-1 text-xs rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300",children:["Nota: ",r.grade]}):e.jsx("span",{className:"px-2 py-1 text-xs rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-700 dark:text-orange-300",children:"Pendente"}),r.plagiarism_reports?.length>0&&e.jsxs("span",{className:"px-2 py-1 text-xs rounded-full bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300",children:["⚠️ ",r.plagiarism_reports[0].plagiarism_percentage,"%"]})]})]})]})},r.id))})]})}),e.jsx("div",{className:"lg:col-span-2",children:t?e.jsx(b,{variant:"elevated",className:"p-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between pb-4 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold",children:t.student?.full_name?.charAt(0)||"A"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:t.student?.full_name||"Aluno"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.student?.email})]})]}),e.jsx(w,{variant:"outline",size:"sm",leftIcon:G,onClick:T,children:"Verificar Plágio"})]}),t.plagiarism_reports?.length>0&&e.jsx("div",{className:"p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(G,{className:"w-5 h-5 text-red-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-bold text-red-900 dark:text-red-100",children:["Plágio Detectado: ",t.plagiarism_reports[0].plagiarism_percentage,"%"]}),e.jsxs("p",{className:"text-sm text-red-800 dark:text-red-200 mt-1",children:["Fontes: ",t.plagiarism_reports[0].sources?.length||0," encontrada(s)"]})]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Submissão do Aluno"}),e.jsx("div",{className:"p-4 bg-muted rounded-lg max-h-64 overflow-y-auto",children:e.jsx("p",{className:"whitespace-pre-wrap",children:t.content})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Nota (0-10)"}),e.jsx(Q,{type:"number",min:"0",max:"10",step:"0.1",value:v,onChange:r=>A(r.target.value),placeholder:"Ex: 8.5"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-2",children:"Feedback para o Aluno"}),e.jsx("textarea",{value:E,onChange:r=>P(r.target.value),rows:6,className:"w-full px-4 py-3 bg-background border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary resize-none",placeholder:"Escreva seu feedback detalhado aqui..."})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(w,{variant:"outline",leftIcon:ae,onClick:()=>D(!1),disabled:C,children:"Salvar Rascunho"}),e.jsx(w,{variant:"gradient",leftIcon:se,onClick:()=>D(!0),disabled:C||!v,children:"Salvar e Notificar Aluno"})]})]})}):e.jsx(b,{variant:"elevated",className:"p-12",children:e.jsx(R,{icon:S,title:"Selecione uma submissão",description:"Escolha uma submissão da lista para iniciar a correção"})})})]})]})};export{je as default};
