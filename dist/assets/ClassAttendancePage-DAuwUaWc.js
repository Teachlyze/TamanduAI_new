import{s as p,ak as $,r as _,z as g,j as e,o as D,m as N,l as I,U as C,e as v,n as S,d as O,T as F}from"./main-NgjJy_CG.js";import{P as b}from"./PremiumCard-BGO_It48.js";import{P as A}from"./PremiumButton-DDGOGflQ.js";import{D as M}from"./download-BtFddqD_.js";import{C as U}from"./chevron-left-CCTbow4A.js";import{U as L}from"./user-check-C-AAn5f8.js";import{f as E}from"./format-CtnHAw15.js";import{p as T}from"./pt-BR-D7au_PjL.js";import{a as z}from"./addDays-DK-fbKQS.js";import"./en-US-DmzJuP_Q.js";import"./toDate-M29M8iGB.js";const V=async(n,s=null,r=null)=>{try{let a=p.from("class_attendance").select(`
        *,
        student:user_id(id, full_name, email, avatar_url)
      `).eq("class_id",n).order("attended_date",{ascending:!1});s&&(a=a.gte("attended_date",s.toISOString().split("T")[0])),r&&(a=a.lte("attended_date",r.toISOString().split("T")[0]));const{data:o,error:l}=await a;if(l)throw l;return o||[]}catch(a){throw console.error("Error getting class attendance:",a),a}},B=async(n,s=null,r=null)=>{try{const{data:a,error:o}=await p.rpc("get_class_attendance_rate",{p_class_id:n,p_start_date:s?s.toISOString().split("T")[0]:null,p_end_date:r?r.toISOString().split("T")[0]:null});if(o)throw o;return a?.[0]||{total_students:0,total_classes:0,total_attendances:0,attendance_rate:0}}catch(a){throw console.error("Error getting attendance rate:",a),a}},H=async(n,s,r=new Date)=>{try{const{data:a,error:o}=await p.rpc("log_class_attendance",{p_class_id:n,p_user_id:s,p_joined_at:r.toISOString()});if(o)throw o;return a}catch(a){throw console.error("Error logging attendance:",a),a}},G=async(n,s,r,a=!0)=>{try{const{data:o,error:l}=await p.from("class_attendance").insert({class_id:n,user_id:s,attended_date:r.toISOString().split("T")[0],joined_at:r,was_on_time:a,duration_minutes:null}).select().single();if(l)throw l;return o}catch(o){throw console.error("Error marking attendance:",o),o}},Q=async(n,s,r)=>{try{const a=s.map(x=>({class_id:n,user_id:x,attended_date:r.toISOString().split("T")[0],joined_at:r,was_on_time:!0})),{data:o,error:l}=await p.from("class_attendance").insert(a).select();if(l)throw l;return o||[]}catch(a){throw console.error("Error bulk marking attendance:",a),a}},X=async(n,s)=>{try{const{data:r,error:a}=await p.from("class_attendance").update(s).eq("id",n).select().single();if(a)throw a;return r}catch(r){throw console.error("Error updating attendance:",r),r}},J=async n=>{try{const{error:s}=await p.from("class_attendance").delete().eq("id",n);if(s)throw s}catch(s){throw console.error("Error deleting attendance:",s),s}},K=async(n,s)=>{try{const{data:r,error:a}=await p.from("class_attendance").select("*").eq("class_id",n).eq("user_id",s).order("attended_date",{ascending:!1});if(a)throw a;return r||[]}catch(r){throw console.error("Error getting student attendance history:",r),r}},q=async n=>{try{const{data:s,error:r}=await p.from("class_members").select("user_id, profiles:user_id(id, full_name, email, avatar_url)").eq("class_id",n).eq("role","student");if(r)throw r;const{data:a,error:o}=await p.from("class_attendance").select("user_id, attended_date, was_on_time").eq("class_id",n);if(o)throw o;const x=[...new Set(a?.map(d=>d.attended_date)||[])].length;return s.map(d=>{const u=a?.filter(w=>w.user_id===d.user_id)||[],i=u.length,m=u.filter(w=>w.was_on_time).length,j=x-i,y=x>0?i/x*100:0;return{user_id:d.user_id,student_name:d.profiles?.full_name,email:d.profiles?.email,avatar_url:d.profiles?.avatar_url,total_classes:x,present_count:i,absent_count:j,on_time_count:m,late_count:i-m,attendance_rate:y}}).sort((d,u)=>u.attendance_rate-d.attendance_rate)}catch(s){throw console.error("Error getting attendance summary:",s),s}},W=async(n,s)=>{try{const r=s.toISOString().split("T")[0],{data:a,error:o}=await p.from("class_members").select("user_id, profiles:user_id(id, full_name, email, avatar_url)").eq("class_id",n).eq("role","student");if(o)throw o;const{data:l,error:x}=await p.from("class_attendance").select("*").eq("class_id",n).eq("attended_date",r);if(x)throw x;const c=a.map(i=>{const m=l?.find(j=>j.user_id===i.user_id);return{user_id:i.user_id,student_name:i.profiles?.full_name,email:i.profiles?.email,avatar_url:i.profiles?.avatar_url,is_present:!!m,was_on_time:m?.was_on_time||!1,joined_at:m?.joined_at,attendance_id:m?.id}}),d=c.filter(i=>i.is_present).length,u=c.length-d;return{date:r,students:c,total_students:c.length,present_count:d,absent_count:u,attendance_rate:c.length>0?d/c.length*100:0}}catch(r){throw console.error("Error getting attendance by date:",r),r}},Y=async(n,s)=>{try{const r=await q(n);let a=`RELATÃ“RIO DE FREQUÃŠNCIA - ${s}

`;a+=`Aluno,Email,Total de Aulas,PresenÃ§as,Faltas,No HorÃ¡rio,Atrasado,Taxa de PresenÃ§a
`,r.forEach(c=>{a+=`${c.student_name},${c.email},${c.total_classes},${c.present_count},${c.absent_count},${c.on_time_count},${c.late_count},${c.attendance_rate.toFixed(1)}%
`});const o=new Blob([a],{type:"text/csv;charset=utf-8;"}),l=document.createElement("a"),x=URL.createObjectURL(o);l.setAttribute("href",x),l.setAttribute("download",`frequencia_${s}_${new Date().toISOString().split("T")[0]}.csv`),l.style.visibility="hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)}catch(r){throw console.error("Error exporting attendance CSV:",r),r}},f={getClassAttendance:V,getAttendanceRate:B,logAttendance:H,markAttendance:G,bulkMarkAttendance:Q,updateAttendance:X,deleteAttendance:J,getStudentAttendanceHistory:K,getAttendanceSummary:q,getAttendanceByDate:W,exportAttendanceCSV:Y},ie=()=>{const{classId:n}=$(),[s,r]=_.useState(!0),[a,o]=_.useState(new Date),[l,x]=_.useState(null),[c,d]=_.useState([]),[u,i]=_.useState(null),[m,j]=_.useState("daily");_.useEffect(()=>{n&&y()},[n,a,m]);const y=async()=>{try{if(r(!0),m==="daily"){const t=await f.getAttendanceByDate(n,a);x(t)}else{const[t,h]=await Promise.all([f.getAttendanceSummary(n),f.getAttendanceRate(n)]);d(t),i(h)}}catch(t){console.error("Erro ao carregar frequÃªncia:",t),g.error("Erro ao carregar dados")}finally{r(!1)}},w=async t=>{try{t.is_present?(await f.deleteAttendance(t.attendance_id),g.success("Falta marcada")):(await f.markAttendance(n,t.user_id,a),g.success("PresenÃ§a marcada")),y()}catch{g.error("Erro ao atualizar presenÃ§a")}},P=async()=>{try{const t=l.students.filter(h=>!h.is_present);if(t.length===0){g.error("Todos jÃ¡ estÃ£o presentes");return}await f.bulkMarkAttendance(n,t.map(h=>h.user_id),a),g.success("Todos marcados como presentes"),y()}catch{g.error("Erro ao marcar presenÃ§a em lote")}},R=async()=>{try{await f.exportAttendanceCSV(n,"Turma"),g.success("RelatÃ³rio exportado!")}catch{g.error("Erro ao exportar relatÃ³rio")}},k=t=>{o(h=>z(h,t))};return s?e.jsx(D,{message:"Carregando frequÃªncia..."}):e.jsxs("div",{className:"space-y-6 animate-fade-in-up",children:[e.jsxs(N.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"relative overflow-hidden bg-gradient-to-br from-green-600 via-emerald-600 to-teal-600 rounded-3xl p-8 text-white",children:[e.jsx("div",{className:"absolute inset-0 opacity-10",children:e.jsx("div",{className:"absolute inset-0",style:{backgroundImage:"radial-gradient(circle at 1px 1px, white 1px, transparent 0)",backgroundSize:"40px 40px"}})}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"ğŸ“‹ Chamada / FrequÃªncia"}),e.jsx("p",{className:"text-white/90 text-lg",children:"Controle de presenÃ§a da turma"})]}),e.jsx("div",{className:"flex gap-3",children:e.jsx(A,{variant:"white",leftIcon:M,onClick:R,className:"whitespace-nowrap inline-flex items-center gap-2 bg-white text-green-600 hover:bg-white/90",children:e.jsx("span",{children:"Exportar CSV"})})})]}),e.jsxs("div",{className:"flex gap-2 bg-white/10 backdrop-blur-sm rounded-xl p-2 border border-white/20 w-fit",children:[e.jsx("button",{onClick:()=>j("daily"),className:`px-4 py-2 rounded-lg font-medium transition-all ${m==="daily"?"bg-white text-green-600":"text-white hover:bg-white/10"}`,children:"Chamada DiÃ¡ria"}),e.jsx("button",{onClick:()=>j("summary"),className:`px-4 py-2 rounded-lg font-medium transition-all ${m==="summary"?"bg-white text-green-600":"text-white hover:bg-white/10"}`,children:"Resumo Geral"})]})]})]}),m==="daily"&&l&&e.jsxs(e.Fragment,{children:[e.jsx(b,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:()=>k(-1),className:"p-2 hover:bg-muted rounded-lg transition-colors",children:e.jsx(U,{className:"w-5 h-5"})}),e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-2xl font-bold",children:E(a,"d 'de' MMMM, yyyy",{locale:T})}),e.jsx("p",{className:"text-sm text-muted-foreground",children:E(a,"EEEE",{locale:T})})]}),e.jsx("button",{onClick:()=>k(1),className:"p-2 hover:bg-muted rounded-lg transition-colors",children:e.jsx(I,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-6",children:[e.jsxs("div",{className:"text-center p-4 rounded-lg bg-muted/30",children:[e.jsx(C,{className:"w-6 h-6 mx-auto mb-2 text-primary"}),e.jsx("p",{className:"text-2xl font-bold",children:l.total_students}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"})]}),e.jsxs("div",{className:"text-center p-4 rounded-lg bg-green-50 dark:bg-green-900/20",children:[e.jsx(v,{className:"w-6 h-6 mx-auto mb-2 text-green-600"}),e.jsx("p",{className:"text-2xl font-bold text-green-600",children:l.present_count}),e.jsx("p",{className:"text-sm text-green-700 dark:text-green-400",children:"Presentes"})]}),e.jsxs("div",{className:"text-center p-4 rounded-lg bg-red-50 dark:bg-red-900/20",children:[e.jsx(S,{className:"w-6 h-6 mx-auto mb-2 text-red-600"}),e.jsx("p",{className:"text-2xl font-bold text-red-600",children:l.absent_count}),e.jsx("p",{className:"text-sm text-red-700 dark:text-red-400",children:"Ausentes"})]})]}),l.absent_count>0&&e.jsx("div",{className:"mt-4",children:e.jsx(A,{variant:"outline",leftIcon:L,onClick:P,className:"w-full whitespace-nowrap inline-flex items-center gap-2 justify-center",children:e.jsx("span",{children:"Marcar Todos Como Presentes"})})})]})}),e.jsx(b,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Lista de Chamada"}),e.jsx("div",{className:"space-y-2",children:l.students.map((t,h)=>e.jsxs(N.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:h*.03},className:`flex items-center justify-between p-4 rounded-lg border-2 transition-all ${t.is_present?"border-green-200 bg-green-50 dark:border-green-800 dark:bg-green-900/20":"border-border bg-white dark:bg-slate-900"}`,children:[e.jsxs("div",{className:"flex items-center gap-3",children:[t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:t.student_name,className:"w-10 h-10 rounded-full"}):e.jsx("div",{className:"w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center text-primary font-bold",children:t.student_name[0]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:t.student_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.email})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[t.is_present&&t.was_on_time&&e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400",children:"No horÃ¡rio"}),t.is_present&&!t.was_on_time&&e.jsx("span",{className:"text-xs px-2 py-1 rounded-full bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400",children:"Atrasado"}),e.jsx("button",{onClick:()=>w(t),className:`p-2 rounded-lg transition-colors ${t.is_present?"bg-green-600 text-white hover:bg-green-700":"bg-muted hover:bg-red-50 dark:hover:bg-red-900/20 text-muted-foreground hover:text-red-600"}`,children:t.is_present?e.jsx(v,{className:"w-5 h-5"}):e.jsx(S,{className:"w-5 h-5"})})]})]},t.user_id))})]})})]}),m==="summary"&&e.jsxs(e.Fragment,{children:[u&&e.jsxs("div",{className:"grid md:grid-cols-4 gap-4",children:[e.jsx(b,{variant:"elevated",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(C,{className:"w-8 h-8 mx-auto mb-3 text-primary"}),e.jsx("p",{className:"text-3xl font-bold mb-1",children:u.total_students}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Alunos"})]})}),e.jsx(b,{variant:"elevated",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(O,{className:"w-8 h-8 mx-auto mb-3 text-primary"}),e.jsx("p",{className:"text-3xl font-bold mb-1",children:u.total_classes}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aulas Realizadas"})]})}),e.jsx(b,{variant:"elevated",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(v,{className:"w-8 h-8 mx-auto mb-3 text-green-600"}),e.jsx("p",{className:"text-3xl font-bold mb-1 text-green-600",children:u.total_attendances}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total de PresenÃ§as"})]})}),e.jsx(b,{variant:"elevated",children:e.jsxs("div",{className:"p-6 text-center",children:[e.jsx(F,{className:"w-8 h-8 mx-auto mb-3 text-primary"}),e.jsxs("p",{className:"text-3xl font-bold mb-1",children:[u.attendance_rate?.toFixed(1)||0,"%"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Taxa de PresenÃ§a"})]})})]}),e.jsx(b,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Resumo por Aluno"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gradient-to-r from-green-50 to-emerald-50 dark:from-slate-800 dark:to-slate-800 border-b-2 border-primary/20",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-bold",children:"Aluno"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold",children:"Total de Aulas"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold",children:"PresenÃ§as"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold",children:"Faltas"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold",children:"No HorÃ¡rio"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold",children:"Atrasado"}),e.jsx("th",{className:"px-4 py-3 text-center text-sm font-bold",children:"Taxa"})]})}),e.jsx("tbody",{children:c.map((t,h)=>e.jsxs(N.tr,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:h*.03},className:"border-b border-border hover:bg-muted/30",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[t.avatar_url?e.jsx("img",{src:t.avatar_url,alt:t.student_name,className:"w-8 h-8 rounded-full"}):e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-primary text-xs font-bold",children:t.student_name[0]}),e.jsx("span",{className:"font-medium",children:t.student_name})]})}),e.jsx("td",{className:"px-4 py-3 text-center",children:t.total_classes}),e.jsx("td",{className:"px-4 py-3 text-center font-bold text-green-600",children:t.present_count}),e.jsx("td",{className:"px-4 py-3 text-center font-bold text-red-600",children:t.absent_count}),e.jsx("td",{className:"px-4 py-3 text-center",children:t.on_time_count}),e.jsx("td",{className:"px-4 py-3 text-center",children:t.late_count}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsxs("span",{className:`inline-block px-3 py-1 rounded-full text-sm font-semibold ${t.attendance_rate>=90?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":t.attendance_rate>=75?"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400":t.attendance_rate>=60?"bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400":"bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"}`,children:[t.attendance_rate.toFixed(1),"%"]})})]},t.user_id))})]})})]})})]})]})};export{ie as default};
