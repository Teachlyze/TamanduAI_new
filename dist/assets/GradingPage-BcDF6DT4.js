import{r as a,j as e,d as X,c as _,ah as J,bH as K,af as O,a0 as Q,m as W,a2 as Y,z as u,al as Z,g as ee,s as A,o as se}from"./main-Cv3DLBs1.js";import{P as f}from"./PremiumCard-C8PJt07T.js";import{P as L}from"./PremiumButton-DEtqLbhG.js";import{g as S}from"./gradingService-YgLGsU0h.js";import{U as ae}from"./user-B-fEXFdH.js";import{S as re}from"./sparkles-DnEdawYL.js";import{S as te}from"./save-DIxQy3Yi.js";import{f as le}from"./format-BmB7BMvl.js";import{p as oe}from"./pt-BR-CVz3wboC.js";import{A as I}from"./arrow-left-Bz9GyE2M.js";import"./en-US-C1KUdeex.js";import"./toDate-B_SDEMqy.js";const ne=({submission:r,activity:n,onComplete:k,onCancel:j})=>{const[i,v]=a.useState(r?.grade||""),[d,N]=a.useState(r?.feedback||""),[l,C]=a.useState(r?.rubric_scores||{}),[m,b]=a.useState(0),[w,E]=a.useState([]),[h,o]=a.useState(!1),[c,y]=a.useState(null),[p,G]=a.useState(!0),[P,R]=a.useState(!1),g=n?.total_points||100,T=r?.submitted_at&&n?.due_date&&new Date(r.submitted_at)>new Date(n.due_date);a.useEffect(()=>{q(),z(),B()},[]),a.useEffect(()=>{c&&l&&M()},[l]);const q=async()=>{try{const s=await S.getFeedbackTemplates();E(s)}catch(s){console.error("Erro ao carregar templates:",s)}},z=async()=>{try{const s=await S.getRubrics({activityId:n?.id});s&&s.length>0&&y(s[0])}catch(s){console.error("Erro ao carregar rubrica:",s)}},B=()=>{if(!T){b(0);return}const s=Math.ceil((new Date(r.submitted_at)-new Date(n.due_date))/(1e3*60*60*24)),t=Math.min(s*5,50);b(t)},M=()=>{if(!c||!c.criteria)return;let s=0;c.criteria.forEach((t,x)=>{const F=l[x]||0;s+=F}),v(s)},D=(s,t)=>{C({...l,[s]:parseFloat(t)||0})},U=async s=>{try{const t=await S.useFeedbackTemplate(s);N(d+(d?`

`:"")+t.content),o(!1),u.success("Template aplicado")}catch{u.error("Erro ao usar template")}},V=async()=>{if(!i||i<0||i>g){u.error(`Nota deve estar entre 0 e ${g}`);return}if(!d.trim()){u.error("Feedback é obrigatório");return}try{R(!0),await S.gradeSubmission(r.id,{grade:parseFloat(i),feedback:d,rubricScores:l,latePenalty:m}),u.success("Correção salva com sucesso!"),k()}catch(s){console.error("Erro ao salvar correção:",s),u.error("Erro ao salvar correção")}finally{R(!1)}},$=Math.max(0,parseFloat(i||0)-m),H=g>0?($/g*100).toFixed(1):0;return e.jsxs("div",{className:"space-y-6",children:[e.jsx(f,{variant:"elevated",children:e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:n?.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ae,{className:"w-4 h-4"}),e.jsx("span",{children:r?.student?.full_name||"Aluno"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(X,{className:"w-4 h-4"}),e.jsxs("span",{children:["Entregue em ",le(new Date(r?.submitted_at),"PPp",{locale:oe})]})]})]})]}),T&&e.jsxs("div",{className:"whitespace-nowrap inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400",children:[e.jsx(_,{className:"w-5 h-5"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-semibold",children:"Entrega Atrasada"}),e.jsxs("div",{children:["Penalidade: -",m,"%"]})]})]})]})})}),c&&e.jsxs(f,{variant:"elevated",children:[e.jsx("div",{className:"border-b border-border",children:e.jsxs("button",{onClick:()=>G(!p),className:"w-full p-4 flex items-center justify-between hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Rubrica de Avaliação"})]}),p?e.jsx(K,{className:"w-5 h-5"}):e.jsx(O,{className:"w-5 h-5"})]})}),e.jsx(Q,{children:p&&e.jsx(W.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsx("div",{className:"p-6 space-y-4",children:c.criteria.map((s,t)=>e.jsxs("div",{className:"p-4 bg-muted/30 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold mb-1",children:s.name}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]}),e.jsxs("div",{className:"text-sm font-medium text-primary",children:["Peso: ",s.weight,"%"]})]}),s.levels&&s.levels.length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 mb-3",children:s.levels.map((x,F)=>e.jsxs("button",{onClick:()=>D(t,x.score),className:`p-2 rounded-lg border-2 transition-all text-left ${l[t]===x.score?"border-primary bg-primary/10":"border-border hover:border-primary/50"}`,children:[e.jsxs("div",{className:"font-semibold text-sm",children:[x.score," pts"]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:x.description})]},F))}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Pontos:"}),e.jsx("input",{type:"number",min:"0",max:s.weight,value:l[t]||0,onChange:x=>D(t,x.target.value),className:"w-24 px-3 py-2 rounded-lg border border-border bg-white dark:bg-slate-900 text-foreground"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["de ",s.weight]})]})]},t))})})})]}),e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold mb-3",children:"Nota Final"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"number",min:"0",max:g,step:"0.5",value:i,onChange:s=>v(s.target.value),className:"w-full px-4 py-3 text-lg font-bold rounded-lg border-2 border-border bg-white dark:bg-slate-900 text-foreground focus:border-primary focus:ring-2 focus:ring-primary/20",placeholder:"0"})}),e.jsxs("div",{className:"text-2xl font-bold text-muted-foreground",children:["/ ",g]}),e.jsxs("div",{className:"px-6 py-3 rounded-lg bg-gradient-to-br from-primary/10 to-primary/5 border-2 border-primary/20",children:[e.jsxs("div",{className:"text-3xl font-bold text-primary",children:[H,"%"]}),m>0&&e.jsxs("div",{className:"text-xs text-red-600 dark:text-red-400 mt-1",children:["-",m,"% penalidade"]})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("label",{className:"block text-sm font-semibold",children:"Feedback"}),e.jsxs("button",{onClick:()=>o(!h),className:"whitespace-nowrap inline-flex items-center gap-2 px-3 py-1.5 text-sm rounded-lg bg-muted hover:bg-muted/80 transition-colors",children:[e.jsx(re,{className:"w-4 h-4"}),e.jsx("span",{children:"Templates"})]})]}),h&&w.length>0&&e.jsx("div",{className:"mb-3 p-3 bg-muted/30 rounded-lg space-y-2",children:w.slice(0,5).map(s=>e.jsxs("button",{onClick:()=>U(s.id),className:"w-full text-left p-3 rounded-lg border border-border hover:border-primary bg-white dark:bg-slate-900 hover:bg-primary/5 transition-all",children:[e.jsx("div",{className:"font-medium text-sm",children:s.title}),e.jsx("div",{className:"text-xs text-muted-foreground line-clamp-1",children:s.content})]},s.id))}),e.jsx("textarea",{value:d,onChange:s=>N(s.target.value),rows:8,className:"w-full px-4 py-3 rounded-lg border border-border bg-white dark:bg-slate-900 text-foreground resize-none focus:border-primary focus:ring-2 focus:ring-primary/20",placeholder:"Escreva seu feedback detalhado aqui..."}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Seja específico e construtivo em seu feedback."})]})]})}),e.jsxs("div",{className:"flex items-center justify-end gap-3",children:[e.jsx(L,{variant:"outline",leftIcon:Y,onClick:j,disabled:P,className:"whitespace-nowrap inline-flex items-center gap-2",children:e.jsx("span",{children:"Cancelar"})}),e.jsx(L,{variant:"gradient",leftIcon:te,onClick:V,disabled:P,className:"whitespace-nowrap inline-flex items-center gap-2",children:e.jsx("span",{children:P?"Salvando...":"Salvar Correção"})})]})]})},ve=()=>{const{submissionId:r}=Z(),n=ee(),[k,j]=a.useState(!0),[i,v]=a.useState(null),[d,N]=a.useState(null),[l,C]=a.useState(null),[m,b]=a.useState(null);a.useEffect(()=>{r&&w()},[r]);const w=async()=>{try{j(!0),b(null);const{data:o,error:c}=await A.from("submissions").select(`
          *,
          student:student_id (
            id,
            full_name,
            email,
            avatar_url
          )
        `).eq("id",r).single();if(c)throw c;if(!o)throw new Error("Submissão não encontrada");v(o),C(o.student);const{data:y,error:p}=await A.from("activities").select("*").eq("id",o.activity_id).single();if(p)throw p;if(!y)throw new Error("Atividade não encontrada");N(y)}catch(o){console.error("Erro ao carregar dados:",o),b(o.message||"Erro ao carregar dados da submissão"),u.error("Erro ao carregar submissão")}finally{j(!1)}},E=()=>{u.success("Correção salva com sucesso!"),n("/dashboard/grading")},h=()=>{n("/dashboard/grading")};return k?e.jsx(se,{message:"Carregando submissão..."}):m?e.jsx("div",{className:"flex items-center justify-center min-h-screen p-6",children:e.jsx(f,{variant:"elevated",className:"max-w-lg w-full",children:e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(_,{className:"w-16 h-16 mx-auto mb-4 text-red-500"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Erro ao Carregar"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:m}),e.jsxs("button",{onClick:h,className:"whitespace-nowrap inline-flex items-center gap-2 px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{children:"Voltar para Fila"})]})]})})}):!i||!d||!l?e.jsx("div",{className:"flex items-center justify-center min-h-screen p-6",children:e.jsx(f,{variant:"elevated",className:"max-w-lg w-full",children:e.jsxs("div",{className:"p-8 text-center",children:[e.jsx(_,{className:"w-16 h-16 mx-auto mb-4 text-yellow-500"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Dados Incompletos"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Não foi possível carregar todos os dados necessários"}),e.jsxs("button",{onClick:h,className:"whitespace-nowrap inline-flex items-center gap-2 px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors",children:[e.jsx(I,{className:"w-4 h-4"}),e.jsx("span",{children:"Voltar para Fila"})]})]})})}):e.jsx("div",{className:"p-6",children:e.jsx(ne,{submission:i,activity:d,student:l,onComplete:E,onCancel:h})})};export{ve as default};
