import{r as i,j as e,u as J,A as ae,a3 as se}from"./react-vendor-C2HUFn5N.js";import{C as ie,B as f,s as v}from"./lazy-CreateActivityPage.jsx-DYBofU2F.js";import{A as p,a as ne}from"./agora-vendor-BaKsgygX.js";import{b as re,L as P}from"./vendor-react-router-B4Bn0PSh.js";const U="C2RSMGZWEfCkNc9kyA0nVw/y2iAQJUULwmNlA";class oe{constructor(){this.client=null,this.rtmClient=null,this.localAudioTrack=null,this.localVideoTrack=null,this.screenTrack=null,this.isJoined=!1,this.uid=null,this.channel=null}async initRTCClient(){return this.client=p.createClient({mode:"rtc",codec:"vp8"}),this.client}async initRTMClient(t){return this.rtmClient=ne.createInstance(U),this.uid=t.toString(),await this.rtmClient.login({uid:this.uid,token:null}),this.rtmClient}async joinChannel(t,h,l){try{return this.channel=t,await this.client.join(U,t,h,l),[this.localAudioTrack,this.localVideoTrack]=await Promise.all([p.createMicrophoneAudioTrack(),p.createCameraVideoTrack()]),await this.client.publish([this.localAudioTrack,this.localVideoTrack]),await this.rtmClient.createChannel(t).join(),this.isJoined=!0,{audioTrack:this.localAudioTrack,videoTrack:this.localVideoTrack}}catch(r){throw console.error("Failed to join channel:",r),r}}async leaveChannel(){try{if(this.localAudioTrack&&(this.localAudioTrack.stop(),this.localAudioTrack.close()),this.localVideoTrack&&(this.localVideoTrack.stop(),this.localVideoTrack.close()),await this.client.leave(),this.rtmClient){const t=this.rtmClient.getChannel(this.channel);t&&await t.leave(),await this.rtmClient.logout()}this.isJoined=!1,this.channel=null}catch(t){throw console.error("Error leaving channel:",t),t}}async startScreenShare(){try{return this.screenTrack=await p.createScreenVideoTrack({},"disable"),await this.client.unpublish([this.localVideoTrack]),await this.client.publish([this.screenTrack]),this.screenTrack}catch(t){throw console.error("Failed to start screen share:",t),t}}async stopScreenShare(){this.screenTrack&&(await this.client.unpublish([this.screenTrack]),this.screenTrack.close(),this.screenTrack=null,this.localVideoTrack&&await this.client.publish([this.localVideoTrack]))}toggleAudio(){return this.localAudioTrack?(this.localAudioTrack.setEnabled(!this.localAudioTrack.enabled),this.localAudioTrack.enabled):!1}toggleVideo(){return this.localVideoTrack?(this.localVideoTrack.setEnabled(!this.localVideoTrack.enabled),this.localVideoTrack.enabled):!1}setupRemoteUserHandlers(t,h){this.client.on("user-published",async(l,r)=>{await this.client.subscribe(l,r),t&&t(l,r)}),this.client.on("user-unpublished",(l,r)=>{h&&h(l,r)})}}const n=new oe;function ue(){const{meetingId:C}=re(),[t,h]=i.useState(null),[l,r]=i.useState(!0),[S,x]=i.useState(""),[A,V]=i.useState(!1),[k,R]=i.useState(!1),j=i.useRef(null),[z,w]=i.useState([]),[M,W]=i.useState(!0),[E,_]=i.useState(!0),[L,T]=i.useState(!1),[b,H]=i.useState(!1),g=i.useRef(null),y=i.useRef(!1);i.useEffect(()=>{(async()=>{try{r(!0);const{data:s,error:o}=await v.from("meetings").select("*").eq("id",C).maybeSingle();if(o)throw o;h(s)}catch(s){x(s.message||"Falha ao carregar reunião")}finally{r(!1)}})()},[C]),i.useEffect(()=>()=>{k&&n.leaveChannel().catch(()=>{})},[k]);const O=async()=>{if(n.client||await n.initRTCClient(),!n.rtmClient){const{data:a}=await v.auth.getUser(),s=a?.user?.id||Math.floor(Math.random()*1e9);await n.initRTMClient(s)}},X=async()=>{try{if(!t)return;V(!0),await O();const a=t.agora_channel||t.id,{data:s}=await v.auth.getUser(),o=s?.user?.id||Math.floor(Math.random()*1e9),{data:I,error:B}=await v.functions.invoke("generate-agora-token",{body:{channel:a,uid:o}});if(B)throw B;const K=I?.token||I;n.setupRemoteUserHandlers(async(c,u)=>{const m=`remote-${c.uid}`;let d=document.getElementById(m);if(!d){d=document.createElement("div"),d.id=m,d.className="w-full h-48 bg-black rounded-md overflow-hidden";const D=document.getElementById("remote-grid");D&&D.appendChild(d),w(N=>N.find(te=>te.uid===c.uid)?N:[...N,{uid:c.uid,videoContainerId:m}])}u==="video"?c.videoTrack?.play(m):u==="audio"&&c.audioTrack?.play()},c=>{w(m=>m.filter(d=>d.uid!==c.uid));const u=document.getElementById(`remote-${c.uid}`);u?.parentNode&&u.parentNode.removeChild(u)});const{videoTrack:ee}=await n.joinChannel(a,K,o);R(!0),setTimeout(()=>{j.current&&ee?.play(j.current)},0)}catch(a){x(a?.message||"Falha ao entrar na reunião")}finally{V(!1)}},Y=async()=>{try{await n.leaveChannel(),R(!1),w([]),T(!1)}catch(a){x(a?.message||"Falha ao sair da reunião")}},$=()=>{const a=n.toggleAudio();W(a)},q=()=>{const a=n.toggleVideo();_(a)},G=async()=>{try{L?(await n.stopScreenShare(),T(!1)):(await n.startScreenShare(),T(!0))}catch(a){x(a?.message||"Falha ao alternar compartilhamento de tela")}},Q=a=>{y.current=!0;const s=g.current.getContext("2d"),o=g.current.getBoundingClientRect();s.beginPath(),s.moveTo(a.clientX-o.left,a.clientY-o.top)},Z=a=>{if(!y.current)return;const s=g.current.getContext("2d"),o=g.current.getBoundingClientRect();s.lineTo(a.clientX-o.left,a.clientY-o.top),s.strokeStyle="#1f2937",s.lineWidth=2,s.stroke()},F=()=>{y.current=!1};return l?e.jsxs("div",{className:"p-6",children:[e.jsx(J,{className:"w-5 h-5 animate-spin inline-block mr-2"})," Carregando…"]}):S||!t?e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{className:"text-red-600 text-sm",children:S||"Reunião não encontrada"}),e.jsx(P,{to:"/dashboard/meetings",className:"text-blue-600 underline",children:"Voltar para Reuniões"})]}):e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(P,{to:"/dashboard/meetings",className:"inline-flex items-center text-sm text-muted-foreground hover:text-foreground",children:[e.jsx(ae,{className:"w-4 h-4 mr-1"})," Voltar"]}),e.jsx("h1",{className:"text-xl font-semibold",children:t.title||"Reunião"})]})}),e.jsxs(ie,{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Canal"}),e.jsx("div",{className:"font-mono text-sm",children:t.agora_channel||t.id})]}),e.jsx("div",{className:"flex gap-2",children:k?e.jsx(f,{variant:"outline",onClick:Y,children:"Sair"}):e.jsx(f,{onClick:X,disabled:A,children:A?e.jsxs(e.Fragment,{children:[e.jsx(J,{className:"w-4 h-4 mr-2 animate-spin"}),"Entrando…"]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2"})," Entrar"]})})})]}),e.jsx("div",{className:"flex items-center gap-2",children:k&&e.jsxs(e.Fragment,{children:[e.jsxs(f,{size:"sm",variant:M?"outline":"destructive",onClick:$,children:[M?"Mutar":"Desmutar"," áudio"]}),e.jsxs(f,{size:"sm",variant:E?"outline":"destructive",onClick:q,children:[E?"Desligar":"Ligar"," câmera"]}),e.jsx(f,{size:"sm",onClick:G,children:L?"Parar Compart.":"Compartilhar Tela"}),e.jsx(f,{size:"sm",variant:b?"secondary":"outline",onClick:()=>H(a=>!a),children:b?"Fechar Lousa":"Abrir Lousa"})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm mb-1",children:"Seu vídeo"}),e.jsx("div",{ref:j,className:"w-full h-48 bg-black rounded-md overflow-hidden"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm mb-1",children:"Participantes"}),e.jsx("div",{id:"remote-grid",className:"grid grid-cols-1 gap-2",children:z.length===0&&e.jsx("div",{className:"w-full h-48 border rounded-md flex items-center justify-center text-xs text-muted-foreground",children:"Aguardando participantes…"})})]})]}),b&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-sm",children:"Lousa"}),e.jsx("canvas",{ref:g,width:960,height:540,className:"border rounded-md bg-white",onMouseDown:Q,onMouseMove:Z,onMouseUp:F,onMouseLeave:F})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Vídeo e lousa básicos. Integração com whiteboard e mais controles virão na próxima etapa."})]})]})}export{ue as default};
