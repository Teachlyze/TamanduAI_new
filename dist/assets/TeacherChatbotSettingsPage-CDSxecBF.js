import{u as G,r as l,j as e,o as H,a0 as y,B as S,s as c,ac as m}from"./main-Bujpyeg-.js";import{P as f}from"./PremiumCard-BaDWg06v.js";import{P as A}from"./PremiumButton-skKgx_xy.js";import{E as M}from"./EmptyState-CpVlA95H.js";import{B as U}from"./bot-W1aPrpb0.js";import{U as J}from"./upload-C29ldkTX.js";import{C as P}from"./circle-check-big-CPiXxACV.js";const ee=()=>{const{user:o}=G(),[z,w]=l.useState(!0),[$,D]=l.useState([]),[i,I]=l.useState(""),[x,g]=l.useState([]),[_,N]=l.useState([]),[u,v]=l.useState([]),[p,C]=l.useState(new Set),[h,E]=l.useState(new Set),[j,k]=l.useState(!1),[q,B]=l.useState(!1);l.useEffect(()=>{(async()=>{if(o?.id){w(!0);try{const{data:a}=await c.from("classes").select("id, name").eq("created_by",o.id).eq("is_active",!0);D(a||[])}finally{w(!1)}}})()},[o?.id]),l.useEffect(()=>{if(!i){g([]),N([]),v([]);return}(async()=>{const{data:a}=await c.from("class_materials").select("id, title, file_url, file_type").eq("class_id",i);g(a||[]);const{data:s}=await c.from("activity_class_assignments").select("activity:activities(id, title, description, instructions)").eq("class_id",i);N((s||[]).map(n=>n.activity).filter(Boolean));const{data:d}=await c.from("rag_training_sources").select("id, file_name, file_type, embedding_status, material_id, activity_id").eq("class_id",i).eq("is_active",!0);v(d||[]);const r=new Set(d.filter(n=>n.material_id).map(n=>n.material_id)),b=new Set(d.filter(n=>n.activity_id).map(n=>n.activity_id));C(r),E(b)})()},[i]);const F=async t=>{const a=t.target.files?.[0];if(!(!a||!i)){k(!0);try{const s=a.name.split(".").pop(),d=`${i}/${Date.now()}_${a.name}`,{error:r}=await c.storage.from("materials").upload(d,a);if(r)throw r;const{data:b}=c.storage.from("materials").getPublicUrl(d),n=b?.publicUrl||null,{data:R,error:T}=await c.from("class_materials").insert({class_id:i,title:a.name,file_url:n,file_type:s,file_size:a.size,uploaded_by:o.id,created_by:o.id}).select().maybeSingle();if(T)throw T;g(O=>[...O,R]),m.success?.("Material enviado com sucesso!")}catch(s){console.error("Erro ao enviar material:",s),m.error?.("Erro ao enviar material")}finally{k(!1)}}},L=async()=>{if(i){B(!0);try{const t=[];for(const a of p){const s=x.find(r=>r.id===a);if(!s)continue;u.find(r=>r.material_id===a)||t.push({class_id:i,material_id:a,file_url:s.file_url,file_name:s.title,file_type:s.file_type,added_by:o.id,embedding_status:"pending"})}for(const a of h){const s=_.find(r=>r.id===a);if(!s)continue;u.find(r=>r.activity_id===a)||t.push({class_id:i,activity_id:a,file_url:`activity://${a}`,file_name:s.title,file_type:"text",added_by:o.id,embedding_status:"pending",content_extracted:[s.description,s.instructions].filter(Boolean).join(`
`)})}if(t.length>0){const{error:a}=await c.from("rag_training_sources").insert(t);if(a)throw a;m.success?.(`${t.length} fontes adicionadas para treinamento!`);const{data:s}=await c.from("rag_training_sources").select("id, file_name, file_type, embedding_status, material_id, activity_id").eq("class_id",i).eq("is_active",!0);v(s||[])}else m.success?.("Todas as fontes selecionadas já estão treinadas!")}catch(t){console.error("Erro ao treinar chatbot:",t),m.error?.("Erro ao treinar chatbot")}finally{B(!1)}}};return z?e.jsx(H,{message:"Carregando configurações..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-purple-600 to-pink-600 p-8 rounded-2xl text-white",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-3",children:[e.jsx(U,{className:"w-6 h-6"})," Configurações do Chatbot"]}),e.jsx("p",{className:"text-white/90",children:"Selecione a turma e os materiais para treinar o chatbot"})]}),e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-3",children:[e.jsx("h2",{className:"text-lg font-bold",children:"1. Selecione a Turma"}),e.jsxs("select",{className:"w-full px-4 py-3 rounded-lg border border-border bg-background",value:i,onChange:t=>I(t.target.value),children:[e.jsx("option",{value:"",children:"-- Escolha uma turma --"}),$.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})}),i&&e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-3",children:[e.jsx("h2",{className:"text-lg font-bold",children:"2. Enviar Novo Material"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"file",onChange:F,disabled:j,accept:".pdf,.doc,.docx,.txt"}),e.jsx(A,{disabled:j,leftIcon:J,children:j?"Enviando...":"Upload"})]})]})}),e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-3",children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2",children:[e.jsx(y,{className:"w-5 h-5"})," 3. Selecione Materiais"]}),x.length===0?e.jsx(M,{icon:y,title:"Sem materiais",description:"Envie materiais para esta turma."}):e.jsx("div",{className:"space-y-2",children:x.map(t=>e.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:p.has(t.id),onChange:a=>{const s=new Set(p);a.target.checked?s.add(t.id):s.delete(t.id),C(s)}}),e.jsx(y,{className:"w-4 h-4"}),e.jsx("span",{className:"flex-1",children:t.title}),u.find(a=>a.material_id===t.id)&&e.jsx(P,{className:"w-4 h-4 text-green-600"})]},t.id))})]})}),e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-3",children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5"})," 4. Selecione Atividades"]}),_.length===0?e.jsx(M,{icon:S,title:"Sem atividades",description:"Crie atividades para esta turma."}):e.jsx("div",{className:"space-y-2",children:_.map(t=>e.jsxs("label",{className:"flex items-center gap-3 p-3 rounded-lg border border-border hover:bg-muted/50 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:h.has(t.id),onChange:a=>{const s=new Set(h);a.target.checked?s.add(t.id):s.delete(t.id),E(s)}}),e.jsx(S,{className:"w-4 h-4"}),e.jsx("span",{className:"flex-1",children:t.title}),u.find(a=>a.activity_id===t.id)&&e.jsx(P,{className:"w-4 h-4 text-green-600"})]},t.id))})]})}),e.jsx(f,{variant:"elevated",children:e.jsx("div",{className:"p-6",children:e.jsx(A,{variant:"gradient",onClick:L,disabled:q||p.size===0&&h.size===0,leftIcon:U,className:"w-full",children:q?"Treinando...":"Treinar / Atualizar Chatbot"})})})]})]})};export{ee as default};
