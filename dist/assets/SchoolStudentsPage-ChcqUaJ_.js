import{u as oe,g as ce,r as i,z as de,s as _,j as e,o as me,U as ue,e as xe,k,A as ge,ai as he,K as ve,aO as B,aP as I,aQ as L,aR as M,aS as d,m as fe,B as pe,d as je,C as Ne,O as we,T as Se}from"./main-BTTCSkdE.js";import{s as C}from"./schoolService-txoXdLN3.js";import{S as x,P as F}from"./PremiumCard-CV5gJlVo.js";import{P}from"./PremiumButton-TaG2j_oH.js";import{E as Ae}from"./EmptyState-j91SMhTI.js";import{B as g}from"./badge-BTDSVm_c.js";import{a as be,e as ye}from"./exportUtils-cJTPDm3y.js";import{D as R}from"./download-BRB6ZsEm.js";import{T as O}from"./triangle-alert-h67Np2YJ.js";import{G as _e}from"./graduation-cap-e4ttO3Rz.js";import{T as Ce}from"./trending-down-BhCLR9zz.js";import"./jspdf.es.min-BQMzH5Qd.js";import"./typeof-QjJsDpFa.js";import"./jspdf.plugin.autotable-DaH8ixQg.js";import"./xlsx-CY9XdSij.js";const Ve=()=>{const{user:w}=oe(),U=ce(),[q,T]=i.useState(!0),[l,G]=i.useState([]),[p,V]=i.useState([]),[h,$]=i.useState(""),[j,z]=i.useState("all"),[n,H]=i.useState("all"),[K,Q]=i.useState([]),[m,W]=i.useState({total:0,active:0,inactive:0,averageGrade:0,topPerformers:0,needsAttention:0});i.useEffect(()=>{w&&J()},[w]),i.useEffect(()=>{ee()},[l,h,j,n]);const J=async()=>{try{T(!0);const a=await C.getUserSchool(w.id);if(!a?.id)throw new Error("Nenhuma escola associada ao usuário");await Promise.all([Y(a.id),X(a.id),Z()])}catch(a){console.error("Erro ao carregar dados:",a),de.error("Erro ao carregar dados dos alunos")}finally{T(!1)}},X=async a=>{try{const o=(await C.getClasses(a)||[]).map(c=>({id:c.id,name:c.name,subject:c.subject}));Q(o)}catch(s){console.error("Erro ao carregar turmas:",s)}},Y=async a=>{try{const o=(await C.getClasses(a)||[]).map(t=>t.id);if(!o||o.length===0){G([]);return}const{data:c,error:N}=await _.from("class_members").select(`
          user_id,
          class_id,
          joined_at,
          role,
          classes (
            id,
            name,
            subject
          ),
          profiles:user_id (
            id,
            full_name,
            avatar_url,
            created_at
          )
        `).in("class_id",o).eq("role","student");if(N)throw N;const S=await Promise.all((c||[]).map(async t=>{const A=t.user_id,{data:v}=await _.from("submissions").select("grade, submitted_at, activity_id, activities(max_score)").eq("student_id",A).not("grade","is",null),u=v?.map(r=>r.grade)||[],ie=u.length>0?u.reduce((r,f)=>r+f,0)/u.length:0,b=u.slice(-3),y=u.slice(-6,-3),E=b.length>0?b.reduce((r,f)=>r+f,0)/b.length:0,D=y.length>0?y.reduce((r,f)=>r+f,0)/y.length:0,le=E>D?"up":E<D?"down":"stable",{count:ne}=await _.from("activity_class_assignments").select("activity_id",{count:"exact",head:!0}).eq("class_id",t.class_id).not("activity_id","in",`(${v?.map(r=>r.activity_id).join(",")||"0"})`);return{id:t.user_id,name:t.profiles?.full_name||"Aluno",avatar:t.profiles?.avatar_url,class:t.classes,joinedAt:t.joined_at,createdAt:t.profiles?.created_at,averageGrade:Math.round(ie*10)/10,totalSubmissions:v?.length||0,pendingActivities:ne||0,trend:le,isActive:u.length>0,lastActivity:v?.length>0?new Date(Math.max(...v.map(r=>new Date(r.submitted_at)))):null}}));G(S)}catch(s){throw console.error("Erro ao carregar alunos:",s),s}},Z=async()=>{};i.useEffect(()=>{if(l.length>0){const a=l.length,s=l.filter(t=>t.isActive).length,o=a-s,c=l.reduce((t,A)=>t+A.averageGrade,0)/a,N=l.filter(t=>t.averageGrade>=8).length,S=l.filter(t=>t.averageGrade<6||t.pendingActivities>3).length;W({total:a,active:s,inactive:o,averageGrade:Math.round(c*10)/10,topPerformers:N,needsAttention:S})}},[l]);const ee=()=>{let a=[...l];h&&(a=a.filter(s=>s.name.toLowerCase().includes(h.toLowerCase())||s.class?.name.toLowerCase().includes(h.toLowerCase()))),j!=="all"&&(a=a.filter(s=>s.class?.id===j)),n!=="all"&&(n==="active"?a=a.filter(s=>s.isActive):n==="inactive"?a=a.filter(s=>!s.isActive):n==="top"?a=a.filter(s=>s.averageGrade>=8):n==="attention"&&(a=a.filter(s=>s.averageGrade<6||s.pendingActivities>3))),V(a)},ae=()=>{const a=p.map(s=>({Nome:s.name,Turma:s.class?.name||"",Média:s.averageGrade,Submissões:s.totalSubmissions,Pendentes:s.pendingActivities,Status:s.isActive?"Ativo":"Inativo","Último Acesso":s.lastActivity?s.lastActivity.toLocaleDateString("pt-BR"):"Nunca"}));be(a,`alunos_escola_${new Date().toISOString().split("T")[0]}`,"Alunos")},se=()=>{const a=p.map(s=>({Nome:s.name,Turma:s.class?.name||"",Média:s.averageGrade,Submissões:s.totalSubmissions,Pendentes:s.pendingActivities,Status:s.isActive?"Ativo":"Inativo","Último Acesso":s.lastActivity?s.lastActivity.toLocaleDateString("pt-BR"):"Nunca"}));ye(a,`alunos_escola_${new Date().toISOString().split("T")[0]}`,"Alunos da Escola",["Nome","Turma","Média","Submissões","Pendentes","Status","Último Acesso"])},te=a=>{switch(a){case"up":return e.jsx(Se,{className:"w-4 h-4 text-green-500"});case"down":return e.jsx(Ce,{className:"w-4 h-4 text-red-500"});default:return e.jsx(k,{className:"w-4 h-4 text-gray-500"})}},re=a=>a>=9?e.jsx(g,{className:"bg-green-100 text-green-700",children:"Excelente"}):a>=8?e.jsx(g,{className:"bg-blue-100 text-blue-700",children:"Muito Bom"}):a>=7?e.jsx(g,{className:"bg-yellow-100 text-yellow-700",children:"Bom"}):a>=6?e.jsx(g,{className:"bg-orange-100 text-orange-700",children:"Regular"}):e.jsx(g,{className:"bg-red-100 text-red-700",children:"Precisa Atenção"});return q?e.jsx(me,{}):e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-green-600 to-teal-600 bg-clip-text text-transparent",children:"Alunos da Escola"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Gerencie e acompanhe o desempenho dos alunos"})]}),e.jsx("div",{className:"flex gap-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{onClick:ae,variant:"outline",className:"whitespace-nowrap inline-flex items-center gap-2 bg-white dark:bg-slate-900 text-foreground border-border hover:bg-slate-50 dark:hover:bg-slate-800",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"Excel"})]}),e.jsxs(P,{onClick:se,variant:"outline",className:"whitespace-nowrap inline-flex items-center gap-2 bg-white dark:bg-slate-900 text-foreground border-border hover:bg-slate-50 dark:hover:bg-slate-800",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"PDF"})]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4",children:[e.jsx(x,{title:"Total de Alunos",value:m.total,icon:ue,gradient:"from-blue-500 to-cyan-500"}),e.jsx(x,{title:"Alunos Ativos",value:m.active,icon:xe,gradient:"from-green-500 to-emerald-500"}),e.jsx(x,{title:"Inativos",value:m.inactive,icon:O,gradient:"from-orange-500 to-red-500"}),e.jsx(x,{title:"Média Geral",value:m.averageGrade,icon:k,gradient:"from-purple-500 to-pink-500"}),e.jsx(x,{title:"Top Performers",value:m.topPerformers,icon:ge,gradient:"from-yellow-500 to-orange-500"}),e.jsx(x,{title:"Precisam Atenção",value:m.needsAttention,icon:O,gradient:"from-red-500 to-pink-500"})]}),e.jsx(F,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground w-4 h-4"}),e.jsx(ve,{placeholder:"Buscar por nome ou turma...",value:h,onChange:a=>$(a.target.value),className:"pl-10"})]})}),e.jsxs(B,{value:j,onValueChange:z,children:[e.jsx(I,{className:"w-full md:w-48",children:e.jsx(L,{placeholder:"Filtrar por turma"})}),e.jsxs(M,{children:[e.jsx(d,{value:"all",children:"Todas as turmas"}),K.map(a=>e.jsx(d,{value:a.id,children:a.name},a.id))]})]}),e.jsxs(B,{value:n,onValueChange:H,children:[e.jsx(I,{className:"w-full md:w-48",children:e.jsx(L,{placeholder:"Filtrar por status"})}),e.jsxs(M,{children:[e.jsx(d,{value:"all",children:"Todos os status"}),e.jsx(d,{value:"active",children:"Ativos"}),e.jsx(d,{value:"inactive",children:"Inativos"}),e.jsx(d,{value:"top",children:"Top Performers"}),e.jsx(d,{value:"attention",children:"Precisam Atenção"})]})]})]})}),e.jsx(F,{className:"p-6",children:p.length===0?e.jsx(Ae,{icon:_e,title:"Nenhum aluno encontrado",description:"Não há alunos que correspondam aos filtros selecionados."}):e.jsx("div",{className:"space-y-4",children:p.map(a=>e.jsxs(fe.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex items-center justify-between p-4 border border-border rounded-xl hover:bg-muted/50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-gradient-to-br from-green-500 to-teal-500 flex items-center justify-center text-white font-bold",children:a.avatar?e.jsx("img",{src:a.avatar,alt:a.name,className:"w-full h-full rounded-full object-cover"}):a.name.charAt(0).toUpperCase()}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold",children:a.name}),te(a.trend)]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(pe,{className:"w-4 h-4"}),a.class?.name||"Sem turma"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(je,{className:"w-4 h-4"}),"Entrou em ",new Date(a.joinedAt).toLocaleDateString("pt-BR")]}),a.lastActivity&&e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Ne,{className:"w-4 h-4"}),"Último acesso: ",a.lastActivity.toLocaleDateString("pt-BR")]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:a.averageGrade}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Média"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold",children:a.totalSubmissions}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Submissões"})]}),a.pendingActivities>0&&e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-lg font-semibold text-orange-600",children:a.pendingActivities}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Pendentes"})]}),e.jsxs("div",{className:"flex flex-col gap-2",children:[re(a.averageGrade),e.jsx(g,{className:a.isActive?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700",children:a.isActive?"Ativo":"Inativo"})]}),e.jsx(P,{size:"sm",variant:"outline",leftIcon:we,onClick:()=>U(`/students/${a.id}`),children:"Ver Perfil"})]})]},a.id))})})]})};export{Ve as default};
