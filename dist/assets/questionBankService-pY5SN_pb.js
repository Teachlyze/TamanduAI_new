import{s as o}from"./main-NgjJy_CG.js";const i=async t=>{try{const{data:{user:e}}=await o.auth.getUser();if(!e)throw new Error("Usuário não autenticado");const{data:s,error:r}=await o.from("question_bank").insert({author_id:e.id,title:t.title,question_text:t.question_text,question_type:t.question_type,options:t.options||null,correct_answer:t.correct_answer,explanation:t.explanation,difficulty:t.difficulty,subject:t.subject,topic:t.topic,tags:t.tags||[],reference:t.reference,visibility:t.visibility||"public",school_id:t.school_id||null,status:"pending",points:t.points||10}).select().single();if(r)throw r;return{success:!0,data:s}}catch(e){return console.error("Erro ao criar questão:",e),{success:!1,error:e.message}}},u=async(t={})=>{try{let e=o.from("question_bank").select(`
        *,
        profiles:author_id(full_name)
      `);t.subject&&(e=e.eq("subject",t.subject)),t.topic&&(e=e.ilike("topic",`%${t.topic}%`)),t.difficulty&&(e=e.eq("difficulty",t.difficulty)),t.questionType&&(e=e.eq("question_type",t.questionType)),t.status&&(e=e.eq("status",t.status)),t.visibility&&(e=e.eq("visibility",t.visibility)),t.tags&&t.tags.length>0&&(e=e.contains("tags",t.tags)),t.authorId&&(e=e.eq("author_id",t.authorId)),t.schoolId&&(e=e.eq("school_id",t.schoolId)),t.status||(e=e.eq("status","approved"));const{data:s,error:r}=await e.order("created_at",{ascending:!1});if(r)throw r;return{success:!0,data:s||[]}}catch(e){return console.error("Erro ao buscar questões:",e),{success:!1,error:e.message,data:[]}}},d=async(t,e=null)=>{try{const{data:s,error:r}=await o.from("question_bank").update({status:"approved",approved_at:new Date().toISOString(),moderator_notes:e}).eq("id",t).select().single();if(r)throw r;return await f(s.author_id),{success:!0,data:s}}catch(s){return console.error("Erro ao aprovar questão:",s),{success:!1,error:s.message}}},l=async(t,e)=>{try{const{data:s,error:r}=await o.from("question_bank").update({status:"rejected",moderator_notes:e}).eq("id",t).select().single();if(r)throw r;return{success:!0,data:s}}catch(s){return console.error("Erro ao rejeitar questão:",s),{success:!1,error:s.message}}},f=async t=>{try{const{count:e}=await o.from("question_bank").select("*",{count:"exact",head:!0}).eq("author_id",t).eq("status","approved"),s=Math.min(25,Math.floor(e/50)*2);return await o.from("profiles").update({questions_contributed:e,discount_percentage:s}).eq("id",t),e}catch(e){return console.error("Erro ao incrementar contribuições:",e),0}},h=async t=>{try{const{data:e}=await o.from("question_bank").select("status, uses_count").eq("author_id",t);return e?{total:e.length,approved:e.filter(r=>r.status==="approved").length,pending:e.filter(r=>r.status==="pending").length,rejected:e.filter(r=>r.status==="rejected").length,totalUses:e.reduce((r,a)=>r+(a.uses_count||0),0),discountEarned:Math.min(25,Math.floor(e.filter(r=>r.status==="approved").length/50)*2)}:null}catch(e){return console.error("Erro ao buscar stats do autor:",e),null}},q=async t=>{try{const{error:e}=await o.rpc("increment_question_uses",{question_id:t});if(e){const{data:s}=await o.from("question_bank").select("uses_count").eq("id",t).single();await o.from("question_bank").update({uses_count:(s?.uses_count||0)+1}).eq("id",t)}return{success:!0}}catch(e){return console.error("Erro ao registrar uso:",e),{success:!1}}},_=async(t,e)=>{try{const{data:{user:s}}=await o.auth.getUser();if(!s)throw new Error("Usuário não autenticado");const{data:r,error:a}=await o.from("question_feedback").insert({question_id:t,user_id:s.id,rating:e.rating,comment:e.comment,issue_type:e.issueType}).select().single();if(a)throw a;return{success:!0,data:r}}catch(s){return console.error("Erro ao enviar feedback:",s),{success:!1,error:s.message}}},g=async t=>{try{const{data:e}=await o.from("question_bank").select("uses_count, correct_rate").eq("id",t).single(),{data:s}=await o.from("question_feedback").select("rating").eq("question_id",t),r=s&&s.length>0?s.reduce((a,n)=>a+n.rating,0)/s.length:0;return{usesCount:e?.uses_count||0,correctRate:e?.correct_rate||0,avgRating:Math.round(r*10)/10,totalFeedbacks:s?.length||0}}catch(e){return console.error("Erro ao buscar stats da questão:",e),null}},p=async(t,e={})=>{try{const{data:s}=await o.from("user_question_attempts").select("question_id, is_correct, difficulty").eq("user_id",t).order("attempted_at",{ascending:!1}).limit(20);let r=3;if(s&&s.length>5){const n=s.slice(0,5).filter(c=>c.is_correct).length;n>=4?r=Math.min(5,(s[0]?.difficulty||3)+1):n<=1&&(r=Math.max(1,(s[0]?.difficulty||3)-1))}const{data:a}=await o.from("question_bank").select("*").eq("status","approved").eq("difficulty",r).eq("subject",e.subject||"").not("id","in",s?.map(n=>n.question_id)||[]).limit(10);return{success:!0,questions:a||[],targetDifficulty:r,recommendation:r>3?"Desafiante":r<3?"Revisão":"Adequado"}}catch(s){return console.error("Erro ao buscar questões adaptativas:",s),{success:!1,questions:[]}}},y=async t=>{try{let e=o.from("question_bank").select("*").eq("status","approved");t.subject&&(e=e.eq("subject",t.subject)),t.difficulty&&(e=e.eq("difficulty",t.difficulty)),t.questionType&&(e=e.eq("question_type",t.questionType));const{data:s}=await e;if(!s||s.length===0)return{success:!1,message:"Nenhuma questão encontrada"};const r=Math.min(t.count||10,s.length);return{success:!0,questions:s.sort(()=>.5-Math.random()).slice(0,r),totalAvailable:s.length}}catch(e){return console.error("Erro ao gerar quiz:",e),{success:!1,message:"Erro ao gerar quiz"}}},b={createQuestion:i,searchQuestions:u,approveQuestion:d,rejectQuestion:l,getAuthorStats:h,recordQuestionUse:q,submitQuestionFeedback:_,getQuestionStats:g,getAdaptiveQuestions:p,generateRandomQuiz:y};export{b as q};
