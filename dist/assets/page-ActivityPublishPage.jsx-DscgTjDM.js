import{r as A,j as e,aq as ae,D as te,A as re,B as se,V as ie,K as ne,u as oe,y as ce}from"./react-vendor-C2HUFn5N.js";import{c as U,B as j,s as m,a as le,u as de,C as G,b as Y,d as z,e as V,j as E,I as $,T as F}from"./lazy-CreateActivityPage.jsx-DYBofU2F.js";import{a as me,e as ue,b as pe,c as O,p as L,d as he,h as fe,j as ge,k as ye}from"./utils-vendor-DsQmHAQY.js";import{$ as ve,a0 as Ne,a1 as xe,a2 as Q}from"./ui-vendor-Dv2DrOQv.js";import{C as we}from"./page-ActivityPage.jsx-DC3PjPXz.js";import{B as be}from"./page-ActivityManagementPage.jsx-C56hp2jB.js";import{b as _e,u as Se}from"./vendor-react-router-B4Bn0PSh.js";const Ae=({mode:a="single",selected:t,onSelect:r,initialFocus:i=!1,className:n,...s})=>{const[l,o]=A.useState(new Date),p=me(l),x=ue(l),v=pe({start:p,end:x}),N=p.getDay(),b=Array.from({length:N},(f,d)=>null).concat(v),c=f=>{f&&(a==="single"||a==="multiple")&&r?.(f)},_=()=>{o(f=>fe(f))},T=()=>{o(f=>ge(f,1))},w=f=>!t||!f?!1:ye(t,f);return e.jsxs("div",{className:U("p-3 bg-white border rounded-lg shadow-lg",n),...s,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(j,{variant:"ghost",size:"sm",onClick:_,className:"h-8 w-8 p-0",children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("h2",{className:"text-sm font-semibold text-gray-900",children:O(l,"MMMM yyyy",{locale:L})}),e.jsx(j,{variant:"ghost",size:"sm",onClick:T,className:"h-8 w-8 p-0",children:e.jsx(te,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Dom","Seg","Ter","Qua","Qui","Sex","S√°b"].map(f=>e.jsx("div",{className:"h-8 w-8 flex items-center justify-center text-xs font-medium text-gray-500",children:f},f))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:b.map((f,d)=>{if(!f)return e.jsx("div",{className:"h-8 w-8"},`empty-${d}`);const u=he(f,l),P=w(f);return e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>c(f),className:U("h-8 w-8 p-0 text-xs font-normal hover:bg-blue-100 hover:text-blue-900",!u&&"text-gray-300 hover:text-gray-400",P&&"bg-blue-600 text-white hover:bg-blue-700 hover:text-white"),children:O(f,"d")},f.toISOString())})})]})},je=ve,Ce=Ne,J=A.forwardRef(({className:a,align:t="center",sideOffset:r=4,...i},n)=>e.jsx(xe,{children:e.jsx(Q,{ref:n,align:t,sideOffset:r,className:U("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none animate-in data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a),...i})}));J.displayName=Q.displayName;const Ie={MEETING:"meeting",EVENT:"event",ASSIGNMENT:"assignment",ANNOUNCEMENT:"announcement",SYSTEM:"system",FEEDBACK:"feedback",REMINDER:"reminder",GRADE:"grade",SUBMISSION:"submission",COMMENT:"comment",MENTION:"mention",APPROVAL:"approval",ALERT:"alert"},R={LOW:"low",NORMAL:"normal",HIGH:"high",URGENT:"urgent"},k={async getNotifications({types:a,categories:t,priorities:r,unreadOnly:i,limit:n=50,offset:s=0,orderBy:l="created_at",orderDir:o="desc"}={}){try{if(n<1||n>100)throw new Error("Limit must be between 1 and 100");if(s<0)throw new Error("Offset cannot be negative");const{data:p,error:x}=await m.auth.getUser();if(x)throw console.error("Authentication error:",x),new Error("Failed to authenticate user");const v=p.user?.id;if(!v)throw new Error("No user is currently signed in");let N=m.from("notifications").select("id, title, message, type, category, priority, reference_id, reference_type, action_url, is_read, read_at, created_at, updated_at",{count:"exact"}).eq("user_id",v);if(a&&a.length>0){const w=Array.isArray(a)?a:[a];if(w.some(f=>typeof f!="string"))throw new Error("All types must be strings");N=N.in("type",w)}if(t){const w=Array.isArray(t)?t:[t];N=N.in("category",w)}if(r){const w=Array.isArray(r)?r:[r];N=N.in("priority",w)}i!==void 0&&(N=N.eq("is_read",!i)),N=N.order(l,{ascending:o.toLowerCase()==="asc"}).range(s,s+n-1);const{data:b,error:c,count:_}=await N;if(c)throw c;const T=b.map(w=>({...w,created_at:new Date(w.created_at),updated_at:w.updated_at?new Date(w.updated_at):null,referenceId:w.reference_id,referenceType:w.reference_type,actionUrl:w.action_url,isRead:w.is_read,readAt:w.read_at}));return{data:T,count:_||0,hasMore:s+T.length<(_||0),error:null}}catch(p){return console.error("Error in getNotifications:",p),{data:[],count:0,hasMore:!1,error:p instanceof Error?p:new Error(String(p))}}},async markAsUnread(a,{userId:t}={}){if(!a)return console.error("markAsUnread error: Notification IDs are required"),{success:!1,message:"Notification IDs are required",affected:0,data:null,error:new Error("Notification IDs are required")};const r=Array.isArray(a)?a:[a];if(r.some(n=>typeof n!="string"||!n.trim())){const n=new Error("Invalid notification ID format");return console.error("markAsUnread error:",n.message),{success:!1,message:n.message,affected:0,data:null,error:n}}const i={is_read:!1,read_at:null,updated_at:new Date().toISOString()};try{try{const{data:o,error:p}=await m.rpc("bulk_update_notifications",{p_notification_ids:r,p_is_read:!1,p_user_id:t||void 0});if(!p)return{success:!0,message:"Notifications marked as unread successfully",affected:o?.length||0,data:o,error:null};console.warn("bulk_update_notifications RPC failed, falling back to direct update:",p)}catch(o){console.warn("Error calling bulk_update_notifications RPC, falling back to direct update:",o)}let n=m.from("notifications").update(i).in("id",r);if(t){if(typeof t!="string"||!t.trim())throw new Error("Invalid user ID format");n=n.eq("user_id",t)}const{data:s,error:l}=await n;if(l)throw l;return{success:!0,message:"Notifications marked as unread successfully",affected:s?.length||0,data:s,error:null}}catch(n){const s=n instanceof Error?n.message:"Unknown error occurred";return console.error("Error in markAsUnread:",s,n),{success:!1,message:s,affected:0,data:null,error:n instanceof Error?n:new Error(s)}}},async markAllAsRead(){const{error:a}=await m.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("is_read",!1);if(a)throw a;return!0},async deleteNotification(a,{userId:t}={}){const r=Array.isArray(a)?a:[a],{data:i,error:n}=await m.rpc("bulk_delete_notifications",{p_notification_ids:r,p_user_id:t||void 0});if(n)throw n;return i},async getNotificationStats(){const{data:a,error:t}=await m.rpc("get_user_notification_stats",{p_user_id:m.auth.user()?.id});if(t)throw t;const r=typeof a=="string"?JSON.parse(a):a;return{total:r.total||0,unread:r.unread||0,read:r.read||0,types:r.types||{},lastNotificationAt:r.last_notification_at||null}},async getUnreadCount(){return(await this.getNotificationStats()).unread||0},async deleteAllNotifications({readOnly:a=!1,type:t}={}){let r=m.from("notifications").delete();a&&(r=r.eq("is_read",!0)),t&&(r=r.eq("type",t));const{error:i}=await r;if(i)throw i;return!0},async getNotificationPreferences(){const{data:a,error:t}=await m.from("notification_preferences").select("*").single();if(t&&t.code==="PGRST116")return this.createDefaultPreferences();if(t)throw t;return a},async updateNotificationPreferences(a){const{data:t,error:r}=await m.from("notification_preferences").upsert(a,{onConflict:"user_id"}).select().single();if(r)throw r;return t},async createDefaultPreferences(){const a={email_notifications:!0,push_notifications:!0,in_app_notifications:!0,email_frequency:"immediate"},{data:t,error:r}=await m.from("notification_preferences").insert(a).select().single();if(r)throw r;return t},async subscribeToNotifications(a){const{data:{user:t}}=await m.auth.getUser(),r=t?.id;if(!r)return()=>{};const i=m.channel("notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${r}`},n=>{typeof a=="function"&&a(n.new)}).subscribe();return()=>{m.removeChannel(i)}},async scheduleNotification(a,t=null,r=null){const{title:i,message:n,type:s,category:l,priority:o=R.NORMAL,referenceId:p,referenceType:x,actionUrl:v,metadata:N={}}=a;if(!Object.values(Ie).includes(s))throw new Error(`Invalid notification type: ${s}`);if(o&&!Object.values(R).includes(o))throw new Error(`Invalid priority: ${o}`);const b={title:i,message:n,type:s,category:l||null,priority:o,reference_id:p||null,reference_type:x||null,action_url:v||null,metadata:Object.keys(N).length>0?N:null,scheduled_for:t?t instanceof Date?t.toISOString():t:null,user_id:r||m.auth.user()?.id},{data:c,error:_}=await m.from("notifications").insert(b).select().single();if(_)throw _;return c},async sendNotification(a,t=null){return this.scheduleNotification(a,null,t)},async sendBatchNotifications(a,t=null){if(!Array.isArray(a)||a.length===0)return[];const r=t||m.auth.user()?.id,i=new Date().toISOString(),n=a.map(o=>({title:o.title,message:o.message,type:o.type,category:o.category||null,priority:o.priority||R.NORMAL,reference_id:o.referenceId||null,reference_type:o.referenceType||null,action_url:o.actionUrl||null,metadata:o.metadata||null,user_id:r,created_at:i,updated_at:i})),{data:s,error:l}=await m.from("notifications").insert(n).select();if(l)throw l;return s||[]},async scheduleReminder({type:a,eventId:t,dueAt:r,notification:i,remindBeforeMinutes:n=15,userId:s=null}){if(!s){const{data:x,error:v}=await m.auth.getUser();if(v)throw v;if(s=x.user?.id,!s)throw new Error("No user is currently signed in")}const l=typeof r=="string"?new Date(r):r,o=new Date(l.getTime()-n*60*1e3);if(o<new Date)return null;const p={...i,metadata:{...i.metadata,isReminder:!0,eventType:a,eventId:t,originalDueAt:l.toISOString(),remindBeforeMinutes:n}};return await this.scheduleNotification(p,o,s)},async markAsRead(a,{userId:t}={}){if(!a)return console.error("markAsRead error: Notification IDs are required"),{success:!1,message:"Notification IDs are required",affected:0,data:null,error:new Error("Notification IDs are required")};const r=Array.isArray(a)?a:[a];if(r.some(i=>typeof i!="string"||!i.trim())){const i=new Error("Invalid notification ID format");return console.error("markAsRead error:",i.message),{success:!1,message:i.message,affected:0,data:null,error:i}}try{const i={is_read:!0,read_at:new Date().toISOString(),updated_at:new Date().toISOString()};try{const{data:p,error:x}=await m.rpc("bulk_update_notifications",{p_notification_ids:r,p_is_read:!0,p_user_id:t||void 0});if(!x)return{success:!0,message:"Notifications marked as read successfully",affected:p?.length||0,data:p,error:null};console.warn("bulk_update_notifications RPC failed, falling back to direct update:",x)}catch(p){console.warn("Error calling bulk_update_notifications RPC, falling back to direct update:",p)}let n=m.from("notifications").update(i).in("id",r);if(t){if(typeof t!="string"||!t.trim())throw new Error("Invalid user ID format");n=n.eq("user_id",t)}const{data:s,error:l,count:o}=await n;if(l)throw console.error("Database error marking notifications as read:",l),new Error(`Failed to update notifications: ${l.message}`);return console.log(`Successfully marked ${o||0} notification(s) as read`),{success:!0,count:o||0,data:s,error:null}}catch(i){return console.error("Error in markAsRead:",i),{success:!1,count:0,data:null,error:i instanceof Error?i:new Error(String(i))}}},async getScheduledNotifications({includeExecuted:a=!1,referenceId:t,referenceType:r,limit:i=50,offset:n=0}={}){const{data:s,error:l}=await m.auth.getUser();if(l)throw l;const o=s.user?.id;if(!o)throw new Error("No user is currently signed in");const p=Math.min(Math.max(parseInt(i,10)||50,1),200),x=Math.max(parseInt(n,10)||0,0);let v=m.from("scheduled_notifications").select("id, title, message, type, category, priority, reference_id, reference_type, action_url, metadata, scheduled_for, created_at, executed_at, user_id").eq("user_id",o).order("scheduled_for",{ascending:!0}).range(x,x+p-1);a||(v=v.is("executed_at",null)),t&&(v=v.eq("reference_id",t)),r&&(v=v.eq("reference_type",r));const{data:N,error:b}=await v;if(b)throw b;return N.map(c=>({...c,scheduled_for:new Date(c.scheduled_for),created_at:new Date(c.created_at),executed_at:c.executed_at?new Date(c.executed_at):null}))},async processDueNotifications(){const a=new Date().toISOString(),{data:t,error:r}=await m.from("scheduled_notifications").select("id, title, message, type, category, priority, reference_id, reference_type, action_url, metadata, user_id").lte("scheduled_for",a).is("executed_at",null);if(r)throw r;if(!t||t.length===0)return{sent:0,failed:0,total:0};let i=0,n=0;for(const s of t)try{await this.sendNotification({title:s.title,message:s.message,type:s.type,category:s.category,priority:s.priority,referenceId:s.reference_id,referenceType:s.reference_type,actionUrl:s.action_url,metadata:s.metadata},s.user_id);const{error:l}=await m.from("scheduled_notifications").update({executed_at:a,updated_at:a}).eq("id",s.id);if(l)throw l;i++}catch(l){n++,await m.from("scheduled_notifications").update({error_count:(s.error_count||0)+1,last_error:l.message,updated_at:a}).eq("id",s.id)}return{sent:i,failed:n,total:t.length}},async cleanupOldNotifications({daysToKeep:a=30}={}){const t=new Date;t.setDate(t.getDate()-a);const{count:r,error:i}=await m.from("scheduled_notifications").delete().not("executed_at","is",null).lte("executed_at",t.toISOString());if(i)throw i;return{deleted:r||0}}},W={async sendEmail({to:a,subject:t,html:r,text:i,from:n}){if(!a||!t||!r&&!i)return{success:!1,error:"Missing required fields: to, subject, and html or text"};const{data:s,error:l}=await m.functions.invoke("send-email",{body:{to:a,subject:t,html:r,text:i,from:n}});return l?(console.error("EmailService.sendEmail error:",l),{success:!1,error:l.message||"invoke failed"}):{success:!!s?.success,emailId:s?.emailId,error:s?.error}},render(a="",t={}){return String(a).replace(/{{\s*([\w.]+)\s*}}/g,(r,i)=>i.split(".").reduce((s,l)=>s&&s[l]!==void 0?s[l]:"",t)??"")}},g={AUTHENTICATION:"authentication",ACTIVITY:"activity",CORRECTION:"correction",PLAGIARISM:"plagiarism",SYSTEM:"system",CHATBOT:"chatbot",ANALYTICS:"analytics"},y={CRITICAL:"critical",HIGH:"high",MEDIUM:"medium",LOW:"low"},h={EMAIL:"email",PUSH:"push",BOTH:"both"},K={critical:{channels:["email","push"],retries:3,delay:0},high:{channels:["email","push"],retries:2,delay:0},medium:{channels:["push"],retries:1,delay:300},low:{channels:["push"],retries:0,delay:1800}};function Ee(a,t){return t===h.BOTH?["email","push"]:t===h.EMAIL?["email"]:t===h.PUSH?["push"]:(K[String(a||"").toLowerCase()]||K.medium).channels}const Te={accountCreated:{id:"accountCreated",type:g.AUTHENTICATION,channel:h.EMAIL,priority:y.CRITICAL,title:"Conta criada com sucesso! üéâ",message:"Bem-vindo(a) ao TamanduAI! Confirme seu email para come√ßar.",emailSubject:"Bem-vindo(a) ao TamanduAI! Confirme seu email",emailHtml:`
      <h2>Bem-vindo(a) ao TamanduAI! üéì</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi criada com sucesso.</p>
      <p>Clique no bot√£o para confirmar seu email:</p>
      <p><a href="{{confirmationUrl}}">Confirmar Email</a></p>
      <small>Este link expira em 24 horas.</small>
    `,variables:["userName","confirmationUrl"]},loginNewDevice:{id:"loginNewDevice",type:g.SYSTEM,channel:h.EMAIL,priority:y.MEDIUM,title:"Novo acesso detectado",message:"Login realizado em {device} √†s {time}. Foi voc√™?",emailSubject:"Novo acesso detectado",emailHtml:"<h2>Novo acesso detectado</h2><p>Dispositivo: {{device}} √†s {{time}}</p>",variables:["device","time"]},passwordRecoveryRequested:{id:"passwordRecoveryRequested",type:g.AUTHENTICATION,channel:h.EMAIL,priority:y.CRITICAL,title:"Recupera√ß√£o de senha solicitada",message:"Use o c√≥digo enviado para redefinir sua senha.",emailSubject:"Recupera√ß√£o de senha",emailHtml:"<h2>Recupera√ß√£o de senha</h2><p>Ol√° {{userName}}, utilize o c√≥digo enviado para redefinir sua senha.</p>",variables:["userName"]},passwordChanged:{id:"passwordChanged",type:g.AUTHENTICATION,channel:h.BOTH,priority:y.HIGH,title:"Senha alterada",message:"Sua senha foi alterada com sucesso √†s {time}.",emailSubject:"Senha alterada com sucesso",emailHtml:"<h2>Senha alterada</h2><p>Sua senha foi alterada √†s {{time}}</p>",variables:["time"]},profileCompleted:{id:"profileCompleted",type:g.SYSTEM,channel:h.PUSH,priority:y.MEDIUM,title:"Perfil completo!",message:"Agora voc√™ pode explorar todas as funcionalidades.",variables:[]},classInviteSent:{id:"classInviteSent",type:g.SYSTEM,channel:h.EMAIL,priority:y.HIGH,title:"Convite para turma",message:"Voc√™ foi convidado(a) para a turma {{className}}",emailSubject:"Convite para a turma {{className}}",emailHtml:'<h2>Convite para turma</h2><p>Voc√™ foi convidado(a) para a turma <strong>{{className}}</strong>.</p><p>Clique para aceitar: <a href="{{acceptUrl}}">Aceitar convite</a></p>',variables:["className","acceptUrl"]},classInviteAccepted:{id:"classInviteAccepted",type:g.SYSTEM,channel:h.PUSH,priority:y.MEDIUM,title:"Convite aceito",message:"{{studentName}} entrou na turma {{className}}",variables:["studentName","className"]},studentAddedToClass:{id:"studentAddedToClass",type:g.SYSTEM,channel:h.PUSH,priority:y.MEDIUM,title:"Aluno adicionado",message:"{{studentName}} foi adicionado na turma {{className}}",variables:["studentName","className"]},studentRemovedFromClass:{id:"studentRemovedFromClass",type:g.SYSTEM,channel:h.BOTH,priority:y.HIGH,title:"Voc√™ foi removido da turma",message:"Turma: {{className}}",emailSubject:"Remo√ß√£o da turma {{className}}",emailHtml:"<h2>Remo√ß√£o da turma</h2><p>Voc√™ foi removido da turma {{className}}</p>",variables:["className"]},classCreated:{id:"classCreated",type:g.SYSTEM,channel:h.PUSH,priority:y.LOW,title:"Nova turma criada",message:"{{className}} foi criada com sucesso",variables:["className"]},accountConfirmed:{id:"accountConfirmed",type:g.AUTHENTICATION,channel:h.BOTH,priority:y.HIGH,title:"Email confirmado! ‚úÖ",message:"Sua conta est√° ativa. Complete seu perfil para come√ßar.",emailSubject:"Sua conta foi confirmada",emailHtml:`
      <h2>Conta confirmada</h2>
      <p>Ol√° <strong>{{userName}}</strong>, sua conta foi confirmada com sucesso.</p>
    `,variables:["userName"]},newActivity:{id:"newActivity",type:g.ACTIVITY,channel:h.BOTH,priority:y.HIGH,title:"Nova atividade: {{activityName}}",message:"Prazo: {{deadline}} ‚Ä¢ Pontua√ß√£o: {{points}} pts",emailSubject:"Nova atividade em {{className}}: {{activityName}}",emailHtml:`
      <h2>üìù Nova Atividade Dispon√≠vel</h2>
      <p>Ol√° <strong>{{studentName}}</strong>,</p>
      <p>Uma nova atividade foi publicada na turma <strong>{{className}}</strong>:</p>
      <p><strong>{{activityName}}</strong></p>
      <p>Prazo: {{deadline}} | Pontos: {{points}}</p>
      <p><a href="{{activityUrl}}">Ver Atividade</a></p>
    `,variables:["studentName","className","activityName","deadline","points","activityUrl"]},deadlineWarning24h:{id:"deadlineWarning24h",type:g.ACTIVITY,channel:h.BOTH,priority:y.CRITICAL,title:"‚è∞ Prazo em 24 horas!",message:"{{activityName}} vence amanh√£ √†s {{time}}",emailSubject:"Lembrete: {{activityName}} vence em 24 horas",emailHtml:`
      <h2>‚è∞ Prazo em 24 horas</h2>
      <p>Atividade: {{activityName}}</p>
      <p>Vence em: {{deadline}}</p>
      <p><a href="{{activityUrl}}">Entregar agora</a></p>
    `,variables:["activityName","deadline","time","activityUrl"]},activityCorrected:{id:"activityCorrected",type:g.CORRECTION,channel:h.BOTH,priority:y.HIGH,title:"Atividade corrigida! üéâ",message:"{{activityName}} ‚Ä¢ Nota: {{grade}}/{{maxGrade}}",emailSubject:"Corre√ß√£o dispon√≠vel: {{activityName}}",emailHtml:`
      <h2>‚úÖ Atividade Corrigida</h2>
      <p>{{activityName}} ‚Äî Nota: {{grade}}/{{maxGrade}}</p>
      <p><a href="{{viewUrl}}">Ver detalhes</a></p>
    `,variables:["activityName","grade","maxGrade","viewUrl"]},plagiarismDetected:{id:"plagiarismDetected",type:g.PLAGIARISM,channel:h.EMAIL,priority:y.CRITICAL,title:"üö® Pl√°gio detectado",message:"{{studentName}} ‚Ä¢ {{percentage}}% similaridade ‚Ä¢ {{activityName}}",emailSubject:"Alerta de Pl√°gio: {{activityName}}",emailHtml:`
      <h2>üö® Alerta de Pl√°gio</h2>
      <p>Aluno: {{studentName}}</p>
      <p>Atividade: {{activityName}}</p>
      <p>Similaridade: {{percentage}}%</p>
      <p><a href="{{reviewUrl}}">Revisar submiss√£o</a></p>
    `,variables:["studentName","activityName","percentage","reviewUrl"]},analysisStarted:{id:"analysisStarted",type:g.PLAGIARISM,channel:h.PUSH,priority:y.LOW,title:"An√°lise anti-pl√°gio iniciada",message:"Verificando {{activityName}}..."},falsePositiveMarked:{id:"falsePositiveMarked",type:g.PLAGIARISM,channel:h.PUSH,priority:y.LOW,title:"Falso positivo marcado",message:"An√°lise de pl√°gio atualizada para {{activityName}}"},chatbotTrainingComplete:{id:"chatbotTrainingComplete",type:g.CHATBOT,channel:h.PUSH,priority:y.MEDIUM,title:"Chatbot treinado com sucesso!",message:"Base atualizada com {{filesCount}} arquivos",variables:["filesCount"]},chatbotTrainingError:{id:"chatbotTrainingError",type:g.CHATBOT,channel:h.PUSH,priority:y.HIGH,title:"Erro no treinamento",message:"Falha ao processar {{fileName}}",variables:["fileName"]},newMaterialProcessed:{id:"newMaterialProcessed",type:g.CHATBOT,channel:h.PUSH,priority:y.LOW,title:"Material processado",message:"{{fileName}} adicionado √† base",variables:["fileName"]},outOfScopeInteraction:{id:"outOfScopeInteraction",type:g.CHATBOT,channel:h.PUSH,priority:y.LOW,title:"Pergunta fora do escopo",message:"Aluno perguntou sobre: {{topic}}",variables:["topic"]},monthlyReportGenerated:{id:"monthlyReportGenerated",type:g.ANALYTICS,channel:h.EMAIL,priority:y.MEDIUM,title:"Relat√≥rio mensal gerado",message:"Seu relat√≥rio de {{monthYear}} est√° pronto",emailSubject:"Relat√≥rio mensal - {{monthYear}}",emailHtml:"<h2>Relat√≥rio mensal</h2><p>Seu relat√≥rio de {{monthYear}} est√° pronto.</p>",variables:["monthYear"]},performanceGoalAchieved:{id:"performanceGoalAchieved",type:g.ANALYTICS,channel:h.BOTH,priority:y.MEDIUM,title:"Meta de desempenho atingida",message:"Parab√©ns! Voc√™ atingiu sua meta",emailSubject:"Meta de desempenho atingida",emailHtml:"<h2>Meta de desempenho atingida</h2><p>Parab√©ns!</p>",variables:[]},lowPerformanceDetected:{id:"lowPerformanceDetected",type:g.ANALYTICS,channel:h.EMAIL,priority:y.HIGH,title:"Baixo desempenho detectado",message:"Identificamos baixo desempenho em {{subject}}",emailSubject:"Baixo desempenho detectado",emailHtml:"<h2>Baixo desempenho detectado</h2><p>√Årea: {{subject}}</p>",variables:["subject"]},classReportAvailable:{id:"classReportAvailable",type:g.ANALYTICS,channel:h.PUSH,priority:y.LOW,title:"Relat√≥rio de turma dispon√≠vel",message:"O relat√≥rio da turma {{className}} est√° dispon√≠vel",variables:["className"]}},De={async send(a,{userId:t,email:r,variables:i={},priorityOverride:n,channelOverride:s,metadata:l}={}){const o=Te[a];if(!o)throw new Error(`Unknown notification template: ${a}`);const p=Ee(n||o.priority,s||o.channel),x=b=>W.render(b,i),v=[];if(p.includes("push")){const b=x(o.title||""),c=x(o.message||"");v.push(k.sendNotification({title:b,message:c,type:o.type,category:o.type,priority:(n||o.priority||"medium").toLowerCase(),metadata:l},t))}if(p.includes("email")){if(!r)throw new Error("Email recipient is required for email delivery");const b=x(o.emailSubject||o.title||"Notifica√ß√£o"),c=o.emailHtml?x(o.emailHtml):void 0,_=c?void 0:x(o.message||"");v.push(W.sendEmail({to:r,subject:b,html:c,text:_}))}return await Promise.allSettled(v)},async notifyNewActivity({userId:a,email:t,variables:r,metadata:i}){return this.send("newActivity",{userId:a,email:t,variables:r,metadata:i})},async notifyDeadline24h({userId:a,email:t,variables:r,metadata:i}){return this.send("deadlineWarning24h",{userId:a,email:t,variables:r,metadata:i})},async notifyActivityCorrected({userId:a,email:t,variables:r,metadata:i}){return this.send("activityCorrected",{userId:a,email:t,variables:r,metadata:i})},async notifyPlagiarismDetected({userId:a,email:t,variables:r,metadata:i}){return this.send("plagiarismDetected",{userId:a,email:t,variables:r,metadata:i})}},Pe=()=>{const{templateId:a,classId:t}=_e(),{user:r}=le(),{toast:i}=de(),n=Se(),[s,l]=A.useState(null),[o,p]=A.useState([]),[x,v]=A.useState(!0),[N,b]=A.useState(!1),[c,_]=A.useState({selectedClasses:t?[t]:[],customTitle:"",customDescription:"",customInstructions:"",dueDate:null,maxPoints:100});A.useEffect(()=>{T()},[a]);const T=async()=>{try{v(!0);const{data:d,error:u}=await m.from("activity_templates").select("*").eq("id",a).eq("created_by",r.id).single();if(u)throw u;l(d);const{data:P,error:D}=await m.from("classes").select("*").eq("teacher_id",r.id);if(D)throw D;p(P||[])}catch(d){console.error("Error loading data:",d),i({title:"Erro ao carregar dados",description:"N√£o foi poss√≠vel carregar o template ou as turmas.",variant:"destructive"})}finally{v(!1)}},w=async()=>{if(c.selectedClasses.length===0){i({title:"Selecione turmas",description:"Selecione pelo menos uma turma para publicar a atividade.",variant:"destructive"});return}try{b(!0);const{error:d}=await m.rpc("publish_activity_template",{template_id_param:a,class_ids:c.selectedClasses,custom_title:c.customTitle||null,custom_description:c.customDescription||null,custom_instructions:c.customInstructions||null,custom_due_date:c.dueDate||null,custom_max_points:c.maxPoints});if(d)throw d;try{for(const u of c.selectedClasses){const D=o.find(S=>S.id===u)?.name||"Sua turma",{data:X,error:q}=await m.from("classes_students").select("student_id").eq("class_id",u);if(q)throw q;const M=(X||[]).map(S=>S.student_id);let B={};if(M.length>0){const{data:S,error:C}=await m.from("profiles").select("id, email, full_name").in("id",M);if(C)throw C;B=Object.fromEntries((S||[]).map(I=>[I.id,{email:I.email,name:I.full_name}]))}const Z=c.dueDate?O(c.dueDate,"PPP p",{locale:L}):null,H={studentName:"",className:D,activityName:c.customTitle||s.title,deadline:Z||"Sem prazo",points:c.maxPoints,activityUrl:`/dashboard/classes/${u}/activities`},ee=M.map(S=>{const C=B[S];return De.send("newActivity",{userId:S,email:C?.email||void 0,channelOverride:"both",variables:{...H,studentName:C?.name||""},metadata:{classId:u,templateId:a,kind:"publish_activity"}})});if(await Promise.allSettled(ee),c.dueDate){const S=M.map(I=>k.scheduleReminder({type:"assignment",eventId:a,dueAt:c.dueDate,notification:{title:"‚è∞ Prazo em 24 horas!",message:`${H.activityName} vence em breve`,type:"assignment",category:"deadline",priority:"high",metadata:{classId:u,templateId:a,reminder24h:!0}},remindBeforeMinutes:1440,userId:I}));await Promise.allSettled(S);const C=M.map(I=>k.scheduleReminder({type:"assignment",eventId:a,dueAt:c.dueDate,notification:{title:"‚ö†Ô∏è URGENTE: Prazo em 1 hora!",message:`${H.activityName} vence em 1 hora`,type:"assignment",category:"deadline",priority:"urgent",metadata:{classId:u,templateId:a,reminder1h:!0}},remindBeforeMinutes:60,userId:I}));await Promise.allSettled(C)}}}catch(u){console.warn("Falha ao enviar notifica√ß√µes p√≥s-publica√ß√£o:",u)}i({title:"Atividade publicada!",description:`A atividade foi publicada em ${c.selectedClasses.length} turma(s) com sucesso.`}),n(t?`/dashboard/classes/${t}/activities`:"/dashboard/activities")}catch(d){console.error("Error publishing template:",d),i({title:"Erro ao publicar",description:"N√£o foi poss√≠vel publicar a atividade. Tente novamente.",variant:"destructive"})}finally{b(!1)}},f=d=>{_(u=>u.selectedClasses.includes(d)?{...u,selectedClasses:u.selectedClasses.filter(D=>D!==d)}:{...u,selectedClasses:[...u.selectedClasses,d]})};return x?e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando dados..."})]})}):s?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs(j,{variant:"ghost",onClick:()=>n("/dashboard/activities"),children:[e.jsx(re,{className:"h-4 w-4 mr-2"}),"Voltar"]}),e.jsxs("div",{className:"ml-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Publicar Atividade"}),e.jsxs("p",{className:"text-gray-600",children:['Configure e publique "',s.title,'" nas turmas']})]})]})})})}),e.jsx("main",{className:"py-6 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(G,{children:[e.jsx(Y,{children:e.jsxs(z,{className:"flex items-center",children:[e.jsx(se,{className:"h-5 w-5 mr-2"}),"Template Original"]})}),e.jsxs(V,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-lg",children:s.title}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:s.description})]}),s.tags&&s.tags.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Tags:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:s.tags.map((d,u)=>e.jsx(be,{variant:"secondary",children:d},u))})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Criado em ",new Date(s.created_at).toLocaleDateString()]})]})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(G,{children:[e.jsx(Y,{children:e.jsx(z,{children:"Configura√ß√µes de Publica√ß√£o"})}),e.jsxs(V,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(E,{className:"text-base font-medium",children:"Turmas"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Selecione as turmas onde deseja publicar esta atividade"}),e.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto",children:o.map(d=>e.jsxs("div",{className:"flex items-start space-x-3 p-3 border rounded-lg",children:[e.jsx(we,{id:`class-${d.id}`,checked:c.selectedClasses.includes(d.id),onCheckedChange:()=>f(d.id)}),e.jsxs("div",{className:"flex-1",children:[e.jsx(E,{htmlFor:`class-${d.id}`,className:"font-medium cursor-pointer",children:d.name}),e.jsxs("div",{className:"flex items-center space-x-4 mt-1 text-sm text-gray-500",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),d.subject]}),e.jsx("span",{children:d.grade_level})]})]})]},d.id))}),o.length===0&&e.jsx("p",{className:"text-sm text-gray-500 italic",children:"Voc√™ n√£o tem turmas para publicar atividades."})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h4",{className:"font-medium mb-4",children:"Personaliza√ß√µes (Opcional)"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"customTitle",children:"T√≠tulo personalizado"}),e.jsx($,{id:"customTitle",value:c.customTitle,onChange:d=>_(u=>({...u,customTitle:d.target.value})),placeholder:s.title})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"customDescription",children:"Descri√ß√£o personalizada"}),e.jsx(F,{id:"customDescription",value:c.customDescription,onChange:d=>_(u=>({...u,customDescription:d.target.value})),placeholder:s.description||"Sem descri√ß√£o",rows:3})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"customInstructions",children:"Instru√ß√µes personalizadas"}),e.jsx(F,{id:"customInstructions",value:c.customInstructions,onChange:d=>_(u=>({...u,customInstructions:d.target.value})),placeholder:"Adicione instru√ß√µes espec√≠ficas para esta turma...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"maxPoints",children:"Pontua√ß√£o m√°xima"}),e.jsx($,{id:"maxPoints",type:"number",min:"1",max:"1000",value:c.maxPoints,onChange:d=>_(u=>({...u,maxPoints:parseInt(d.target.value)||100}))})]}),e.jsxs("div",{children:[e.jsx(E,{children:"Data de entrega (opcional)"}),e.jsxs(je,{children:[e.jsx(Ce,{asChild:!0,children:e.jsxs(j,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ne,{className:"mr-2 h-4 w-4"}),c.dueDate?O(c.dueDate,"PPP",{locale:L}):e.jsx("span",{children:"Selecionar data"})]})}),e.jsx(J,{className:"w-auto p-0",align:"start",children:e.jsx(Ae,{mode:"single",selected:c.dueDate,onSelect:d=>_(u=>({...u,dueDate:d})),initialFocus:!0})})]})]})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-6 border-t",children:[e.jsx(j,{variant:"outline",onClick:()=>n("/dashboard/activities"),disabled:N,children:"Cancelar"}),e.jsx(j,{onClick:w,disabled:N||c.selectedClasses.length===0,children:N?e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"mr-2 h-4 w-4 animate-spin"}),"Publicando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),"Publicar em ",c.selectedClasses.length," turma",c.selectedClasses.length!==1?"s":""]})})]})]})]})})]})})})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Template n√£o encontrado"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"O template que voc√™ est√° tentando acessar n√£o existe ou voc√™ n√£o tem permiss√£o."}),e.jsx(j,{onClick:()=>n("/dashboard/activities"),children:"Voltar para Atividades"})]})})},qe=Object.freeze(Object.defineProperty({__proto__:null,default:Pe},Symbol.toStringTag,{value:"Module"}));export{qe as A,De as N};
