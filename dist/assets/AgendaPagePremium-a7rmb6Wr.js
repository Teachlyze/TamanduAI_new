import{s as m,u as Q,r as h,j as e,o as Y,d as k,C as A,B as $,e as F,l as G,U as R,c as W,V,aq as S}from"./main-NgjJy_CG.js";import{t as J,b as K}from"./toDate-M29M8iGB.js";import{S as D,P as C}from"./PremiumCard-BGO_It48.js";import{P as E}from"./PremiumButton-DDGOGflQ.js";import{E as X}from"./EmptyState-Cb7n_MKP.js";import{C as Z}from"./chevron-left-CCTbow4A.js";import{P as ee}from"./plus-BItzgCLM.js";function q(r,s,n){const a=J(r,n?.in);return a.setTime(a.getTime()+s*K),a}const z={async getUserCalendar({from:r,to:s,userId:n=null,userRole:a=null}){try{if(n&&a==="student"){const{data:u,error:v}=await m.from("calendar_events").select("id, class_id, title, description, start_time, end_time, activity_id, type, event_type, created_by").gte("start_time",r.toISOString()).lte("end_time",s.toISOString()).order("start_time",{ascending:!0});return v?(console.error("CalendarService.getUserCalendar error:",v),[]):u||[]}let i=m.from("calendar_events").select("id, class_id, title, description, start_time, end_time, activity_id, type, event_type, created_by").gte("start_time",r.toISOString()).lte("end_time",s.toISOString()).order("start_time",{ascending:!0});a==="teacher"&&n&&(i=i.eq("created_by",n));const{data:o,error:d}=await i;return d?(console.error("CalendarService.getUserCalendar error:",d),[]):o||[]}catch(i){return console.error("CalendarService.getUserCalendar exception:",i),[]}},async createEvent({class_id:r,title:s,description:n=null,start_time:a,end_time:i,type:o="event",event_type:d=null,activity_id:u=null}){const{data:v}=await m.auth.getUser(),I=v?.user?.id||null,l=(T=>{switch((T||"").toLowerCase()){case"meeting":return{type:"meeting",event_type:"meeting"};case"class":return{type:"event",event_type:"class"};case"exam":return{type:"event",event_type:"exam"};case"video":return{type:"meeting",event_type:"meeting"};case"other":return{type:"event",event_type:"other"};case"deadline":return{type:"deadline",event_type:"assignment"};case"activity":return{type:"activity",event_type:"assignment"};default:return{type:"event",event_type:"other"}}})(o),g=l.type,y=d||l.event_type,f={class_id:r,title:s,description:n,start_time:a instanceof Date?a.toISOString():a,end_time:i instanceof Date?i.toISOString():i,type:g,event_type:y,activity_id:u,created_by:I},{data:N,error:_}=await m.from("calendar_events").insert(f).select().single();if(_)throw _;return N},async updateEvent(r,s){const n=d=>d instanceof Date?d.toISOString():d,a={...s};if(a.start_time&&(a.start_time=n(a.start_time)),a.end_time&&(a.end_time=n(a.end_time)),typeof a.type=="string"&&a.type){const u=(v=>{switch((v||"").toLowerCase()){case"meeting":return{type:"meeting",event_type:"meeting"};case"class":return{type:"event",event_type:"class"};case"exam":return{type:"event",event_type:"exam"};case"video":return{type:"meeting",event_type:"meeting"};case"other":return{type:"event",event_type:"other"};case"deadline":return{type:"deadline",event_type:"assignment"};case"activity":return{type:"activity",event_type:"assignment"};default:return{type:"event",event_type:"other"}}})(a.type);a.type=u.type,a.event_type||(a.event_type=u.event_type)}const{data:i,error:o}=await m.from("calendar_events").update(a).eq("id",r).select().single();if(o)throw o;return i},async deleteEvent(r){const{error:s}=await m.from("calendar_events").delete().eq("id",r);if(s)throw s;return!0},async getClassCalendar(r,{from:s,to:n}){const{data:a,error:i}=await m.from("calendar_events").select("id, class_id, title, description, start_time, end_time, activity_id").eq("class_id",r).gte("start_time",s.toISOString()).lte("end_time",n.toISOString()).order("start_time",{ascending:!0});if(i)throw i;return a||[]},subscribeUserCalendar(r,s){const n=m.channel(`calendar-user-${r}`);return n.on("postgres_changes",{event:"*",schema:"public",table:"calendar_events"},()=>s("calendar_events")).on("postgres_changes",{event:"*",schema:"public",table:"event_attendees",filter:`user_id=eq.${r}`},()=>s("event_attendees")).subscribe(),()=>{try{m.removeChannel(n)}catch{}}},subscribeClassCalendar(r,s){const n=m.channel(`calendar-class-${r}`);return n.on("postgres_changes",{event:"*",schema:"public",table:"calendar_events",filter:`class_id=eq.${r}`},()=>s("calendar_events")).on("postgres_changes",{event:"*",schema:"public",table:"event_attendees"},()=>s("event_attendees")).subscribe(),()=>{try{m.removeChannel(n)}catch{}}},detectConflicts(r){const s=[],n=[...r].sort((a,i)=>new Date(a.start_time)-new Date(i.start_time));for(let a=0;a<n.length-1;a++){const i=n[a],o=n[a+1];new Date(o.start_time)<new Date(i.end_time)&&s.push([i,o])}return s},computeReminderWindows(r){const s=new Date(r.end_time),n=r.estimated_minutes||60,a=r.complexity==="high"?2:r.complexity==="medium"?1.2:1,i=Math.ceil(n*a);return[{label:"Iniciar preparo",when:q(s,-i-120)},{label:"Lembrete 24h",when:q(s,-24*60)},{label:"Lembrete 2h",when:q(s,-120)}]},async getUserCalendarCompact({from:r,to:s,userId:n}){const a=r instanceof Date?r.toISOString():r,i=s instanceof Date?s.toISOString():s,o=n||(await m.auth.getUser()).data?.user?.id||null,{data:d,error:u}=await m.rpc("get_user_calendar_compact",{p_user:o,p_from:a,p_to:i});if(u)throw u;return d||[]}};function ce(){const{user:r}=Q(),[s,n]=h.useState(!0),[a,i]=h.useState(new Date),[o,d]=h.useState([]),[u,v]=h.useState("day"),[I,b]=h.useState(!1),[l,g]=h.useState({title:"",type:"class",start:"",end:"",location:"",date:new Date().toISOString().split("T")[0]});h.useEffect(()=>{r&&y(a)},[r]),h.useEffect(()=>{if(!r)return;const t=z.subscribeUserCalendar(r.id,()=>{y(a)},[]);return()=>{try{t?.()}catch{}}},[r,a]);const y=async t=>{n(!0);try{const c=t.getFullYear(),p=t.getMonth(),j=new Date(c,p,1),M=new Date(c,p+1,0,23,59,59),w=await z.getUserCalendar({from:j,to:M,userId:r.id,userRole:"teacher"});d(w||[])}catch(c){console.error("Erro ao carregar eventos:",c)}finally{n(!1)}},f=o.filter(t=>{const c=new Date(t.start_time),p=new Date;return c.toDateString()===p.toDateString()}),N=o.filter(t=>new Date(t.start_time)>new Date),_=o.length,T=o.filter(t=>t.status==="completed").length,O=t=>{switch(t){case"class":return $;case"meeting":return R;case"exam":return $;case"video":return V;default:return k}},L=t=>{switch(t){case"class":return"bg-blue-100 dark:bg-muted/50 text-blue-700 dark:text-blue-300";case"meeting":return"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300";case"exam":return"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300";case"video":return"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300";default:return"bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-300"}};return s?e.jsx(Y,{message:"Carregando agenda..."}):e.jsxs("div",{className:"space-y-8 animate-fade-in-up",children:[e.jsxs("div",{className:"bg-gradient-to-br from-orange-600 via-red-600 to-pink-600 p-8 rounded-2xl text-white relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 opacity-10",children:e.jsx("div",{className:"absolute inset-0",style:{backgroundImage:"radial-gradient(circle at 1px 1px, white 1px, transparent 0)",backgroundSize:"40px 40px"}})}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("h1",{className:"text-3xl font-bold mb-2 flex items-center gap-3",children:[e.jsx(k,{className:"w-8 h-8"}),"Agenda"]}),e.jsx("p",{className:"text-slate-900 dark:text-white/90",children:"Gerencie sua agenda e compromissos"})]})]}),e.jsxs("div",{className:"stagger-children grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(D,{title:"Eventos Hoje",value:f.length.toString(),icon:k}),e.jsx(D,{title:"Próximos Eventos",value:N.length.toString(),icon:A}),e.jsx(D,{title:"Total de Eventos",value:_.toString(),icon:$}),e.jsx(D,{title:"Concluídos",value:T.toString(),icon:F})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(C,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold",children:a.toLocaleDateString("pt-BR",{month:"long",year:"numeric"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{variant:"outline",size:"sm",onClick:()=>{const t=new Date(a);t.setMonth(t.getMonth()-1),i(t),y(t)},children:e.jsx(Z,{className:"w-4 h-4"})}),e.jsx(E,{variant:"outline",size:"sm",onClick:()=>i(new Date),children:"Hoje"}),e.jsx(E,{variant:"outline",size:"sm",onClick:()=>{const t=new Date(a);t.setMonth(t.getMonth()+1),i(t),y(t)},children:e.jsx(G,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2 mb-2",children:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].map(t=>e.jsx("div",{className:"text-center text-sm font-medium text-muted-foreground py-2",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:(()=>{const t=a.getFullYear(),c=a.getMonth(),p=new Date(t,c,1).getDay(),j=new Date(t,c+1,0).getDate(),M=new Date,w=[];for(let x=0;x<p;x++)w.push(e.jsx("div",{className:"aspect-square"},`empty-${x}`));for(let x=1;x<=j;x++){const P=new Date(t,c,x),H=P.toDateString()===M.toDateString(),B=o.some(U=>new Date(U.start_time).toDateString()===P.toDateString());w.push(e.jsxs("button",{type:"button",onClick:U=>{U.preventDefault(),i(P)},className:`aspect-square p-2 rounded-lg text-sm font-medium transition-colors relative ${H?"bg-primary text-primary-foreground":B?"bg-muted hover:bg-muted/80":"hover:bg-muted/50"}`,children:[x,B&&e.jsx("div",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-primary"})]},x))}return w})()})]}),e.jsxs("div",{className:"border-t border-border pt-4 hidden",children:[e.jsxs("h4",{className:"font-semibold mb-3",children:["Eventos - ",a.toLocaleDateString("pt-BR")]}),e.jsx("div",{className:"space-y-3",children:f.length===0?e.jsx(X,{icon:k,title:"Nenhum evento neste dia",description:"Clique em '+' para adicionar um evento"}):f.map(t=>{const c=O(t.type);return e.jsxs("div",{className:"flex items-center gap-4 p-4 rounded-lg border border-border hover:bg-muted/50 transition-colors cursor-pointer",children:[e.jsx("div",{className:`p-3 rounded-lg ${L(t.type)}`,children:e.jsx(c,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:t.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mt-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(A,{className:"w-3 h-3"}),t.start," - ",t.end]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"w-3 h-3"}),t.students," alunos"]})]})]}),t.status==="upcoming"&&e.jsx(W,{className:"w-5 h-5 text-warning"})]},t.id)})})]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(C,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Próximos Eventos"}),e.jsx(E,{variant:"gradient",size:"sm",leftIcon:ee,onClick:()=>b(!0),children:"Novo Evento"})]}),e.jsx("div",{className:"space-y-3",children:N.slice(0,5).map(t=>{const c=O(t.type);return e.jsx("div",{className:"p-3 rounded-lg border border-border hover:bg-muted/50 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded ${L(t.type)}`,children:e.jsx(c,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h5",{className:"font-medium text-sm truncate",children:t.title}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[new Date(t.date).toLocaleDateString("pt-BR")," às ",t.start]})]})]})},t.id)})})]})}),e.jsx(C,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Resumo do Mês"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(V,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-sm font-medium",children:"Aulas"})]}),e.jsx("span",{className:"text-xl font-bold text-blue-600 dark:text-blue-400",children:"12"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4 text-purple-600 dark:text-purple-400"}),e.jsx("span",{className:"text-sm font-medium",children:"Reuniões"})]}),e.jsx("span",{className:"text-xl font-bold text-purple-600 dark:text-purple-400",children:"5"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-green-50 dark:bg-green-900/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-4 h-4 text-green-600 dark:text-green-400"}),e.jsx("span",{className:"text-sm font-medium",children:"Concluídos"})]}),e.jsx("span",{className:"text-xl font-bold text-green-600 dark:text-green-400",children:"15"})]})]})]})}),e.jsx(C,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Eventos do dia"}),o.filter(t=>new Date(t.start_time).toDateString()===a.toDateString()).length===0?e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Nenhum evento para ",a.toLocaleDateString("pt-BR")]}):e.jsx("div",{className:"space-y-3",children:o.filter(t=>new Date(t.start_time).toDateString()===a.toDateString()).map(t=>{const c=O(t.type),p=new Date(t.start_time),j=new Date(t.end_time);return e.jsx("div",{className:"p-3 rounded-lg border border-border hover:bg-muted/50 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded ${L(t.type)}`,children:e.jsx(c,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h5",{className:"font-medium text-sm truncate",children:t.title}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[p.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})," - ",j.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})]})]})]})},t.id)})})]})})]})]}),I&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>b(!1),children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-2xl max-w-md w-full shadow-2xl border border-gray-200 dark:border-gray-700",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-gray-900 dark:text-white",children:"Novo Evento"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Título"}),e.jsx("input",{type:"text",value:l.title,onChange:t=>g({...l,title:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Nome do evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Data"}),e.jsx("input",{type:"date",value:l.date,onChange:t=>g({...l,date:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Tipo"}),e.jsxs("select",{value:l.type,onChange:t=>g({...l,type:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"class",children:"Aula"}),e.jsx("option",{value:"meeting",children:"Reunião"}),e.jsx("option",{value:"exam",children:"Prova"}),e.jsx("option",{value:"video",children:"Videoconferência"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Início"}),e.jsx("input",{type:"time",value:l.start,onChange:t=>g({...l,start:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Fim"}),e.jsx("input",{type:"time",value:l.end,onChange:t=>g({...l,end:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Local"}),e.jsx("input",{type:"text",value:l.location,onChange:t=>g({...l,location:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Ex: Sala 12"})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:()=>{b(!1),g({title:"",type:"class",start:"",end:"",location:"",date:new Date().toISOString().split("T")[0]})},className:"flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:"Cancelar"}),e.jsx("button",{onClick:async()=>{if(!r)return S.error("Usuário não autenticado");if(l.title&&l.start&&l.end&&l.date)try{const t=new Date(`${l.date}T${l.start}`),c=new Date(`${l.date}T${l.end}`);await z.createEvent({class_id:null,title:l.title,description:null,start_time:t,end_time:c,type:l.type,color:null,meeting_id:null,activity_id:null,metadata:{location:l.location,teacher_id:r.id}}),b(!1),g({title:"",type:"class",start:"",end:"",location:"",date:new Date().toISOString().split("T")[0]}),await y(a),S.success("Evento criado com sucesso!")}catch(t){console.error("Erro ao criar evento:",t),S.error("Erro ao criar evento")}else S.error("Preencha todos os campos obrigatórios")},className:"flex-1 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:opacity-90 transition-opacity font-medium",children:"Criar Evento"})]})]})]})})]})}export{ce as default};
