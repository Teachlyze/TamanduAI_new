import{al as le,g as re,q as de,r as o,s as u,j as e,D as ie,x as l,y as r,c as ce,i as q,an as ne,ap as oe,ah as me,Z as xe,B as he,W as ue,X as je,Y as k,$ as A,F as j,H as p,T as pe}from"./main-7VZoQpWp.js";import{B as b}from"./badge-k0pzqXLv.js";import{u as ge}from"./use-toast-JWqhS_ZM.js";import{A as E}from"./arrow-left-CLPezyTZ.js";import{C as fe}from"./chart-no-axes-column-DAmEJ2Be.js";import{R as F,T as O}from"./CategoricalChart-DNAoAVZT.js";import{B as Ne,a as ve}from"./BarChart-DLLTkKEj.js";import{C as be,X as ye,Y as we}from"./CartesianChart-4i8jaTf4.js";import{P as _e,a as Ce,C as ke}from"./PieChart-B3OhKt--.js";import{T as Ae}from"./trophy-DdJxtQM5.js";import{T as Se}from"./target-DIUEpcX7.js";import"./index-D_P3mdcN.js";const H=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6"],Me=()=>{const{studentId:M}=le(),D=re(),{user:m}=de(),{toast:V}=ge(),d=M||m?.id,[G,c]=o.useState(!0),[y,I]=o.useState(null),[S,K]=o.useState([]),[g,Y]=o.useState([]),[f,$]=o.useState([]),[T,z]=o.useState([]),[Q,i]=o.useState(!1);o.useEffect(()=>{d&&m&&U()},[d,m]);const U=async()=>{try{c(!0);const{data:a}=await u.from("profiles").select("role").eq("id",m.id).single(),n=a?.role;if(n==="student"){if(d!==m.id){i(!1),c(!1);return}i(!0);var s=null}else if(n==="teacher"){const{data:t}=await u.from("class_members").select(`
            class_id,
            classes!inner (id, created_by)
          `).eq("user_id",d).eq("role","student");if(!t||t.length===0){i(!1),c(!1);return}const C=t.filter(h=>h.classes.created_by===m.id);if(C.length===0){i(!1),c(!1);return}i(!0);var s=C.map(h=>h.class_id)}else if(n==="school"){const{data:t}=await u.from("class_members").select(`
            class_id,
            classes!inner (
              id,
              school_classes!inner (school_id, schools!inner (owner_id))
            )
          `).eq("user_id",d).eq("role","student");if(!t||t.length===0){i(!1),c(!1);return}const C=t.filter(h=>h.classes?.school_classes?.schools?.owner_id===m.id);if(C.length===0){i(!1),c(!1);return}i(!0);var s=C.map(h=>h.class_id)}else{i(!1),c(!1);return}const{data:v}=await u.from("profiles").select("*").eq("id",d).single();let _=u.from("class_members").select(`
          joined_at,
          classes (id, name, subject, grade_level, color)
        `).eq("user_id",d);s!==null&&(_=_.in("class_id",s));const{data:ee}=await _;let se=u.from("submissions").select(`
          id, grade, submitted_at, status, feedback, graded_at,
          activities (
            id, title, max_score, due_date, class_id,
            classes (name, subject)
          )
        `).eq("student_id",d).order("submitted_at",{ascending:!1}).limit(50);const{data:L}=await se,X=s!==null?L?.filter(t=>s.includes(t.activities?.class_id)):L,{data:ae}=await u.from("xp_log").select("*").eq("user_id",d).order("created_at",{ascending:!1}).limit(100);I(v),K(ee?.map(t=>t.classes)||[]),Y(X?.filter(t=>t.activities)||[]),$(ae||[]);const te=X?.filter(t=>t.feedback).map(t=>({...t,activityName:t.activities?.title,className:t.activities?.classes?.name}))||[];z(te)}catch(a){console.error("Erro ao buscar dados:",a),V({variant:"destructive",title:"Erro",description:"Não foi possível carregar os dados do aluno"})}finally{c(!1)}};if(G)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsxs("div",{className:"text-center",children:[e.jsx(ie,{className:"w-8 h-8 animate-spin mx-auto text-primary"}),e.jsx("p",{className:"mt-4 text-muted-foreground",children:"Carregando dados do aluno..."})]})});if(!Q||!y)return e.jsx("div",{className:"flex items-center justify-center min-h-[400px]",children:e.jsx(l,{className:"max-w-md",children:e.jsxs(r,{className:"p-8 text-center",children:[e.jsx(ce,{className:"w-12 h-12 mx-auto text-destructive mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Acesso Negado"}),e.jsxs("div",{className:"text-muted-foreground mb-4 space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:"Níveis de acesso:"})}),e.jsxs("ul",{className:"text-sm text-left space-y-1",children:[e.jsxs("li",{children:["👨‍🎓 ",e.jsx("strong",{children:"Aluno:"})," Vê todos seus dados de todas as turmas"]}),e.jsxs("li",{children:["👨‍🏫 ",e.jsx("strong",{children:"Professor:"})," Vê apenas dados das turmas onde é professor"]}),e.jsxs("li",{children:["🏫 ",e.jsx("strong",{children:"Escola:"})," Vê apenas dados das turmas vinculadas à escola"]})]})]}),e.jsxs(q,{onClick:()=>D(-1),children:[e.jsx(E,{className:"w-4 h-4 mr-2"}),"Voltar"]})]})})});const w=g.length,x=g.filter(s=>s.grade!==null),N=x.length>0?(x.reduce((s,a)=>s+a.grade,0)/x.length).toFixed(1):0,B=f.reduce((s,a)=>s+a.xp,0),Z=Math.floor(B/100)+1,W=S.map(s=>{const a=g.filter(v=>v.activities?.classes?.name===s.name&&v.grade!==null),n=a.length>0?a.reduce((v,_)=>v+_.grade,0)/a.length:0;return{name:s.name,media:n.toFixed(1)}}),J=f.reduce((s,a)=>{const n=a.source||"Outros";return s[n]=(s[n]||0)+a.xp,s},{}),P=Object.entries(J).map(([s,a])=>({name:s,value:a})),R=y.full_name||y.name||y.email?.split("@")[0]||"Aluno";return e.jsxs("div",{className:"w-full p-6",children:[e.jsx("div",{className:"flex items-center justify-between mb-6",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(q,{variant:"ghost",size:"sm",onClick:()=>D(-1),children:e.jsx(E,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Detalhes do Aluno"}),e.jsx("p",{className:"text-muted-foreground",children:"Visualize o desempenho completo"})]})]})}),e.jsx(l,{className:"mb-6",children:e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(ne,{className:"h-20 w-20",children:e.jsx(oe,{className:"text-2xl bg-gradient-to-br from-blue-500 to-purple-500 text-white",children:R.split(" ").map(s=>s[0]).join("").slice(0,2)})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold",children:R}),e.jsx("p",{className:"text-muted-foreground",children:y.email}),e.jsx(b,{className:"mt-2",children:"Aluno"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 flex-1",children:[e.jsx(l,{children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(fe,{className:"w-4 h-4 text-blue-500"}),e.jsx("p",{className:"text-sm font-medium",children:"Média Geral"})]}),e.jsx("p",{className:"text-2xl font-bold",children:N}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"de 10.0"})]})}),e.jsx(l,{children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(me,{className:"w-4 h-4 text-green-500"}),e.jsx("p",{className:"text-sm font-medium",children:"Atividades"})]}),e.jsx("p",{className:"text-2xl font-bold",children:x.length}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["de ",w," total"]})]})}),e.jsx(l,{children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(xe,{className:"w-4 h-4 text-yellow-500"}),e.jsx("p",{className:"text-sm font-medium",children:"XP Total"})]}),e.jsx("p",{className:"text-2xl font-bold",children:B}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Nível ",Z]})]})}),e.jsx(l,{children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(he,{className:"w-4 h-4 text-purple-500"}),e.jsx("p",{className:"text-sm font-medium",children:"Turmas"})]}),e.jsx("p",{className:"text-2xl font-bold",children:S.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"ativas"})]})})]})]})})}),e.jsxs(ue,{defaultValue:"overview",className:"w-full",children:[e.jsxs(je,{className:"grid w-full grid-cols-5",children:[e.jsx(k,{value:"overview",children:"Visão Geral"}),e.jsx(k,{value:"activities",children:"Atividades"}),e.jsx(k,{value:"xp",children:"XP & Gamificação"}),e.jsx(k,{value:"feedback",children:"Feedbacks"}),e.jsx(k,{value:"analytics",children:"Analytics"})]}),e.jsx(A,{value:"overview",children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsx(j,{children:e.jsx(p,{children:"Desempenho por Turma"})}),e.jsx(r,{children:e.jsx(F,{width:"100%",height:300,children:e.jsxs(Ne,{data:W,children:[e.jsx(be,{strokeDasharray:"3 3"}),e.jsx(ye,{dataKey:"name"}),e.jsx(we,{domain:[0,10]}),e.jsx(O,{}),e.jsx(ve,{dataKey:"media",fill:"#3b82f6"})]})})})]}),e.jsxs(l,{children:[e.jsx(j,{children:e.jsx(p,{children:"Turmas"})}),e.jsx(r,{children:e.jsxs("div",{className:"space-y-3",children:[S.map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-muted/50",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.subject})]}),e.jsx(b,{children:s.grade_level})]},a)),S.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Nenhuma turma encontrada"})]})})]})]})}),e.jsx(A,{value:"activities",children:e.jsxs(l,{children:[e.jsx(j,{children:e.jsxs(p,{children:["Histórico de Atividades (",g.length,")"]})}),e.jsx(r,{children:e.jsxs("div",{className:"space-y-3",children:[g.slice(0,20).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg border",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.activities?.title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.activities?.classes?.name}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Entregue em ",new Date(s.submitted_at).toLocaleDateString("pt-BR")]})]}),e.jsx("div",{className:"text-right",children:s.grade!==null?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-2xl font-bold",children:s.grade}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["de ",s.activities?.max_score]}),e.jsx(b,{className:"mt-1",variant:s.grade>=7?"default":"destructive",children:s.grade>=7?"Aprovado":"Recuperação"})]}):e.jsx(b,{variant:"secondary",children:"Aguardando correção"})})]},s.id)),g.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Nenhuma atividade encontrada"})]})})]})}),e.jsx(A,{value:"xp",children:e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs(l,{children:[e.jsx(j,{children:e.jsx(p,{children:"Origem do XP"})}),e.jsx(r,{children:e.jsx(F,{width:"100%",height:300,children:e.jsxs(_e,{children:[e.jsx(Ce,{data:P,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:P.map((s,a)=>e.jsx(ke,{fill:H[a%H.length]},`cell-${a}`))}),e.jsx(O,{})]})})})]}),e.jsxs(l,{children:[e.jsx(j,{children:e.jsx(p,{children:"Histórico de XP (últimas 10)"})}),e.jsx(r,{children:e.jsxs("div",{className:"space-y-3",children:[f.slice(0,10).map((s,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:s.source}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[new Date(s.created_at).toLocaleDateString("pt-BR")," às ",new Date(s.created_at).toLocaleTimeString("pt-BR")]})]}),e.jsxs(b,{className:"bg-yellow-500",children:["+",s.xp," XP"]})]},a)),f.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Nenhum XP registrado"})]})})]})]})}),e.jsx(A,{value:"feedback",children:e.jsxs(l,{children:[e.jsx(j,{children:e.jsxs(p,{children:["Feedbacks Recebidos (",T.length,")"]})}),e.jsx(r,{children:e.jsxs("div",{className:"space-y-4",children:[T.map((s,a)=>e.jsx(l,{children:e.jsxs(r,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.activityName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.className})]}),e.jsxs(b,{children:[s.grade,"/10"]})]}),e.jsx("div",{className:"p-3 rounded-lg bg-muted/50 mt-2",children:e.jsx("p",{className:"text-sm",children:s.feedback})}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:s.graded_at?`Corrigido em ${new Date(s.graded_at).toLocaleDateString("pt-BR")}`:""})]})},a)),T.length===0&&e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Nenhum feedback encontrado"})]})})]})}),e.jsxs(A,{value:"analytics",children:[e.jsxs("div",{className:"grid md:grid-cols-3 gap-6 mb-6",children:[e.jsx(l,{children:e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-lg bg-blue-100 dark:bg-blue-900/30",children:e.jsx(pe,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Taxa de Entrega"}),e.jsxs("p",{className:"text-2xl font-bold",children:[w>0?Math.round(x.length/w*100):0,"%"]})]})]})})}),e.jsx(l,{children:e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-lg bg-green-100 dark:bg-green-900/30",children:e.jsx(Ae,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aproveitamento"}),e.jsxs("p",{className:"text-2xl font-bold",children:[N>0?Math.round(N/10*100):0,"%"]})]})]})})}),e.jsx(l,{children:e.jsx(r,{className:"p-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 rounded-lg bg-purple-100 dark:bg-purple-900/30",children:e.jsx(Se,{className:"w-6 h-6 text-purple-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Engajamento"}),e.jsx("p",{className:"text-2xl font-bold",children:f.length>0?"Alto":"Médio"})]})]})})})]}),e.jsxs(l,{children:[e.jsx(j,{children:e.jsx(p,{children:"Insights"})}),e.jsx(r,{children:e.jsxs("div",{className:"space-y-3",children:[N>=8&&e.jsx("div",{className:"p-4 rounded-lg bg-green-100 dark:bg-green-900/30 border-l-4 border-green-500",children:e.jsx("p",{className:"font-medium text-green-900 dark:text-green-100",children:"🎉 Excelente desempenho! Média acima de 8.0"})}),N<6&&N>0&&e.jsx("div",{className:"p-4 rounded-lg bg-amber-100 dark:bg-amber-900/30 border-l-4 border-amber-500",children:e.jsx("p",{className:"font-medium text-amber-900 dark:text-amber-100",children:"⚠️ Atenção: Média abaixo de 6.0. Considere um acompanhamento mais próximo."})}),w-x.length>5&&e.jsx("div",{className:"p-4 rounded-lg bg-blue-100 dark:bg-blue-900/30 border-l-4 border-blue-500",children:e.jsxs("p",{className:"font-medium text-blue-900 dark:text-blue-100",children:["📝 ",w-x.length," atividades pendentes de correção"]})}),f.length===0&&e.jsx("div",{className:"p-4 rounded-lg bg-purple-100 dark:bg-purple-900/30 border-l-4 border-purple-500",children:e.jsx("p",{className:"font-medium text-purple-900 dark:text-purple-100",children:"💡 Incentive o aluno a participar mais das atividades gamificadas!"})})]})})]})]})]})]})};export{Me as default};
