import{G as H,b as p,r as Z,V as ae,C as B,m as P,a as ie,B as T,F as f,$ as L,A as I,T as y,c as ee,e as $,L as Y,W as K,H as Q,_ as te,d as se,o as M,x as q,i as z,f as V,N as le,g as U,X as j,h as ne,j as ce,D as he,k as J,s as oe}from"./appliance-plugin-alqGq5nK.js";import{l as x}from"./Whiteboard-Bt5ZMH01.js";import"./eventemitter2-B4k4W4Xh.js";import"./main-BBAlbGLj.js";import"./es.string.trim-BBX5KnYe.js";import"./extends-BFqQA52f.js";import"./typeof-CPR7xHyo.js";import"./asyncToGenerator-Ds6Qpe_-.js";import"./popper-B_2vCoY7.js";import"./assertThisInitialized-b-KHx1rs.js";import"./inheritsLoose-CMRHYPv0.js";import"./index-CL7e-2tA.js";import"./apiSupabase-CoV1_a5J.js";var pe=Object.defineProperty,de=(N,e,s)=>e in N?pe(N,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):N[e]=s,u=(N,e,s)=>de(N,typeof e!="symbol"?e+"":e,s);class ue{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"serviceWorkShapes",new Map),u(this,"localWorkShapes",new Map),u(this,"tmpOpt"),u(this,"animationId"),u(this,"syncUnitTime",B.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}createLocalWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t){const o=s.toString();!this.getToolsOpt()&&r&&this.setToolsOpt({toolsType:r,toolsOpt:t}),this.setWorkOptions(o,t)}}getLocalWorkShape(e){return this.localWorkShapes.get(e)}createLocalWorkShape(e,s){if(e&&this.tmpOpt){const t={toolsType:this.tmpOpt.toolsType,toolsOpt:s||this.tmpOpt.toolsOpt},r=this.createWorkShapeNode({...t,workId:e});return r&&this.localWorkShapes.set(e,{node:r,toolsType:r.toolsType,workState:I.Start}),r}}canUseTopLayer(e){return e===y.LaserPen}destroy(){this.clearAll()}clearAll(){this.thread.topLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),$(this.thread.serviceLayer,this.thread.serviceLayer.parent)),this.serviceWorkShapes.clear(),this.localWorkShapes.clear()}consumeDraw(e){const{workId:s,dataType:t}=e;if(t===f.Service)this.activeServiceWorkShape(e);else{const r=s?.toString(),o=r&&this.localWorkShapes.get(r);if(!o)return;const a=o.node.consume({data:e,isFullWork:!1,isSubWorker:!0});a.rect&&(o.result=a,o.workState=I.Doing,r&&this.localWorkShapes.set(r,o))}this.runAnimation()}setToolsOpt(e){var s;this.tmpOpt=e,(s=e.toolsOpt)!=null&&s.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}getToolsOpt(){return this.tmpOpt}createWorkShapeNode(e){const{toolsType:s}=e;if(s===y.LaserPen)return q({...e,vNodes:this.vNodes,fullLayer:this.thread.topLayer,drawLayer:this.thread.topLayer})}setNodeKey(e,s,t,r){return s.toolsType=t,s.node=this.createWorkShapeNode({workId:e,toolsType:t,toolsOpt:r}),s}activeServiceWorkShape(e){var s,t;const{workId:r,opt:o,toolsType:a,type:i,updateNodeOpt:l,ops:n,op:h}=e;if(!r)return;const c=r.toString(),m=(s=this.vNodes.get(c))==null?void 0:s.rect;if(!((t=this.serviceWorkShapes)!=null&&t.has(c))){let S={toolsType:a,animationWorkData:h||[],animationIndex:0,type:i,updateNodeOpt:l,ops:n,oldRect:m};a&&o&&(S=this.setNodeKey(c,S,a,o)),this.serviceWorkShapes.set(c,S)}const d=this.serviceWorkShapes.get(c);i&&(d.type=i),n&&(d.animationWorkData=z(n),d.ops=n),l&&(d.updateNodeOpt=l),h&&(d.animationWorkData=h),d.node&&d.node.getWorkId()!==c&&d.node.setWorkId(c),m&&(d.oldRect=m),a&&o&&(d.toolsType!==a&&a&&o&&this.setNodeKey(c,d,a,o),d.node&&d.node.setWorkOptions(o))}computNextAnimationIndex(e,s){var t;const r=((t=e.node)==null?void 0:t.syncUnitTime)||this.syncUnitTime,o=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/s/r)*s;return Math.min((e.animationIndex||0)+(o||s),(e.animationWorkData||[]).length)}animationDraw(){var e,s,t,r;this.animationId=void 0;let o=!1;const a=new Map,i=[];for(const[l,n]of this.serviceWorkShapes.entries())switch(n.toolsType){case y.LaserPen:{const h=this.computNextAnimationIndex(n,8),c=Math.max(0,n.animationIndex||0),m=(n.animationWorkData||[]).slice(c,h);if((n.animationIndex||0)<h&&((e=n.node)==null||e.consumeService({op:m,isFullWork:!1}),n.animationIndex=h,m.length&&a.set(l,{workState:c===0?I.Start:h===((s=n.animationWorkData)==null?void 0:s.length)?I.Done:I.Doing,op:m.slice(-2)})),n.isDel){(t=n.node)==null||t.clearTmpPoints(),this.serviceWorkShapes.delete(l);break}n.ops&&n.animationIndex===((r=n.animationWorkData)==null?void 0:r.length)&&!n.isDel&&(this.thread.topLayer.getElementsByName(l.toString())[0]||(n.isDel=!0,this.serviceWorkShapes.set(l,n))),o=!0;break}}for(const[l,n]of this.localWorkShapes.entries()){const{result:h,toolsType:c,isDel:m,workState:d}=n;switch(c){case y.LaserPen:{if(m){n.node.clearTmpPoints(),this.localWorkShapes.delete(l),i.push({removeIds:[l.toString()],type:p.RemoveNode});break}h&&((h.op||h.ops)&&i.push(h),n.result=void 0),!this.thread.topLayer.getElementsByName(l.toString())[0]&&d===I.Done&&(n.isDel=!0,this.localWorkShapes.set(l,n)),o=!0;break}}}o&&this.runAnimation(),a.size&&a.forEach((l,n)=>{i.push({type:p.Cursor,uid:n.split(oe)[0],op:l.op,workState:l.workState,viewId:this.thread.viewId})}),i.length&&this.thread.post({sp:i})}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}setWorkOptions(e,s){var t;let r=(t=this.localWorkShapes.get(e))==null?void 0:t.node;if(!r&&this.tmpOpt){const{toolsType:o}=this.tmpOpt;this.tmpOpt.toolsOpt=s,r=this.createWorkShapeNode({workId:e,toolsType:o,toolsOpt:s}),r&&this.localWorkShapes.set(e,{node:r,toolsType:o,workState:I.Start}),this.setToolsOpt(this.tmpOpt)}s!=null&&s.syncUnitTime||(s.syncUnitTime=this.syncUnitTime),r&&r.setWorkOptions(s)}consumeDrawAll(e){const{workId:s,dataType:t}=e;if(t===f.Service)this.activeServiceWorkShape(e);else{const r=s?.toString(),o=r&&this.localWorkShapes.get(r);if(!o)return;const a=o.node.consumeAll({data:e});o.result=a,o.workState=I.Done,r&&this.localWorkShapes.set(r,o)}this.runAnimation()}}class me{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"effectSelectNodeData",new Set),u(this,"batchEraserRemoveNodes",new Set),u(this,"batchEraserWorks",new Set),u(this,"tmpOpt"),u(this,"syncUnitTime",B.syncOpt.interval),u(this,"fullWorkerDrawCount",0),u(this,"drawWorkActiveId"),u(this,"consumeCount",0),u(this,"combineTimerId"),u(this,"combineDrawResolve"),u(this,"combineDrawActiveId"),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return await this.thread.loadImageBitMap(e)}createLocalWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t){const o=s.toString();!this.getToolsOpt()&&r&&this.setToolsOpt({toolsType:r,toolsOpt:t}),this.setWorkOptions(o,t)}}async updateSelector(e){var s;const t=this.workShapes.get(L);if(!((s=t?.selectIds)!=null&&s.length))return;const{callback:r,...o}=e,{updateSelectorOpt:a,willSerializeData:i,smoothSync:l}=o,n=await t?.updateSelector({updateSelectorOpt:a,selectIds:x.cloneDeep(t.selectIds),vNodes:this.vNodes,willSerializeData:i,worker:this}),h=new Map;let c;n!=null&&n.selectIds&&(c=x.xor(t.selectIds,n.selectIds),n.selectIds.forEach(S=>{const v=this.vNodes.get(S);if(v){const{toolsType:w,op:W,opt:g}=v;h.set(S,{opt:g,toolsType:w,ops:W?.length&&j(W)||void 0})}}),t.selectIds=n.selectIds);const m=[],d=r&&r({res:n,workShapeNode:t,param:o,postData:{sp:m},newServiceStore:h,smoothSync:l})||{sp:m};c&&d.sp.push({type:p.RemoveNode,removeIds:c,viewId:this.thread.viewId}),d.sp.length&&this.thread.post(d)}destroy(){this.clearAll()}clearAll(){if(this.thread.localLayer.children.length&&(this.thread.topLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),$(this.thread.localLayer,this.thread.localLayer.parent)),this.workShapes.get(L)){const e=[];e.push({type:p.Select,dataType:f.Local,selectIds:[],willSyncService:!1}),this.thread.post({sp:e})}this.workShapes.clear(),this.effectSelectNodeData.clear(),this.batchEraserWorks.clear(),this.batchEraserRemoveNodes.clear()}async checkTextActive(e){const{op:s,viewId:t,dataType:r}=e;if(s!=null&&s.length){let o;for(const a of this.vNodes.curNodeMap.values()){const{rect:i,name:l,toolsType:n,opt:h}=a,c=s[0]*this.thread.fullLayer.worldScaling[0]+this.thread.fullLayer.worldPosition[0],m=s[1]*this.thread.fullLayer.worldScaling[1]+this.thread.fullLayer.worldPosition[1];if(n===y.Text&&ne([c,m],i)&&h.workState===I.Done){o=l;break}}o&&(await this.blurSelector({viewId:t,msgType:p.Select,dataType:r,isSync:!0}),this.thread.post({sp:[{type:p.GetTextActive,toolsType:y.Text,workId:o}]}))}}cursorHover(e){const{opt:s,toolsType:t,point:r}=e,o=this.setFullWork({workId:U,toolsType:t,opt:s});o&&r&&o.cursorHover(r)}cursorBlur(){var e;const s=this.getWorkShape(U);s&&(e=s.selectIds)!=null&&e.length&&(s.cursorBlur(),this.clearWorkShapeNodeCache(U)),this.thread.fullLayer.parent.children.forEach(t=>{t.name==="Cursor_Hover_Id"&&t.remove()})}updateFullSelectWork(e){var s,t,r,o,a;const i=this.workShapes.get(L),{selectIds:l}=e;if(!(l!=null&&l.length)){this.blurSelector(e);return}if(!i){const n=this.setFullWork(e);!n&&e.workId&&this.tmpOpt&&((s=this.tmpOpt)==null?void 0:s.toolsType)===y.Selector&&this.setWorkOptions(e.workId.toString(),e.opt||this.tmpOpt.toolsOpt),n&&this.updateFullSelectWork(e);return}if(i&&l!=null&&l.length){const{selectRect:n}=i.updateSelectIds(l),h=[{...e,selectorColor:((t=e.opt)==null?void 0:t.strokeColor)||i.selectorColor,strokeColor:((r=e.opt)==null?void 0:r.strokeColor)||i.strokeColor,fillColor:((o=e.opt)==null?void 0:o.fillColor)||i.fillColor,textOpt:((a=e.opt)==null?void 0:a.textOpt)||i.textOpt,canTextEdit:i.canTextEdit,canRotate:i.canRotate,scaleType:i.scaleType,type:p.Select,selectRect:n,points:i.getChildrenPoints(),willSyncService:e?.willSyncService||!1,opt:e?.willSyncService&&i.getWorkOptions()||void 0,canLock:i.canLock,isLocked:i.isLocked,toolsTypes:i.toolsTypes,shapeOpt:i.shapeOpt,thickness:i.thickness,useStroke:i.useStroke,strokeType:i.strokeType}];this.thread.post({sp:h})}}commandDeleteText(e){const s=this.vNodes.get(e);if(s&&s.toolsType===y.Text)return{type:p.TextUpdate,toolsType:y.Text,workId:e,dataType:f.Local}}async removeSelector(e){const{willSyncService:s}=e,t=[],r=[],o=this.workShapes.get(L);if(!o)return;const a=o.selectIds&&[...o.selectIds]||[];for(const i of a){if(this.vNodes.get(i)){const l=this.commandDeleteText(i);l&&t.push(l)}this.removeNode(i),r.push(i)}r.length&&t.push({type:p.RemoveNode,removeIds:r}),t.push({type:p.Select,selectIds:[],willSyncService:s}),await this.blurSelector(),t.length&&this.thread.post({sp:t})}removeWork(e){const{workId:s}=e,t=s?.toString();t&&this.removeNode(t)}removeNode(e){var s;this.vNodes.get(e)&&((s=this.thread.fullLayer)==null||s.getElementsByName(e).forEach(t=>{t.remove(),M(t,this.thread.fullLayer.parent)}),this.vNodes.delete(e)),this.workShapes.has(e)&&(this.thread.localLayer.getElementsByName(e).forEach(t=>{t.remove(),M(t,this.thread.localLayer.parent)}),this.clearWorkShapeNodeCache(e))}setFullWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t&&r){const o=s.toString();let a;return s&&this.workShapes.has(o)?(a=this.workShapes.get(o),a?.setWorkOptions(t)):a=this.createWorkShapeNode({toolsOpt:t,toolsType:r,workId:o}),a?(this.workShapes.set(o,a),a):void 0}}async consumeFull(e){var s;const t=this.setFullWork(e),r=e.ops&&z(e.ops);if(t){const o=(s=e.workId)==null?void 0:s.toString();t.toolsType===y.Image?await t.consumeServiceAsync({isFullWork:!0,replaceId:o,worker:this}):t.toolsType===y.Text?await t.consumeServiceAsync({isFullWork:!0,replaceId:o}):t.consumeService({op:r,isFullWork:!0,replaceId:o}),e!=null&&e.updateNodeOpt&&t.updataOptService(e.updateNodeOpt);const a=[];e.workId&&this.workShapes.delete(e.workId.toString()),e.willSyncService&&a.push({opt:e.opt,toolsType:e.toolsType,type:p.FullWork,workId:e.workId,ops:e.ops,updateNodeOpt:e.updateNodeOpt,viewId:this.thread.viewId}),a.length&&this.thread.post({sp:a})}}async colloctEffectSelectWork(e){const s=this.workShapes.get(L),{workId:t,msgType:r}=e;if(s&&t&&s.selectIds&&s.selectIds.includes(t.toString())){r===p.RemoveNode?s.selectIds=s.selectIds.filter(o=>o!==t.toString()):this.effectSelectNodeData.add(e),await new Promise(o=>{setTimeout(()=>{o(!0)},0)}),await this.runEffectSelectWork(!0).then(()=>{var o;(o=this.effectSelectNodeData)==null||o.clear()});return}return e}async runEffectSelectWork(e){var s;for(const t of this.effectSelectNodeData.values()){const r=this.setFullWork(t);if(r){const o=(s=t.workId)==null?void 0:s.toString();if(r.toolsType===y.Image)await r.consumeServiceAsync({isFullWork:!0,replaceId:o,worker:this});else if(r.toolsType===y.Text)await r.consumeServiceAsync({isFullWork:!0,replaceId:o});else{const a=t.ops&&z(t.ops);r.consumeService({op:a,isFullWork:!0,replaceId:o}),t!=null&&t.updateNodeOpt&&r.updataOptService(t.updateNodeOpt)}t.workId&&this.workShapes.delete(t.workId.toString())}}this.reRenderSelector(e)}hasSelector(){return this.workShapes.has(L)}getSelector(){return this.workShapes.get(L)}reRenderSelector(e=!1){var s;const t=this.workShapes.get(L);if(!t)return;if(t&&!((s=t.selectIds)!=null&&s.length))return this.blurSelector();const r=t.reRenderSelector();r&&this.thread.post({sp:[{type:p.Select,selectIds:t.selectIds,selectRect:r,willSyncService:e,viewId:this.thread.viewId,points:t.getChildrenPoints(),textOpt:t.textOpt,selectorColor:t.selectorColor,strokeColor:t.strokeColor,fillColor:t.fillColor,canTextEdit:t.canTextEdit,canRotate:t.canRotate,scaleType:t.scaleType,opt:t.getWorkOptions()||void 0,canLock:t.canLock,isLocked:t.isLocked,toolsTypes:t.toolsTypes,shapeOpt:t.shapeOpt,thickness:t.thickness,useStroke:t.useStroke,strokeType:t.strokeType}]})}async blurSelector(e){var s;const t=this.workShapes.get(L),r=t?.blurSelector();if(this.clearWorkShapeNodeCache(L),((s=this.thread.fullLayer)==null?void 0:s.parent).children.forEach(o=>{o.name===L&&o.remove()}),r){const o=[];o.push({...r,isSync:e?.isSync}),this.thread.post({sp:o})}}clearWorkShapeNodeCache(e){var s;(s=this.getWorkShape(e))==null||s.clearTmpPoints(),this.workShapes.delete(e)}async drawBitMapEraserFull(e,s,t){const{willUpdateNodes:r,willDeleteNodes:o}=s,a=e.getWorkId(),i=[{type:p.RemoveNode,removeIds:[a],viewId:this.thread.viewId}];if(t&&i.push({type:p.None,isLockSentEventCursor:t}),r!=null&&r.size||o!=null&&o.size){if(r!=null&&r.size)for(const[l,n]of r)i.push({type:p.UpdateNode,dataType:f.Local,opt:n.opt,workId:l,updateNodeOpt:{useAnimation:!1}});o!=null&&o.size&&i.push({type:p.RemoveNode,removeIds:[...o],viewId:this.thread.viewId})}i.length&&this.thread.post({sp:i})}drawPencilEraserFull(e,s,t){const{willNewNodes:r,willDeleteNodes:o}=s,a=e.getWorkId(),i=[{type:p.RemoveNode,removeIds:[a],viewId:this.thread.viewId}];if(t&&i.push({type:p.None,isLockSentEventCursor:t}),r!=null&&r.size||o!=null&&o.size){if(r!=null&&r.size)for(const[l,n]of r)i.push({type:p.FullWork,dataType:f.Local,toolsType:n.toolsType,ops:j(n.op),opt:n.opt,workId:l,updateNodeOpt:{useAnimation:!1}});o!=null&&o.size&&i.push({type:p.RemoveNode,removeIds:[...o],viewId:this.thread.viewId})}i.length&&this.thread.post({sp:i})}drawEraser(e,s){const t=[];e.removeIds&&t.push(e),s&&t.push({type:p.None,isLockSentEventCursor:s}),this.thread.post({sp:t,consumeCount:this.consumeCount})}getWorkShape(e){return this.workShapes.get(e)}getWorkShapes(){return this.workShapes}consumeDraw(e,s){const{op:t,workId:r,scenePath:o,postCount:a,smoothSync:i}=e;if(t!=null&&t.length&&r){const l=r.toString(),n=this.workShapes.get(l);if(!n)return;const h=n.toolsType;if(h===y.LaserPen)return;switch(this.combineDrawActiveId&&this.combineDrawActiveId!==l&&(this.combineTimerId&&(clearTimeout(this.combineTimerId),this.combineTimerId=void 0,this.combineDrawResolve&&this.combineDrawResolve(!1),this.combineDrawActiveId=void 0),this.consumeDrawAll({workId:this.combineDrawActiveId,scenePath:o,viewId:this.thread.viewId,msgType:p.DrawWork,dataType:f.Local},s)),this.drawWorkActiveId&&this.drawWorkActiveId!==l&&(this.consumeDrawAll({workId:this.drawWorkActiveId,scenePath:o,viewId:this.thread.viewId,msgType:p.DrawWork,dataType:f.Local},s),this.drawWorkActiveId=void 0),!this.drawWorkActiveId&&l!==L&&(this.drawWorkActiveId=l),x.isNumber(a)&&(this.consumeCount=a),h){case y.Selector:{const c=n.consume({data:e,isFullWork:!0,isMainThread:!0});this.fullWorkerDrawCount++;const m=[];c.type===p.Select&&(c.selectIds&&s.runReverseSelectWork(c.selectIds),m.push(c)),this.thread.post({consumeCount:this.consumeCount,fullWorkerDrawCount:this.fullWorkerDrawCount,sp:m});break}case y.PencilEraser:case y.BitMapEraser:{n.consume({data:e,isFullWork:!1,isMainThread:!0}),this.fullWorkerDrawCount++,this.thread.post({sp:void 0,consumeCount:this.consumeCount,fullWorkerDrawCount:this.fullWorkerDrawCount}),this.combineTimerId||new Promise(c=>{this.combineDrawActiveId=l,this.combineDrawResolve=c,this.combineTimerId=ce(()=>{this.combineTimerId=void 0,this.combineDrawResolve&&this.combineDrawResolve(!0)},this.thread.master.maxCombineEraserTime,this.thread.master.control.hasPolyfillMethod("requestIdleCallback"))}).then(c=>{c&&this.drawEraserCombine(l),this.combineDrawResolve=void 0});break}case y.Eraser:{const c=n.consume({data:e,isFullWork:!0});this.drawEraser(c)}break;case y.Arrow:case y.Straight:case y.Ellipse:case y.Rectangle:case y.Star:case y.Polygon:case y.SpeechBalloon:case y.Pencil:{const c=n.consume({data:e,isFullWork:!1,isMainThread:!0,smoothSync:i});c&&(this.fullWorkerDrawCount++,this.thread.post({consumeCount:this.consumeCount,fullWorkerDrawCount:this.fullWorkerDrawCount,sp:c.op&&[{...c,scenePath:o}]||void 0}))}break}}}drawEraserCombine(e){var s,t,r,o;const a=(s=this.workShapes.get(e))==null?void 0:s.combineConsume({workerEngine:this});if(a){const{willDeleteNodes:i,willNewNodes:l}=a,n={render:[],sp:[]};if(a!=null&&a.rect){const h=he(a.rect);(t=n.render)==null||t.push({rect:h,isClear:!0,clearCanvas:J.Bg,viewId:this.thread.viewId},{rect:h,drawCanvas:J.Bg,viewId:this.thread.viewId})}if(i!=null&&i.size&&((r=n.sp)==null||r.push({type:p.RemoveNode,removeIds:[...i],viewId:this.thread.viewId})),l!=null&&l.size)for(const[h,c]of l)(o=n.sp)==null||o.push({type:p.FullWork,dataType:f.Local,toolsType:c.toolsType,ops:j(c.op),opt:c.opt,workId:h,updateNodeOpt:{useAnimation:!1}});this.thread.post(n)}}consumeDrawAll(e,s){var t,r,o;const{workId:a,scenePath:i,isLockSentEventCursor:l}=e;if(a){this.combineTimerId&&(clearTimeout(this.combineTimerId),this.combineTimerId=void 0,this.combineDrawResolve&&this.combineDrawResolve(!1),this.combineDrawActiveId=void 0);const n=a.toString();this.drawWorkActiveId===n&&(this.drawWorkActiveId=void 0);const h=this.workShapes.get(n);if(!h)return;const c=h.toolsType;if(c===y.LaserPen)return;const m=this.workShapes.get(U),d=(t=m?.selectIds)==null?void 0:t[0],S=h.consumeAll({data:e,workerEngine:this});switch(c){case y.Selector:{S.selectIds&&d&&(r=S.selectIds)!=null&&r.includes(d)&&m.cursorBlur();const v=[];l&&v.push({type:p.None,isLockSentEventCursor:l}),S.type===p.Select&&(S.selectIds&&s.runReverseSelectWork(S.selectIds),v.push({...S,scenePath:i})),v.length&&this.thread.post({sp:v}),(o=h.selectIds)!=null&&o.length?h.clearTmpPoints():this.clearWorkShapeNodeCache(n)}break;case y.PencilEraser:this.drawPencilEraserFull(h,S,l),this.fullWorkerDrawCount=0,this.clearWorkShapeNodeCache(n);break;case y.BitMapEraser:this.drawBitMapEraserFull(h,S,l),this.fullWorkerDrawCount=0,this.clearWorkShapeNodeCache(n);break;case y.Eraser:this.drawEraser({...S,scenePath:i},l),h.clearTmpPoints();break;case y.Arrow:case y.Straight:case y.Ellipse:case y.Rectangle:case y.Star:case y.Polygon:case y.SpeechBalloon:case y.Pencil:{const v=[];l&&v.push({type:p.None,isLockSentEventCursor:l}),S&&(v.push(S),this.fullWorkerDrawCount=0,this.thread.post({fullWorkerDrawCount:this.fullWorkerDrawCount,sp:v})),this.clearWorkShapeNodeCache(n);break}}}}getToolsOpt(){return this.tmpOpt}setToolsOpt(e){var s;this.tmpOpt=e,(s=e.toolsOpt)!=null&&s.syncUnitTime&&(this.syncUnitTime=e.toolsOpt.syncUnitTime)}setWorkOptions(e,s){let t=this.workShapes.get(e);if(!t&&this.tmpOpt){const{toolsType:r}=this.tmpOpt;this.tmpOpt.toolsOpt=s,t=this.createWorkShapeNode({workId:e,toolsType:r,toolsOpt:s}),t&&this.workShapes.set(e,t),this.setToolsOpt(this.tmpOpt)}s.syncUnitTime||(s.syncUnitTime=this.syncUnitTime),t?.setWorkOptions(s)}createWorkShapeNode(e){return q({...e,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.localLayer},this.thread.serviceWork)}}class ye{constructor(e){u(this,"vNodes"),u(this,"thread"),u(this,"workShapes",new Map),u(this,"selectorWorkShapes",new Map),u(this,"willRunEffectSelectorIds",new Set),u(this,"runEffectId"),u(this,"animationId"),u(this,"syncUnitTime",B.syncOpt.interval),this.vNodes=e.vNodes,this.thread=e.thread}async loadImageBitMap(e){return await this.thread.loadImageBitMap(e)}destroy(){this.clearAll()}clearAll(){this.thread.serviceLayer.children.length&&(this.thread.serviceLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),$(this.thread.serviceLayer,this.thread.serviceLayer.parent)),this.workShapes.clear(),this.selectorWorkShapes.clear(),this.willRunEffectSelectorIds.clear()}runEffect(){this.runEffectId||(this.runEffectId=setTimeout(this.effectRunSelector.bind(this),0))}effectRunSelector(){this.runEffectId=void 0,this.willRunEffectSelectorIds.forEach(e=>{var s,t;const r=this.selectorWorkShapes.get(e);r&&r.selectIds&&((s=r.node)==null||s.selectServiceNode(e,r,!0)),(t=r?.selectIds)!=null&&t.length||this.selectorWorkShapes.delete(e)}),this.willRunEffectSelectorIds.clear()}runSelectWork(e){this.activeSelectorShape(e);const{workId:s}=e,t=s?.toString();t&&this.willRunEffectSelectorIds.add(t),this.runEffect()}removeWork(e){const{workId:s}=e,t=s?.toString();if(t){if(this.workShapes.get(t)){this.workShapes.delete(t),this.removeNode(t,e);return}this.removeNode(t,e)}}consumeFull(e){this.activeWorkShape(e),this.runAnimation()}runReverseSelectWork(e){e.forEach(s=>{this.selectorWorkShapes.forEach((t,r)=>{var o;if((o=t.selectIds)!=null&&o.length){const a=t.selectIds.indexOf(s);a>-1&&(t.selectIds.splice(a,1),this.willRunEffectSelectorIds.add(r))}})}),this.willRunEffectSelectorIds.size&&this.runEffect()}consumeDraw(e){this.activeWorkShape(e),this.runAnimation()}computNextAnimationIndex(e,s){const t=Math.floor((e.animationWorkData||[]).slice(e.animationIndex).length*32/s/this.syncUnitTime)*s;return Math.min((e.animationIndex||0)+(t||s),(e.animationWorkData||[]).length)}async animationDraw(){var e,s,t,r,o,a,i,l,n,h,c,m,d,S,v,w,W,g,R,_;this.animationId=void 0;let X=!1;const F=new Map;for(const[b,k]of this.workShapes.entries())switch(k.toolsType){case y.Image:{await((e=k.node)==null?void 0:e.consumeServiceAsync({isFullWork:!0,worker:this})),this.selectorWorkShapes.forEach((D,C)=>{var O;(O=D.selectIds)!=null&&O.includes(b)&&(this.willRunEffectSelectorIds.add(C),this.runEffect())}),this.workShapes.delete(b);break}case y.Text:{k.node&&(await((s=k.node)==null?void 0:s.consumeServiceAsync({isFullWork:!0,replaceId:b})),this.selectorWorkShapes.forEach((D,C)=>{var O;(O=D.selectIds)!=null&&O.includes(b)&&(this.willRunEffectSelectorIds.add(C),this.runEffect())}),(t=k.node)==null||t.clearTmpPoints(),this.workShapes.delete(b));break}case y.Arrow:case y.Straight:case y.Rectangle:case y.Ellipse:case y.Star:case y.Polygon:case y.SpeechBalloon:{const D=!!k.ops;if((r=k.animationWorkData)!=null&&r.length){const C=k.oldRect;(o=k.node)==null||o.consumeService({op:k.animationWorkData,isFullWork:D}),D&&(this.selectorWorkShapes.forEach((O,A)=>{var G;(G=O.selectIds)!=null&&G.includes(b)&&(this.willRunEffectSelectorIds.add(A),this.runEffect())}),(a=k.node)==null||a.clearTmpPoints(),this.workShapes.delete(b)),k.isEnableCursor?F.set(b,{workState:C?k.ops?I.Done:I.Doing:I.Start,op:k.animationWorkData.slice(-3,-1)}):D&&!k.useAnimation&&(i=k.updateNodeOpt)!=null&&i.useAnimation&&F.set(b,{workState:I.Done,op:k.animationWorkData.slice(-3,-1),uid:(l=k.updateNodeOpt)==null?void 0:l.uid}),k.animationWorkData.length=0}break}case y.Pencil:{if(k.useAnimation){if(k.useAnimation){if(k.isDel){(v=k.node)==null||v.clearTmpPoints(),this.workShapes.delete(b);break}const D=3,C=this.computNextAnimationIndex(k,D),O=k.isDiff?0:Math.max(0,(k.animationIndex||0)-D),A=(k.animationWorkData||[]).slice(O,C),G=(W=(w=k.node)==null?void 0:w.getWorkId())==null?void 0:W.toString();if((k.animationIndex||0)<C||k.isDiff){if((g=k.node)==null||g.consumeService({op:A,isFullWork:!1}),k.animationIndex=C,k.isDiff&&(k.isDiff=!1),A.length&&k.isEnableCursor){const re=A.slice(-3,-1);F.set(b,{workState:O===0?I.Start:C===((R=k.animationWorkData)==null?void 0:R.length)?I.Done:I.Doing,op:re})}}else k.ops&&((_=k.node)==null||_.consumeService({op:k.animationWorkData||[],isFullWork:!0,replaceId:G}),k.isDel=!0,k.isEnableCursor&&F.set(b,{workState:I.Done,op:A.slice(-3,-1)}));X=!0;break}}else{const D=!!k.ops;if((n=k.node)==null||n.consumeService({op:k.animationWorkData||[],isFullWork:D,replaceId:b}),(h=k.node)==null||h.updataOptService(k.updateNodeOpt),D){if(!k.isEnableCursor&&(c=k.updateNodeOpt)!=null&&c.useAnimation&&(m=k.animationWorkData)!=null&&m.length){const C=k.animationWorkData.slice(-3,-1);F.set(b,{workState:I.Done,op:C,uid:(d=k.updateNodeOpt)==null?void 0:d.uid})}this.selectorWorkShapes.forEach((C,O)=>{var A;(A=C.selectIds)!=null&&A.includes(b)&&(this.willRunEffectSelectorIds.add(O),this.runEffect())}),(S=k.node)==null||S.clearTmpPoints(),this.workShapes.delete(b)}}break}}if(X&&this.runAnimation(),F.size){const b=[];F.forEach((k,D)=>{b.push({type:p.Cursor,uid:k.uid||D.split(oe)[0],op:k.op,workState:k.workState,viewId:this.thread.viewId})}),this.thread.post({sp:b})}}runAnimation(){this.animationId||(this.animationId=requestAnimationFrame(this.animationDraw.bind(this)))}hasDiffData(e,s,t){const r=e.length;if(s.length<r)return!0;switch(t){case y.Pencil:{for(let o=0;o<r;o+=3)if(s[o]!==e[o]||s[o+1]!==e[o+1])return!0;break}case y.LaserPen:{for(let o=0;o<r;o+=2)if(s[o]!==e[o]||s[o+1]!==e[o+1])return!0;break}}return!1}activeWorkShape(e){var s,t,r,o;const{workId:a,opt:i,toolsType:l,type:n,updateNodeOpt:h,ops:c,op:m,useAnimation:d,imageBitmap:S,isEnableCursor:v}=e;if(!a)return;const w=a.toString(),W=(s=this.vNodes.get(w))==null?void 0:s.rect;if(!((t=this.workShapes)!=null&&t.has(w))){let R={toolsType:l,animationWorkData:m||[],animationIndex:0,type:n,updateNodeOpt:h,ops:c,useAnimation:typeof d<"u"?d:typeof h?.useAnimation<"u"?h?.useAnimation:!0,oldRect:W,isDiff:!1,imageBitmap:S,isEnableCursor:v};l&&i&&(R=this.setNodeKey(w,R,l,i)),(r=this.workShapes)==null||r.set(w,R)}const g=(o=this.workShapes)==null?void 0:o.get(w);g.isEnableCursor=v,n&&(g.type=n),c&&(g.animationWorkData=z(c),g.ops=c),h&&(g.updateNodeOpt=h),m&&(g.isDiff=this.hasDiffData(g.animationWorkData||[],m,g.toolsType),g.animationWorkData=m),g.node&&g.node.getWorkId()!==w&&g.node.setWorkId(w),W&&(g.oldRect=W),l&&i&&(i.syncUnitTime&&(this.syncUnitTime=i.syncUnitTime),g.toolsType!==l&&l&&i&&this.setNodeKey(w,g,l,i),g.node&&g.node.setWorkOptions(i)),S&&(g.imageBitmap=S)}removeNode(e,s){e.indexOf(L)>-1&&this.removeSelectWork(s),this.thread.fullLayer.getElementsByName(e).forEach(t=>{t.remove(),M(t,this.thread.fullLayer.parent)}),this.thread.serviceLayer.getElementsByName(e).forEach(t=>{t.remove(),M(t,this.thread.serviceLayer.parent)}),this.vNodes.delete(e)}removeSelectWork(e){const{workId:s}=e,t=s?.toString();t&&(this.activeSelectorShape(e),this.willRunEffectSelectorIds.add(t)),this.runEffect()}activeSelectorShape(e){var s,t,r;const{workId:o,opt:a,toolsType:i,type:l,selectIds:n}=e;if(!o)return;const h=o.toString();if(!((s=this.selectorWorkShapes)!=null&&s.has(h))){let m={toolsType:i,selectIds:n,type:l,opt:a};i&&a&&(m=this.setNodeKey(h,m,i,a)),(t=this.selectorWorkShapes)==null||t.set(h,m)}const c=(r=this.selectorWorkShapes)==null?void 0:r.get(h);l&&(c.type=l),c.node&&c.node.getWorkId()!==h&&c.node.setWorkId(h),c.selectIds=n||[]}setNodeKey(e,s,t,r){return s.toolsType=t,s.node=q({toolsType:t,toolsOpt:r,vNodes:this.vNodes,fullLayer:this.thread.fullLayer,drawLayer:this.thread.serviceLayer,workId:e},this),s}}class E{constructor(){u(this,"localWork"),u(this,"serviceWork"),u(this,"threadEngine")}registerMainThread(e){return this.threadEngine=e,this.localWork=e.localWork,this.serviceWork=e.serviceWork,this}}class Se extends E{constructor(){super(...arguments),u(this,"emitEventType",T.CopyNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.FullWork&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t}=e;t&&await((s=this.localWork)==null?void 0:s.consumeFull(e))}}class ke extends E{constructor(){super(...arguments),u(this,"emitEventType",T.SetColorNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r}=e,{willSyncService:o,isSync:a,textUpdateForWoker:i}=s,l=t.sp||[];if(o)for(const[n,h]of r.entries())i&&h.toolsType===y.Text?l.push({...h,workId:n,type:p.TextUpdate,dataType:f.Local,willSyncService:!0}):l.push({...h,workId:n,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:l}}}class ve extends E{constructor(){super(...arguments),u(this,"emitEventType",T.ZIndexNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r}=e,{willSyncService:o,isSync:a}=s,i=t.sp||[];if(o&&i)for(const[l,n]of r.entries())i.push({...n,workId:l,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class we extends E{constructor(){super(...arguments),u(this,"emitEventType",T.TranslateNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s,t;const{workId:r,updateNodeOpt:o,willRefreshSelector:a,willSyncService:i,willSerializeData:l,textUpdateForWoker:n,emitEventType:h,smoothSync:c}=e;r===L&&o&&(o.workState===I.Done&&o!=null&&o.translate&&(o.translate[0]||o.translate[1])||o.workState!==I.Done?await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:o,willRefreshSelector:a,willSyncService:i,willSerializeData:l,isSync:!0,textUpdateForWoker:n,emitEventType:h,callback:this.updateSelectorCallback,smoothSync:c})):o.workState===I.Done&&((t=this.localWork)==null||t.vNodes.deleteLastTarget()))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a,smoothSync:i}=e,{willSyncService:l,isSync:n,updateSelectorOpt:h,textUpdateForWoker:c}=s,m=h.workState,d=t.sp||[];if(m===I.Start)return{sp:[],render:[]};const S=a?.selectRect;if(l){d.push({type:p.Select,selectIds:o.selectIds,selectRect:S,willSyncService:m===I.Done?!0:i,isSync:!0,points:m===I.Done&&o.getChildrenPoints()||void 0,textOpt:o.textOpt});const v={useAnimation:h.useAnimation||!1};h.uid&&(v.uid=h.uid);for(const[w,W]of r.entries())c&&W.toolsType===y.Text?d.push({...W,workId:w,type:p.TextUpdate,dataType:f.Local,willSyncService:m===I.Done?!0:i,updateNodeOpt:v}):(i||m===I.Done)&&d.push({...W,workId:w,type:p.UpdateNode,updateNodeOpt:v,isSync:n})}return{sp:d}}}class fe extends E{constructor(){super(...arguments),u(this,"emitEventType",T.DeleteNode)}async consume(){return!1}}class ge extends E{constructor(){super(...arguments),u(this,"emitEventType",T.ScaleNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willSyncService:o,willSerializeData:a,smoothSync:i}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willSyncService:o,willSerializeData:a,isSync:!0,callback:this.updateSelectorCallback.bind(this),smoothSync:i}))}updateSelectorCallback(e){const{param:s,postData:t,workShapeNode:r,res:o,newServiceStore:a,smoothSync:i}=e,{updateSelectorOpt:l,willSyncService:n}=s,h=l.workState,c=t.sp||[],m=o?.selectRect;if(h===I.Start)return{sp:[],render:[]};if(n){c.push({type:p.Select,selectIds:r.selectIds,selectRect:m,willSyncService:h===I.Done?!0:i,isSync:!0,points:h===I.Done&&r.getChildrenPoints()||void 0,textOpt:r.textOpt});const d={useAnimation:l.useAnimation||!1};l.uid&&(d.uid=l.uid);for(const[S,v]of a.entries())v.toolsType===y.Text?c.push({...v,workId:S,type:p.TextUpdate,dataType:f.Local,willSyncService:h===I.Done?!0:i,updateNodeOpt:d}):(i||h===I.Done)&&c.push({...v,workId:S,type:p.UpdateNode,updateNodeOpt:d,isSync:!0})}return{sp:c}}}class Ie extends E{constructor(){super(...arguments),u(this,"emitEventType",T.RotateNode)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,emitEventType:l,smoothSync:n}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,emitEventType:l,isSync:!0,callback:this.updateSelectorCallback,smoothSync:n}))}updateSelectorCallback(e){const{param:s,postData:t,workShapeNode:r,res:o,newServiceStore:a,smoothSync:i}=e,{updateSelectorOpt:l,willSyncService:n,willSerializeData:h,isSync:c}=s,m=l.workState,d=t.sp||[],S=o?.selectRect;if(n){h&&m===I.Done&&d.push({type:p.Select,selectIds:r.selectIds,selectRect:S,willSyncService:m===I.Done?!0:i,isSync:c,points:r.getChildrenPoints()});const v={useAnimation:l.useAnimation||!1};if(l.uid&&(v.uid=l.uid),i||m===I.Done)for(const[w,W]of a.entries())d.push({...W,workId:w,type:p.UpdateNode,updateNodeOpt:v,isSync:c})}return{sp:d}}}class We extends E{constructor(){super(...arguments),u(this,"emitEventType",T.SetFontStyle)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return await this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a}=e,{willSyncService:i,isSync:l,updateSelectorOpt:n,textUpdateForWoker:h}=s,c=t.sp||[],m=a?.selectRect;if(i&&c){n.fontSize&&c.push({type:p.Select,selectIds:o.selectIds,selectRect:m,willSyncService:i,isSync:l,points:o.getChildrenPoints()});for(const[d,S]of r.entries())h&&S.toolsType===y.Text?c.push({...S,workId:d,type:p.TextUpdate,dataType:f.Local,willSyncService:!0}):c.push({...S,workId:d,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l})}return{sp:c}}}class Te extends E{constructor(){super(...arguments),u(this,"emitEventType",T.SetPoint)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,textUpdateForWoker:l}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,emitEventType:this.emitEventType,willSerializeData:i,isSync:!0,textUpdateForWoker:l,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a}=e,{willSyncService:i,isSync:l}=s,n=t.sp||[],h=a?.selectRect;if(i&&n){for(const[c,m]of r.entries())n.push({...m,workId:c,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});n.push({type:p.Select,selectIds:o.selectIds,selectRect:h,willSyncService:i,isSync:l,points:o.getChildrenPoints()})}return{sp:n}}}class Le extends E{constructor(){super(...arguments),u(this,"emitEventType",T.SetLock)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r,workShapeNode:o,res:a}=e,{willSyncService:i,isSync:l,updateSelectorOpt:n}=s,h=t.sp||[],c=a?.selectRect;if(i&&h){for(const[m,d]of r.entries())h.push({...d,workId:m,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:l});h.push({isLocked:n.isLocked,selectorColor:o.selectorColor,scaleType:o.scaleType,canRotate:o.canRotate,type:p.Select,selectIds:o.selectIds,selectRect:c,willSyncService:i,isSync:l})}return{sp:h}}}class Ne extends E{constructor(){super(...arguments),u(this,"emitEventType",T.SetShapeOpt)}async consume(e){const{msgType:s,dataType:t,emitEventType:r}=e;if(s===p.UpdateNode&&t===f.Local&&r===this.emitEventType)return this.consumeForLocalWorker(e),!0}async consumeForLocalWorker(e){var s;const{workId:t,updateNodeOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i}=e;t===L&&r&&await((s=this.localWork)==null?void 0:s.updateSelector({updateSelectorOpt:r,willRefreshSelector:o,willSyncService:a,willSerializeData:i,callback:this.updateSelectorCallback}))}updateSelectorCallback(e){const{param:s,postData:t,newServiceStore:r}=e,{willSyncService:o,isSync:a}=s,i=t.sp||[];if(o&&i)for(const[l,n]of r.entries())i.push({...n,workId:l,type:p.UpdateNode,updateNodeOpt:{useAnimation:!1},isSync:a});return{sp:i}}}class be{constructor(e){u(this,"builders",new Map),this.builders=new Map(e.map(s=>[s,this.build(s)]))}build(e){switch(e){case T.TranslateNode:return new we;case T.ZIndexNode:return new ve;case T.CopyNode:return new Se;case T.SetColorNode:return new ke;case T.DeleteNode:return new fe;case T.ScaleNode:return new ge;case T.RotateNode:return new Ie;case T.SetFontStyle:return new We;case T.SetPoint:return new Te;case T.SetLock:return new Le;case T.SetShapeOpt:return new Ne}}registerForMainThread(e){return this.builders.forEach(s=>{s&&s.registerMainThread(e)}),this}async consumeForMainThread(e){for(const s of this.builders.values())if(await s?.consume(e))return!0;return!1}}class De{constructor(e,s){u(this,"viewId"),u(this,"fullLayer"),u(this,"topLayer"),u(this,"localLayer"),u(this,"serviceLayer"),u(this,"snapshotFullLayer"),u(this,"vNodes"),u(this,"master"),u(this,"opt"),u(this,"cameraOpt"),u(this,"scene"),u(this,"localWork"),u(this,"serviceWork"),u(this,"topWork"),u(this,"taskUpdateCameraId"),u(this,"debounceUpdateCameraId"),u(this,"debounceUpdateCache",new Set),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"methodBuilder"),u(this,"cacheImages",new Map),u(this,"imageResolveMap",new Map),this.viewId=e,this.opt=s,this.scene=this.createScene({...s.canvasOpt,container:s.container}),this.master=s.master;const t=B.bufferSize.full,r=B.bufferSize.sub;this.fullLayer=this.createLayer("fullLayer",this.scene,{...s.layerOpt,bufferSize:this.viewId===P?t:r*2}),this.topLayer=this.createLayer("topLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,P,r),contextType:"2d"}),this.localLayer=this.createLayer("localLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,P,r),contextType:"2d"}),this.serviceLayer=this.createLayer("serviceLayer",this.scene,{...s.layerOpt,bufferSize:(this.viewId,P,r),contextType:"2d"}),this.vNodes=new ie(e,this.scene);const o={thread:this,vNodes:this.vNodes};this.localWork=new me(o),this.serviceWork=new ye(o),this.topWork=new ue(o),this.vNodes.init(this.fullLayer),this.methodBuilder=new be([T.CopyNode,T.SetColorNode,T.DeleteNode,T.RotateNode,T.ScaleNode,T.TranslateNode,T.ZIndexNode,T.SetFontStyle,T.SetPoint,T.SetLock,T.SetShapeOpt]).registerForMainThread(this)}getCachedImages(e){var s;return(s=this.cacheImages.get(e))==null?void 0:s.imageBitmap}getCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())if(s===e&&t.imageBitmap)return t.imageBitmap}deleteCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())t.workId===e&&(t.imageBitmap.close(),this.cacheImages.delete(s))}clearCacheImages(){this.cacheImages.forEach(e=>e.imageBitmap.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}updateDpr(e){this.scene.displayRatio=e}async on(e){if(!await this.methodBuilder.consumeForMainThread(e)){const{msgType:s,toolsType:t,opt:r,dataType:o,workId:a,workState:i,imageSrc:l,imageBitmap:n,workIds:h,isLockSentEventCursor:c}=e,m=a?.toString();switch(s){case p.UpdateDpr:x.isNumber(e.dpr)&&this.updateDpr(e.dpr);break;case p.AuthClear:{const{clearUids:d,localUid:S}=e;this.vNodes.setCanClearUids(d),this.vNodes.setLocalUid(S);break}case p.Destroy:this.destroy();break;case p.Clear:this.clearAll();break;case p.UpdateCamera:await this.updateCamera(e);break;case p.UpdateTools:if(t&&r){const d={toolsType:t,toolsOpt:r};this.topWork.canUseTopLayer(t)?this.topWork.setToolsOpt(d):this.localWork.setToolsOpt(d)}break;case p.CreateWork:if(m&&r&&t){if(this.topWork.canUseTopLayer(t)){this.topWork.getToolsOpt()||this.topWork.setToolsOpt({toolsType:t,toolsOpt:r}),this.topWork.setWorkOptions(m,r);break}this.localWork.getToolsOpt()||this.localWork.setToolsOpt({toolsType:t,toolsOpt:r}),this.localWork.setWorkOptions(m,r)}break;case p.DrawWork:i===I.Done&&o===f.Local?(this.consumeDrawAll(o,e),t===y.LaserPen&&c&&this.post({sp:[{type:p.None,isLockSentEventCursor:c}]})):this.consumeDraw(o,e);break;case p.UpdateNode:case p.FullWork:if(t&&this.topWork.canUseTopLayer(t)){this.consumeDrawAll(o,e);break}this.consumeFull(o,e);break;case p.RemoveNode:await this.removeNode(e);return;case p.Select:o===f.Service&&(a===L?this.localWork.updateFullSelectWork(e):this.serviceWork.runSelectWork(e));break;case p.CursorBlur:this.localWork.cursorBlur();return;case p.CursorHover:this.localWork.cursorHover(e);break;case p.GetTextActive:o===f.Local&&this.localWork.checkTextActive(e);break;case p.GetImageBitMap:if(l&&n&&a){const d=a.toString();this.deleteCachedImagesByWorkId(d),this.cacheImages.set(l,{imageBitmap:n,workId:d});const S=this.imageResolveMap.get(l);if(S){const{resolve:v,timer:w}=S;w&&clearTimeout(w),v&&v(l)}}break;case p.GetVNodeInfo:if(a&&h){const d=h.map(S=>this.vNodes.get(S));this.post({sp:[{type:p.GetVNodeInfo,dataType:f.Local,workId:a,vInfo:d}]})}break}}}getIconSize(e,s,t){const r=e*t,o=s*t;return r<=50||o<=50?[50,50]:r<=100||o<=100?[100,100]:r<=200||o<=200?[200,200]:r<=400||o<=400?[400,400]:r<=800||o<=800?[800,800]:[1600,1600]}async loadImageBitMap(e){const{toolsType:s,opt:t,workId:r}=e;if(s===y.Image&&t&&r){const o=r.toString(),{src:a,type:i,width:l,height:n,strokeColor:h}=t;if(!a||!i||!l||!n)return;let c=a;if(i===ee.Iconify){const[d,S]=this.getIconSize(l,n,this.opt.displayer.dpr);c=`${a}?width=${d}&height=${S}&color=${h}`}if(this.cacheImages.has(c)){const d=this.getCachedImages(c);if(d)return d}if(this.imageResolveMap.has(c)){const d=this.getCachedImagesByWorkId(o);if(d)return d}const m=await new Promise(d=>{const S=this.imageResolveMap.get(c)||{resolve:void 0,timer:void 0};S.timer&&clearTimeout(S.timer),S.resolve=d,S.timer=setTimeout(()=>{const v=this.imageResolveMap.get(c);v!=null&&v.resolve&&v.resolve(c)},5e3),this.imageResolveMap.set(c,S),this.opt.post({sp:[{imageSrc:c,workId:o,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!1,type:p.GetImageBitMap}]})});return this.imageResolveMap.delete(m),this.getCachedImages(c)}}async removeNode(e){const{dataType:s,workId:t,removeIds:r}=e,o=r||[];if(t&&o.push(t.toString()),o.length)for(const a of o){if(a===L){await this.localWork.removeSelector(e);continue}s===f.Local?this.localWork.removeWork(e):s===f.Service&&this.serviceWork.removeWork(e),await this.localWork.colloctEffectSelectWork(e)}}async consumeFull(e,s){const t=await this.localWork.colloctEffectSelectWork(s);t&&e===f.Local&&await this.localWork.consumeFull(t),t&&e===f.Service&&this.serviceWork.consumeFull(t)}setCameraOpt(e){this.cameraOpt=e;const{scale:s,centerX:t,centerY:r,width:o,height:a}=e;(o!==this.scene.width||a!==this.scene.height)&&this.updateScene({width:o,height:a}),this.fullLayer.setAttribute("scale",[s,s]),this.fullLayer.setAttribute("translate",[-t,-r]),this.topLayer.setAttribute("scale",[s,s]),this.topLayer.setAttribute("translate",[-t,-r]),this.localLayer.setAttribute("scale",[s,s]),this.localLayer.setAttribute("translate",[-t,-r]),this.serviceLayer.setAttribute("scale",[s,s]),this.serviceLayer.setAttribute("translate",[-t,-r])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const s=[];let t,r;for(const o of this.combinePostMsg.values()){if((e=o.sp)!=null&&e.length)for(const a of o.sp){let i=!1;for(const l of s)if(x.isEqual(a,l)){i=!0;break}i||s.push(a)}x.isNumber(o.fullWorkerDrawCount)&&(t=o.fullWorkerDrawCount),x.isNumber(o.consumeCount)&&(r=o.consumeCount)}return this.combinePostMsg.clear(),{sp:s,fullWorkerDrawCount:t,consumeCount:r}}combinePost(){var e,s;const t=this.combinePostData(),r=(e=t.sp)==null?void 0:e.filter(o=>o.type!==p.None||o.isLockSentEventCursor);r!=null&&r.length?t.sp=r.map(o=>o.viewId?o:{...o,viewId:this.viewId}):delete t.sp,t.consumeCount===void 0&&delete t.consumeCount,t.fullWorkerDrawCount===void 0&&delete t.fullWorkerDrawCount,(t!=null&&t.consumeCount||t!=null&&t.fullWorkerDrawCount||(s=t.sp)!=null&&s.length)&&this.opt.post(t)}clearAll(){this.fullLayer.children.length&&(this.fullLayer.parent.children.forEach(e=>{e.name!=="viewport"&&e.remove()}),$(this.fullLayer,this.fullLayer.parent)),this.clearCacheImages(),this.clearImageResolveMap(),this.localWork.clearAll(),this.topWork.clearAll(),this.serviceWork.clearAll(),this.vNodes.clear(),this.post({sp:[{type:p.Clear}]})}consumeDrawAll(e,s){const{toolsType:t,workId:r}=s;if(r){const o=r.toString();if(t&&this.topWork.canUseTopLayer(t)){e===f.Local&&(this.topWork.getLocalWorkShape(r.toString())||this.topWork.createLocalWork(s)),this.topWork.consumeDrawAll(s);return}e===f.Local&&(this.localWork.getWorkShape(o)||this.localWork.createLocalWork(s),this.localWork.consumeDrawAll(s,this.serviceWork))}}consumeDraw(e,s){const{opt:t,workId:r,toolsType:o}=s;if(r&&o&&t){const a=r.toString();if(this.topWork.canUseTopLayer(o)){e===f.Local&&(this.topWork.getLocalWorkShape(a)||this.topWork.createLocalWork(s)),this.topWork.consumeDraw(s);return}e===f.Local?(this.localWork.getWorkShape(a)||this.localWork.createLocalWork(s),this.localWork.consumeDraw(s,this.serviceWork)):e===f.Service&&this.serviceWork.consumeDraw(s);return}}async updateCamera(e){var s;const{cameraOpt:t,scenePath:r}=e;if(t&&!x.isEqual(this.cameraOpt,t)){if(this.taskUpdateCameraId&&(clearTimeout(this.taskUpdateCameraId),this.taskUpdateCameraId=void 0),r){let n=!1;for(const[h,c]of this.localWork.getWorkShapes().entries())switch(c.toolsType){case y.Text:case y.BitMapEraser:case y.PencilEraser:case y.Eraser:case y.Selector:case y.LaserPen:break;default:h!==U&&h!==L&&(n=!0);break}if(n){this.taskUpdateCameraId=setTimeout(()=>{this.taskUpdateCameraId=void 0,this.updateCamera(e)},Y);return}}const o=new Map;for(const[n,h]of this.vNodes.getNodesByType(y.Text).entries()){const c=h.rect;o.set(n,x.cloneDeep(c))}const a=new Set(o.keys());let i=!1;if(this.localWork.hasSelector()){const n=(s=this.localWork.getSelector())==null?void 0:s.selectIds;if(n){i=!0;for(const h of n)a.add(h)}}let l=!1;if(this.serviceWork.selectorWorkShapes.size)for(const n of this.serviceWork.selectorWorkShapes.values()){const h=n.selectIds;if(h){l=!0;for(const c of h)a.add(c)}}if(this.setCameraOpt(t),this.vNodes.curNodeMap.size){this.vNodes.clearTarget(),this.vNodes.updateHighLevelNodesRect(a),this.debounceUpdateCameraId&&clearTimeout(this.debounceUpdateCameraId);for(const[n,h]of o.entries()){const c=this.vNodes.get(n);if(c){const m=h,d=c.rect,S=this.getSceneRect(),v=K(m,S),w=K(d,S);let W=!1;if((v!==w||m.w!==d.w||m.h!==d.h||w===Q.intersect)&&(W=!0),W){const{toolsType:g,opt:R}=c;g===y.Text&&R.workState===I.Done&&this.debounceUpdateCache.add(n)}}}if(i&&this.localWork.reRenderSelector(),l)for(const[n,h]of this.serviceWork.selectorWorkShapes.entries())this.serviceWork.runSelectWork({workId:n,selectIds:h.selectIds,msgType:p.Select,dataType:f.Service,viewId:this.viewId});this.debounceUpdateCameraId=setTimeout(()=>{var n;this.debounceUpdateCameraId=void 0;const h=[];for(const c of this.debounceUpdateCache.values()){if((n=this.fullLayer)!=null&&n.getElementsByName(c)[0]){const m=this.vNodes.get(c);if(m){const{toolsType:d,opt:S,rect:v}=m,w=this.localWork.setFullWork({toolsType:d,opt:S,workId:c});if(w){const W=this.getSceneRect(),g=K(v,W);h.push(w.consumeServiceAsync({isFullWork:!0,replaceId:c,isDrawLabel:g!==Q.outside}))}}}this.debounceUpdateCache.delete(c)}this.vNodes.updateLowLevelNodesRect(),this.vNodes.clearHighLevelIds()},Y)}}}getSceneRect(){const{width:e,height:s}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(s)}}createScene(e){return new te({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!0,id:this.viewId,contextType:"2d"})}createLayer(e,s,t){const{width:r,height:o}=t,a=`canvas-${e}`,i=s.layer(a,{...t,offscreen:!1}),l=new se({anchor:[.5,.5],pos:[r*.5,o*.5],size:[r,o],name:"viewport",id:e});return i.append(l),l}updateScene(e){this.scene.attr({...e});const{width:s,height:t}=e;this.scene.width=s,this.scene.height=t,this.updateLayer({width:s,height:t})}updateLayer(e){const{width:s,height:t}=e;this.fullLayer.parent.setAttribute("width",s),this.fullLayer.parent.setAttribute("height",t),this.fullLayer.setAttribute("size",[s,t]),this.fullLayer.setAttribute("pos",[s*.5,t*.5]),this.topLayer.parent.setAttribute("width",s),this.topLayer.parent.setAttribute("height",t),this.topLayer.setAttribute("size",[s,t]),this.topLayer.setAttribute("pos",[s*.5,t*.5]),this.localLayer.parent.setAttribute("width",s),this.localLayer.parent.setAttribute("height",t),this.localLayer.setAttribute("size",[s,t]),this.localLayer.setAttribute("pos",[s*.5,t*.5]),this.serviceLayer.parent.setAttribute("width",s),this.serviceLayer.parent.setAttribute("height",t),this.serviceLayer.setAttribute("size",[s,t]),this.serviceLayer.setAttribute("pos",[s*.5,t*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.vNodes.clear(),this.fullLayer.remove(),M(this.fullLayer,this.fullLayer.parent),this.topLayer.remove(),M(this.topLayer,this.topLayer.parent),this.localLayer.remove(),M(this.localLayer,this.localLayer.parent),this.serviceLayer.remove(),M(this.serviceLayer,this.serviceLayer.parent),this.scene.remove(),this.localWork.destroy(),this.serviceWork.destroy(),this.topWork.destroy()}}class Ce{constructor(e,s){u(this,"viewId"),u(this,"fullLayer"),u(this,"master"),u(this,"opt"),u(this,"scene"),u(this,"mainThreadPostId"),u(this,"combinePostMsg",new Set),u(this,"workShapes",new Map),u(this,"cacheImages",new Map),u(this,"imageResolveMap",new Map),this.viewId=e,this.opt=s,this.scene=this.createScene({...s.canvasOpt,container:s.container}),this.master=s.master,this.fullLayer=this.createLayer("fullLayer",this.scene,{...s.layerOpt,bufferSize:this.viewId===P?6e3:3e3,contextType:"2d"})}getCachedImages(e){var s;return(s=this.cacheImages.get(e))==null?void 0:s.imageBitmap}getCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())if(s===e&&t.imageBitmap)return t.imageBitmap}deleteCachedImagesByWorkId(e){for(const[s,t]of this.cacheImages.entries())t.workId===e&&(t.imageBitmap.close(),this.cacheImages.delete(s))}clearCacheImages(){this.cacheImages.forEach(e=>e.imageBitmap.close()),this.cacheImages.clear()}clearImageResolveMap(){this.imageResolveMap.forEach(({timer:e})=>{e&&clearTimeout(e)}),this.imageResolveMap.clear()}post(e){this.combinePostMsg.add(e),this.runBatchPostData()}async on(e){const{msgType:s,imageSrc:t,imageBitmap:r,workId:o}=e;switch(s){case p.Snapshot:await this.getSnapshot(e),this.destroy();return;case p.BoundingBox:await this.getBoundingRect(e),this.destroy();return;case p.GetImageBitMap:if(t&&r&&o){const a=o.toString();this.deleteCachedImagesByWorkId(a),this.cacheImages.set(t,{imageBitmap:r,workId:a});const i=this.imageResolveMap.get(t);if(i){const{resolve:l,timer:n}=i;n&&clearTimeout(n),l&&l(t)}}break}}getIconSize(e,s,t){const r=e*t,o=s*t;return r<=50||o<=50?[50,50]:r<=100||o<=100?[100,100]:r<=200||o<=200?[200,200]:r<=400||o<=400?[400,400]:r<=800||o<=800?[800,800]:[1600,1600]}async loadImageBitMap(e){const{toolsType:s,opt:t,workId:r}=e;if(s===y.Image&&t&&r){const o=r.toString(),{src:a,type:i,width:l,height:n,strokeColor:h}=t;if(!a||!i||!l||!n)return;let c=a;if(i===ee.Iconify){const[d,S]=this.getIconSize(l,n,this.opt.displayer.dpr);c=`${a}?width=${d}&height=${S}&color=${h}`}if(this.cacheImages.has(c)){const d=this.getCachedImages(c);if(d)return d}if(this.imageResolveMap.has(c)){const d=this.getCachedImagesByWorkId(o);if(d)return d}const m=await new Promise(d=>{const S=this.imageResolveMap.get(c)||{resolve:void 0,timer:void 0};S.timer&&clearTimeout(S.timer),S.resolve=d,S.timer=setTimeout(()=>{const v=this.imageResolveMap.get(c);v!=null&&v.resolve&&v.resolve(c)},5e3),this.imageResolveMap.set(c,S),this.opt.post({sp:[{imageSrc:c,workId:o,viewId:this.viewId,isgl:!!this.fullLayer.parent.gl,isSubWorker:!0,type:p.GetImageBitMap}]})});return this.imageResolveMap.delete(m),this.getCachedImages(c)}}createWorkShapeNode(e){return q({...e,fullLayer:this.fullLayer,drawLayer:void 0})}setFullWork(e){const{workId:s,opt:t,toolsType:r}=e;if(s&&t&&r){const o=s.toString();let a;return s&&this.workShapes.has(o)?(a=this.workShapes.get(o),a?.setWorkOptions(t)):a=this.createWorkShapeNode({toolsOpt:t,toolsType:r,workId:o}),a?(this.workShapes.set(o,a),a):void 0}}async runFullWork(e){var s;const t=this.setFullWork(e),r=e.ops&&z(e.ops);if(t){let o,a;const i=(s=t.getWorkId())==null?void 0:s.toString();return t.toolsType===y.Image?o=await t.consumeServiceAsync({isFullWork:!0,worker:this}):t.toolsType===y.Text?o=await t.consumeServiceAsync({isFullWork:!0,replaceId:i,isDrawLabel:!0}):(o=t.consumeService({op:r,isFullWork:!0,replaceId:i}),a=e?.updateNodeOpt&&t.updataOptService(e.updateNodeOpt)),V(o,a)}}async getSnapshot(e){const{scenePath:s,scenes:t,cameraOpt:r,w:o,h:a}=e;if(s&&t&&r){this.setCameraOpt(r);let i;for(const[n,h]of Object.entries(t))if(h!=null&&h.type)switch(h?.type){case p.UpdateNode:case p.FullWork:{const{opt:c}=h,m={...h,opt:c,workId:n,msgType:p.FullWork,dataType:f.Service,viewId:this.viewId},d=await this.runFullWork(m);i=V(i,d);break}}let l;o&&a&&(l={resizeWidth:o,resizeHeight:a}),await this.getSnapshotRender({scenePath:s,options:l})}}getSceneRect(){const{width:e,height:s}=this.scene;return{x:0,y:0,w:Math.floor(e),h:Math.floor(s)}}getRectImageBitmap(e,s){const t=Math.floor(e.x*this.opt.displayer.dpr),r=Math.floor(e.y*this.opt.displayer.dpr),o=e.w>0&&Math.floor(e.w*this.opt.displayer.dpr||1)||1,a=e.h>0&&Math.floor(e.h*this.opt.displayer.dpr||1)||1;return createImageBitmap(this.fullLayer.parent.canvas,t,r,o,a,s)}async getSnapshotRender(e){var s;const{scenePath:t,options:r}=e;((s=this.fullLayer)==null?void 0:s.parent).render();const o=await this.getRectImageBitmap(this.getSceneRect(),r);o&&(this.post({sp:[{type:p.Snapshot,scenePath:t,imageBitmap:o,viewId:this.viewId}]}),this.fullLayer&&$(this.fullLayer,this.fullLayer.parent))}async getBoundingRect(e){const{scenePath:s,scenes:t,cameraOpt:r}=e;if(s&&t&&r){this.setCameraOpt(r);let o;for(const[a,i]of Object.entries(t))if(i!=null&&i.type)switch(i?.type){case p.UpdateNode:case p.FullWork:{const l=await this.runFullWork({...i,workId:a,msgType:p.FullWork,dataType:f.Service,viewId:this.viewId});o=V(o,l);break}}o&&this.post({sp:[{type:p.BoundingBox,scenePath:s,rect:o}]})}}setCameraOpt(e){const{scale:s,centerX:t,centerY:r,width:o,height:a}=e;this.updateScene({width:o,height:a}),this.fullLayer.setAttribute("scale",[s,s]),this.fullLayer.setAttribute("translate",[-t,-r])}runBatchPostData(){this.mainThreadPostId||(this.mainThreadPostId=requestAnimationFrame(this.combinePost.bind(this)))}combinePostData(){var e;this.mainThreadPostId=void 0;const s=[];for(const t of this.combinePostMsg.values())if((e=t.sp)!=null&&e.length)for(const r of t.sp){let o=!1;for(const a of s)if(le(r,a)){o=!0;break}o||s.push(r)}return this.combinePostMsg.clear(),{sp:s}}combinePost(){var e,s;const t=this.combinePostData(),r=(e=t.sp)==null?void 0:e.filter(o=>o.type!==p.None||o.isLockSentEventCursor);r!=null&&r.length?t.sp=r.map(o=>o.viewId?o:{...o,viewId:this.viewId}):delete t.sp,(s=t.sp)!=null&&s.length&&this.opt.post(t)}createScene(e){return new te({displayRatio:this.opt.displayer.dpr,depth:!1,desynchronized:!0,...e,autoRender:!1,contextType:"2d"})}createLayer(e,s,t){const{width:r,height:o}=t,a=`canvas-${e}`,i=s.layer(a,t),l=new se({anchor:[.5,.5],pos:[r*.5,o*.5],size:[r,o],name:"viewport",id:e});return i.append(l),l}updateScene(e){this.scene.attr({...e});const{width:s,height:t}=e;this.scene.width=s,this.scene.height=t,this.updateLayer({width:s,height:t})}updateLayer(e){const{width:s,height:t}=e;this.fullLayer.parent.setAttribute("width",s),this.fullLayer.parent.setAttribute("height",t),this.fullLayer.setAttribute("size",[s,t]),this.fullLayer.setAttribute("pos",[s*.5,t*.5])}destroy(){this.clearCacheImages(),this.clearImageResolveMap(),this.fullLayer.remove(),M(this.fullLayer,this.fullLayer.parent),this.scene.remove()}}class qe{constructor(e){u(this,"mainThreadMap",new Map),u(this,"snapshotThread"),u(this,"master"),this.master=e}post(e){const{fullWorkerDrawCount:s,sp:t,workerTasksqueueCount:r,consumeCount:o}=e;this.master.isBusy&&H(r)&&this.master.setWorkerTasksqueueCount(r),H(s)&&this.master.setMaxDrawCount(s),H(o)&&this.master.setConsumeCount(o),t&&this.master.collectorSyncData(t)}destroy(){this.mainThreadMap.clear()}createMainThread(e,s){return new De(e,s)}createSnapshotThread(e,s){return new Ce(e,s)}async consume(e){var s,t,r,o;for(const a of e.values()){const{msgType:i,viewId:l,tasksqueue:n,mainTasksqueueCount:h,layerOpt:c,offscreenCanvasOpt:m,cameraOpt:d,isSubWorker:S}=a;if(i===p.Console){console.log(this);continue}if(i===p.Init){const w=(s=this.master.control.viewContainerManager.getView(l))==null?void 0:s.displayer,W=w?.canvasContainerRef.current;if(w&&W&&c&&m){const g=this.createMainThread(l,{displayer:w,container:W,layerOpt:c,master:this.master,canvasOpt:m,post:this.post.bind(this)});this.mainThreadMap.set(l,g),g&&d&&g.setCameraOpt(d)}continue}if((i===p.Snapshot||i===p.BoundingBox)&&l===((t=this.master.control.viewContainerManager.mainView)==null?void 0:t.id)){const w=(r=this.master.control.viewContainerManager.getView(l))==null?void 0:r.displayer,W=(o=w.snapshotContainerRef)==null?void 0:o.current;if(w&&W&&d){W.style.width=`${d.width}px`,W.style.height=`${d.height}px`;const g={...Z.defaultLayerOpt,offscreen:!1,width:d.width,height:d.height},R={...Z.defaultScreenCanvasOpt,width:d.width,height:d.height};this.snapshotThread=this.createSnapshotThread(l,{displayer:w,container:W,layerOpt:g,master:this.master,canvasOpt:R,post:this.post.bind(this)}),this.snapshotThread.on(a).then(()=>{this.snapshotThread=void 0,W.innerHTML="",W.style.width="",W.style.height=""});continue}}if(i===p.GetImageBitMap&&S&&this.snapshotThread){this.snapshotThread.on(a);continue}if(i===p.TasksQueue&&n!=null&&n.size){for(const[w,W]of this.mainThreadMap.entries()){const g=n.get(w);g&&(await W.on(g),h&&this.post({workerTasksqueueCount:h}))}continue}if(l===ae){for(const w of this.mainThreadMap.values())w.on(a),i===p.Destroy&&this.mainThreadMap.delete(l);continue}const v=this.mainThreadMap.get(l);v&&(v.on(a),i===p.Destroy&&this.mainThreadMap.delete(l))}}}export{qe as MainThreadManagerImpl};
