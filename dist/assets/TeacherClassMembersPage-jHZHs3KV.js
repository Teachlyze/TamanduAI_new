import{ak as P,u as q,r as t,j as e,U as d,C as w,s as o,aq as k}from"./main-NgjJy_CG.js";import{P as f}from"./PremiumCard-BGO_It48.js";import{P as R}from"./PremiumButton-DDGOGflQ.js";import{E as n}from"./EmptyState-Cb7n_MKP.js";import{T as C}from"./trash-2-Bhwmq7t6.js";const z=()=>{const{classId:a}=P(),{user:S}=q(),[M,h]=t.useState(!0),[p,E]=t.useState(null),[_,j]=t.useState([]),[g,b]=t.useState([]),[v,y]=t.useState(null);t.useEffect(()=>{(async()=>{if(a){h(!0);try{const{data:i,error:r}=await o.from("classes").select("id, name, created_by").eq("id",a).maybeSingle();if(r)throw r;E(i);const{data:u,error:l}=await o.from("class_members").select("id, user_id, role, joined_at, nickname, user:profiles(id, full_name, email)").eq("class_id",a).order("joined_at",{ascending:!1});if(l)throw l;j(u||[]);const{data:x,error:N}=await o.from("class_member_history").select("id, user_id, action, role, performed_by, reason, created_at, user:profiles!class_member_history_user_id_fkey(full_name), performer:profiles!class_member_history_performed_by_fkey(full_name)").eq("class_id",a).order("created_at",{ascending:!1}).limit(50);if(N)throw N;b(x||[])}catch(i){console.error("Erro ao carregar membros:",i)}finally{h(!1)}}})()},[a]);const A=async(s,i)=>{if(window.confirm("Tem certeza que deseja remover este aluno da turma?")){y(s);try{await o.rpc("set_config",{parameter:"app.current_user_id",value:S.id});const{error:r}=await o.from("class_members").delete().eq("id",s);if(r)throw r;j(l=>l.filter(x=>x.id!==s)),k.success?.("Aluno removido da turma");const{data:u}=await o.from("class_member_history").select("id, user_id, action, role, performed_by, reason, created_at, user:profiles!class_member_history_user_id_fkey(full_name), performer:profiles!class_member_history_performed_by_fkey(full_name)").eq("class_id",a).order("created_at",{ascending:!1}).limit(50);b(u||[])}catch(r){console.error("Erro ao remover membro:",r),k.error?.("Erro ao remover aluno")}finally{y(null)}}};if(!p)return e.jsx(n,{icon:d,title:"Turma não encontrada"});const c=_.filter(s=>s.role==="student"),m=_.filter(s=>s.role==="teacher");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gradient-to-br from-indigo-600 to-purple-600 p-8 rounded-2xl text-white",children:[e.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-3",children:[e.jsx(d,{className:"w-6 h-6"})," Gerenciar Membros"]}),e.jsx("p",{className:"text-slate-900 dark:text-white/90",children:p.name})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("h2",{className:"text-lg font-bold",children:["Alunos (",c.length,")"]}),c.length===0?e.jsx(n,{icon:d,title:"Sem alunos",description:"Nenhum aluno matriculado ainda."}):e.jsx("div",{className:"space-y-2",children:c.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.user?.full_name||"Aluno"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.user?.email}),s.nickname&&e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Apelido: ",s.nickname]}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Entrou: ",new Date(s.joined_at).toLocaleDateString("pt-BR")]})]}),e.jsx(R,{variant:"outline",size:"sm",onClick:()=>A(s.id,s.user_id),disabled:v===s.id,leftIcon:C,children:v===s.id?"Removendo...":"Remover"})]},s.id))})]})}),e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("h2",{className:"text-lg font-bold",children:["Professores (",m.length,")"]}),m.length===0?e.jsx(n,{icon:d,title:"Sem co-professores"}):e.jsx("div",{className:"space-y-2",children:m.map(s=>e.jsxs("div",{className:"p-3 rounded-lg border border-border",children:[e.jsx("div",{className:"font-medium",children:s.user?.full_name||"Professor"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:s.user?.email})]},s.id))})]})})]}),e.jsx(f,{variant:"elevated",children:e.jsxs("div",{className:"p-6 space-y-4",children:[e.jsxs("h2",{className:"text-lg font-bold flex items-center gap-2",children:[e.jsx(w,{className:"w-5 h-5"})," Histórico de Alterações"]}),g.length===0?e.jsx(n,{icon:w,title:"Sem histórico",description:"Nenhuma alteração registrada."}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:g.map(s=>e.jsxs("div",{className:"p-3 rounded-lg border border-border text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`px-2 py-1 rounded text-xs font-semibold ${s.action==="added"?"bg-green-100 text-green-700":s.action==="removed"?"bg-red-100 text-red-700":"bg-blue-100 text-blue-700"}`,children:s.action==="added"?"Adicionado":s.action==="removed"?"Removido":"Alterado"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:new Date(s.created_at).toLocaleString("pt-BR")})]}),e.jsxs("div",{className:"mt-1",children:[e.jsx("strong",{children:s.user?.full_name||"Usuário"})," (",s.role,")",s.performer?.full_name&&e.jsxs(e.Fragment,{children:[" por ",e.jsx("strong",{children:s.performer.full_name})]})]}),s.reason&&e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:["Motivo: ",s.reason]})]},s.id))})]})})]})};export{z as default};
