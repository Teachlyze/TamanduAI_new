import{r as d,j as e,f as Te,u as ge,T as Me,P as Re,ap as ze,R as ke}from"./react-vendor-C2HUFn5N.js";import{c as ve,u as Ee,j as ie,I as he,C as Le,b as Be,d as Ie,B as te,e as Ve,S as Qe,f as Ge,g as He,h as We,i as Xe,s as y}from"./lazy-CreateActivityPage.jsx-DYBofU2F.js";import{Z as Ae,_ as Je}from"./ui-vendor-Dv2DrOQv.js";import{D as Ke,a as Ye,b as Ze,c as es,d as ss}from"./page-ActivityManagementPage.jsx-C56hp2jB.js";import{u as Ce,b as ts,a as rs}from"./vendor-react-router-B4Bn0PSh.js";import{j as $e,k as ue,l as xe,m as pe,n as ee,o as re,p as as,q as Pe,r as os,s as is,t as ns,u as be,v as ye,a as ls,w as cs}from"./vendor-react-icons-DKBOa7A2.js";import{u as ds}from"./vendor-react-dropzone-JpbzFaVP.js";import{m as ce,A as me}from"./motion-vendor-Crtv24Dn.js";import{u as ms}from"./form-vendor-DOeDnMZv.js";import{T as us,a as xs,b as we,c as je}from"./vendor-react-tabs-ke5kyYRH.js";import{u as ps}from"./page-ActivitiesListPage.jsx-Cv5lq7oV.js";const qe=d.forwardRef(({className:s,...a},p)=>e.jsx(Ae,{ref:p,className:ve("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",s),...a,children:e.jsx(Je,{className:ve("flex items-center justify-center text-current"),children:e.jsx(Te,{className:"h-4 w-4"})})}));qe.displayName=Ae.displayName;const Ne=s=>s.format==="date"?"date":s.format==="textarea"?"textarea":s.type==="number"?"number":s.type==="boolean"?"boolean":s.enum?"select":s.type==="array"&&s.items?.enum?"checkboxes":"string",hs=[{value:"string",label:"Texto Curto"},{value:"textarea",label:"Parágrafo"},{value:"select",label:"Múltipla Escolha"},{value:"checkboxes",label:"Checkbox"},{value:"number",label:"Número"},{value:"date",label:"Data"}],Se=({activityId:s,initialData:a,onActivityCreated:p})=>{const{toast:n}=Ee(),[g,k]=d.useState(a?.schema?.title||""),[_,A]=d.useState(a?.schema?.properties?Object.entries(a.schema.properties).map(([i,b],l)=>({id:l+1,type:Ne(b),question:b.title||"",required:a.schema.required?.includes(i)||!1,options:b.enum||b.items?.enum||[]})):[{id:1,type:"string",question:"",options:[]}]),[w,O]=d.useState(!1),[F,B]=d.useState(!1),[U,Q]=d.useState(null),[V,E]=d.useState(!0),[j,S]=d.useState(!!s&&!a),[P,N]=d.useState(!1),[h,C]=d.useState(null),[t,x]=d.useState([]),[$,o]=d.useState([]),R=async(i=!1)=>{if(w||F)return console.log("Save already in progress, skipping..."),null;try{console.log("Starting save operation..."),B(!0);const b=y.auth.user();if(!b)throw new Error("Usuário não autenticado. Por favor, faça login novamente.");console.log("Preparing activity data...");const l={title:G&&G.title||"Sem título",description:"",schema:G||{},ui_schema:H||{},created_by:b.id,is_draft:i?!1:V,updated_at:new Date().toISOString()};console.log("Saving activity data:",l);let c;try{if(s){console.log("Updating existing activity:",s);const{data:T,error:L}=await y.from("activity_templates").update(l).eq("id",s).select().single();if(L)throw console.error("Error updating activity:",L),L;c=T,console.log("Activity updated successfully:",c)}else{console.log("Creating new activity");const{data:T,error:L}=await y.from("activities").insert([l]).select().single();if(L)throw console.error("Error creating activity:",L),L;c=T,console.log("Activity created successfully:",c),c?.id&&(console.log("Updating URL with new activity ID:",c.id),window.history.replaceState({},"",`/dashboard/atividade/editar/${c.id}`))}if(Q(new Date),n({title:i?"Atividade publicada!":"Rascunho salvo",description:i?"Sua atividade foi publicada com sucesso.":"Suas alterações foram salvas automaticamente.",variant:"default"}),i){E(!1);try{if(c?.id&&(await y.from("activity_class_assignments").delete().eq("activity_id",c.id),$.length>0)){const T=$.map(L=>({activity_id:c.id,class_id:L}));await y.from("activity_class_assignments").insert(T)}}catch(T){console.warn("Failed to save class assignments:",T)}}return console.log("Save operation completed successfully"),c}catch(T){throw console.error("Database operation failed:",T),new Error(T.message||"Falha ao salvar no banco de dados")}}catch(b){throw console.error("Error in saveActivity:",b),n({title:"Erro ao salvar",description:b.message||"Ocorreu um erro ao salvar a atividade. Por favor, tente novamente.",variant:"destructive"}),b}finally{console.log("Cleaning up save operation..."),B(!1),O(!1)}},D=d.useRef(R);d.useEffect(()=>{D.current=R});const q=d.useCallback((i=!1)=>{h&&clearTimeout(h);const b=setTimeout(()=>{D.current&&D.current(i)},i?0:2e3);return C(b),()=>clearTimeout(b)},[h]);d.useEffect(()=>()=>{h&&clearTimeout(h)},[h]),d.useEffect(()=>{let i=!0;return(async()=>{if(!s){console.log("No activityId provided, skipping load"),i&&S(!1);return}if(a){console.log("Using provided initialData, skipping load"),i&&S(!1);return}console.log(`Loading activity with ID: ${s}`);try{i&&S(!0);const l=setTimeout(()=>{i&&(console.warn("Activity loading is taking too long, forcing completion"),S(!1))},1e4),{data:c,error:T}=await y.from("activity_templates").select("*").eq("id",s).single();if(clearTimeout(l),T)throw console.error("Error loading activity:",T),T;if(!c){console.warn("No data received for activity ID:",s),i&&S(!1);return}if(console.log("Activity data loaded:",c),!i){console.log("Component unmounted before setting state");return}try{const L=typeof c.schema=="string"?JSON.parse(c.schema):c.schema||{title:"Nova Atividade",type:"object",properties:{}};console.log("Parsed schema:",L),k(L.title||""),E(!!c.is_draft);let Z=[];L.properties&&Object.keys(L.properties).length>0&&(Z=Object.entries(L.properties).map(([K,Y],se)=>{const de=Ne(Y);return{id:`q-${Date.now()}-${se}`,type:de,question:Y.title||`Pergunta ${se+1}`,required:Array.isArray(L.required)?L.required.includes(K):!1,options:Array.isArray(Y.enum)?[...Y.enum]:Array.isArray(Y.items?.enum)?[...Y.items.enum]:[]}})),Z.length===0&&(Z=[{id:`q-${Date.now()}-0`,type:"string",question:"",options:[]}]),console.log("Setting questions from schema:",Z),A(Z)}catch(L){throw console.error("Error parsing activity data:",L),new Error("Erro ao processar os dados da atividade. O formato pode estar incorreto.")}}catch(l){console.error("Error in loadActivity:",l);let c="Não foi possível carregar os dados da atividade.";l.message.includes("permission_denied")?c="Você não tem permissão para visualizar esta atividade.":l.message.includes("network")?c="Erro de conexão. Verifique sua internet e tente novamente.":l.message&&(c=l.message),n({title:"Erro ao carregar",description:c,variant:"destructive"}),setTimeout(()=>{i&&!window.location.pathname.endsWith("/novo")&&X("/activities")},2e3)}finally{i&&(console.log("Loading complete, setting isLoading to false"),S(!1))}})(),()=>{i=!1}},[s,a,n,X]),d.useEffect(()=>{let i=!0;return(async()=>{try{const{data:l}=await y.auth.getUser(),c=l?.user?.id;if(!c)return;const[{data:T,error:L},{data:Z,error:K}]=await Promise.all([y.from("class_members").select("class_id, role").eq("user_id",c),y.from("classes").select("id").eq("created_by",c)]);if(L)throw L;if(K)throw K;const Y=new Set([...T?.map(oe=>oe.class_id)||[],...Z?.map(oe=>oe.id)||[]]);if(Y.size===0){i&&x([]);return}const{data:se,error:de}=await y.from("classes").select("id, name, color").in("id",Array.from(Y));if(de)throw de;if(i&&x(se||[]),s){const{data:oe}=await y.from("activity_class_assignments").select("class_id").eq("activity_id",s);oe&&i&&o(oe.map(Oe=>Oe.class_id))}}catch(l){console.warn("Failed to load classes for assignment",l)}})(),()=>{i=!1}},[s]);const z=i=>{const b=i();return q(),b},r=()=>{A([..._,{id:_.length+1,type:"string",question:"",options:[]}])},u=(i,b,l)=>{z(()=>{const c=_.map(T=>T.id===i?{...T,[b]:l}:T);return A(c),c})},v=i=>{z(()=>{const b=_.map(l=>l.id===i?{...l,options:[...l.options,""]}:l);return A(b),b})},m=(i,b,l)=>{z(()=>{const c=_.map(T=>{if(T.id===i){const L=[...T.options];return L[b]=l,{...T,options:L}}return T});return A(c),c})},f=i=>{_.length>1&&z(()=>{const b=_.filter(l=>l.id!==i);return A(b),b})},M=(i,b)=>{z(()=>{const l=_.map(c=>{if(c.id===i){const T=[...c.options];return T.splice(b,1),{...c,options:T}}return c});return A(l),l})},{schema:G,uiSchema:H}=d.useMemo(()=>{const i={},b=[],l={};return _.forEach((c,T)=>{const L=`question_${T+1}`,Z={textarea:"string",string:"string",number:"number",date:"string",select:"string",checkboxes:"array"}[c.type]||"string",K={title:c.question,type:Z};c.type==="textarea"?K.format="textarea":c.type==="date"?K.format="date":(c.type==="select"||c.type==="checkboxes")&&(c.type==="select"?K.enum=c.options:(K.items={type:"string",enum:c.options},K.uniqueItems=!0)),i[L]=K,c.required&&b.push(L);const Y={textarea:"textarea",date:"date",select:"select",checkboxes:"checkboxes"};l[L]={"ui:widget":Y[c.type],"ui:options":c.type==="select"||c.type==="checkboxes"?{enumOptions:c.options.map(se=>({label:se,value:se}))}:void 0}}),{schema:{title:g.trim()||"Nova Atividade",type:"object",properties:i,required:b.length>0?b:void 0},uiSchema:l}},[_,g]),J=()=>{N(!0)},X=Ce(),I=d.useCallback(()=>{const i=[];return g.trim()||i.push("Por favor, insira um título para a atividade."),_.forEach((b,l)=>{b.question.trim()||i.push(`A pergunta #${l+1} está vazia.`),(b.type==="select"||b.type==="checkboxes")&&b.options.length<2&&i.push(`A pergunta "${b.question||`#${l+1}`}" precisa de pelo menos 2 opções.`),(b.type==="select"||b.type==="checkboxes")&&b.options.some(c=>!c.trim())&&i.push(`A pergunta "${b.question||`#${l+1}`}" tem opções vazias.`)}),i},[g,_]),ae=async i=>{if(i.preventDefault(),w){console.log("Submit already in progress, skipping...");return}const b=I();if(b.length>0){console.log("Form validation failed with errors:",b),n({title:"Erro de validação",description:e.jsx("div",{className:"space-y-1",children:b.map((l,c)=>e.jsxs("div",{className:"flex items-start",children:[e.jsx("span",{className:"mr-2",children:"•"}),e.jsx("span",{children:l})]},c))}),variant:"destructive"});return}try{console.log("Starting form submission..."),O(!0),console.log("Calling saveActivity with isFinal=true");const l=await R(!0);if(!l||!l.id)throw new Error("A resposta do servidor está incompleta. Por favor, tente novamente.");console.log("Activity saved successfully, result:",l),n({title:"Sucesso!",description:"Atividade salva com sucesso.",variant:"default"}),console.log("Preparing to redirect after save..."),setTimeout(()=>{try{p?(console.log("Calling onActivityCreated with ID:",l.id),p(l.id)):(console.log("Navigating to /activities"),X("/activities"))}catch(c){console.error("Error during navigation:",c),window.location.href="/activities"}},1500)}catch(l){console.error("Error in handleSubmit:",l);let c="Ocorreu um erro ao salvar a atividade. Por favor, tente novamente.";throw l.message&&(l.message.includes("network")?c="Erro de conexão. Verifique sua conexão com a internet e tente novamente.":l.message.includes("permission_denied")?c="Você não tem permissão para realizar esta ação.":l.message.includes("violates not-null constraint")?c="Erro de configuração do banco de dados. A atividade precisa estar associada a uma turma ou o sistema precisa ser atualizado.":l.message.includes("Já existe")?c=l.message:l.message.includes("timeout")?c="A operação demorou muito para ser concluída. Verifique sua conexão e tente novamente.":l.message.includes("Unknown network error")?c="Erro de conexão com o servidor. Verifique sua internet e tente novamente em alguns instantes.":c=l.message),n({title:"Erro ao salvar",description:c,variant:"destructive"}),l}finally{console.log("Cleaning up submit state...")}};return j?e.jsx("div",{className:"flex h-screen items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(ge,{className:"h-8 w-8 animate-spin"}),e.jsx("p",{className:"text-muted-foreground",children:"Carregando atividade..."})]})}):e.jsxs("div",{className:"bg-card p-6 rounded-lg shadow-sm",children:[e.jsx("h2",{className:"text-2xl font-bold mb-6",children:s?"Editar Atividade":"Criar Nova Atividade"}),e.jsxs("form",{onSubmit:ae,className:"space-y-6",children:[e.jsx("div",{className:"flex justify-end items-center mb-2",children:F?e.jsxs("p",{className:"text-sm text-muted-foreground flex items-center",children:[e.jsx(ge,{className:"h-4 w-4 animate-spin mr-2"})," Salvando..."]}):U?e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Último salvamento: ",new Date(U).toLocaleTimeString()]}):null}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:"activity-title",children:"Título da Atividade"}),e.jsx(he,{id:"activity-title",value:g,onChange:i=>k(i.target.value),placeholder:"Digite o título da atividade",required:!0,disabled:w})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:"Distribuir para turmas"}),t.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Você ainda não participa de nenhuma turma."}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2",children:t.map(i=>{const b=$.includes(i.id);return e.jsxs("label",{className:"flex items-center gap-2 border rounded-md p-2 cursor-pointer",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4",checked:b,onChange:l=>{o(c=>l.target.checked?[...c,i.id]:c.filter(T=>T!==i.id)),q()},disabled:w}),e.jsx("span",{className:"truncate",children:i.name}),i.color?e.jsx("span",{className:"ml-auto h-3 w-3 rounded-full",style:{backgroundColor:i.color}}):null]},i.id)})})]}),e.jsx("div",{className:"space-y-4",children:_.map((i,b)=>e.jsxs(Le,{className:"p-4",children:[e.jsx(Be,{className:"p-0 pb-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs(Ie,{className:"text-lg",children:["Pergunta ",b+1]}),e.jsxs(te,{type:"button",variant:"ghost",size:"icon",onClick:()=>f(i.id),disabled:w||_.length===1,className:"text-destructive hover:bg-destructive/10 h-8 w-8",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Remover pergunta"})]})]})}),e.jsxs(Ve,{className:"p-0 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:`question-type-${i.id}`,children:"Tipo de Pergunta"}),e.jsxs(Qe,{value:i.type,onValueChange:l=>u(i.id,"type",l),disabled:w,children:[e.jsx(Ge,{id:`question-type-${i.id}`,children:e.jsx(He,{placeholder:"Selecione o tipo de pergunta"})}),e.jsx(We,{children:hs.map(l=>e.jsx(Xe,{value:l.value,children:l.label},l.value))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{htmlFor:`question-${i.id}`,children:"Pergunta"}),e.jsx(he,{id:`question-${i.id}`,value:i.question,onChange:l=>u(i.id,"question",l.target.value),placeholder:"Digite o enunciado da pergunta",disabled:w})]}),(i.type==="select"||i.type==="checkboxes")&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ie,{children:"Opções"}),e.jsxs("div",{className:"space-y-2",children:[i.options.map((l,c)=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{value:l,onChange:T=>m(i.id,c,T.target.value),placeholder:`Opção ${c+1}`,disabled:w}),e.jsx(te,{type:"button",variant:"ghost",className:"text-destructive",onClick:()=>M(i.id,c),disabled:w,children:"Remover"})]},c)),e.jsx(te,{type:"button",variant:"outline",onClick:()=>v(i.id),disabled:w,children:"Adicionar opção"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(qe,{id:`required-${i.id}`,checked:!!i.required,onCheckedChange:l=>u(i.id,"required",!!l),disabled:w}),e.jsx(ie,{htmlFor:`required-${i.id}`,children:"Resposta obrigatória"})]})]})]},i.id))}),e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs(te,{type:"button",variant:"outline",onClick:()=>r(),disabled:w,children:[e.jsx(Re,{className:"w-4 h-4 mr-2"})," Adicionar pergunta"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(te,{type:"button",variant:"secondary",onClick:J,disabled:w,children:[e.jsx(ze,{className:"w-4 h-4 mr-2"})," Preview"]}),e.jsx(te,{type:"submit",disabled:w,children:w?"Salvando...":"Publicar atividade"})]})]})]}),e.jsx(Ke,{open:P,onOpenChange:N,children:e.jsxs(Ye,{className:"sm:max-w-[600px]",children:[e.jsx(Ze,{children:e.jsx(es,{children:"Preview do Formulário"})}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsx("h3",{className:"text-lg font-medium",children:g}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Visualização do formulário que será exibido aos alunos."})]}),e.jsx(ss,{children:e.jsx(te,{type:"button",onClick:()=>N(!1),children:"Fechar"})})]})})]})},ne={DRAFTS:"drafts",ACTIVITIES:"activities",SUBMISSIONS:"submissions"},fs=async(s,a,p="")=>{try{const n=s.name.split(".").pop(),g=`${Math.random().toString(36).substring(2,15)}-${Date.now()}.${n}`,k=p?`${p}/${g}`:g,{data:_,error:A}=await y.storage.from(a).upload(k,s,{cacheControl:"3600",upsert:!1});if(A)throw A;const{data:{publicUrl:w}}=y.storage.from(a).getPublicUrl(k);return{data:{path:_.path,publicUrl:w,fileName:s.name,fileType:s.type,size:s.size},error:null}}catch(n){return console.error("Error uploading file:",n),{data:null,error:n}}},Fe=async(s,a)=>{try{const{data:p,error:n}=await y.storage.from(s).remove([a]);if(n)throw n;return{data:p,error:null}}catch(p){return console.error("Error removing file:",p),{data:null,error:p}}},gs=async(s,a,p,n)=>{try{const{data:g,error:k}=await y.storage.from(s).download(a);if(k)throw k;const{data:_,error:A}=await fs(new File([g],n.split("/").pop(),{type:g.type}),p,n.split("/").slice(0,-1).join("/"));if(A)throw A;return await Fe(s,a),{data:_,error:null}}catch(g){return console.error("Error moving file:",g),{data:null,error:g}}},Ue=({onUpload:s,onRemove:a,files:p=[],maxFiles:n=5,maxSize:g=10*1024*1024,accept:k={"image/*":[".jpeg",".jpg",".png",".gif"],"application/pdf":[".pdf"],"application/msword":[".doc"],"application/vnd.openxmlformats-officedocument.wordprocessingml.document":[".docx"],"application/vnd.ms-excel":[".xls"],"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"],"text/plain":[".txt"],"application/zip":[".zip"],"application/x-rar-compressed":[".rar"]},disabled:_=!1,label:A="Arraste e solte arquivos aqui, ou clique para selecionar",subLabel:w=`Máx. ${n} arquivos • ${g/(1024*1024)}MB por arquivo`,className:O=""})=>{const[F,B]=d.useState(!1),[U,Q]=d.useState([]),V=d.useRef(null),E=d.useCallback((t,x)=>{if(B(!1),p.length+t.length>n){Q($=>[...$,`Você só pode fazer upload de no máximo ${n} arquivos.`]);return}if(x&&x.length>0){const $=x.map(({file:o,errors:R})=>R.some(D=>D.code==="file-too-large")?`O arquivo ${o.name} é muito grande. Tamanho máximo: ${g/1048576}MB`:R.some(D=>D.code==="file-invalid-type")?`Tipo de arquivo não suportado: ${o.name}`:`Erro ao processar o arquivo ${o.name}`);Q(o=>[...o,...$])}t.length>0&&s&&s(t)},[p.length,n,g,s]),{getRootProps:j,getInputProps:S}=ds({onDrop:E,accept:k,maxSize:g,maxFiles:n-p.length,disabled:_||p.length>=n,onDragEnter:()=>B(!0),onDragLeave:()=>B(!1),noClick:!1,noKeyboard:!0}),P=(t,x)=>{a&&a(t,x)},N=t=>{_||V.current?.click()};ke.useEffect(()=>{if(U.length>0){const t=setTimeout(()=>{Q([])},5e3);return()=>clearTimeout(t)}},[U]);const h=t=>t?t.startsWith("image/")?e.jsx(ee,{className:"w-5 h-5 text-blue-500"}):t==="application/pdf"?e.jsx(ee,{className:"w-5 h-5 text-red-500"}):t==="application/msword"||t==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"?e.jsx(ee,{className:"w-5 h-5 text-blue-600"}):t==="application/vnd.ms-excel"||t==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"?e.jsx(ee,{className:"w-5 h-5 text-green-600"}):t==="text/plain"?e.jsx(ee,{className:"w-5 h-5 text-gray-500"}):t==="application/zip"||t==="application/x-rar-compressed"?e.jsx(ee,{className:"w-5 h-5 text-yellow-500"}):e.jsx(ee,{className:"w-5 h-5 text-gray-400"}):e.jsx(ee,{className:"w-5 h-5"}),C=t=>t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`;return e.jsxs("div",{className:`space-y-4 ${O}`,children:[e.jsxs("div",{...j(),className:`
          border-2 border-dashed rounded-lg p-6 text-center transition-colors
          ${F?"border-blue-500 bg-blue-50":"border-gray-300 hover:border-blue-400"}
          ${_?"opacity-50 cursor-not-allowed":"cursor-pointer"}
        `,onClick:N,children:[e.jsx("input",{...S(),ref:V}),e.jsxs("div",{className:"flex flex-col items-center justify-center space-y-2",children:[e.jsx("div",{className:"p-3 rounded-full bg-blue-100 text-blue-500",children:e.jsx($e,{className:"w-6 h-6"})}),e.jsx("div",{className:"text-sm font-medium text-gray-700",children:A}),e.jsx("p",{className:"text-xs text-gray-500",children:w}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Formatos suportados: JPG, PNG, GIF, PDF, DOC, DOCX, XLS, XLSX, TXT, ZIP, RAR"})]})]}),e.jsx("div",{className:"space-y-2",children:p.map((t,x)=>e.jsxs(ce.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},className:"flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200 shadow-sm",children:[e.jsxs("div",{className:"flex items-center space-x-3 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0",children:h(t.type)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:t.name}),e.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-500",children:[e.jsx("span",{children:C(t.size)}),t.isUploading&&e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx("span",{className:"animate-pulse",children:"Enviando..."}),e.jsxs("span",{className:"ml-1",children:[t.progress,"%"]})]}),t.isUploaded&&e.jsxs("span",{className:"inline-flex items-center text-green-600",children:[e.jsx(ue,{className:"w-3 h-3 mr-1"}),"Enviado"]}),t.error&&e.jsx("span",{className:"text-red-500 text-xs",children:t.error})]})]})]}),!_&&e.jsx("button",{type:"button",onClick:$=>{$.stopPropagation(),P(t,x)},className:"p-1 text-gray-400 hover:text-red-500 transition-colors",disabled:t.isUploading,children:e.jsx(xe,{className:"w-5 h-5"})})]},t.id||t.name))}),e.jsx(me,{children:U.length>0&&e.jsx(ce.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},className:"space-y-2",children:U.map((t,x)=>e.jsxs("div",{className:"flex items-start p-3 text-sm text-red-700 bg-red-50 rounded-lg",children:[e.jsx(pe,{className:"flex-shrink-0 w-5 h-5 mt-0.5 mr-2 text-red-500"}),e.jsx("span",{children:t})]},x))})})]})},W=[];for(let s=0;s<256;++s)W.push((s+256).toString(16).slice(1));function vs(s,a=0){return(W[s[a+0]]+W[s[a+1]]+W[s[a+2]]+W[s[a+3]]+"-"+W[s[a+4]]+W[s[a+5]]+"-"+W[s[a+6]]+W[s[a+7]]+"-"+W[s[a+8]]+W[s[a+9]]+"-"+W[s[a+10]]+W[s[a+11]]+W[s[a+12]]+W[s[a+13]]+W[s[a+14]]+W[s[a+15]]).toLowerCase()}let fe;const bs=new Uint8Array(16);function ys(){if(!fe){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");fe=crypto.getRandomValues.bind(crypto)}return fe(bs)}const ws=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),_e={randomUUID:ws};function js(s,a,p){s=s||{};const n=s.random??s.rng?.()??ys();if(n.length<16)throw new Error("Random bytes length must be >= 16");return n[6]=n[6]&15|64,n[8]=n[8]&63|128,vs(n)}function le(s,a,p){return _e.randomUUID&&!s?_e.randomUUID():js(s)}const De=(s,a,p=!1)=>{const[n,g]=d.useState(!1),[k,_]=d.useState(0),[A,w]=d.useState(null),O=d.useCallback(()=>p?ne.DRAFTS:ne.ACTIVITIES,[p]),F=d.useCallback(E=>{const j=Date.now(),S=E.split(".").pop(),P=le();return`${a}/${s||"temp"}/${j}-${P}.${S}`},[s,a]),B=d.useCallback(async E=>{if(!E)return null;g(!0),w(null);try{const j=O(),S=F(E.name),P={cacheControl:"3600",upsert:!1,onProgress:t=>{const x=Math.round(t.loaded/t.total*100);_(x)}},{data:N,error:h}=await y.storage.from(j).upload(S,E,P);if(h)throw h;const{data:{publicUrl:C}}=y.storage.from(j).getPublicUrl(S);return{id:le(),name:E.name,url:C,path:N.path,size:E.size,type:E.type,isNew:!0}}catch(j){throw console.error("Erro ao fazer upload do arquivo:",j),w(j.message||"Erro ao fazer upload do arquivo"),j}finally{g(!1),_(0)}},[O,F]),U=d.useCallback(async E=>{if(!E)return!1;try{const j=O(),{error:S}=await Fe(j,E);if(S)throw S;return!0}catch(j){throw console.error("Erro ao remover arquivo:",j),w(j.message||"Erro ao remover o arquivo"),j}},[O]),Q=d.useCallback(async(E=null)=>{try{if(!p)throw new Error("Apenas rascunhos podem ser publicados");const j=ne.DRAFTS,S=ne.ACTIVITIES,P=`${a}/${s||"temp"}`,N=`${a}/${E||s}`,{data:h,error:C}=await y.storage.from(j).list(P);if(C)throw C;const t=[];for(const x of h){const $=`${P}/${x.name}`,o=`${N}/${x.name}`,{error:R}=await gs(j,$,S,o);if(R){console.warn(`Falha ao mover o arquivo ${x.name}:`,R);continue}const{data:{publicUrl:D}}=y.storage.from(S).getPublicUrl(o);t.push({originalPath:$,newPath:o,url:D,name:x.name,type:x.metadata?.mimetype||"application/octet-stream",size:x.metadata?.size||0})}return t}catch(j){throw console.error("Erro ao publicar arquivos da atividade:",j),w(j.message||"Erro ao publicar os arquivos da atividade"),j}},[s,p,a]),V=d.useCallback(async(E,j)=>{if(!E||!j)throw new Error("Arquivo e ID de submissão são obrigatórios");g(!0),w(null);try{const S=ne.SUBMISSIONS,P=`${a}/${s}/${j}/${E.name}`,N={cacheControl:"3600",upsert:!1,onProgress:x=>{const $=Math.round(x.loaded/x.total*100);_($)}},{data:h,error:C}=await y.storage.from(S).upload(P,E,N);if(C)throw C;const{data:{publicUrl:t}}=y.storage.from(S).getPublicUrl(P);return{id:le(),name:E.name,url:t,path:h.path,size:E.size,type:E.type,isNew:!0}}catch(S){throw console.error("Erro ao fazer upload da submissão:",S),w(S.message||"Erro ao fazer upload da submissão"),S}finally{g(!1),_(0)}},[s,a]);return{isUploading:n,uploadProgress:k,error:A,uploadActivityFile:B,removeActivityFile:U,publishActivityFiles:Q,uploadSubmission:V,resetError:()=>w(null)}},Ns=({activityId:s,userId:a,initialAttachments:p=[],onAttachmentsChange:n,isSubmitting:g=!1,isDraft:k=!1,isTeacher:_=!1,isEditing:A=!0,maxFiles:w=10,maxSize:O=20*1024*1024})=>{const[F,B]=d.useState(p||[]),[U,Q]=d.useState(!1),[V,E]=d.useState({}),[j,S]=d.useState([]),{uploadActivityFile:P,removeActivityFile:N}=De(s,a,k);d.useEffect(()=>{p&&p.length>0&&B(p)},[p]),d.useEffect(()=>{n&&n(F)},[F,n]);const h=d.useCallback(async o=>{if(!o||o.length===0)return;const R=[],D=[];try{Q(!0);for(const q of o)try{if(F.some(m=>m.name===q.name)){D.push(`O arquivo "${q.name}" já foi adicionado.`);continue}const z=`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,r={id:z,name:q.name,size:q.size,type:q.type,isUploading:!0,progress:0,isNew:!0};B(m=>[...m,r]);const{data:u,error:v}=await P(q);if(v)throw new Error(`Falha ao fazer upload de ${q.name}: ${v.message}`);B(m=>m.map(f=>f.id===z?{...f,...u,isUploading:!1,isUploaded:!0,progress:100}:f)),R.push({...u,isNew:!0})}catch(z){console.error("Erro ao fazer upload do arquivo:",z),B(r=>r.map(u=>u.name===q.name?{...u,isUploading:!1,error:z.message||"Erro ao fazer upload",hasError:!0}:u)),D.push(z.message||`Erro ao fazer upload de ${q.name}`)}return D.length>0&&S(q=>[...q,...D]),R}catch(q){return console.error("Erro no processo de upload:",q),S(z=>[...z,q.message||"Erro ao processar os arquivos"]),[]}finally{Q(!1),E({})}},[F,P]),C=d.useCallback(async(o,R)=>{if(!(!o||g))try{o.path&&!o.isNew&&await N(o.path),B(D=>D.filter((q,z)=>z!==R))}catch(D){console.error("Erro ao remover anexo:",D),S(q=>[...q,`Erro ao remover ${o.name}: ${D.message}`])}},[g,N]),t=o=>{o.url&&window.open(o.url,"_blank","noopener,noreferrer")},x=o=>o<1024?`${o} B`:o<1024*1024?`${(o/1024).toFixed(1)} KB`:`${(o/(1024*1024)).toFixed(1)} MB`,$=o=>o?o.startsWith("image/")?e.jsx(re,{className:"w-4 h-4 text-blue-500"}):o==="application/pdf"?e.jsx(re,{className:"w-4 h-4 text-red-500"}):o==="application/msword"||o==="application/vnd.openxmlformats-officedocument.wordprocessingml.document"?e.jsx(re,{className:"w-4 h-4 text-blue-600"}):o==="application/vnd.ms-excel"||o==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"?e.jsx(re,{className:"w-4 h-4 text-green-600"}):e.jsx(re,{className:"w-4 h-4 text-gray-500"}):e.jsx(re,{className:"w-4 h-4"});return d.useEffect(()=>{if(j.length>0){const o=setTimeout(()=>{S([])},5e3);return()=>clearTimeout(o)}},[j]),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-700 flex items-center",children:[e.jsx(re,{className:"mr-2"}),"Anexos (",F.length,"/",w,")"]}),F.length>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[F.filter(o=>!o.isUploading).length," arquivo(s) carregado(s)"]})]}),A&&F.length<w&&e.jsx(Ue,{onUpload:h,files:F,maxFiles:w,maxSize:O,disabled:g||U,label:"Arraste e solte arquivos aqui ou clique para selecionar",subLabel:`Máx. ${w} arquivos • ${O/(1024*1024)}MB por arquivo`}),e.jsx("div",{className:"space-y-2",children:e.jsx(me,{children:F.map((o,R)=>e.jsxs(ce.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},className:`flex items-center justify-between p-3 rounded-lg border ${o.hasError?"bg-red-50 border-red-200":o.isUploading?"bg-blue-50 border-blue-200":"bg-white border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center space-x-3 min-w-0",children:[e.jsx("div",{className:"flex-shrink-0",children:$(o.type)}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:o.name}),e.jsxs("div",{className:"flex items-center space-x-2 text-xs text-gray-500",children:[e.jsx("span",{children:x(o.size)}),o.isUploading&&e.jsxs("span",{className:"inline-flex items-center",children:[e.jsx("span",{className:"animate-pulse",children:"Enviando..."}),e.jsxs("span",{className:"ml-1",children:[o.progress||0,"%"]})]}),o.isUploaded&&e.jsxs("span",{className:"inline-flex items-center text-green-600",children:[e.jsx(ue,{className:"w-3 h-3 mr-1"}),"Enviado"]}),o.error&&e.jsx("span",{className:"text-red-500 text-xs",children:o.error})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[!o.isUploading&&!o.hasError&&e.jsx("button",{type:"button",onClick:()=>t(o),className:"p-1 text-gray-400 hover:text-blue-500 transition-colors",title:"Visualizar",children:e.jsx(as,{className:"w-4 h-4"})}),!o.isUploading&&o.url&&e.jsx("a",{href:o.url,download:o.name,target:"_blank",rel:"noopener noreferrer",className:"p-1 text-gray-400 hover:text-green-500 transition-colors",title:"Baixar",children:e.jsx(Pe,{className:"w-4 h-4"})}),A&&e.jsx("button",{type:"button",onClick:()=>C(o,R),className:"p-1 text-gray-400 hover:text-red-500 transition-colors",disabled:g||o.isUploading,title:"Remover",children:e.jsx(os,{className:"w-4 h-4"})})]})]},o.id||`file-${R}`))})}),e.jsx(me,{children:j.length>0&&e.jsx(ce.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},className:"space-y-2",children:j.map((o,R)=>e.jsxs("div",{className:"flex items-start p-3 text-sm text-red-700 bg-red-50 rounded-lg",children:[e.jsx(pe,{className:"flex-shrink-0 w-5 h-5 mt-0.5 mr-2 text-red-500"}),e.jsx("span",{children:o}),e.jsx("button",{type:"button",onClick:()=>S(D=>D.filter((q,z)=>z!==R)),className:"ml-auto text-red-500 hover:text-red-700",children:e.jsx(xe,{className:"w-4 h-4"})})]},R))})})]})},Ss=({activityId:s,userId:a,onSubmit:p,onAutosave:n,schema:g=null,isSubmitting:k=!1,initialData:_=null,isPlagiarismCheckEnabled:A=!1,maxFiles:w=5,maxSize:O=20*1024*1024})=>{const{register:F,handleSubmit:B,formState:{errors:U},setValue:Q,watch:V,reset:E}=ms({defaultValues:_||{answer:"",files:[],agreeTerms:!1}}),[j,S]=d.useState(!1),[P,N]=d.useState({}),[h,C]=d.useState(null),[t,x]=d.useState(!1),{uploadSubmission:$}=De(s,a),[o,R]=d.useState({}),D=V("files"),q=d.useMemo(()=>D||[],[D]),z=V("answer")||"";d.useEffect(()=>{_&&E({answer:_.answer||"",files:_.files||[],agreeTerms:_.agreeTerms||!1})},[_,E]),d.useEffect(()=>{if(!n)return;const m=setTimeout(()=>{try{n({answer:z,files:q,answersByIndex:o})}catch{}},1e3);return()=>clearTimeout(m)},[z,q,o,n]);const r=async m=>{if(!m||m.length===0)return;const f=[],M=[];try{S(!0);for(const G of m)try{if(q.some(I=>I.name===G.name)){M.push(`O arquivo "${G.name}" já foi adicionado.`);continue}const H=`temp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;N(I=>({...I,[H]:0}));const{data:J,error:X}=await $(G,H);if(X)throw new Error(`Falha ao fazer upload de ${G.name}: ${X.message}`);f.push({...J,tempId:H,isNew:!0})}catch(H){console.error("Erro ao fazer upload do arquivo:",H),M.push(H.message||`Erro ao fazer upload de ${G.name}`)}return f.length>0&&Q("files",[...q,...f]),M.length>0&&C(M.join(`
`)),f}catch(G){return console.error("Erro no processo de upload:",G),C("Ocorreu um erro ao processar os arquivos. Tente novamente."),[]}finally{S(!1),N({})}},u=(m,f)=>{const M=q.filter((G,H)=>H!==f);Q("files",M)},v=async m=>{if(!(k||j))try{if(C(null),!m.answer&&(!m.files||m.files.length===0))throw new Error("Por favor, insira uma resposta ou anexe pelo menos um arquivo.");if(A&&!m.agreeTerms)throw new Error("Você deve concordar com os termos de verificação de plágio.");const f={...m,activityId:s,userId:a,submittedAt:new Date().toISOString(),answersByIndex:o};p&&(await p(f),x(!0))}catch(f){console.error("Erro ao enviar a submissão:",f),C(f.message||"Ocorreu um erro ao enviar sua submissão. Tente novamente.")}};return t?e.jsx("div",{className:"rounded-md bg-green-50 p-4 mb-6",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ue,{className:"h-5 w-5 text-green-400","aria-hidden":"true"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("h3",{className:"text-sm font-medium text-green-800",children:"Submissão enviada com sucesso!"}),e.jsx("div",{className:"mt-2 text-sm text-green-700",children:e.jsx("p",{children:"Sua resposta foi registrada e está disponível para o professor."})})]})]})}):e.jsxs("form",{onSubmit:B(v),className:"space-y-6",children:[g?.properties&&e.jsx("div",{className:"space-y-4",children:Object.entries(g.properties).map(([m,f],M)=>{const G=M+1,H=f.format==="date"?"date":f.type==="number"?"number":Array.isArray(f.enum)?"select":f.type==="array"&&f.items?.enum?"checkboxes":f.format==="textarea"?"textarea":"string",J=o[G],X=I=>R(ae=>({...ae,[G]:I}));return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:f.title||`Pergunta ${G}`}),H==="textarea"&&e.jsx("textarea",{className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md",rows:4,value:J||"",onChange:I=>X(I.target.value),disabled:k}),H==="string"&&e.jsx("input",{className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md",value:J||"",onChange:I=>X(I.target.value),disabled:k}),H==="number"&&e.jsx("input",{type:"number",className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md",value:J??"",onChange:I=>X(I.target.value===""?null:Number(I.target.value)),disabled:k}),H==="date"&&e.jsx("input",{type:"date",className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md",value:J||"",onChange:I=>X(I.target.value),disabled:k}),H==="select"&&e.jsxs("select",{className:"shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md",value:J||"",onChange:I=>X(I.target.value),disabled:k,children:[e.jsx("option",{value:"",children:"Selecione..."}),f.enum.map(I=>e.jsx("option",{value:I,children:I},I))]}),H==="checkboxes"&&e.jsx("div",{className:"flex flex-wrap gap-2",children:f.items.enum.map(I=>{const ae=Array.isArray(J)?J:[],i=ae.includes(I);return e.jsxs("label",{className:"inline-flex items-center gap-1 text-sm",children:[e.jsx("input",{type:"checkbox",checked:i,disabled:k,onChange:b=>{const l=new Set(ae);b.target.checked?l.add(I):l.delete(I),X(Array.from(l))}}),I]},I)})})]},m)})}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"answer",className:"block text-sm font-medium text-gray-700 mb-1",children:["Sua resposta ",A?"(opcional)":""]}),e.jsx("div",{className:"mt-1",children:e.jsx("textarea",{id:"answer",name:"answer",rows:6,className:`shadow-sm focus:ring-blue-500 focus:border-blue-500 block w-full sm:text-sm border border-gray-300 rounded-md ${U.answer?"border-red-300":""}`,placeholder:"Digite sua resposta aqui...",...F("answer"),disabled:k})}),U.answer&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:U.answer.message})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Anexos ",A?"(opcional)":""]}),e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:["Você pode anexar até ",w," arquivos (máx. ",O/(1024*1024),"MB por arquivo)"]}),e.jsx(Ue,{onUpload:r,files:q.map(m=>({...m,progress:P[m.tempId]||0,isUploading:!!m.tempId&&P[m.tempId]<100,isUploaded:!m.tempId||P[m.tempId]===100})),onRemove:u,maxFiles:w,maxSize:O,disabled:k||j||q.length>=w,accept:{"image/*":[".jpeg",".jpg",".png",".gif"],"application/pdf":[".pdf"],"application/msword":[".doc"],"application/vnd.openxmlformats-officedocument.wordprocessingml.document":[".docx"],"text/plain":[".txt"]}}),U.files&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:U.files.message})]}),A&&e.jsxs("div",{className:"flex items-start",children:[e.jsx("div",{className:"flex items-center h-5",children:e.jsx("input",{id:"agreeTerms",name:"agreeTerms",type:"checkbox",className:"focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 rounded",disabled:k,...F("agreeTerms",{required:"Você deve concordar com os termos de verificação de plágio."})})}),e.jsxs("div",{className:"ml-3 text-sm",children:[e.jsx("label",{htmlFor:"agreeTerms",className:"font-medium text-gray-700",children:"Declaro que esta é uma resposta original de minha autoria"}),e.jsx("p",{className:"text-gray-500",children:"Concordo que minha submissão será verificada quanto a plágio. Qualquer violação dos termos acadêmicos pode resultar em penalidades."}),U.agreeTerms&&e.jsx("p",{className:"mt-1 text-sm text-red-600",children:U.agreeTerms.message})]})]}),h&&e.jsx("div",{className:"rounded-md bg-red-50 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(pe,{className:"h-5 w-5 text-red-400","aria-hidden":"true"})}),e.jsx("div",{className:"ml-3",children:e.jsx("h3",{className:"text-sm font-medium text-red-800",children:h.split(`
`).map((m,f)=>e.jsxs(ke.Fragment,{children:[m,e.jsx("br",{})]},f))})}),e.jsx("div",{className:"ml-auto pl-3",children:e.jsx("div",{className:"-mx-1.5 -my-1.5",children:e.jsxs("button",{type:"button",className:"inline-flex rounded-md bg-red-50 p-1.5 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2 focus:ring-offset-red-50",onClick:()=>C(null),children:[e.jsx("span",{className:"sr-only",children:"Fechar"}),e.jsx(xe,{className:"h-5 w-5","aria-hidden":"true"})]})})})]})}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"submit",disabled:k||j,className:`inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 ${k||j?"opacity-50 cursor-not-allowed":""}`,children:k?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Enviando..."]}):e.jsxs(e.Fragment,{children:[e.jsx($e,{className:"-ml-1 mr-2 h-4 w-4"}),"Enviar resposta"]})})})]})},_s=({activityId:s,userId:a,submissions:p=[],isTeacher:n=!1,onSubmissionsChange:g,isPlagiarismCheckEnabled:k=!1})=>{const[_,A]=d.useState(null),[w,O]=d.useState(!1),[F,B]=d.useState({}),[U,Q]=d.useState({}),[V,E]=d.useState({}),[j]=d.useState("all"),{toast:S}=Ee();d.useEffect(()=>{(async()=>{if(!(!n||!k))try{const u={};for(const v of p)if(v.plagiarism_checked){const{data:m,error:f}=await y.from("plagiarism_checks").select("*").eq("submission_id",v.id).single();m&&!f&&(u[v.id]=m)}B(u)}catch(u){console.error("Erro ao carregar resultados de plágio:",u)}})()},[p,n,k]),d.useEffect(()=>{(async()=>{try{if(!n||!p?.length)return;const u=p.map(M=>M.id).filter(Boolean);if(!u.length)return;const{data:v,error:m}=await y.from("answers").select("id, submission_id, question_index, value, is_correct, points_earned, feedback").in("submission_id",u).order("question_index",{ascending:!0});if(m)throw m;const f={};(v||[]).forEach(M=>{f[M.submission_id]||(f[M.submission_id]=[]),f[M.submission_id].push(M)}),Q(f)}catch(u){console.warn("Erro ao carregar respostas:",u)}})()},[n,p]);const P=p.filter(r=>j==="all"?!0:r.group_id===j),N=async r=>{try{const u=prompt("Mensagem para o aluno (opcional):","Por favor, revise sua submissão conforme os comentários.");if(u===null)return;const{error:v}=await y.from("submissions").update({status:"returned",feedback:u,updated_at:new Date().toISOString()}).eq("id",r.id);if(v)throw v;g&&g(p.map(m=>m.id===r.id?{...m,status:"returned",feedback:u}:m)),S({title:"Devolvida para revisão",description:"O aluno será notificado."})}catch{S({title:"Erro ao devolver",variant:"destructive"})}},h=r=>{const u=U[r]||[],v=u.reduce((f,M)=>f+(M.points_earned||0),0),m=u.length;return{totalEarned:v,totalPossible:m}},C=(r,u,v,m)=>{Q(f=>{const M=f[r]?[...f[r]]:[],G=M.findIndex(H=>H.id===u);return G>=0&&(M[G]={...M[G],[v]:m}),{...f,[r]:M}})},t=async r=>{try{A(null);const u=r.id,v=U[u]||[];await Promise.all(v.map(M=>y.from("answers").update({is_correct:M.is_correct,points_earned:M.points_earned,feedback:M.feedback}).eq("id",M.id)));const m=V[u]||{},f={updated_at:new Date().toISOString()};typeof m.final_grade<"u"&&m.final_grade!==null&&(f.final_grade=m.final_grade,f.graded_at=new Date().toISOString(),f.status="graded"),typeof m.feedback<"u"&&(f.feedback=m.feedback),Object.keys(f).length>1&&await y.from("submissions").update(f).eq("id",u),g&&g(p.map(M=>M.id===u?{...M,...f}:M)),S({title:"Avaliação salva",description:"Nota e feedback atualizados com sucesso."})}catch(u){console.error("Erro ao salvar avaliação:",u),A("Falha ao salvar avaliação."),S({title:"Erro ao salvar avaliação",variant:"destructive"})}},x=async r=>{try{const{data:u,error:v}=await y.storage.from(ne.SUBMISSIONS).createSignedUrl(r.file_path,3600);if(v)throw v;window.open(u.signedUrl,"_blank","noopener,noreferrer")}catch(u){console.error("Erro ao baixar o arquivo:",u),A("Não foi possível baixar o arquivo. Tente novamente mais tarde.")}},$=d.useCallback(async r=>{if(!(!n||!k))try{O(!0),A(null);const{data:u,error:v}=await y.functions.invoke("plagiarism-check",{body:JSON.stringify({submission_id:r.id,file_path:r.file_path,activity_id:s,user_id:a})});if(v)throw v;if(B(m=>({...m,[r.id]:u})),g){const m=p.map(f=>f.id===r.id?{...f,plagiarism_checked:!0,plagiarism_score:u.similarity_score||0}:f);g(m)}return u}catch(u){throw console.error("Erro ao verificar plágio:",u),A("Não foi possível verificar plágio. Tente novamente mais tarde."),u}finally{O(!1)}},[s,n,k,g,p,a]),o=async()=>{if(!(!n||!k))try{O(!0),A(null);const r=[];for(const u of P)if(!u.plagiarism_checked){const v=await $(u);r.push(v)}return r}catch(r){throw console.error("Erro ao verificar plágio em lote:",r),A("Ocorreu um erro ao verificar plágio em lote."),r}finally{O(!1)}},R=r=>{const u={day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"};return new Date(r).toLocaleString("pt-BR",u)},D=r=>r==null?"gray":r<20?"green":r<50?"yellow":r<80?"orange":"red",q=r=>{if(!k)return null;const u=F[r.id],v=r.plagiarism_score||(u?u.similarity_score:null);if(v==null)return n?e.jsx("button",{onClick:()=>$(r),className:"inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:w,children:w?"Verificando...":"Verificar plágio"}):e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800",children:[e.jsx(be,{className:"mr-1"})," Aguardando verificação"]});const m={green:"bg-green-100 text-green-800",yellow:"bg-yellow-100 text-yellow-800",orange:"bg-orange-100 text-orange-800",red:"bg-red-100 text-red-800",gray:"bg-gray-100 text-gray-800"}[D(v)];return e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${m}`,children:[v.toFixed(1),"% de similaridade"]}),n&&u?.report_url&&e.jsx("a",{href:u.report_url,target:"_blank",rel:"noopener noreferrer",className:"text-xs text-blue-600 hover:text-blue-800 hover:underline",children:"Ver relatório"})]})},z=P.some(r=>!r.plagiarism_checked&&k);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Submissões dos Alunos"}),n&&k&&z&&e.jsx("button",{type:"button",onClick:o,disabled:w,className:"inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50",children:w?"Verificando...":"Verificar plágio em lote"})]}),_&&e.jsx("div",{className:"rounded-md bg-red-50 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(is,{className:"h-5 w-5 text-red-400","aria-hidden":"true"})}),e.jsx("div",{className:"ml-3",children:e.jsx("h3",{className:"text-sm font-medium text-red-800",children:_})}),e.jsx("div",{className:"ml-auto pl-3",children:e.jsx("div",{className:"-mx-1.5 -my-1.5",children:e.jsxs("button",{type:"button",className:"inline-flex rounded-md bg-red-50 p-1.5 text-red-500 hover:bg-red-100 focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-offset-2 focus:ring-offset-red-50",onClick:()=>A(null),children:[e.jsx("span",{className:"sr-only",children:"Fechar"}),e.jsx(xe,{className:"h-5 w-5","aria-hidden":"true"})]})})})]})}),e.jsx("div",{className:"overflow-hidden bg-white shadow sm:rounded-md",children:e.jsx("ul",{className:"divide-y divide-gray-200",children:P.length===0?e.jsx("li",{className:"py-4 px-4 text-center text-gray-500",children:"Nenhuma submissão encontrada."}):e.jsx(me,{children:P.map((r,u)=>e.jsxs(ce.li,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,x:-10},className:"px-4 py-4 sm:px-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(ns,{className:"h-5 w-5 text-blue-600"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:r.user_name||"Aluno"}),e.jsxs("p",{className:"text-xs text-gray-500 flex items-center",children:[e.jsx(be,{className:"mr-1"}),R(r.submitted_at||new Date().toISOString())]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[q(r),e.jsxs("button",{type:"button",onClick:()=>x(r),className:"inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(Pe,{className:"-ml-0.5 mr-1.5 h-4 w-4"}),"Baixar"]}),!n&&r.user_id===a&&e.jsx("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:"Sua submissão"})]})]}),r.feedback&&e.jsx("div",{className:"mt-3 pl-14",children:e.jsxs("div",{className:"text-sm text-gray-700 bg-gray-50 p-3 rounded-md border border-gray-200",children:[e.jsx("p",{className:"font-medium text-gray-900",children:"Feedback do professor:"}),e.jsx("p",{className:"mt-1",children:r.feedback}),r.grade!==null&&r.grade!==void 0&&e.jsxs("p",{className:"mt-2 font-medium",children:["Nota: ",e.jsx("span",{className:"text-blue-600",children:r.grade})]})]})}),n&&e.jsxs("div",{className:"mt-4 pl-14 space-y-3",children:[(U[r.id]||[]).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"Respostas por pergunta"}),e.jsx("div",{className:"border rounded-md divide-y",children:(U[r.id]||[]).map(v=>e.jsxs("div",{className:"p-2 grid grid-cols-1 lg:grid-cols-4 gap-2 items-center",children:[e.jsxs("div",{className:"text-xs text-gray-600",children:["Q",v.question_index]}),e.jsx("div",{className:"text-xs break-words lg:col-span-1",children:String(v.value)}),e.jsxs("label",{className:"inline-flex items-center gap-1 text-xs",children:[e.jsx("input",{type:"checkbox",checked:!!v.is_correct,onChange:m=>C(r.id,v.id,"is_correct",m.target.checked)}),"Correta"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-xs",children:"Pontos:"}),e.jsx("input",{type:"number",className:"w-20 border rounded px-1 py-0.5 text-xs",value:v.points_earned??0,onChange:m=>C(r.id,v.id,"points_earned",Number(m.target.value))})]})]},v.id))})]}),e.jsxs("div",{className:"space-y-2",children:[(()=>{const{totalEarned:v,totalPossible:m}=h(r.id),f=r.final_grade??(m>0?Math.round(v/m*100):null);return e.jsxs("div",{className:"text-xs text-gray-600",children:["Pontos computados: ",v," / ",m||"?",f!==null&&` | Nota: ${f}%`]})})(),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-2",children:[e.jsx("input",{className:"border rounded px-2 py-1 text-sm",placeholder:"Feedback geral",value:V[r.id]?.feedback||"",onChange:v=>E(m=>({...m,[r.id]:{...m[r.id]||{},feedback:v.target.value}}))}),e.jsx("input",{type:"number",className:"border rounded px-2 py-1 text-sm",placeholder:"Nota final (%)",value:V[r.id]?.final_grade??"",onChange:v=>E(m=>({...m,[r.id]:{...m[r.id]||{},final_grade:v.target.value===""?null:Number(v.target.value)}}))}),e.jsx("button",{type:"button",onClick:()=>t(r),className:"justify-self-start inline-flex items-center px-3 py-1.5 border border-transparent text-xs font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700",children:"Salvar avaliação"})]}),e.jsx("button",{type:"button",onClick:()=>N(r),className:"inline-flex items-center px-3 py-1.5 border border-gray-300 text-xs font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50",children:"Devolver para revisão"})]})]})]},r.id||`submission-${u}`))})})})]})},ks=s=>s?s.format==="date"?"date":s.type==="number"?"number":Array.isArray(s.enum)?"select":s.type==="array"&&s.items?.enum?"checkboxes":s.format==="textarea"?"textarea":"string":"string",Es=async s=>{try{const{data:a,error:p}=await y.from("submissions").select("id, user_id, activity_id, status").eq("id",s).single();if(p)throw p;if(a.status==="graded")throw new Error("This submission has already been graded");const{data:n,error:g}=await y.from("activities").select("id, schema").eq("id",a.activity_id).single();if(g)throw g;const{data:k,error:_}=await y.from("answers").select("id, question_index, value").eq("submission_id",s).order("question_index",{ascending:!0});if(_)throw _;const A=n?.schema||{},w=A?.properties||{},O=A?.meta||{},F=O?.answer_key||A?.answer_key||{},B=O?.points||{};let U=0,Q=0,V=!1;const E=[];for(const h of k||[]){const C=h.question_index,t=`question_${C}`,x=w[t],$=ks(x);if(!["select","checkboxes","number","date"].includes($)){V=!0,E.push({id:h.id,is_correct:null,points_earned:0});continue}const R=typeof B[C]=="number"?B[C]:1;U+=R;const D=F[C];let q=!1;if($==="select"||$==="date"||$==="string")q=h.value===D;else if($==="number"){const r=typeof O.tolerance=="number"?O.tolerance:0,u=typeof h.value=="number"?h.value:Number(h.value),v=typeof D=="number"?D:Number(D);q=isFinite(u)&&isFinite(v)&&Math.abs(u-v)<=r}else if($==="checkboxes"){const r=new Set(Array.isArray(h.value)?h.value:[]),u=new Set(Array.isArray(D)?D:[]);r.size===u.size?q=[...r].every(v=>u.has(v)):q=!1}const z=q?R:0;Q+=z,E.push({id:h.id,is_correct:q,points_earned:z})}await Promise.all(E.map(h=>y.from("answers").update({is_correct:h.is_correct,points_earned:h.points_earned,updated_at:new Date().toISOString()}).eq("id",h.id)));const j=U>0?Math.round(Q/U*100):null,S=V?"submitted":"graded",{data:P,error:N}=await y.from("submissions").update({final_grade:V?null:j,status:S,graded_at:V?null:new Date().toISOString(),feedback:V?"Needs manual review":"Automatically graded",updated_at:new Date().toISOString()}).eq("id",s).select().single();if(N)throw N;return!V&&j!==null&&(await y.from("feedback_history").insert([{id:le(),submission_id:s,user_id:"system",feedback:"Automatically graded",feedback_type:"automatic",created_at:new Date().toISOString()}]),await y.from("notifications").insert([{id:le(),user_id:a.user_id,type:"grade_posted",title:"Grade Posted",message:`Your submission has been automatically graded. Grade: ${j}%`,reference_id:s,is_read:!1,created_at:new Date().toISOString()}])),{...P,needs_review:V,total_points_earned:Q,total_points_possible:U}}catch(a){throw console.error("Error auto-grading submission:",a),a}},As=({activityId:s,isTeacher:a=!1,userId:p})=>{const[n,g]=d.useState(null),[k,_]=d.useState(!0),[A,w]=d.useState(null),[O,F]=d.useState([]),[B,U]=d.useState(0),[Q,V]=d.useState([]);d.useEffect(()=>{s&&(async()=>{try{_(!0),w(null);const{data:h,error:C}=await y.from("activities").select("*").eq("id",s).single();if(C)throw C;g(h);const{data:t}=await y.from("activity_class_assignments").select("class_id, classes ( id, name, color )").eq("activity_id",s);V((t||[]).map(x=>({id:x.classes?.id||x.class_id,name:x.classes?.name||"Turma",color:x.classes?.color}))),a&&await E(s)}catch(h){console.error("Erro ao carregar atividade:",h),w("Não foi possível carregar a atividade. Tente novamente mais tarde.")}finally{_(!1)}})()},[s,a]);const E=async N=>{try{const{data:h,error:C}=await y.from("submissions").select(`
          *,
          user:profiles (id, full_name, avatar_url)
        `).eq("activity_id",N).order("submitted_at",{ascending:!1});if(C)throw C;const t=h.map(x=>({...x,user_name:x.user?.full_name||"Aluno",user_avatar:x.user?.avatar_url}));F(t)}catch(h){console.error("Erro ao carregar submissões:",h),w("Não foi possível carregar as submissões. Tente novamente mais tarde.")}},j=async({answer:N,files:h})=>{try{if(!p||!s)return;const{data:C,error:t}=await y.from("submissions").select("id").eq("activity_id",s).eq("user_id",p).maybeSingle();if(t)throw t;C?.id?await y.from("submissions").update({answer:N,files:h,status:"draft",updated_at:new Date().toISOString()}).eq("id",C.id):await y.from("submissions").insert([{activity_id:s,user_id:p,answer:N,files:h,status:"draft",created_at:new Date().toISOString()}])}catch{}},S=async N=>{try{w(null);const{data:h,error:C}=await y.from("submissions").select("id").eq("activity_id",s).eq("user_id",p).maybeSingle();if(C)throw C;let t=h?.id;if(t){const{error:x}=await y.from("submissions").update({answer:N.answer,files:N.files,submitted_at:new Date().toISOString(),status:"submitted",plagiarism_checked:!1,plagiarism_score:null}).eq("id",t);if(x)throw x}else{const{data:x,error:$}=await y.from("submissions").insert([{activity_id:s,user_id:p,answer:N.answer,files:N.files,submitted_at:new Date().toISOString(),status:"submitted",plagiarism_checked:!1,plagiarism_score:null}]).select().single();if($)throw $;t=x.id}if(n?.settings?.plagiarism_check_enabled)try{const{error:x}=await y.functions.invoke("plagiarism-check",{body:JSON.stringify({submission_id:t,activity_id:s,user_id:p})});if(x)throw x}catch(x){console.error("Erro ao verificar plágio:",x)}if(t&&N?.answersByIndex&&Object.keys(N.answersByIndex).length>0)try{await y.from("answers").delete().eq("submission_id",t);const x=Object.entries(N.answersByIndex).map(([$,o])=>({submission_id:t,question_index:Number($),value:o,created_at:new Date().toISOString()}));x.length>0&&await y.from("answers").insert(x)}catch(x){console.warn("Falha ao salvar respostas por pergunta:",x)}try{await Es(t)}catch{}return a&&await E(s),!0}catch(h){throw console.error("Erro ao enviar submissão:",h),w(h.message||"Ocorreu um erro ao enviar sua resposta. Tente novamente."),h}},P=O.find(N=>N.user_id===p);return k?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"})}):A?e.jsx("div",{className:"rounded-md bg-red-50 p-4 mb-6",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(pe,{className:"h-5 w-5 text-red-400"})}),e.jsx("div",{className:"ml-3",children:e.jsx("h3",{className:"text-sm font-medium text-red-800",children:A})})]})}):n?e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"bg-white shadow-sm rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-5 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:n.title||"Sem título"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:n.description||"Nenhuma descrição fornecida."}),Q.length>0&&e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:Q.map(N=>e.jsxs("span",{className:"inline-flex items-center px-2 py-0.5 rounded text-xs",style:{backgroundColor:"#f3f4f6"},children:[e.jsx("span",{className:"mr-1 inline-block h-2 w-2 rounded-full",style:{backgroundColor:N.color||"#9ca3af"}}),N.name]},N.id))})]}),e.jsxs("div",{className:"flex items-center space-x-3",children:[n.due_date&&e.jsxs("div",{className:"text-sm text-gray-500",children:[e.jsx("span",{className:"font-medium",children:"Data de entrega:"})," ",new Date(n.due_date).toLocaleDateString("pt-BR")]}),n.points!==null&&n.points!==void 0&&e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800",children:[n.points," pontos"]})]})]})}),e.jsxs("div",{className:"px-6 py-5",children:[e.jsx("div",{className:"prose max-w-none",children:n.content?e.jsx("div",{dangerouslySetInnerHTML:{__html:n.content}}):e.jsx("p",{className:"text-gray-500 italic",children:"Nenhum conteúdo disponível."})}),n.attachments&&n.attachments.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"Materiais de Apoio"}),e.jsx(Ns,{activityId:s,userId:p,initialAttachments:n.attachments,isEditing:!1})]})]})]}),e.jsx("div",{className:"bg-white shadow-sm rounded-lg overflow-hidden",children:e.jsxs(us,{selectedIndex:B,onSelect:N=>U(N),children:[e.jsxs(xs,{className:"flex border-b border-gray-200",children:[!a&&e.jsx(we,{className:"px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none border-b-2 border-transparent ui-selected:border-blue-500 ui-selected:text-blue-600",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ye,{className:"mr-2"}),P?"Minha Resposta":"Enviar Resposta"]})}),a&&e.jsx(we,{className:"px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none border-b-2 border-transparent ui-selected:border-blue-500 ui-selected:text-blue-600",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ls,{className:"mr-2"}),"Submissões (",O.length,")"]})})]}),e.jsxs("div",{className:"p-6",children:[!a&&e.jsx(je,{children:P?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border-l-4 border-green-400 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(ue,{className:"h-5 w-5 text-green-400"})}),e.jsx("div",{className:"ml-3",children:e.jsxs("p",{className:"text-sm text-green-700",children:["Você já enviou sua resposta em ",new Date(P.submitted_at).toLocaleString("pt-BR"),"."]})})]})}),e.jsxs("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:[e.jsxs("div",{className:"px-4 py-5 sm:px-6",children:[e.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900",children:"Sua Resposta"}),e.jsxs("p",{className:"mt-1 max-w-2xl text-sm text-gray-500",children:["Enviada em ",new Date(P.submitted_at).toLocaleString("pt-BR")]})]}),e.jsxs("div",{className:"border-t border-gray-200 px-4 py-5 sm:px-6",children:[P.answer?e.jsx("div",{className:"prose max-w-none",dangerouslySetInnerHTML:{__html:P.answer}}):e.jsx("p",{className:"text-gray-500 italic",children:"Nenhuma resposta em texto fornecida."}),P.files&&P.files.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Arquivos anexados:"}),e.jsx("ul",{className:"border border-gray-200 rounded-md divide-y divide-gray-200",children:P.files.map((N,h)=>e.jsxs("li",{className:"pl-3 pr-4 py-3 flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"w-0 flex-1 flex items-center",children:[e.jsx(ye,{className:"flex-shrink-0 h-5 w-5 text-gray-400"}),e.jsx("span",{className:"ml-2 flex-1 w-0 truncate",children:N.name})]}),e.jsx("div",{className:"ml-4 flex-shrink-0",children:e.jsx("a",{href:N.url,target:"_blank",rel:"noopener noreferrer",className:"font-medium text-blue-600 hover:text-blue-500",children:"Baixar"})})]},h))})]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:()=>U(0),className:"bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Editar Resposta"})})]}):e.jsx(Ss,{activityId:s,userId:p,onSubmit:S,onAutosave:j,schema:n.schema,isSubmitting:!1,isPlagiarismCheckEnabled:n.settings?.plagiarism_check_enabled||!1})}),a&&e.jsx(je,{children:e.jsx(_s,{activityId:s,userId:p,submissions:O,isTeacher:a,isPlagiarismCheckEnabled:n.settings?.plagiarism_check_enabled||!1,onSubmissionsChange:F})})]})]})})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Atividade não encontrada"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"A atividade que você está tentando acessar não existe ou foi removida."})]})},Cs=()=>{const{id:s}=ts(),a=Ce(),p=rs(),n=()=>{const t=p.pathname;return t.includes("/editar/")?"edit":t.includes("/criar")?"create":"view"},[g,k]=d.useState(n()),[_,A]=d.useState(!1),[w,O]=d.useState(!0),[F,B]=d.useState(null),[U,Q]=d.useState(null),[V,E]=d.useState(null),{data:j,loading:S,error:P,invalidateCache:N}=ps(s);d.useEffect(()=>{(async()=>{if(g==="create"){O(!1);return}if(s)try{if(O(S),E(P),j)B(j);else if(!S){const{data:x,error:$}=await y.from("activities").select(`
              *,
              class:classes (id, name, description)
            `).eq("id",s).single();if($)throw $;B(x)}}catch(x){console.error("Error loading activity:",x),E("Não foi possível carregar a atividade. Por favor, tente novamente.")}})()},[s,g,j,S,P]),d.useEffect(()=>{(F||g==="create")&&(async()=>{try{console.log("Checking authentication status...");const{data:{session:x},error:$}=await y.auth.getSession();if($)throw console.error("Session error:",$),$;const o=!!x;if(console.log("Is authenticated:",o),A(o),!o){console.log("Not authenticated, redirecting to login..."),a("/login");return}const{data:{user:R},error:D}=await y.auth.getUser();if(D)throw console.error("Error getting user:",D),D;Q(R);const{data:q,error:z}=await y.from("profiles").select("is_teacher").eq("id",R.id).single();if(z)throw console.error("Error fetching profile:",z),z;const r=q?.is_teacher||!1;g==="edit"&&F&&F.created_by!==R?.id&&!r&&(console.log("User is not the owner, redirecting to view mode..."),a(`/dashboard/activities/${s}`,{replace:!0}),k("view")),console.log("Authentication check passed, setting loading to false"),O(!1)}catch(x){console.error("Error in auth check:",x),E("Ocorreu um erro ao verificar a autenticação."),O(!1)}})()},[a,s,g,F]);const h=async t=>{if(N&&await N(t),a(`/dashboard/activities/${t}`,{replace:!0}),k("view"),t){const{data:x,error:$}=await y.from("activities").select("*").eq("id",t).single();$||B(x)}};if(w)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando..."})]})});if(!_)return e.jsx("div",{className:"flex justify-center items-center h-screen",children:e.jsx("div",{className:"bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4",children:e.jsx("p",{children:"Redirecionando para a página de login..."})})});if(V)return e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 py-8 sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-red-50 border-l-4 border-red-400 p-4",children:e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("svg",{className:"h-5 w-5 text-red-400",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm text-red-700",children:V}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{onClick:()=>window.location.reload(),className:"bg-red-100 text-red-700 px-4 py-2 rounded-md text-sm font-medium hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:"Tentar novamente"})})]})]})})})});const C=U?.user_metadata?.is_teacher||!1;return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("nav",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between h-16",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsxs("button",{onClick:()=>a(-1),className:"mr-4 p-1 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:[e.jsx(cs,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"Voltar"})]}),e.jsx("div",{className:"flex-shrink-0 flex items-center",children:e.jsx("h1",{className:"text-xl font-bold text-gray-800",children:g==="create"?"Criar Atividade":g==="edit"?"Editar Atividade":F?.title||"Visualizar Atividade"})})]}),e.jsxs("div",{className:"hidden sm:ml-6 sm:flex sm:items-center space-x-4",children:[e.jsx("button",{onClick:()=>a("/dashboard"),className:"text-gray-500 hover:text-gray-700 text-sm font-medium px-3 py-1 rounded-md hover:bg-gray-100",children:"Dashboard"}),e.jsx("button",{onClick:async()=>{await y.auth.signOut(),a("/login")},className:"text-gray-500 hover:text-gray-700 text-sm font-medium px-3 py-1 rounded-md hover:bg-gray-100",children:"Sair"})]})]})})}),e.jsx("main",{className:"py-6 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-7xl mx-auto",children:g==="create"?e.jsxs("div",{className:"bg-white shadow-sm rounded-lg p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Criar Nova Atividade"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Preencha os detalhes abaixo para criar uma nova atividade."})]}),e.jsx(Se,{onActivityCreated:h,userId:U?.id})]}):g==="edit"&&F?e.jsxs("div",{className:"bg-white shadow-sm rounded-lg overflow-hidden",children:[e.jsx("div",{className:"px-6 py-5 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Editar Atividade"}),e.jsxs("div",{className:"flex space-x-3",children:[e.jsx("button",{onClick:()=>k("view"),className:"inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Cancelar"}),e.jsx("button",{type:"submit",form:"activity-form",className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Salvar Alterações"})]})]})}),e.jsx("div",{className:"p-6",children:e.jsx(Se,{activityId:s,initialData:F,onActivityCreated:h,userId:U?.id})})]}):F?e.jsx(As,{activityId:s,isTeacher:C,userId:U?.id}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"Atividade não encontrada"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"A atividade que você está tentando acessar não existe ou foi removida."}),e.jsx("div",{className:"mt-6",children:e.jsx("button",{onClick:()=>a("/dashboard"),className:"inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",children:"Voltar para o Dashboard"})})]})})})]})},Ls=Object.freeze(Object.defineProperty({__proto__:null,default:Cs},Symbol.toStringTag,{value:"Module"}));export{Ls as A,qe as C};
