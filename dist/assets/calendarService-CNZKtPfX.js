import{s}from"./main-Bujpyeg-.js";import{t as v,e as S}from"./toDate-B_SDEMqy.js";function d(n,t,r){const e=v(n,r?.in);return e.setTime(e.getTime()+t*S),e}const y={async getUserCalendar({from:n,to:t,userId:r=null,userRole:e=null}){try{if(r&&e==="student"){const{data:o,error:l}=await s.from("calendar_events").select("id, class_id, title, description, start_time, end_time, meeting_id, activity_id, type, color, location, participants, created_by").gte("start_time",n.toISOString()).lte("end_time",t.toISOString()).order("start_time",{ascending:!0});return l?(console.error("CalendarService.getUserCalendar error:",l),[]):o||[]}let a=s.from("calendar_events").select("id, class_id, title, description, start_time, end_time, meeting_id, activity_id, type, color, location, participants, created_by").gte("start_time",n.toISOString()).lte("end_time",t.toISOString()).order("start_time",{ascending:!0});e==="teacher"&&r&&(a=a.eq("created_by",r));const{data:i,error:c}=await a;return c?(console.error("CalendarService.getUserCalendar error:",c),[]):i||[]}catch(a){return console.error("CalendarService.getUserCalendar exception:",a),[]}},async createEvent({class_id:n,title:t,description:r=null,start_time:e,end_time:a,type:i="custom",color:c=null,meeting_id:o=null,activity_id:l=null,metadata:u=null,participants:_=[]}){const{data:g}=await s.auth.getUser(),p=g?.user?.id||null,h={class_id:n,title:t,description:r,start_time:e instanceof Date?e.toISOString():e,end_time:a instanceof Date?a.toISOString():a,type:i,color:c,meeting_id:o,activity_id:l,metadata:u,participants:Array.isArray(_)?_:[],created_by:p},{data:f,error:m}=await s.from("calendar_events").insert(h).select().single();if(m)throw m;return f},async updateEvent(n,t){const r=c=>c instanceof Date?c.toISOString():c,e={...t};e.start_time&&(e.start_time=r(e.start_time)),e.end_time&&(e.end_time=r(e.end_time));const{data:a,error:i}=await s.from("calendar_events").update(e).eq("id",n).select().single();if(i)throw i;return a},async deleteEvent(n){const{error:t}=await s.from("calendar_events").delete().eq("id",n);if(t)throw t;return!0},async getClassCalendar(n,{from:t,to:r}){const{data:e,error:a}=await s.from("calendar_events").select("id, class_id, title, description, start_time, end_time, meeting_id, activity_id").eq("class_id",n).gte("start_time",t.toISOString()).lte("end_time",r.toISOString()).order("start_time",{ascending:!0});if(a)throw a;return e||[]},subscribeUserCalendar(n,t){const r=s.channel(`calendar-user-${n}`);return r.on("postgres_changes",{event:"*",schema:"public",table:"calendar_events"},()=>t("calendar_events")).on("postgres_changes",{event:"*",schema:"public",table:"event_attendees",filter:`user_id=eq.${n}`},()=>t("event_attendees")).subscribe(),()=>{try{s.removeChannel(r)}catch{}}},subscribeClassCalendar(n,t){const r=s.channel(`calendar-class-${n}`);return r.on("postgres_changes",{event:"*",schema:"public",table:"calendar_events",filter:`class_id=eq.${n}`},()=>t("calendar_events")).on("postgres_changes",{event:"*",schema:"public",table:"event_attendees"},()=>t("event_attendees")).subscribe(),()=>{try{s.removeChannel(r)}catch{}}},detectConflicts(n){const t=[],r=[...n].sort((e,a)=>new Date(e.start_time)-new Date(a.start_time));for(let e=0;e<r.length-1;e++){const a=r[e],i=r[e+1];new Date(i.start_time)<new Date(a.end_time)&&t.push([a,i])}return t},computeReminderWindows(n){const t=new Date(n.end_time),r=n.estimated_minutes||60,e=n.complexity==="high"?2:n.complexity==="medium"?1.2:1,a=Math.ceil(r*e);return[{label:"Iniciar preparo",when:d(t,-a-120)},{label:"Lembrete 24h",when:d(t,-24*60)},{label:"Lembrete 2h",when:d(t,-120)}]},async getUserCalendarCompact({from:n,to:t,userId:r}){const e=n instanceof Date?n.toISOString():n,a=t instanceof Date?t.toISOString():t,i=r||(await s.auth.getUser()).data?.user?.id||null,{data:c,error:o}=await s.rpc("get_user_calendar_compact",{p_user:i,p_from:e,p_to:a});if(o)throw o;return c||[]}};export{y as C};
