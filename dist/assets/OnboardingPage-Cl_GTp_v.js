import{s as l,g as N,r as f,j as r,J as u,K as h,i as A,bd as S,bJ as P}from"./main-BrBEgNdp.js";import{n as O}from"./roleNavigation-mm4rSh2G.js";import{B as C}from"./building-2-ClWLCMjt.js";const T={async logAcceptance(c,e,a,s={}){try{const{data:t,error:o}=await l.from("terms_acceptance").insert([{user_id:c,terms_version:e,privacy_version:a,ip_address:s.ipAddress||this.getClientIP(),user_agent:s.userAgent||navigator.userAgent,acceptance_method:s.method||"web",metadata:s.metadata||{}}]).select().single();if(o)throw o;return t}catch(t){throw console.error("Error logging terms acceptance:",t),t}},async getAcceptanceHistory(c){try{const{data:e,error:a}=await l.from("terms_acceptance").select("*").eq("user_id",c).order("accepted_at",{ascending:!1});if(a)throw a;return e||[]}catch(e){return console.error("Error getting acceptance history:",e),[]}},async hasAcceptedVersions(c,e,a){try{const{data:s,error:t}=await l.from("terms_acceptance").select("id").eq("user_id",c).eq("terms_version",e).eq("privacy_version",a).limit(1).single();if(t&&t.code!=="PGRST116")throw t;return!!s}catch(s){return console.error("Error checking acceptance versions:",s),!1}},async getLatestAcceptance(c){try{const{data:e,error:a}=await l.from("terms_acceptance").select("*").eq("user_id",c).order("accepted_at",{ascending:!1}).limit(1).single();if(a&&a.code!=="PGRST116")throw a;return e||null}catch(e){return console.error("Error getting latest acceptance:",e),null}},async getAcceptanceStats(c={}){try{let e=l.from("terms_acceptance").select("terms_version, privacy_version, accepted_at, acceptance_method");c.dateFrom&&(e=e.gte("accepted_at",c.dateFrom)),c.dateTo&&(e=e.lte("accepted_at",c.dateTo)),c.method&&(e=e.eq("acceptance_method",c.method));const{data:a,error:s}=await e;if(s)throw s;const t={total:a?.length||0,byTermsVersion:{},byPrivacyVersion:{},byMethod:{},recentAcceptances:a?.slice(0,10)||[]};return a?.forEach(o=>{t.byTermsVersion[o.terms_version]=(t.byTermsVersion[o.terms_version]||0)+1,t.byPrivacyVersion[o.privacy_version]=(t.byPrivacyVersion[o.privacy_version]||0)+1,t.byMethod[o.acceptance_method]=(t.byMethod[o.acceptance_method]||0)+1}),t}catch(e){return console.error("Error getting acceptance stats:",e),{total:0,byTermsVersion:{},byPrivacyVersion:{},byMethod:{},recentAcceptances:[]}}},async getUniqueIPAddresses(c={}){try{let e=l.from("terms_acceptance").select("ip_address, accepted_at");c.dateFrom&&(e=e.gte("accepted_at",c.dateFrom)),c.dateTo&&(e=e.lte("accepted_at",c.dateTo));const{data:a,error:s}=await e;if(s)throw s;const t={};return a?.forEach(o=>{const i=o.ip_address;i&&(t[i]=(t[i]||0)+1)}),Object.entries(t).map(([o,i])=>({ip_address:o,acceptance_count:i,latest_acceptance:a?.find(g=>g.ip_address===o)?.accepted_at}))}catch(e){return console.error("Error getting unique IP addresses:",e),[]}},getClientIP(){return"client-side-detection-needed"},async validateAcceptance(c,e,a){try{if(!await this.hasAcceptedVersions(c,e,a)){const t=await this.getLatestAcceptance(c);return{valid:!1,requiresAcceptance:!0,currentTermsVersion:t?.terms_version||null,currentPrivacyVersion:t?.privacy_version||null,requiredTermsVersion:e,requiredPrivacyVersion:a}}return{valid:!0,requiresAcceptance:!1,currentTermsVersion:e,currentPrivacyVersion:a}}catch(s){return console.error("Error validating acceptance:",s),{valid:!1,requiresAcceptance:!0,error:s.message}}}},b="1.0",j="1.0",q=()=>{const c=N(),[e,a]=f.useState({full_name:"",role:"",age:"",cpf:"",school_name:"",terms_accepted:!1,privacy_accepted:!1}),[s,t]=f.useState(!1),[o,i]=f.useState(""),g=async n=>{if(n.preventDefault(),i(""),!e.full_name||!e.role||!e.terms_accepted||!e.privacy_accepted){i("Preencha nome, papel e aceite os termos e a privacidade.");return}if(e.role==="school"&&!e.school_name){i("Por favor, informe o nome da escola.");return}t(!0);try{console.log("[Onboarding] Starting onboarding process...");const{data:{user:m},error:_}=await l.auth.getUser();if(_)throw _;if(!m)throw new Error("No user found");console.log("[Onboarding] Updating user metadata...");const{data:I,error:v}=await l.auth.updateUser({data:{full_name:e.full_name,role:e.role,age:e.age?Number(e.age):null,cpf:e.cpf||null,terms_accepted:!0,privacy_accepted:!0,terms_version:b,privacy_version:j,onboarding_completed:!0,onboarding_completed_at:new Date().toISOString()}});if(v)throw v;console.log("[Onboarding] User metadata updated successfully");const p=m.id;try{await T.logAcceptance(p,b,j,{ipAddress:await w(),userAgent:navigator.userAgent,method:"onboarding",metadata:{onboarding_completed:!0,form_data:{full_name:e.full_name,role:e.role,age:e.age,cpf:e.cpf}}})}catch(d){console.error("[Onboarding] Failed to log terms acceptance:",d)}if(e.role==="student"){console.log("[Onboarding] Initializing gamification for student...");try{await S.initializeProfile(p),await P.initializeMissions(p),console.log("[Onboarding] Gamification initialized successfully!")}catch(d){console.error("[Onboarding] Error initializing gamification:",d)}}if(e.role==="school"){console.log("[Onboarding] Creating school...");try{const{data:d,error:y}=await l.from("schools").insert({name:e.school_name,created_at:new Date().toISOString()}).select().single();if(y)throw y;console.log("[Onboarding] School created:",d.id);const{error:x}=await l.from("school_admins").insert({school_id:d.id,user_id:p,role:"owner"});if(x)throw x;console.log("[Onboarding] User linked as school admin!")}catch(d){console.error("[Onboarding] Error creating school:",d)}}console.log("[Onboarding] Onboarding completed successfully!");const E=e.role||"student";O(c,E)}catch(m){console.error("[Onboarding] Error:",m),i(m?.message||"Falha ao concluir onboarding")}finally{t(!1)}},w=async()=>{try{return"client-side-detection-needed"}catch{return"unknown"}};return r.jsx("div",{className:"min-h-screen flex items-center justify-center p-6",children:r.jsxs("div",{className:"w-full max-w-xl p-6 space-y-6 bg-white dark:bg-gray-800 rounded-lg shadow-lg",children:[r.jsxs("div",{children:[r.jsx("h1",{className:"text-2xl font-bold",children:"Completar cadastro"}),r.jsx("p",{className:"text-sm text-muted-foreground",children:"Informe seus dados para continuar usando a plataforma."})]}),r.jsxs("form",{onSubmit:g,className:"space-y-4",children:[o&&r.jsx("div",{className:"p-3 rounded bg-red-50 text-red-700 text-sm",children:o}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"full_name",children:"Nome completo"}),r.jsx(h,{id:"full_name",value:e.full_name,onChange:n=>a({...e,full_name:n.target.value}),required:!0})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"role",children:"Papel"}),r.jsxs("select",{className:"w-full border rounded h-10 px-3",value:e.role,onChange:n=>a({...e,role:n.target.value}),required:!0,children:[r.jsx("option",{value:"",disabled:!0,children:"Selecione"}),r.jsx("option",{value:"teacher",children:"Professor"}),r.jsx("option",{value:"student",children:"Aluno"}),r.jsx("option",{value:"school",children:"Escola"})]})]}),e.role==="school"&&r.jsxs("div",{className:"space-y-2",children:[r.jsxs(u,{htmlFor:"school_name",children:[r.jsx(C,{className:"mr-1 inline h-4 w-4"}),"Nome da Escola"]}),r.jsx(h,{id:"school_name",value:e.school_name,onChange:n=>a({...e,school_name:n.target.value}),placeholder:"Ex: Colégio XYZ",required:e.role==="school"})]}),r.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[r.jsxs("div",{className:"space-y-2",children:[r.jsxs(u,{htmlFor:"age",children:["Idade ",r.jsx("span",{className:"text-base-content/50",children:"(opcional)"})]}),r.jsx(h,{id:"age",type:"number",min:"1",max:"120",value:e.age,onChange:n=>a({...e,age:n.target.value})})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsx(u,{htmlFor:"cpf",children:"CPF (opcional)"}),r.jsx(h,{id:"cpf",value:e.cpf,onChange:n=>a({...e,cpf:n.target.value})})]})]}),r.jsxs("div",{className:"space-y-2",children:[r.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",checked:e.terms_accepted,onChange:n=>a({...e,terms_accepted:n.target.checked})}),"Aceito os ",r.jsx("a",{className:"text-primary underline",href:"/terms",target:"_blank",rel:"noreferrer",children:"Termos de Uso"})]}),r.jsxs("label",{className:"flex items-center gap-2 text-sm",children:[r.jsx("input",{type:"checkbox",checked:e.privacy_accepted,onChange:n=>a({...e,privacy_accepted:n.target.checked})}),"Aceito a ",r.jsx("a",{className:"text-primary underline",href:"/privacy",target:"_blank",rel:"noreferrer",children:"Política de Privacidade"})]})]}),r.jsx("div",{children:r.jsx(A,{type:"submit",disabled:s,className:"w-full",children:s?"Salvando...":"Concluir"})})]})]})})};export{q as default};
