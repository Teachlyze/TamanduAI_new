import{s as c,u as Q,r as h,j as e,o as Y,d as w,C as B,B as P,e as z,l as G,U,c as W,V as A,ar as N}from"./main-BTTCSkdE.js";import{t as J,e as K}from"./toDate-B_SDEMqy.js";import{S as _,P as k}from"./PremiumCard-CV5gJlVo.js";import{P as S}from"./PremiumButton-TaG2j_oH.js";import{E as X}from"./EmptyState-j91SMhTI.js";import{C as Z}from"./chevron-left-ga51-8R3.js";import{P as ee}from"./plus-oG5N7bqt.js";function $(r,s,n){const a=J(r,n?.in);return a.setTime(a.getTime()+s*K),a}const L={async getUserCalendar({from:r,to:s,userId:n=null,userRole:a=null}){try{if(n&&a==="student"){const{data:p,error:f}=await c.from("calendar_events").select("id, class_id, title, description, start_time, end_time, activity_id, type, created_by").gte("start_time",r.toISOString()).lte("end_time",s.toISOString()).order("start_time",{ascending:!0});return f?(console.error("CalendarService.getUserCalendar error:",f),[]):p||[]}let i=c.from("calendar_events").select("id, class_id, title, description, start_time, end_time, activity_id, type, created_by").gte("start_time",r.toISOString()).lte("end_time",s.toISOString()).order("start_time",{ascending:!0});a==="teacher"&&n&&(i=i.eq("created_by",n));const{data:o,error:m}=await i;return m?(console.error("CalendarService.getUserCalendar error:",m),[]):o||[]}catch(i){return console.error("CalendarService.getUserCalendar exception:",i),[]}},async createEvent({class_id:r,title:s,description:n=null,start_time:a,end_time:i,type:o="custom",activity_id:m=null}){const{data:p}=await c.auth.getUser(),f=p?.user?.id||null,D={class_id:r,title:s,description:n,start_time:a instanceof Date?a.toISOString():a,end_time:i instanceof Date?i.toISOString():i,type:o,activity_id:m,created_by:f},{data:b,error:l}=await c.from("calendar_events").insert(D).select().single();if(l)throw l;return b},async updateEvent(r,s){const n=m=>m instanceof Date?m.toISOString():m,a={...s};a.start_time&&(a.start_time=n(a.start_time)),a.end_time&&(a.end_time=n(a.end_time));const{data:i,error:o}=await c.from("calendar_events").update(a).eq("id",r).select().single();if(o)throw o;return i},async deleteEvent(r){const{error:s}=await c.from("calendar_events").delete().eq("id",r);if(s)throw s;return!0},async getClassCalendar(r,{from:s,to:n}){const{data:a,error:i}=await c.from("calendar_events").select("id, class_id, title, description, start_time, end_time, activity_id").eq("class_id",r).gte("start_time",s.toISOString()).lte("end_time",n.toISOString()).order("start_time",{ascending:!0});if(i)throw i;return a||[]},subscribeUserCalendar(r,s){const n=c.channel(`calendar-user-${r}`);return n.on("postgres_changes",{event:"*",schema:"public",table:"calendar_events"},()=>s("calendar_events")).on("postgres_changes",{event:"*",schema:"public",table:"event_attendees",filter:`user_id=eq.${r}`},()=>s("event_attendees")).subscribe(),()=>{try{c.removeChannel(n)}catch{}}},subscribeClassCalendar(r,s){const n=c.channel(`calendar-class-${r}`);return n.on("postgres_changes",{event:"*",schema:"public",table:"calendar_events",filter:`class_id=eq.${r}`},()=>s("calendar_events")).on("postgres_changes",{event:"*",schema:"public",table:"event_attendees"},()=>s("event_attendees")).subscribe(),()=>{try{c.removeChannel(n)}catch{}}},detectConflicts(r){const s=[],n=[...r].sort((a,i)=>new Date(a.start_time)-new Date(i.start_time));for(let a=0;a<n.length-1;a++){const i=n[a],o=n[a+1];new Date(o.start_time)<new Date(i.end_time)&&s.push([i,o])}return s},computeReminderWindows(r){const s=new Date(r.end_time),n=r.estimated_minutes||60,a=r.complexity==="high"?2:r.complexity==="medium"?1.2:1,i=Math.ceil(n*a);return[{label:"Iniciar preparo",when:$(s,-i-120)},{label:"Lembrete 24h",when:$(s,-24*60)},{label:"Lembrete 2h",when:$(s,-120)}]},async getUserCalendarCompact({from:r,to:s,userId:n}){const a=r instanceof Date?r.toISOString():r,i=s instanceof Date?s.toISOString():s,o=n||(await c.auth.getUser()).data?.user?.id||null,{data:m,error:p}=await c.rpc("get_user_calendar_compact",{p_user:o,p_from:a,p_to:i});if(p)throw p;return m||[]}};function de(){const{user:r}=Q(),[s,n]=h.useState(!0),[a,i]=h.useState(new Date),[o,m]=h.useState([]),[p,f]=h.useState("day"),[D,b]=h.useState(!1),[l,g]=h.useState({title:"",type:"class",start:"",end:"",location:"",date:new Date().toISOString().split("T")[0]});h.useEffect(()=>{r&&v(a)},[r]),h.useEffect(()=>{if(!r)return;const t=L.subscribeUserCalendar(r.id,()=>{v(a)});return()=>{try{t?.()}catch{}}},[r,a]);const v=async t=>{n(!0);try{const d=t.getFullYear(),x=t.getMonth(),y=new Date(d,x,1),O=new Date(d,x+1,0,23,59,59),j=await L.getUserCalendar({from:y,to:O,userId:r.id,userRole:"teacher"});m(j||[])}catch(d){console.error("Erro ao carregar eventos:",d)}finally{n(!1)}},C=o.filter(t=>{const d=new Date(t.start_time),x=new Date;return d.toDateString()===x.toDateString()}),R=o.filter(t=>new Date(t.start_time)>new Date),F=o.length,V=o.filter(t=>t.status==="completed").length,E=t=>{switch(t){case"class":return P;case"meeting":return U;case"exam":return P;case"video":return A;default:return w}},I=t=>{switch(t){case"class":return"bg-blue-100 dark:bg-muted/50 text-blue-700 dark:text-blue-300";case"meeting":return"bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300";case"exam":return"bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-300";case"video":return"bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300";default:return"bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-300"}};return s?e.jsx(Y,{message:"Carregando agenda..."}):e.jsxs("div",{className:"space-y-8 animate-fade-in-up",children:[e.jsxs("div",{className:"bg-gradient-to-br from-orange-600 via-red-600 to-pink-600 p-8 rounded-2xl text-white relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 opacity-10",children:e.jsx("div",{className:"absolute inset-0",style:{backgroundImage:"radial-gradient(circle at 1px 1px, white 1px, transparent 0)",backgroundSize:"40px 40px"}})}),e.jsxs("div",{className:"relative z-10",children:[e.jsxs("h1",{className:"text-3xl font-bold mb-2 flex items-center gap-3",children:[e.jsx(w,{className:"w-8 h-8"}),"Agenda"]}),e.jsx("p",{className:"text-white/90",children:"Gerencie sua agenda e compromissos"})]})]}),e.jsxs("div",{className:"stagger-children grid grid-cols-1 md:grid-cols-4 gap-6",children:[e.jsx(_,{title:"Eventos Hoje",value:C.length.toString(),icon:w}),e.jsx(_,{title:"Próximos Eventos",value:R.length.toString(),icon:B}),e.jsx(_,{title:"Total de Eventos",value:F.toString(),icon:P}),e.jsx(_,{title:"Concluídos",value:V.toString(),icon:z})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsx(k,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h3",{className:"text-xl font-bold",children:a.toLocaleDateString("pt-BR",{month:"long",year:"numeric"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{const t=new Date(a);t.setMonth(t.getMonth()-1),i(t),v(t)},children:e.jsx(Z,{className:"w-4 h-4"})}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>i(new Date),children:"Hoje"}),e.jsx(S,{variant:"outline",size:"sm",onClick:()=>{const t=new Date(a);t.setMonth(t.getMonth()+1),i(t),v(t)},children:e.jsx(G,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"grid grid-cols-7 gap-2 mb-2",children:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].map(t=>e.jsx("div",{className:"text-center text-sm font-medium text-muted-foreground py-2",children:t},t))}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:(()=>{const t=a.getFullYear(),d=a.getMonth(),x=new Date(t,d,1).getDay(),y=new Date(t,d+1,0).getDate(),O=new Date,j=[];for(let u=0;u<x;u++)j.push(e.jsx("div",{className:"aspect-square"},`empty-${u}`));for(let u=1;u<=y;u++){const M=new Date(t,d,u),H=M.toDateString()===O.toDateString(),q=o.some(T=>new Date(T.start_time).toDateString()===M.toDateString());j.push(e.jsxs("button",{type:"button",onClick:T=>{T.preventDefault(),i(M)},className:`aspect-square p-2 rounded-lg text-sm font-medium transition-colors relative ${H?"bg-primary text-primary-foreground":q?"bg-muted hover:bg-muted/80":"hover:bg-muted/50"}`,children:[u,q&&e.jsx("div",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-primary"})]},u))}return j})()})]}),e.jsxs("div",{className:"border-t border-border pt-4 hidden",children:[e.jsxs("h4",{className:"font-semibold mb-3",children:["Eventos - ",a.toLocaleDateString("pt-BR")]}),e.jsx("div",{className:"space-y-3",children:C.length===0?e.jsx(X,{icon:w,title:"Nenhum evento neste dia",description:"Clique em '+' para adicionar um evento"}):C.map(t=>{const d=E(t.type);return e.jsxs("div",{className:"flex items-center gap-4 p-4 rounded-lg border border-border hover:bg-muted/50 transition-colors cursor-pointer",children:[e.jsx("div",{className:`p-3 rounded-lg ${I(t.type)}`,children:e.jsx(d,{className:"w-5 h-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium",children:t.title}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground mt-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(B,{className:"w-3 h-3"}),t.start," - ",t.end]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(U,{className:"w-3 h-3"}),t.students," alunos"]})]})]}),t.status==="upcoming"&&e.jsx(W,{className:"w-5 h-5 text-warning"})]},t.id)})})]})]})})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(k,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-bold",children:"Próximos Eventos"}),e.jsx(S,{variant:"gradient",size:"sm",leftIcon:ee,onClick:()=>b(!0),children:"Novo Evento"})]}),e.jsx("div",{className:"space-y-3",children:R.slice(0,5).map(t=>{const d=E(t.type);return e.jsx("div",{className:"p-3 rounded-lg border border-border hover:bg-muted/50 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded ${I(t.type)}`,children:e.jsx(d,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h5",{className:"font-medium text-sm truncate",children:t.title}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[new Date(t.date).toLocaleDateString("pt-BR")," às ",t.start]})]})]})},t.id)})})]})}),e.jsx(k,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Resumo do Mês"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-muted/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-4 h-4 text-blue-600 dark:text-blue-400"}),e.jsx("span",{className:"text-sm font-medium",children:"Aulas"})]}),e.jsx("span",{className:"text-xl font-bold text-blue-600 dark:text-blue-400",children:"12"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4 text-purple-600 dark:text-purple-400"}),e.jsx("span",{className:"text-sm font-medium",children:"Reuniões"})]}),e.jsx("span",{className:"text-xl font-bold text-purple-600 dark:text-purple-400",children:"5"})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-green-50 dark:bg-green-900/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-4 h-4 text-green-600 dark:text-green-400"}),e.jsx("span",{className:"text-sm font-medium",children:"Concluídos"})]}),e.jsx("span",{className:"text-xl font-bold text-green-600 dark:text-green-400",children:"15"})]})]})]})}),e.jsx(k,{variant:"elevated",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-4",children:"Eventos do dia"}),o.filter(t=>new Date(t.start_time).toDateString()===a.toDateString()).length===0?e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Nenhum evento para ",a.toLocaleDateString("pt-BR")]}):e.jsx("div",{className:"space-y-3",children:o.filter(t=>new Date(t.start_time).toDateString()===a.toDateString()).map(t=>{const d=E(t.type),x=new Date(t.start_time),y=new Date(t.end_time);return e.jsx("div",{className:"p-3 rounded-lg border border-border hover:bg-muted/50 transition-colors cursor-pointer",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:`p-2 rounded ${I(t.type)}`,children:e.jsx(d,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h5",{className:"font-medium text-sm truncate",children:t.title}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[x.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})," - ",y.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})]})]})]})},t.id)})})]})})]})]}),D&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",onClick:()=>b(!1),children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 p-6 rounded-2xl max-w-md w-full shadow-2xl border border-gray-200 dark:border-gray-700",onClick:t=>t.stopPropagation(),children:[e.jsx("h3",{className:"text-xl font-bold mb-4 text-gray-900 dark:text-white",children:"Novo Evento"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Título"}),e.jsx("input",{type:"text",value:l.title,onChange:t=>g({...l,title:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Nome do evento"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Data"}),e.jsx("input",{type:"date",value:l.date,onChange:t=>g({...l,date:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Tipo"}),e.jsxs("select",{value:l.type,onChange:t=>g({...l,type:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"class",children:"Aula"}),e.jsx("option",{value:"meeting",children:"Reunião"}),e.jsx("option",{value:"exam",children:"Prova"}),e.jsx("option",{value:"video",children:"Videoconferência"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Início"}),e.jsx("input",{type:"time",value:l.start,onChange:t=>g({...l,start:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Fim"}),e.jsx("input",{type:"time",value:l.end,onChange:t=>g({...l,end:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium mb-1 block text-gray-700 dark:text-gray-300",children:"Local"}),e.jsx("input",{type:"text",value:l.location,onChange:t=>g({...l,location:t.target.value}),className:"w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Ex: Sala 12"})]}),e.jsxs("div",{className:"flex gap-3 mt-6",children:[e.jsx("button",{onClick:()=>{b(!1),g({title:"",type:"class",start:"",end:"",location:"",date:new Date().toISOString().split("T")[0]})},className:"flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors",children:"Cancelar"}),e.jsx("button",{onClick:async()=>{if(!r)return N.error("Usuário não autenticado");if(l.title&&l.start&&l.end&&l.date)try{const t=new Date(`${l.date}T${l.start}`),d=new Date(`${l.date}T${l.end}`);await L.createEvent({class_id:null,title:l.title,description:null,start_time:t,end_time:d,type:l.type,color:null,meeting_id:null,activity_id:null,metadata:{location:l.location,teacher_id:r.id}}),b(!1),g({title:"",type:"class",start:"",end:"",location:"",date:new Date().toISOString().split("T")[0]}),await v(a),N.success("Evento criado com sucesso!")}catch(t){console.error("Erro ao criar evento:",t),N.error("Erro ao criar evento")}else N.error("Preencha todos os campos obrigatórios")},className:"flex-1 px-4 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-purple-600 text-white hover:opacity-90 transition-opacity font-medium",children:"Criar Evento"})]})]})]})})]})}export{de as default};
