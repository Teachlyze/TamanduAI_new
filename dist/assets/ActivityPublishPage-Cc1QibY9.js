import{r as f,j as e,ad as z,i as v,l as Z,ak as ee,u as se,g as te,s as y,x as B,F as q,H as $,B as ae,y as L,J as N,b8 as ie,U as re,K as H,bE as R,bL as ne,bM as le,d as ce,bN as oe,D as de,e as me,b5 as ue,bd as U}from"./main-NgjJy_CG.js";import{u as he}from"./use-toast-GUBWlXfL.js";import{t as V,c as I}from"./toDate-M29M8iGB.js";import{e as xe}from"./endOfMonth-DIv7euNo.js";import{n as Q}from"./en-US-DmzJuP_Q.js";import{C as pe}from"./chevron-left-CCTbow4A.js";import{f as _}from"./format-CtnHAw15.js";import{p as O}from"./pt-BR-D7au_PjL.js";import{i as Y}from"./isSameDay-Ca9HGok4.js";import{B as ge}from"./badge-DS8upoqS.js";import{A as fe}from"./arrow-left-MOSQdYvL.js";function G(i,o,r){const l=V(i,r?.in);if(isNaN(o))return I(i,NaN);if(!o)return l;const m=l.getDate(),n=I(i,l.getTime());n.setMonth(l.getMonth()+o+1,0);const u=n.getDate();return m>=u?n:(l.setFullYear(n.getFullYear(),n.getMonth(),m),l)}function ve(i,o){const[r,l]=Q(i,o.start,o.end);return{start:r,end:l}}function je(i,o){const{start:r,end:l}=ve(o?.in,i);let m=+r>+l;const n=m?+r:+l,u=m?l:r;u.setHours(0,0,0,0);let x=1;const p=[];for(;+u<=n;)p.push(I(r,u)),u.setDate(u.getDate()+x),u.setHours(0,0,0,0);return m?p.reverse():p}function be(i,o){const r=V(i,o?.in);return r.setDate(1),r.setHours(0,0,0,0),r}function Ne(i,o,r){const[l,m]=Q(r?.in,i,o);return l.getFullYear()===m.getFullYear()&&l.getMonth()===m.getMonth()}function ye(i,o,r){return G(i,-1,r)}const we=({mode:i="single",selected:o,onSelect:r,className:l,...m})=>{const[n,u]=f.useState(new Date),x=be(n),p=xe(n),T=je({start:x,end:p}),S=x.getDay(),w=Array(S).fill(null).concat(T),P=c=>{c&&(i==="single"||i==="multiple")&&r?.(c)},t=()=>{u(c=>ye(c))},g=()=>{u(c=>G(c,1))},M=c=>!o||!c?!1:Y(o,c);return e.jsxs("div",{className:z("p-3 bg-white border rounded-lg shadow-lg",l),...m,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:t,className:"h-8 w-8 p-0",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsx("h2",{className:"text-sm font-semibold text-gray-900",children:_(n,"MMMM yyyy",{locale:O})}),e.jsx(v,{variant:"ghost",size:"sm",onClick:g,className:"h-8 w-8 p-0",children:e.jsx(Z,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].map(c=>e.jsx("div",{className:"h-8 w-8 flex items-center justify-center text-xs font-medium text-gray-500",children:c},c))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:w.map((c,k)=>{if(!c)return e.jsx("div",{className:"h-8 w-8"},`empty-${k}`);const s=Ne(c,n),a=M(c),d=Y(c,new Date);return e.jsxs(v,{variant:"ghost",size:"sm",onClick:()=>P(c),className:z("h-8 w-8 p-0 text-xs font-normal hover:bg-blue-100 hover:text-blue-900 transition-all relative",!s&&"text-gray-300 hover:text-gray-400",d&&!a&&"bg-blue-600 text-white hover:bg-blue-700 hover:text-white font-bold ring-4 ring-blue-200 dark:ring-blue-800 shadow-lg scale-105",a&&!d&&"bg-blue-100 dark:bg-blue-900/50 text-blue-900 dark:text-blue-100 font-semibold ring-2 ring-blue-300 dark:ring-blue-700",a&&d&&"bg-blue-600 text-white hover:bg-blue-700 hover:text-white font-bold ring-4 ring-blue-300 dark:ring-blue-800 shadow-lg scale-110"),children:[_(c,"d"),d&&!a&&e.jsx("span",{className:"absolute -bottom-1 left-1/2 transform -translate-x-1/2 text-[8px] whitespace-nowrap",children:"Hoje"})]},c.toISOString())})})]})},Fe=()=>{const{templateId:i,classId:o}=ee(),{user:r}=se(),{toast:l}=he(),m=te(),[n,u]=f.useState(null),[x,p]=f.useState([]),[T,S]=f.useState(!0),[w,P]=f.useState(!1),[t,g]=f.useState({selectedClasses:o?[o]:[],customTitle:"",customDescription:"",customInstructions:"",dueDate:null,maxPoints:100});f.useEffect(()=>{M()},[M]);const M=f.useCallback(async()=>{try{if(S(!0),!r||!r.id||!i){u(null),p([]);return}const{data:s,error:a}=await y.from("activities").select("*").eq("id",i).eq("created_by",r.id).single();if(a)throw a;u(s);const{data:d,error:C}=await y.from("classes").select("*").eq("created_by",r.id);if(C)throw C;p(d||[])}catch(s){console.error("Error loading data:",s),l({title:"Erro ao carregar dados",description:"Não foi possível carregar o template ou as turmas.",variant:"destructive"})}finally{S(!1)}},[i,r?.id,l]),c=async()=>{if(t.selectedClasses.length===0){l({title:"Selecione turmas",description:"Selecione pelo menos uma turma para publicar a atividade.",variant:"destructive"});return}try{P(!0);const{error:s}=await y.from("activities").update({status:"published",published_at:new Date().toISOString(),title:t.customTitle||void 0,description:t.customDescription||void 0,instructions:t.customInstructions||void 0,due_date:t.dueDate||void 0,total_points:t.maxPoints||void 0}).eq("id",i).eq("created_by",r.id);if(s)throw s;const{error:a}=await y.from("activity_class_assignments").insert(t.selectedClasses.map(d=>({activity_id:i,class_id:d,assigned_at:new Date().toISOString()})));if(a)throw a;try{for(const d of t.selectedClasses){const J=x.find(h=>h.id===d)?.name||"Sua turma",{data:K,error:F}=await y.from("class_members").select("user_id").eq("class_id",d).eq("role","student");if(F)throw F;const D=(K||[]).map(h=>h.user_id);let A={};if(D.length>0){const{data:h,error:j}=await y.from("profiles").select("id, email, full_name").in("id",D);if(j)throw j;A=Object.fromEntries((h||[]).map(b=>[b.id,{email:b.email,name:b.full_name}]))}const W=t.dueDate?_(t.dueDate,"PPP p",{locale:O}):null,E={studentName:"",className:J,activityName:t.customTitle||n.title,deadline:W||"Sem prazo",points:t.maxPoints,activityUrl:`/dashboard/classes/${d}/activities`},X=D.map(h=>{const j=A[h];return ue.send("newActivity",{userId:h,email:j?.email||void 0,channelOverride:"both",variables:{...E,studentName:j?.name||""},metadata:{classId:d,templateId:i,kind:"publish_activity"}})});if(await Promise.allSettled(X),t.dueDate){const h=D.map(b=>U.scheduleReminder({type:"assignment",eventId:i,dueAt:t.dueDate,notification:{title:"⏰ Prazo em 24 horas!",message:`${E.activityName} vence em breve`,type:"assignment",category:"deadline",priority:"high",metadata:{classId:d,templateId:i,reminder24h:!0}},remindBeforeMinutes:1440,userId:b}));await Promise.allSettled(h);const j=D.map(b=>U.scheduleReminder({type:"assignment",eventId:i,dueAt:t.dueDate,notification:{title:"⚠️ URGENTE: Prazo em 1 hora!",message:`${E.activityName} vence em 1 hora`,type:"assignment",category:"deadline",priority:"urgent",metadata:{classId:d,templateId:i,reminder1h:!0}},remindBeforeMinutes:60,userId:b}));await Promise.allSettled(j)}}}catch(d){console.warn("Falha ao enviar notificações pós-publicação:",d)}l({title:"Atividade publicada!",description:`A atividade foi publicada em ${t.selectedClasses.length} turma(s) com sucesso.`}),m(o?`/dashboard/classes/${o}/activities`:"/dashboard/activities")}catch(s){console.error("Error publishing template:",s),l({title:"Erro ao publicar",description:"Não foi possível publicar a atividade. Tente novamente.",variant:"destructive"})}finally{P(!1)}},k=s=>{g(a=>a.selectedClasses.includes(s)?{...a,selectedClasses:a.selectedClasses.filter(C=>C!==s)}:{...a,selectedClasses:[...a.selectedClasses,s]})};return T?e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando dados..."})]})}):n?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs(v,{variant:"ghost",onClick:()=>m("/dashboard/activities"),children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Voltar"]}),e.jsxs("div",{className:"ml-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Publicar Atividade"}),e.jsxs("p",{className:"text-gray-600",children:['Configure e publique "',n.title,'" nas turmas']})]})]})})})}),e.jsx("main",{className:"py-6 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(B,{children:[e.jsx(q,{children:e.jsxs($,{className:"flex items-center",children:[e.jsx(ae,{className:"h-5 w-5 mr-2"}),"Template Original"]})}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-lg",children:n.title}),n.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:n.description})]}),n.tags&&n.tags.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Tags:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:n.tags.map((s,a)=>e.jsx(ge,{variant:"secondary",children:s},a))})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Criado em ",new Date(n.created_at).toLocaleDateString()]})]})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(B,{children:[e.jsx(q,{children:e.jsx($,{children:"Configurações de Publicação"})}),e.jsxs(L,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(N,{className:"text-base font-medium",children:"Turmas"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Selecione as turmas onde deseja publicar esta atividade"}),e.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto",children:x.map(s=>e.jsxs("div",{className:"flex items-start space-x-3 p-3 border rounded-lg",children:[e.jsx(ie,{id:`class-${s.id}`,checked:t.selectedClasses.includes(s.id),onCheckedChange:()=>k(s.id)}),e.jsxs("div",{className:"flex-1",children:[e.jsx(N,{htmlFor:`class-${s.id}`,className:"font-medium cursor-pointer",children:s.name}),e.jsxs("div",{className:"flex items-center space-x-4 mt-1 text-sm text-gray-500",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(re,{className:"h-4 w-4 mr-1"}),s.subject]}),e.jsx("span",{children:s.grade_level})]})]})]},s.id))}),x.length===0&&e.jsx("p",{className:"text-sm text-gray-500 italic",children:"Você não tem turmas para publicar atividades."})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h4",{className:"font-medium mb-4",children:"Personalizações (Opcional)"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"customTitle",children:"Título personalizado"}),e.jsx(H,{id:"customTitle",value:t.customTitle,onChange:s=>g(a=>({...a,customTitle:s.target.value})),placeholder:n.title})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"customDescription",children:"Descrição personalizada"}),e.jsx(R,{id:"customDescription",value:t.customDescription,onChange:s=>g(a=>({...a,customDescription:s.target.value})),placeholder:n.description||"Sem descrição",rows:3})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"customInstructions",children:"Instruções personalizadas"}),e.jsx(R,{id:"customInstructions",value:t.customInstructions,onChange:s=>g(a=>({...a,customInstructions:s.target.value})),placeholder:"Adicione instruções específicas para esta turma...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"maxPoints",children:"Pontuação máxima"}),e.jsx(H,{id:"maxPoints",type:"number",min:"1",max:"1000",value:t.maxPoints,onChange:s=>g(a=>({...a,maxPoints:parseInt(s.target.value)||100}))})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Data de entrega (opcional)"}),e.jsxs(ne,{children:[e.jsx(le,{asChild:!0,children:e.jsxs(v,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(ce,{className:"mr-2 h-4 w-4"}),t.dueDate?_(t.dueDate,"PPP",{locale:O}):e.jsx("span",{children:"Selecionar data"})]})}),e.jsx(oe,{className:"w-auto p-0",align:"start",children:e.jsx(we,{mode:"single",selected:t.dueDate,onSelect:s=>g(a=>({...a,dueDate:s})),initialFocus:!0})})]})]})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-6 border-t",children:[e.jsx(v,{variant:"outline",onClick:()=>m("/dashboard/activities"),disabled:w,children:"Cancelar"}),e.jsx(v,{onClick:c,disabled:w||t.selectedClasses.length===0,children:w?e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"mr-2 h-4 w-4 animate-spin"}),"Publicando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"mr-2 h-4 w-4"}),"Publicar em ",t.selectedClasses.length," turma",t.selectedClasses.length!==1?"s":""]})})]})]})]})})]})})})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Template não encontrado"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"O template que você está tentando acessar não existe ou você não tem permissão."}),e.jsx(v,{onClick:()=>m("/dashboard/activities"),children:"Voltar para Atividades"})]})})};export{Fe as default};
