import{r as f,j as e,ae as z,i as v,l as X,al as Z,u as ee,g as se,s as y,x as B,F as q,H as $,B as te,y as L,J as N,ba as ae,U as ie,K as R,aM as H,bL as re,bM as ne,d as le,bN as ce,D as oe,e as de,b6 as me,bf as U}from"./main-BBAlbGLj.js";import{u as ue}from"./use-toast-Ci9GuxPV.js";import{t as Y,c as O}from"./toDate-B_SDEMqy.js";import{e as he}from"./endOfMonth-5f4-gZt5.js";import{n as V}from"./en-US-C1KUdeex.js";import{C as xe}from"./chevron-left-CJcRRXyQ.js";import{f as _}from"./format-BmB7BMvl.js";import{p as k}from"./pt-BR-CVz3wboC.js";import{i as pe}from"./isSameDay-B_Hc6oyE.js";import{B as ge}from"./badge-Dxkfeepr.js";import{A as fe}from"./arrow-left-D8R0xudv.js";function Q(a,o,i){const l=Y(a,i?.in);if(isNaN(o))return O(a,NaN);if(!o)return l;const d=l.getDate(),r=O(a,l.getTime());r.setMonth(l.getMonth()+o+1,0);const m=r.getDate();return d>=m?r:(l.setFullYear(r.getFullYear(),r.getMonth(),d),l)}function ve(a,o){const[i,l]=V(a,o.start,o.end);return{start:i,end:l}}function je(a,o){const{start:i,end:l}=ve(o?.in,a);let d=+i>+l;const r=d?+i:+l,m=d?l:i;m.setHours(0,0,0,0);let x=1;const p=[];for(;+m<=r;)p.push(O(i,m)),m.setDate(m.getDate()+x),m.setHours(0,0,0,0);return d?p.reverse():p}function be(a,o){const i=Y(a,o?.in);return i.setDate(1),i.setHours(0,0,0,0),i}function Ne(a,o,i){const[l,d]=V(i?.in,a,o);return l.getFullYear()===d.getFullYear()&&l.getMonth()===d.getMonth()}function ye(a,o,i){return Q(a,-1,i)}const Ce=({mode:a="single",selected:o,onSelect:i,className:l,...d})=>{const[r,m]=f.useState(new Date),x=be(r),p=he(r),T=je({start:x,end:p}),S=x.getDay(),C=Array(S).fill(null).concat(T),P=c=>{c&&(a==="single"||a==="multiple")&&i?.(c)},t=()=>{m(c=>ye(c))},g=()=>{m(c=>Q(c,1))},M=c=>!o||!c?!1:pe(o,c);return e.jsxs("div",{className:z("p-3 bg-white border rounded-lg shadow-lg",l),...d,children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:t,className:"h-8 w-8 p-0",children:e.jsx(xe,{className:"h-4 w-4"})}),e.jsx("h2",{className:"text-sm font-semibold text-gray-900",children:_(r,"MMMM yyyy",{locale:k})}),e.jsx(v,{variant:"ghost",size:"sm",onClick:g,className:"h-8 w-8 p-0",children:e.jsx(X,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].map(c=>e.jsx("div",{className:"h-8 w-8 flex items-center justify-center text-xs font-medium text-gray-500",children:c},c))}),e.jsx("div",{className:"grid grid-cols-7 gap-1",children:C.map((c,I)=>{if(!c)return e.jsx("div",{className:"h-8 w-8"},`empty-${I}`);const s=Ne(c,r),n=M(c);return e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>P(c),className:z("h-8 w-8 p-0 text-xs font-normal hover:bg-blue-100 hover:text-blue-900",!s&&"text-gray-300 hover:text-gray-400",n&&"bg-blue-600 text-white hover:bg-blue-700 hover:text-white"),children:_(c,"d")},c.toISOString())})})]})},Fe=()=>{const{templateId:a,classId:o}=Z(),{user:i}=ee(),{toast:l}=ue(),d=se(),[r,m]=f.useState(null),[x,p]=f.useState([]),[T,S]=f.useState(!0),[C,P]=f.useState(!1),[t,g]=f.useState({selectedClasses:o?[o]:[],customTitle:"",customDescription:"",customInstructions:"",dueDate:null,maxPoints:100});f.useEffect(()=>{M()},[M]);const M=f.useCallback(async()=>{try{if(S(!0),!i||!i.id||!a){m(null),p([]);return}const{data:s,error:n}=await y.from("activities").select("*").eq("id",a).eq("created_by",i.id).single();if(n)throw n;m(s);const{data:u,error:w}=await y.from("classes").select("*").eq("created_by",i.id);if(w)throw w;p(u||[])}catch(s){console.error("Error loading data:",s),l({title:"Erro ao carregar dados",description:"Não foi possível carregar o template ou as turmas.",variant:"destructive"})}finally{S(!1)}},[a,i?.id,l]),c=async()=>{if(t.selectedClasses.length===0){l({title:"Selecione turmas",description:"Selecione pelo menos uma turma para publicar a atividade.",variant:"destructive"});return}try{P(!0);const{error:s}=await y.from("activities").update({status:"published",published_at:new Date().toISOString(),title:t.customTitle||void 0,description:t.customDescription||void 0,instructions:t.customInstructions||void 0,due_date:t.dueDate||void 0,total_points:t.maxPoints||void 0}).eq("id",a).eq("created_by",i.id);if(s)throw s;const{error:n}=await y.from("activity_class_assignments").insert(t.selectedClasses.map(u=>({activity_id:a,class_id:u,assigned_at:new Date().toISOString()})));if(n)throw n;try{for(const u of t.selectedClasses){const G=x.find(h=>h.id===u)?.name||"Sua turma",{data:J,error:F}=await y.from("class_members").select("user_id").eq("class_id",u).eq("role","student");if(F)throw F;const D=(J||[]).map(h=>h.user_id);let A={};if(D.length>0){const{data:h,error:j}=await y.from("profiles").select("id, email, full_name").in("id",D);if(j)throw j;A=Object.fromEntries((h||[]).map(b=>[b.id,{email:b.email,name:b.full_name}]))}const K=t.dueDate?_(t.dueDate,"PPP p",{locale:k}):null,E={studentName:"",className:G,activityName:t.customTitle||r.title,deadline:K||"Sem prazo",points:t.maxPoints,activityUrl:`/dashboard/classes/${u}/activities`},W=D.map(h=>{const j=A[h];return me.send("newActivity",{userId:h,email:j?.email||void 0,channelOverride:"both",variables:{...E,studentName:j?.name||""},metadata:{classId:u,templateId:a,kind:"publish_activity"}})});if(await Promise.allSettled(W),t.dueDate){const h=D.map(b=>U.scheduleReminder({type:"assignment",eventId:a,dueAt:t.dueDate,notification:{title:"⏰ Prazo em 24 horas!",message:`${E.activityName} vence em breve`,type:"assignment",category:"deadline",priority:"high",metadata:{classId:u,templateId:a,reminder24h:!0}},remindBeforeMinutes:1440,userId:b}));await Promise.allSettled(h);const j=D.map(b=>U.scheduleReminder({type:"assignment",eventId:a,dueAt:t.dueDate,notification:{title:"⚠️ URGENTE: Prazo em 1 hora!",message:`${E.activityName} vence em 1 hora`,type:"assignment",category:"deadline",priority:"urgent",metadata:{classId:u,templateId:a,reminder1h:!0}},remindBeforeMinutes:60,userId:b}));await Promise.allSettled(j)}}}catch(u){console.warn("Falha ao enviar notificações pós-publicação:",u)}l({title:"Atividade publicada!",description:`A atividade foi publicada em ${t.selectedClasses.length} turma(s) com sucesso.`}),d(o?`/dashboard/classes/${o}/activities`:"/dashboard/activities")}catch(s){console.error("Error publishing template:",s),l({title:"Erro ao publicar",description:"Não foi possível publicar a atividade. Tente novamente.",variant:"destructive"})}finally{P(!1)}},I=s=>{g(n=>n.selectedClasses.includes(s)?{...n,selectedClasses:n.selectedClasses.filter(w=>w!==s)}:{...n,selectedClasses:[...n.selectedClasses,s]})};return T?e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Carregando dados..."})]})}):r?e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white shadow-sm",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs(v,{variant:"ghost",onClick:()=>d("/dashboard/activities"),children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),"Voltar"]}),e.jsxs("div",{className:"ml-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Publicar Atividade"}),e.jsxs("p",{className:"text-gray-600",children:['Configure e publique "',r.title,'" nas turmas']})]})]})})})}),e.jsx("main",{className:"py-6 px-4 sm:px-6 lg:px-8",children:e.jsx("div",{className:"max-w-4xl mx-auto",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(B,{children:[e.jsx(q,{children:e.jsxs($,{className:"flex items-center",children:[e.jsx(te,{className:"h-5 w-5 mr-2"}),"Template Original"]})}),e.jsxs(L,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-lg",children:r.title}),r.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:r.description})]}),r.tags&&r.tags.length>0&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Tags:"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:r.tags.map((s,n)=>e.jsx(ge,{variant:"secondary",children:s},n))})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Criado em ",new Date(r.created_at).toLocaleDateString()]})]})]})}),e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(B,{children:[e.jsx(q,{children:e.jsx($,{children:"Configurações de Publicação"})}),e.jsxs(L,{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(N,{className:"text-base font-medium",children:"Turmas"}),e.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"Selecione as turmas onde deseja publicar esta atividade"}),e.jsx("div",{className:"space-y-3 max-h-60 overflow-y-auto",children:x.map(s=>e.jsxs("div",{className:"flex items-start space-x-3 p-3 border rounded-lg",children:[e.jsx(ae,{id:`class-${s.id}`,checked:t.selectedClasses.includes(s.id),onCheckedChange:()=>I(s.id)}),e.jsxs("div",{className:"flex-1",children:[e.jsx(N,{htmlFor:`class-${s.id}`,className:"font-medium cursor-pointer",children:s.name}),e.jsxs("div",{className:"flex items-center space-x-4 mt-1 text-sm text-gray-500",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(ie,{className:"h-4 w-4 mr-1"}),s.subject]}),e.jsx("span",{children:s.grade_level})]})]})]},s.id))}),x.length===0&&e.jsx("p",{className:"text-sm text-gray-500 italic",children:"Você não tem turmas para publicar atividades."})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h4",{className:"font-medium mb-4",children:"Personalizações (Opcional)"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"customTitle",children:"Título personalizado"}),e.jsx(R,{id:"customTitle",value:t.customTitle,onChange:s=>g(n=>({...n,customTitle:s.target.value})),placeholder:r.title})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"customDescription",children:"Descrição personalizada"}),e.jsx(H,{id:"customDescription",value:t.customDescription,onChange:s=>g(n=>({...n,customDescription:s.target.value})),placeholder:r.description||"Sem descrição",rows:3})]}),e.jsxs("div",{children:[e.jsx(N,{htmlFor:"customInstructions",children:"Instruções personalizadas"}),e.jsx(H,{id:"customInstructions",value:t.customInstructions,onChange:s=>g(n=>({...n,customInstructions:s.target.value})),placeholder:"Adicione instruções específicas para esta turma...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(N,{htmlFor:"maxPoints",children:"Pontuação máxima"}),e.jsx(R,{id:"maxPoints",type:"number",min:"1",max:"1000",value:t.maxPoints,onChange:s=>g(n=>({...n,maxPoints:parseInt(s.target.value)||100}))})]}),e.jsxs("div",{children:[e.jsx(N,{children:"Data de entrega (opcional)"}),e.jsxs(re,{children:[e.jsx(ne,{asChild:!0,children:e.jsxs(v,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx(le,{className:"mr-2 h-4 w-4"}),t.dueDate?_(t.dueDate,"PPP",{locale:k}):e.jsx("span",{children:"Selecionar data"})]})}),e.jsx(ce,{className:"w-auto p-0",align:"start",children:e.jsx(Ce,{mode:"single",selected:t.dueDate,onSelect:s=>g(n=>({...n,dueDate:s})),initialFocus:!0})})]})]})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-6 border-t",children:[e.jsx(v,{variant:"outline",onClick:()=>d("/dashboard/activities"),disabled:C,children:"Cancelar"}),e.jsx(v,{onClick:c,disabled:C||t.selectedClasses.length===0,children:C?e.jsxs(e.Fragment,{children:[e.jsx(oe,{className:"mr-2 h-4 w-4 animate-spin"}),"Publicando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"mr-2 h-4 w-4"}),"Publicar em ",t.selectedClasses.length," turma",t.selectedClasses.length!==1?"s":""]})})]})]})]})})]})})})]}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex justify-center items-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Template não encontrado"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"O template que você está tentando acessar não existe ou você não tem permissão."}),e.jsx(v,{onClick:()=>d("/dashboard/activities"),children:"Voltar para Atividades"})]})})};export{Fe as default};
