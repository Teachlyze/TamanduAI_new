import{u as B,r as o,j as s,o as T,U as P,s as h}from"./main-Bujpyeg-.js";import{P as v}from"./PremiumCard-BaDWg06v.js";import{E as j}from"./EmptyState-CpVlA95H.js";import{T as N}from"./trophy-BvMu_Ocx.js";import"./PremiumButton-skKgx_xy.js";const C=(d,g)=>{const m=Object.entries(d).map(([a,l])=>({user_id:a,xp:l,name:g.get(a)?.full_name||"Aluno"}));return m.sort((a,l)=>(l.xp||0)-(a.xp||0)),m.map((a,l)=>({...a,position:l+1}))},F=()=>{const{user:d}=B(),[g,m]=o.useState(!0),[a,l]=o.useState([]),[u,I]=o.useState({}),[y,M]=o.useState(new Map),[S,q]=o.useState({}),[x,U]=o.useState(null);o.useEffect(()=>{(async()=>{if(d?.id){m(!0);try{const{data:t}=await h.from("class_members").select("class_id, class:classes(id, name, school_id)").eq("user_id",d.id).eq("role","student"),e=(t||[]).map(p=>p.class).filter(Boolean);l(e);const r=e.find(p=>p.school_id)?.school_id||null;if(U(r),e.length>0){const p=e.map(i=>i.id),{data:A}=await h.from("class_members").select("class_id, user_id").in("class_id",p).eq("role","student"),f={},E=new Set;for(const i of A||[])f[i.class_id]=f[i.class_id]||[],f[i.class_id].push(i.user_id),E.add(i.user_id);I(f);const b=Array.from(E);if(b.length){const{data:i}=await h.from("profiles").select("id, full_name").in("id",b),k=new Map;(i||[]).forEach(c=>k.set(c.id,c)),M(k);const{data:R}=await h.from("xp_log").select("user_id, xp").in("user_id",b),_={};(R||[]).forEach(c=>{_[c.user_id]=(_[c.user_id]||0)+(c.xp||0)}),q(_)}}}finally{m(!1)}}})()},[d?.id]);const w=o.useMemo(()=>{if(!x)return[];const n=new Set;for(const t of a)t.school_id===x&&u[t.id]&&u[t.id].forEach(e=>n.add(e));return Array.from(n)},[x,a,u]);return g?s.jsx(T,{message:"Calculando rankings..."}):s.jsxs("div",{className:"space-y-6",children:[s.jsxs("div",{className:"bg-gradient-to-br from-amber-600 to-yellow-600 p-8 rounded-2xl text-white",children:[s.jsxs("h1",{className:"text-2xl font-bold flex items-center gap-3",children:[s.jsx(N,{className:"w-6 h-6"})," Ranking"]}),s.jsx("p",{className:"text-white/90",children:"Rankings por turma e por escola"})]}),s.jsx("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:a.length===0?s.jsx(v,{variant:"elevated",children:s.jsx("div",{className:"p-6",children:s.jsx(j,{icon:P,title:"Sem turmas",description:"Entre em uma turma para ver o ranking."})})}):a.map(n=>{const t={};(u[n.id]||[]).forEach(r=>{t[r]=S[r]||0});const e=C(t,y);return s.jsx(v,{variant:"elevated",children:s.jsxs("div",{className:"p-6",children:[s.jsxs("div",{className:"font-bold mb-4",children:["Turma: ",n.name]}),e.length===0?s.jsx(j,{icon:N,title:"Sem pontos ainda",description:"Ninguém pontuou por enquanto."}):s.jsx("div",{className:"space-y-2",children:e.slice(0,10).map(r=>s.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("span",{className:"w-7 text-center font-bold",children:r.position}),s.jsx("span",{children:r.name})]}),s.jsxs("span",{className:"text-sm font-semibold",children:[r.xp," XP"]})]},r.user_id))})]})},n.id)})}),s.jsx(v,{variant:"elevated",children:s.jsxs("div",{className:"p-6",children:[s.jsx("div",{className:"font-bold mb-4",children:"Escola"}),!x||w.length===0?s.jsx(j,{icon:P,title:"Sem escola",description:"Participe de uma turma vinculada a uma escola para ver o ranking."}):(()=>{const n={};w.forEach(e=>{n[e]=S[e]||0});const t=C(n,y);return t.length===0?s.jsx(j,{icon:N,title:"Sem pontos ainda",description:"Ninguém pontuou por enquanto."}):s.jsx("div",{className:"space-y-2",children:t.slice(0,20).map(e=>s.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border border-border",children:[s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("span",{className:"w-7 text-center font-bold",children:e.position}),s.jsx("span",{children:e.name})]}),s.jsxs("span",{className:"text-sm font-semibold",children:[e.xp," XP"]})]},e.user_id))})})()]})})]})};export{F as default};
