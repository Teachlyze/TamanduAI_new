import{al as D,r as a,j as e,L as _,s as U,x as P,F as V,H as q,I as H,y as O,J as b,K as T,aN as z,aO as M,aP as Q,aQ as G,aR as A,i as y,aS as F,C as J,U as R,t as K,v as W,u as X,c as Y,W as Z,X as ee,Y as I,B as se,$ as E}from"./main-Cv3DLBs1.js";import{g as ae,a as te,b as re}from"./apiSupabase-Clw2--zA.js";import{B as ne}from"./bot-vLlYw4u7.js";import{S as ie}from"./send-BE4VkFZG.js";import{u as $}from"./use-toast-D9kn2S2s.js";import{C}from"./classInviteService-5RpEdn3N.js";import{C as L}from"./copy-DBsE7LuZ.js";import{L as oe}from"./link-1m3G8lM8.js";import{T as ce}from"./trash-2-ChfOtETt.js";import{f as le}from"./formatDistanceToNow-DKkltRxp.js";import{f as de}from"./format-BmB7BMvl.js";import{p as me}from"./pt-BR-CVz3wboC.js";import{S as ue}from"./share-2-bLWPyo27.js";import"./constructNow-BUe0KqNa.js";import"./toDate-B_SDEMqy.js";import"./en-US-C1KUdeex.js";import"./endOfMonth-5f4-gZt5.js";const xe=()=>{const{classId:t}=D(),[u,c]=a.useState([]),[m,l]=a.useState(!0),[x,o]=a.useState("");return a.useEffect(()=>{t&&(async()=>{l(!0),o("");try{const d=await ae(t);c(d)}catch(d){o("Erro ao carregar atividades. Tente novamente."),console.error("Erro ao carregar atividades:",d)}finally{l(!1)}})()},[t]),m?e.jsx(_,{}):x?e.jsx("p",{className:"text-red-500 text-center",children:x}):e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("h1",{className:"text-3xl font-bold mb-4",children:"Atividades da Turma"}),u.length===0?e.jsx("p",{className:"text-gray-500 text-center",children:"Nenhuma atividade disponível."}):e.jsx("div",{className:"space-y-4",children:u.map(r=>e.jsxs("div",{className:"border rounded-lg p-4",children:[e.jsx("h2",{className:"text-xl font-semibold mb-2",children:r.title}),e.jsx("p",{className:"text-gray-600 mb-4",children:r.description||"Sem descrição"}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("p",{className:"text-sm text-gray-500",children:["Criado em: ",new Date(r.created_at).toLocaleDateString()]}),e.jsx("button",{className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700",onClick:()=>{},children:"Ver atividade"})]})]},r.id))})]})};async function he({classId:t,question:u}){try{const{data:c,error:m}=await U.functions.invoke("chatgpt-assistant",{body:{classId:t,question:u}});return m?(console.error("AI Service Error:",m),{answer:"Desculpe, o assistente IA está temporariamente indisponível. Tente novamente em alguns minutos.",error:!0}):c}catch(c){return console.error("AI Service Error:",c),{answer:"Desculpe, o assistente IA está temporariamente indisponível. Tente novamente em alguns minutos.",error:!0}}}function pe({classId:t}){const[u,c]=a.useState(""),[m,l]=a.useState(!1),[x,o]=a.useState([]),[r,d]=a.useState(""),p=async h=>{if(h.preventDefault(),!u.trim())return;d(""),l(!0);const f=u.trim();c("");try{const i=await he({classId:t,question:f});o(n=>[...n,{role:"user",content:f},{role:"assistant",content:i?.answer||"Sem resposta"}])}catch(i){d(i?.message||"Falha ao obter resposta")}finally{l(!1)}};return e.jsxs("div",{className:"border rounded-lg p-4 bg-card",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ne,{className:"w-5 h-5"}),e.jsx("h3",{className:"font-semibold",children:"Assistente IA da Turma"})]}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Contexto atrelado à turma. A IA responde com base nos materiais e atividades desta turma."}),e.jsxs("div",{className:"space-y-2 max-h-64 overflow-auto border rounded p-2 bg-background",children:[x.length===0&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sem mensagens. Faça sua primeira pergunta."}),x.map((h,f)=>e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"font-medium mr-1",children:h.role==="user"?"Você:":"IA:"}),h.content]},f))]}),e.jsxs("form",{onSubmit:p,className:"mt-3 flex items-center gap-2",children:[e.jsx("input",{className:"flex-1 border rounded-md px-3 py-2 text-sm bg-background",placeholder:"Pergunte algo sobre esta turma...",value:u,onChange:h=>c(h.target.value),disabled:m}),e.jsxs("button",{type:"submit",className:"inline-flex items-center gap-1 px-3 py-2 text-sm rounded-md border hover:bg-muted",disabled:m,children:[e.jsx(ie,{className:"w-4 h-4"}),"Enviar"]})]}),r&&e.jsx("div",{className:"text-xs text-red-600 mt-2",children:r})]})}function fe(t){const[u,c]=a.useState([]),[m,l]=a.useState(!1),[x,o]=a.useState(null),{toast:r}=$(),d=a.useCallback(async()=>{if(t){l(!0),o(null);try{const i=await C.getInvitesByClass(t);c(i||[])}catch(i){console.error("Error fetching invites:",i),o(i.message),r({variant:"destructive",title:"Erro ao carregar convites",description:"Não foi possível carregar os links de convite. Tente novamente."})}finally{l(!1)}}},[t,r]),p=a.useCallback(async(i={})=>{if(!t)return null;l(!0),o(null);try{const n=await C.createInvite(t,i);return await d(),r({title:"Link de convite criado",description:"O link foi gerado com sucesso!"}),n}catch(n){throw console.error("Error creating invite:",n),o(n.message),r({variant:"destructive",title:"Erro ao criar convite",description:n.message||"Não foi possível criar o link de convite."}),n}finally{l(!1)}},[t,d,r]),h=a.useCallback(async i=>{if(!i)return!1;l(!0),o(null);try{return await C.revokeInvite(i),c(n=>n.filter(g=>g.id!==i)),r({title:"Convite revogado",description:"O link de convite foi desativado com sucesso."}),!0}catch(n){return console.error("Error revoking invite:",n),o(n.message),r({variant:"destructive",title:"Erro ao revogar convite",description:"Não foi possível revogar o link de convite."}),!1}finally{l(!1)}},[r]),f=a.useCallback(async i=>{if(!i)return{success:!1,error:"Token inválido"};l(!0),o(null);try{const{data:{user:n}}=await U.auth.getUser();if(!n)throw new Error("Usuário não autenticado");const g=await C.acceptInvite(i,n.id);return g.success&&r({title:"Inscrição realizada",description:g.alreadyEnrolled?"Você já está inscrito nesta turma.":"Você foi inscrito na turma com sucesso!"}),g}catch(n){throw console.error("Error using invite:",n),o(n.message),r({variant:"destructive",title:"Erro ao usar convite",description:n.message||"Não foi possível aceitar o convite."}),n}finally{l(!1)}},[r]);return{invites:u,isLoading:m,error:x,fetchInvites:d,createInvite:p,revokeInvite:h,useInvite:f}}const ve=({classId:t,className:u})=>{const{toast:c}=$(),[m,l]=a.useState(7),[x,o]=a.useState(10),[r,d]=a.useState(null),[p,h]=a.useState("student"),{invites:f,isLoading:i,createInvite:n,revokeInvite:g,fetchInvites:w}=fe(t);a.useEffect(()=>{t&&w()},[t,w]);const j=async()=>{try{await n({maxUses:parseInt(x,10)||10,expiresInHours:(parseInt(m,10)||7)*24,role:p})}catch(s){console.error("Error creating invite:",s)}},v=s=>{const N=`${window.location.origin}/join/${s}`;navigator.clipboard.writeText(N),d(s),setTimeout(()=>d(null),2e3),c({title:"Link copiado!",description:"O link de convite foi copiado para a área de transferência."})},k=s=>{navigator.clipboard.writeText(s),c({title:"Código copiado!",description:"O código de convite foi copiado para a área de transferência."})},S=async s=>{window.confirm("Tem certeza que deseja revogar este convite? Esta ação não pode ser desfeita.")&&await g(s)},B=s=>{if(!s)return"Não expira";const N=new Date(s);return N<new Date?"Expirado":`Expira em ${de(N,"dd/MM/yyyy HH:mm")} (${le(N,{addSuffix:!0,locale:me})})`};return e.jsxs(P,{className:u,children:[e.jsxs(V,{children:[e.jsx(q,{children:"Convites para a turma"}),e.jsx(H,{children:"Crie links de convite para que alunos possam se juntar a esta turma sem necessidade de aprovação."})]}),e.jsx(O,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:"Criar novo convite"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"expiration",children:"Dias até expirar"}),e.jsx(T,{id:"expiration",type:"number",min:"1",value:m,onChange:s=>l(s.target.value),className:"max-w-[200px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{htmlFor:"maxUses",children:"Número máximo de usos"}),e.jsx(T,{id:"maxUses",type:"number",min:"1",value:x,onChange:s=>o(s.target.value),className:"max-w-[200px]"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(b,{children:"Role"}),e.jsxs(z,{value:p,onValueChange:h,children:[e.jsx(M,{className:"max-w-[220px]",children:e.jsx(Q,{placeholder:"Selecione o papel"})}),e.jsxs(G,{children:[e.jsx(A,{value:"student",children:"Student"}),e.jsx(A,{value:"teacher",children:"Teacher"})]})]})]})]}),e.jsx(y,{onClick:j,disabled:i,className:"mt-2",children:i?e.jsxs(e.Fragment,{children:[e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}),"Criando..."]}):"Gerar link de convite"})]}),f.length>0&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium",children:"Links ativos"}),e.jsx("div",{className:"space-y-3",children:f.map(s=>e.jsx("div",{className:"border rounded-lg p-4 space-y-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-2 flex-1 min-w-0",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(b,{className:"text-xs text-muted-foreground",children:"Código do convite"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-mono text-lg font-bold tracking-wider",children:s.invitation_code}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>k(s.invitation_code),children:e.jsx(L,{className:"h-3.5 w-3.5"})})]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(b,{className:"text-xs text-muted-foreground",children:"Link do convite"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"font-mono text-sm truncate text-muted-foreground",children:`${window.location.origin}/join/${s.invitation_code}`})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 text-sm text-muted-foreground pt-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(J,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:B(s.expires_at)})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(R,{className:"h-3.5 w-3.5"}),e.jsxs("span",{children:[s.current_uses||0," de ",s.max_uses," usos"]})]}),s.role&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-blue-50 text-blue-700 text-xs",children:s.role==="student"?"Aluno":"Professor"})}),s.status&&s.status!=="active"&&e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("span",{className:"inline-flex items-center px-2 py-0.5 rounded bg-red-50 text-red-700 text-xs",children:s.status==="cancelled"?"Cancelado":s.status==="expired"?"Expirado":s.status==="depleted"?"Esgotado":s.status})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(y,{variant:"outline",size:"sm",onClick:()=>v(s.invitation_code),disabled:r===s.invitation_code,children:r===s.invitation_code?e.jsxs(e.Fragment,{children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Copiado!"]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Copiar Link"]})}),e.jsx(y,{variant:"ghost",size:"sm",className:"text-destructive hover:text-destructive",onClick:()=>S(s.id),disabled:i||s.status!=="active",children:e.jsx(ce,{className:"h-4 w-4"})})]})]})},s.id))})]})]})})]})},Re=()=>{const{classId:t}=D(),[u]=W(),{user:c}=X(),[m,l]=a.useState(null),[x,o]=a.useState(!0),[r,d]=a.useState(""),[p,h]=a.useState(!1),[f,i]=a.useState([]),[n,g]=a.useState(!1),w=u.get("tab")||"activities",j=a.useCallback(async()=>{if(!t){console.error("No classId provided"),d("ID da turma não fornecido"),o(!1);return}if(!c){console.error("No user found in auth context"),d("Usuário não autenticado"),o(!1);return}try{d(""),console.log("Fetching class details for classId:",t);const v=await te(t);if(console.log("Class details:",v),!v)throw new Error("Turma não encontrada");const k=v.created_by===c.id;h(k),l(v);const S=await re(t);i(S||[])}catch(v){console.error("Error fetching class details:",v),d(v.message||"Erro ao carregar os detalhes da turma"),o(!1)}},[t,c]);return a.useEffect(()=>{j()},[j]),x?e.jsxs("div",{className:"flex items-center justify-center min-h-[60vh]",children:[e.jsx(_,{}),e.jsx("span",{className:"ml-2",children:"Carregando detalhes da turma..."})]}):r?e.jsx("div",{className:"container mx-auto p-4",children:e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(Y,{className:"w-5 h-5 mr-2 flex-shrink-0"}),e.jsx("span",{className:"font-medium",children:"Erro ao carregar a turma"})]}),e.jsx("p",{className:"mt-2 text-sm",children:r}),e.jsxs("button",{onClick:j,className:"mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500",children:[e.jsx(F,{className:`w-4 h-4 mr-2 ${n?"animate-spin":""}`}),"Tentar novamente"]})]})}):m?e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:m.name}),m.description&&e.jsx("p",{className:"text-gray-600 mt-2",children:m.description})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsxs(Z,{defaultValue:w,className:"space-y-6",children:[e.jsxs(ee,{className:`grid w-full ${p?"grid-cols-3":"grid-cols-2"}`,children:[e.jsxs(I,{value:"activities",className:"whitespace-nowrap inline-flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsx("span",{children:"Atividades"})]}),e.jsxs(I,{value:"students",className:"whitespace-nowrap inline-flex items-center gap-2",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"Alunos"})]}),p&&e.jsxs(I,{value:"invites",className:"whitespace-nowrap inline-flex items-center gap-2",children:[e.jsx(ue,{className:"w-4 h-4"}),e.jsx("span",{children:"Convites"})]})]}),e.jsx(E,{value:"activities",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"Atividades da Turma"}),e.jsx(xe,{classId:t,isTeacher:p})]})}),e.jsx(E,{value:"students",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-6",children:"Alunos da Turma"}),e.jsx("p",{className:"text-gray-600",children:"Lista de alunos será implementada aqui"})]})}),p&&e.jsx(E,{value:"invites",children:e.jsx(ve,{classId:t,className:"bg-white rounded-lg shadow"})})]})}),e.jsx("div",{className:"space-y-6",children:e.jsx(pe,{classId:t})})]})]}):e.jsx("div",{className:"container mx-auto p-4 text-center",children:e.jsx("p",{className:"text-gray-600",children:"Turma não encontrada."})})};export{Re as default};
